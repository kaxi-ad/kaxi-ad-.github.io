<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> 卡西莫多的小站</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      
<section class="cover">
    
      
      <a class="forkMe" href="https://github.com/Shen-Yu/hexo-theme-ayer"
        target="_blank"><img width="149" height="149" src="/images/forkme.png"
          class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover1.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">卡西莫多的小站</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.staticfile.org/typed.js/2.0.12/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['面朝大海，春暖花开', '愿你一生努力，一生被爱', '想要的都拥有，得不到的都释怀'],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  
  

<div class="notice" style="margin-top:50px">
    <i class="ri-heart-fill"></i>
    <div class="notice-content" id="broad"></div>
</div>
<script type="text/javascript">
    fetch('https://v1.hitokoto.cn')
        .then(response => response.json())
        .then(data => {
            document.getElementById("broad").innerHTML = data.hitokoto;
        })
        .catch(console.error)
</script>

<style>
    .notice {
        padding: 20px;
        border: 1px dashed #e6e6e6;
        color: #969696;
        position: relative;
        display: inline-block;
        width: 100%;
        background: #fbfbfb50;
        border-radius: 10px;
    }

    .notice i {
        float: left;
        color: #999;
        font-size: 16px;
        padding-right: 10px;
        vertical-align: middle;
        margin-top: -2px;
    }

    .notice-content {
        display: initial;
        vertical-align: middle;
    }
</style>
  
  <article class="articles">
    
    
    
    
    <article
  id="post-Mysql事务"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/08/01/Mysql%E4%BA%8B%E5%8A%A1/"
    >Mysql事务</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/08/01/Mysql%E4%BA%8B%E5%8A%A1/" class="article-date">
  <time datetime="2022-08-01T09:47:25.000Z" itemprop="datePublished">2022-08-01</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="Mysql事务"><a href="#Mysql事务" class="headerlink" title="Mysql事务"></a>Mysql事务</h1><blockquote>
<p>事务会把数据库从一种一致状态转换为另一种一致状态</p>
</blockquote>
<ul>
<li>原子性（atomicity）</li>
<li>一致性（consistency）</li>
<li>隔离性（isolation）</li>
<li>持久型（durability）</li>
</ul>
<p>锁保证事务的隔离性</p>
<h2 id="一、认识事务"><a href="#一、认识事务" class="headerlink" title="一、认识事务"></a>一、认识事务</h2><h3 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h3><blockquote>
<p>事务是访问并更新数据库中各种数据项的一个程序执行单元</p>
</blockquote>
<ul>
<li>A（Atomicity）原子性</li>
</ul>
<p>原子性指整个数据库事务是不可分割的工作单位。只有使事务中所有的数据库操作都执行成功，才算整个事务成功。</p>
<ul>
<li>C（consistency）一致性</li>
</ul>
<p>一致性指事务将数据库从一种状态转变为下一种一致的状态。事务开始前后，数据库的完整性约束没有被破坏。</p>
<ul>
<li>I（isolation）隔离性</li>
</ul>
<p>事务的隔离性要求每个读写事务的对象对其他事务的操作对象能相互分离，即该事务提交前对其他事务都不可见，通常这是用锁来实现。</p>
<ul>
<li>D（durability）持久性</li>
</ul>
<p>事务一旦提交，结果永久性的。即使发生宕机等故障，数据库也能将数据恢复。</p>
<h3 id="2、分类"><a href="#2、分类" class="headerlink" title="2、分类"></a>2、分类</h3><ul>
<li><p>扁平事务（Flat Transactions）</p>
</li>
<li><p>带有保存点的扁平事务（Flat Transactions with Savepoints）</p>
</li>
<li><p>链事务（Chained Transactions）</p>
</li>
<li><p>嵌套事务（Nested Transactions）</p>
</li>
</ul>
<h4 id="扁平事务"><a href="#扁平事务" class="headerlink" title="扁平事务"></a>扁平事务</h4><p>​		所有操作处于同一层次，其次由BEGIN WORK开始，由COMMIT WORK或者ROLLBACK WORK结束，其间的操作是原子的，要么都执行，要么都回滚。</p>
<p>​		主要限制，不能提交或回滚事务的某一部分，或分几个步骤提交。</p>
<p>​		<strong>带有保存点的扁平事务</strong></p>
<p>​		保存点（Savepoint）用来通知系统应该记住事务当前的状态，以便当之后发生错误时，事务能回到保存点当时的状态。</p>
<p>​		对于扁平的事务，其隐式地设置了一个保存点。然后在整个事务中，只有这一个保存点，因此，回滚只能回滚到事务开始时的状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">保存点用SAVE WORK函数建立</span><br><span class="line">SAVE　WORK：２</span><br><span class="line">回滚保存点２</span><br><span class="line">ROLL　BACK　WORK：２</span><br></pre></td></tr></table></figure>

<p><img src="/images/MySql%E4%BA%8B%E5%8A%A1/1.jpg" alt="示例"></p>
<h4 id="链事务"><a href="#链事务" class="headerlink" title="链事务"></a>链事务</h4><blockquote>
<p>可视为保存点模式的一种变种。</p>
</blockquote>
<p>思想：在提交一个事务时，释放不需要的数据对象，将必要的处理上下文隐式地传给下一个要开始的事务。</p>
<p>注：提交事务操作和开始下一个事务操作将合并为一个原子操作。下一个事务将看到上一个事务的结果。</p>
<p><img src="/images/MySql%E4%BA%8B%E5%8A%A1/2.jpg" alt="链事务"></p>
<p>与带有保存点的扁平事务不同处：</p>
<ul>
<li>带有保存点的扁平事务能回滚到任意正确的保存点。链事务中的回滚仅限于当前的事务，即只能恢复到最近一个的保存点</li>
<li>对于锁的处理，两者也不相同。链事务在执行COMMIT后即释放了当前事务所持有的锁，而带有保存点的扁平事务不影响迄今为止所持有的锁。</li>
</ul>
<h4 id="嵌套事务"><a href="#嵌套事务" class="headerlink" title="嵌套事务"></a>嵌套事务</h4><p>是一个层次结构框架。由一个顶层事务控制着各个层次的事务。</p>
<p><img src="/images/MySql%E4%BA%8B%E5%8A%A1/3.jpg" alt="嵌套事务"></p>
<h4 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h4><p>通常是一个在分布式环境下运行的扁平事务，因此需要根据数据所在位置访问网络中的不同节点。</p>
<p>​		对于InnoDB存储引擎来说，其支持扁平事务、带有保存点的事务、链事务、分布式事务。对于嵌套事务，并不原生支持。</p>
<h2 id="三、事务控制语句"><a href="#三、事务控制语句" class="headerlink" title="三、事务控制语句"></a>三、事务控制语句</h2><ul>
<li>START TRANSACTION | BEGIN：显式地开启一个事务</li>
<li>COMMIT：最简形式COMMIT，详细形式COMMIT WORK，二者几乎等价。COMMIT会提交事务，并使得已对数据库做地所有修改成为永久性地。</li>
<li>ROLLBACK：最简形式，ROLLBACK。也可改写为ROLLBACK　WORK，几乎等价。回滚会结束用户地事务，并撤销正在进行地所有未提交地修改。</li>
<li>SAVEPOINT identifier:SAVEPOINT允许在事务中创建一个保存点，一个事务中可以有多个SAVEPOINT；</li>
<li>RELEASE　SAVEPOINT　identifier：删除一个事务地保存点，当没有一个保存点执行这句语句时，会抛出一个异常。</li>
<li>ROLLBACK　TO［SAVEPOINT］identifier:这个语句与SAVEPOINT命令一起使用。可以把事务回滚到标记点，而不回滚在此标记点之前地任何工作。</li>
<li>SET TRANSACTION：设置事务隔离级别。READ UNCOMMITTED、READ COMMITTED、REPEATABLE READ、SERIALIZABLE</li>
</ul>
<p>COMMIT和COMMIT WORK语句基本是一致地，提交事务。不同之处在于COMMIT WORK用来控制事务结束后地行为是CHAIN还是RELEASE的。如果是CHAIN方式，那么事务就变成了链事务。</p>
<p><strong>completion_type</strong></p>
<p>该参数默认为0，表示没有任何操作。在这种设置下COMMIT和COMMIT WORK是完全等价的。当参数completion_type的值为1时，COMMIT WORK等同于COMMIT AND CHAIN，表示马上自动开启一个相同隔离级别的事务</p>
<p>例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into l select 3;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; commit work;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into l select 4;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into l select 4;</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &#x27;4&#x27; for key &#x27;PRIMARY&#x27;</span><br><span class="line">mysql&gt; rollback;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"># 回滚之后只有3没有4</span><br></pre></td></tr></table></figure>

<p>参数completion_type为2时，COMMIT WORK等同于COMMIT AND RELEASE。事务提交后会自动断开与服务器的连接。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set @@completion_type=2;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into l select 4;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; commit work;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select @@version\G;</span><br><span class="line">ERROR 2013 (HY000): Lost connection to MySQL server during query</span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br><span class="line">#提交后断开连接</span><br></pre></td></tr></table></figure>

<p>InnoDB存储引擎中的事务都是原子的。</p>
<ul>
<li>构成事务的每条语句都会提交（成为永久）</li>
<li>或者所有语句都回滚</li>
</ul>
<p>虽然有ROLLBACK，但其并不是真正的结束一个事务，因此即使执行了<strong>ROLLBACK TO SAVEPOINT</strong>，之后也需要显式地运行COMMIT或ROLLBACK命令。</p>
<blockquote>
<p>ROLLBACK TO SAVEPOINT命令并不真正地结束事务</p>
</blockquote>
<h2 id="四、隐式提交的SQL语句"><a href="#四、隐式提交的SQL语句" class="headerlink" title="四、隐式提交的SQL语句"></a>四、隐式提交的SQL语句</h2><p>以下语句会产生一个隐式的提交操作，执行完语句后，会有隐式的COMMIT操作</p>
<ul>
<li>DDL语句：ALTER DATEBASE … UPGRADE DATA DIRECTORY NAME，ALTER EVENT，ALTER PROCEDURE，ALTER TABLE，ALTER VIEW，CREATE DATABASE，CREATE EVENT，CREATE INDEX，CREATE INDEX，CREATE PROCEDURE…</li>
<li>用来隐式地修改MySQL架构的操作:CREATE USER、DROP USER、GRANT、RENAME USER、REVOKE、SET PASSWORD</li>
<li>管理语句:ANALYZE TABLE…</li>
<li>注：TRUNCATE TABLE语句是DDL，虽然结果与DELETE相同，但是不能被回滚的</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM l\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">a: 1</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">a: 2</span><br><span class="line">2 rows in set (0.03 sec)</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line">mysql&gt; BEGIN;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; TRUNCATE TABLE L;</span><br><span class="line">Query OK, 0 rows affected (0.12 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; ROLLBACK;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM l\G;</span><br><span class="line">Empty set (0.01 sec)</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br></pre></td></tr></table></figure>

<h2 id="五、对于事务操作的统计"><a href="#五、对于事务操作的统计" class="headerlink" title="五、对于事务操作的统计"></a>五、对于事务操作的统计</h2><p>InnoDB存储引擎是支持事务的</p>
<p>因此InnoDB存储引擎的应用需要在考虑<strong>每秒请求数</strong>（Question Per Second,QPS）的同时，应该关注每秒<strong>事务处理的能力</strong>(Transaction PerSecond,TPS)</p>
<p>计算TPS方式：(com_commit+com_rollback)&#x2F;time</p>
<p>前提：所有事务必须是显式提交的，如果存在隐式地提交和回滚（默认autocommit&#x3D;1），不会计算到com_commit和com_rollback变量中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW GLOBAL STATUS LIKE &#x27;com_commit&#x27;\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">Variable_name: Com_commit</span><br><span class="line">        Value: 10878</span><br><span class="line">1 row in set (0.03 sec)</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW GLOBAL STATUS LIKE &#x27;com_rollback&#x27;\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">Variable_name: Com_rollback</span><br><span class="line">        Value: 19</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<h2 id="六、事务的隔离级别"><a href="#六、事务的隔离级别" class="headerlink" title="六、事务的隔离级别"></a>六、事务的隔离级别</h2><ul>
<li>READ UNCOMMITTED</li>
<li>READ COMMITTED</li>
<li>REPEATABLE READ</li>
<li>SERIALIZABLE</li>
</ul>
<p>InnoDB引擎在REPEATABLE READ事务隔离级别下，使用Next-Key Lock锁的算法,因此避免幻读产生。</p>
<p>在SERIALABLE的事务隔离级别，InnoDB存储引擎会对每个SELECT语句后自动加上LOCK IN SHARE MODE,为每个读取操作加一个共享锁</p>
<h2 id="七、分布式事务"><a href="#七、分布式事务" class="headerlink" title="七、分布式事务"></a>七、分布式事务</h2><h3 id="1、MySQL数据库分布式事务"><a href="#1、MySQL数据库分布式事务" class="headerlink" title="1、MySQL数据库分布式事务"></a>1、MySQL数据库分布式事务</h3><p>分布式事务：允许多个独立的事务资源参与到一个全局的事务中。</p>
<p>在使用分布式事务时，Inn哦DB存储引擎的事务隔离级别必须设置为SERIALIZABLE。</p>
<p>分布式事务使用两段式提交（two-phase commit）的方式</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BA%8B%E5%8A%A1/" rel="tag">事务</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-Mysql锁"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/08/01/Mysql%E9%94%81/"
    >Mysql锁</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/08/01/Mysql%E9%94%81/" class="article-date">
  <time datetime="2022-08-01T09:47:25.000Z" itemprop="datePublished">2022-08-01</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="MySql锁"><a href="#MySql锁" class="headerlink" title="MySql锁"></a>MySql锁</h1><blockquote>
<p>人们认为行就送总会增加开销。实际上，只有当实现本身会增加开销时，行级锁才会增加开销。InnoDB存储引擎不需要锁升级，因为一个锁和多个锁的开销是相同的。</p>
</blockquote>
<h2 id="一、什么是锁（what）"><a href="#一、什么是锁（what）" class="headerlink" title="一、什么是锁（what）"></a>一、什么是锁（what）</h2><p>​		锁是数据库系统区别于文件系统的一个关键特性。锁机制用于管理对共享资源的并发访问。</p>
<p>​		对于MyISAM引擎，其锁是表锁设计。并发情况下的读没有问题，但是并发插入时的性能就要差一些了。</p>
<h2 id="二、lock"><a href="#二、lock" class="headerlink" title="二、lock"></a>二、lock</h2><p>​		lock的对象是事务，用来锁定的是数据库中的对象，如表、页、行。并且一般lock的对象仅在事务commit或rollback后进行释放（不同事务隔离级别释放的时间可能不同）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SHOW ENGINE INNODB STATUS</span><br><span class="line">以及information_schema架构下的表INNODB_TRX、INNODB_LOCKS、INNODB_LOCK_WAITS来观察锁信息。</span><br></pre></td></tr></table></figure>

<h2 id="三、InnoDB存储引擎中的锁"><a href="#三、InnoDB存储引擎中的锁" class="headerlink" title="三、InnoDB存储引擎中的锁"></a>三、InnoDB存储引擎中的锁</h2><h3 id="1、锁的类型"><a href="#1、锁的类型" class="headerlink" title="1、锁的类型"></a>1、锁的类型</h3><p>InnoDB实现的两种标准行级锁：</p>
<ul>
<li>共享锁（S Lock），允许事务读一行数据</li>
<li>排他锁（X Lock），允许事务删除或更新一行数据</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>X</th>
<th>S</th>
</tr>
</thead>
<tbody><tr>
<td>X</td>
<td>不兼容</td>
<td>不兼容</td>
</tr>
<tr>
<td>S</td>
<td>不兼容</td>
<td>兼容</td>
</tr>
</tbody></table>
<p>注意：S和X锁都是行锁，兼容指对同一记录（row）锁的兼容性情况。</p>
<p><strong>意向锁</strong>：将锁定的对象分为多个层次，意向锁意味着事务希望在更细粒度上进行加锁。</p>
<blockquote>
<p>若将上锁的对象看成一棵树，那么对最下层的对象上锁，也就是对最细粒度的对象进行上锁，熟悉需要对粗粒度的对象上锁。</p>
</blockquote>
<p>InnoDB意向锁即为表级别的锁。</p>
<p>支持两种意向锁：</p>
<ul>
<li>意向共享锁（IS Lock），事务想要获得一张表中某几行的共享锁。</li>
<li>意向排他锁（IX Lock），事务想要获得一张表中某几行的排他锁。</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>IS</th>
<th>IX</th>
<th>S</th>
<th>X</th>
</tr>
</thead>
<tbody><tr>
<td>IS</td>
<td>兼容</td>
<td>兼容</td>
<td>兼容</td>
<td>不兼容</td>
</tr>
<tr>
<td>IX</td>
<td>兼容</td>
<td>兼容</td>
<td>不兼容</td>
<td>不兼容</td>
</tr>
<tr>
<td>S</td>
<td>兼容</td>
<td>不兼容</td>
<td>兼容</td>
<td>不兼容</td>
</tr>
<tr>
<td>X</td>
<td>不兼容</td>
<td>不兼容</td>
<td>不兼容</td>
<td>不兼容</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> ENGINE INNODB STATUS查看当前锁请求的信息</span><br></pre></td></tr></table></figure>

<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">------------</span><br><span class="line">TRANSACTIONS</span><br><span class="line">------------</span><br><span class="line">Trx id counter <span class="number">261562</span></span><br><span class="line">Purge done for trx<span class="symbol">&#x27;s</span> n:o &lt; <span class="number">261560</span> undo n:o &lt; <span class="number">0</span> state: running but idle</span><br><span class="line">History list length <span class="number">8</span></span><br><span class="line">LIST OF TRANSACTIONS FOR EACH SESSION:</span><br><span class="line">---TRANSACTION <span class="number">283159487235888</span>, not started</span><br><span class="line"><span class="number">0</span> lock struct(<span class="name">s</span>), heap size <span class="number">1136</span>, <span class="number">0</span> row lock(<span class="name">s</span>)</span><br><span class="line">---TRANSACTION <span class="number">261561</span>, ACTIVE <span class="number">30</span> sec starting index read</span><br><span class="line">mysql tables in use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line">LOCK WAIT <span class="number">2</span> lock struct(<span class="name">s</span>), heap size <span class="number">1136</span>, <span class="number">1</span> row lock(<span class="name">s</span>)</span><br><span class="line">MySQL thread id <span class="number">13</span>, OS thread handle <span class="number">27560</span>, query id <span class="number">173</span> localhost ::<span class="number">1</span> root updating</span><br><span class="line">update rlock set a=<span class="number">4</span> where a=<span class="number">1</span></span><br><span class="line">Trx read view will not see trx with id &gt;= <span class="number">261561</span>, sees &lt; <span class="number">261560</span></span><br><span class="line">------- TRX HAS BEEN WAITING <span class="number">12</span> SEC FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id <span class="number">1138</span> page no <span class="number">3</span> n bits <span class="number">72</span> index GEN_CLUST_INDEX of table `test`.`rlock` trx id <span class="number">261561</span> lock_mode X waiting</span><br><span class="line">Record lock, heap no <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">4</span><span class="comment">; compact format; info bits 0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">6</span><span class="comment">; hex 00000003b200; asc       ;;</span></span><br><span class="line"> <span class="number">1</span>: len <span class="number">6</span><span class="comment">; hex 00000003fda6; asc       ;;</span></span><br><span class="line"> <span class="number">2</span>: len <span class="number">7</span><span class="comment">; hex 2300000124157b; asc #   $ &#123;;;</span></span><br><span class="line"> <span class="number">3</span>: len <span class="number">4</span><span class="comment">; hex 80000001; asc     ;;</span></span><br><span class="line"></span><br><span class="line">------------------</span><br><span class="line">---TRANSACTION <span class="number">261560</span>, ACTIVE <span class="number">43</span> sec</span><br><span class="line"><span class="number">2</span> lock struct(<span class="name">s</span>), heap size <span class="number">1136</span>, <span class="number">4</span> row lock(<span class="name">s</span>)</span><br><span class="line">MySQL thread id <span class="number">12</span>, OS thread handle <span class="number">14848</span>, query id <span class="number">170</span> localhost ::<span class="number">1</span> root</span><br></pre></td></tr></table></figure>

<p>locks rec but not gap代表锁住的是一个索引，不是一个范围。</p>
<p>从InnoDB1.0版本开始，在INFORMATION_SCHEMA架构下添加了表<strong>INNODB_TRX</strong>、<strong>INNODB_LOCKS</strong>、<strong>INNODB_LOCK_WAITS</strong>。通过这三张表，用户可以更简单地监控当前事务并分析可能存在的锁问题。</p>
<p><strong>INNODB_TRX</strong></p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>trx_id</td>
<td>事务ID</td>
</tr>
<tr>
<td>trx_state</td>
<td>事务状态</td>
</tr>
<tr>
<td>trx_started</td>
<td>事务开始时间</td>
</tr>
<tr>
<td>trx_requested_lock_id</td>
<td>等待事务的锁ID。</td>
</tr>
<tr>
<td>trx_wait_started</td>
<td>事务等待开始时间</td>
</tr>
<tr>
<td>trx_weight</td>
<td>事务权重，反映了一个事务修改和锁住的行数。在InnoDB存储引擎中，发生死锁需要回滚时，Inn哦DB存储引擎会选择该值最小的进行回滚。</td>
</tr>
<tr>
<td>trx_mysql_thread_id</td>
<td>MySql中的线程ID</td>
</tr>
<tr>
<td>trx_query</td>
<td>事务运行的SQL语句</td>
</tr>
</tbody></table>
<p>例子：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.INNODB_TRX\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                    trx_id: <span class="number">261579</span></span><br><span class="line">                 trx_state: <span class="keyword">RUNNING</span></span><br><span class="line">               trx_started: <span class="number">2022</span><span class="number">-08</span><span class="number">-02</span> <span class="number">09</span>:<span class="number">56</span>:<span class="number">47</span></span><br><span class="line">     trx_requested_lock_id: <span class="keyword">NULL</span></span><br><span class="line">          trx_wait_started: <span class="keyword">NULL</span></span><br><span class="line">                trx_weight: <span class="number">1</span></span><br><span class="line">       trx_mysql_thread_id: <span class="number">13</span></span><br><span class="line">                 trx_query: <span class="keyword">NULL</span></span><br><span class="line">       trx_operation_state: <span class="keyword">NULL</span></span><br><span class="line">         trx_tables_in_use: <span class="number">0</span></span><br><span class="line">         trx_tables_locked: <span class="number">1</span></span><br><span class="line">          trx_lock_structs: <span class="number">1</span></span><br><span class="line">     trx_lock_memory_bytes: <span class="number">1136</span></span><br><span class="line">           trx_rows_locked: <span class="number">1</span></span><br><span class="line">         trx_rows_modified: <span class="number">0</span></span><br><span class="line">   trx_concurrency_tickets: <span class="number">0</span></span><br><span class="line">       trx_isolation_level: REPEATABLE READ</span><br><span class="line">         trx_unique_checks: <span class="number">1</span></span><br><span class="line">    trx_foreign_key_checks: <span class="number">1</span></span><br><span class="line">trx_last_foreign_key_error: <span class="keyword">NULL</span></span><br><span class="line"> trx_adaptive_hash_latched: <span class="number">0</span></span><br><span class="line"> trx_adaptive_hash_timeout: <span class="number">0</span></span><br><span class="line">          trx_is_read_only: <span class="number">0</span></span><br><span class="line">trx_autocommit_non_locking: <span class="number">0</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                    trx_id: <span class="number">261578</span></span><br><span class="line">                 trx_state: <span class="keyword">RUNNING</span></span><br><span class="line">               trx_started: <span class="number">2022</span><span class="number">-08</span><span class="number">-02</span> <span class="number">09</span>:<span class="number">56</span>:<span class="number">33</span></span><br><span class="line">     trx_requested_lock_id: <span class="keyword">NULL</span></span><br><span class="line">          trx_wait_started: <span class="keyword">NULL</span></span><br><span class="line">                trx_weight: <span class="number">4</span></span><br><span class="line">       trx_mysql_thread_id: <span class="number">12</span></span><br><span class="line">                 trx_query: <span class="keyword">NULL</span></span><br><span class="line">       trx_operation_state: <span class="keyword">NULL</span></span><br><span class="line">         trx_tables_in_use: <span class="number">0</span></span><br><span class="line">         trx_tables_locked: <span class="number">1</span></span><br><span class="line">          trx_lock_structs: <span class="number">2</span></span><br><span class="line">     trx_lock_memory_bytes: <span class="number">1136</span></span><br><span class="line">           trx_rows_locked: <span class="number">1</span></span><br><span class="line">         trx_rows_modified: <span class="number">2</span></span><br><span class="line">   trx_concurrency_tickets: <span class="number">0</span></span><br><span class="line">       trx_isolation_level: REPEATABLE READ</span><br><span class="line">         trx_unique_checks: <span class="number">1</span></span><br><span class="line">    trx_foreign_key_checks: <span class="number">1</span></span><br><span class="line">trx_last_foreign_key_error: <span class="keyword">NULL</span></span><br><span class="line"> trx_adaptive_hash_latched: <span class="number">0</span></span><br><span class="line"> trx_adaptive_hash_timeout: <span class="number">0</span></span><br><span class="line">          trx_is_read_only: <span class="number">0</span></span><br><span class="line">trx_autocommit_non_locking: <span class="number">0</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<p><strong>INNODB_LOCKS</strong>查看锁</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>lock_id</td>
<td>锁ID</td>
</tr>
<tr>
<td>lock_trx_id</td>
<td>事务ID</td>
</tr>
<tr>
<td>lock_mode</td>
<td>锁的模型</td>
</tr>
<tr>
<td>lock_type</td>
<td>锁的类型，表锁还是行锁</td>
</tr>
<tr>
<td>lock_table</td>
<td>要加锁的表</td>
</tr>
<tr>
<td>lock_index</td>
<td>锁住的索引</td>
</tr>
<tr>
<td>lock_space</td>
<td>锁对象的space id</td>
</tr>
<tr>
<td>lock_page</td>
<td>事务锁定页的数量，若为表锁，null</td>
</tr>
<tr>
<td>lock_rec</td>
<td>事务锁定行的数量，若为表锁，null</td>
</tr>
<tr>
<td>lock_data</td>
<td>事务锁定记录的主键值，若为表锁，null</td>
</tr>
</tbody></table>
<p>例子：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.INNODB_LOCKS\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">    lock_id: <span class="number">261579</span>:<span class="number">1140</span>:<span class="number">3</span>:<span class="number">2</span></span><br><span class="line">lock_trx_id: <span class="number">261579</span></span><br><span class="line">  lock_mode: X</span><br><span class="line">  lock_type: RECORD</span><br><span class="line"> lock_table: `test`.`rlock`</span><br><span class="line"> lock_index: <span class="keyword">PRIMARY</span></span><br><span class="line"> lock_space: <span class="number">1140</span></span><br><span class="line">  lock_page: <span class="number">3</span></span><br><span class="line">   lock_rec: <span class="number">2</span></span><br><span class="line">  lock_data: <span class="number">1</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">    lock_id: <span class="number">261578</span>:<span class="number">1140</span>:<span class="number">3</span>:<span class="number">2</span></span><br><span class="line">lock_trx_id: <span class="number">261578</span></span><br><span class="line">  lock_mode: X</span><br><span class="line">  lock_type: RECORD</span><br><span class="line"> lock_table: `test`.`rlock`</span><br><span class="line"> lock_index: <span class="keyword">PRIMARY</span></span><br><span class="line"> lock_space: <span class="number">1140</span></span><br><span class="line">  lock_page: <span class="number">3</span></span><br><span class="line">   lock_rec: <span class="number">2</span></span><br><span class="line">  lock_data: <span class="number">1</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>

<p>INNODB_LOCK_WAITS事务的等待</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>requesting_trx_id</td>
<td>申请锁资源的事务ID</td>
</tr>
<tr>
<td>requesting_lock_id</td>
<td>申请的锁的ID</td>
</tr>
<tr>
<td>blocking_trx_id</td>
<td>阻塞的事务ID</td>
</tr>
<tr>
<td>blocking_lock_id</td>
<td>阻塞的锁ID</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.INNODB_LOCK_WAITS\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">requesting_trx_id: <span class="number">261579</span></span><br><span class="line">requested_lock_id: <span class="number">261579</span>:<span class="number">1140</span>:<span class="number">3</span>:<span class="number">2</span></span><br><span class="line">  blocking_trx_id: <span class="number">261578</span></span><br><span class="line"> blocking_lock_id: <span class="number">261578</span>:<span class="number">1140</span>:<span class="number">3</span>:<span class="number">2</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>如果需要，用户可以根据三张表联合查询得到更直观的详细信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>    r.trx_id waiting_trx_id,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>    r.trx_mysql_thread_id waiting_thread,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>    r.trx_query waiting_query,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>    b.trx_id blocking_trx_id,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>    b.trx_mysql_thread_id blocking_thread,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>    b.trx_query blocking_query</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">from</span> information_schema.innodb_lock_waits w</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> information_schema.innodb_trx b</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">ON</span> b.trx_id <span class="operator">=</span> w.blocking_trx_id</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> information_schema.innodb_trx r</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">ON</span> r.trx_id <span class="operator">=</span> w.requesting_trx_id\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line"> waiting_trx_id: <span class="number">261579</span></span><br><span class="line"> waiting_thread: <span class="number">13</span></span><br><span class="line">  waiting_query: <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> rlock <span class="keyword">for</span> <span class="keyword">update</span></span><br><span class="line">blocking_trx_id: <span class="number">261578</span></span><br><span class="line">blocking_thread: <span class="number">12</span></span><br><span class="line"> blocking_query: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="2、一致性非锁定读"><a href="#2、一致性非锁定读" class="headerlink" title="2、一致性非锁定读"></a>2、一致性非锁定读</h3><p>​		一致性的非锁定读（consistent nonlocking read）是指</p>
<p>InnoDB存储引擎通过行多版本控制（multi versioning）的方式来读取当前执行时间数据库中行的数据。如果读取的行正在执行DELETE或UPDATE操作，这是读取操作不会因此去等待行上锁的释放。相反地，InnoDB存储引擎获取读取行的一个快照数据。</p>
<p><img src="/images/MySql%E9%94%81/1.png" alt="InnoDB存储引擎非锁定的一致性读"></p>
<p>之所以称其为非锁定读，因为不需要等待访问的行上X锁的释放。</p>
<p>​		在不同事务隔离级别下，读取方式不同，并不是在每个事务隔离级别下都是采用非锁定的一致性读。</p>
<p>​		一个行记录可能不止一个快照数据，一般称这种技术为行多版本技术。由此带来的并发控制，称之为多版本并发控制（Multi Version Concurrency Control，MVCC）。</p>
<ul>
<li>在READ COMMITTED事务隔离级别下，对于快照数据，非一致性读总是读取被锁定行的最新一份快照数据。</li>
<li>在REPEATABLE READ事务隔离级别下，对于快照数据，非一致性读总是读取事务开始时的行数据版本。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span>查询事务隔离级别</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@tx</span>_isolation;</span><br></pre></td></tr></table></figure>

<h3 id="3、一致性锁定读"><a href="#3、一致性锁定读" class="headerlink" title="3、一致性锁定读"></a>3、一致性锁定读</h3><p>​	某些情况下，用户需要显式地对数据库读取操作进行加锁以保证数据逻辑的一致性。而这要求数据库支持加锁语句，即使是对于select的只读操作。</p>
<p>​		InnoDB存储引擎对于select语句支持两种一致性的锁定读(locking read)操作：</p>
<ul>
<li>select ··· for update</li>
<li>select ··· lock in share mode</li>
</ul>
<p>select ··· for update 对读取的行记录加一个x锁，其他事务不能对已锁定的行加上任何锁。</p>
<p>select ··· lock in share mode对读取的行记录加一个S锁，其他事务可以想被锁定的行加S锁，但如果加X锁，会被阻塞。</p>
<p>​		select···for update，select···lock in share mode必须在一个事务中，事务提交，锁释放。可使用begin，start transaction 或者set autocommit&#x3D;0。</p>
<h3 id="4、自增长与锁"><a href="#4、自增长与锁" class="headerlink" title="4、自增长与锁"></a>4、自增长与锁</h3><p>​	对于有自增长值得列得并发插入性能较差，事务必须等待前一个插入的完成（虽然不用等待事务的完成）。其次，对于INSERT···SELECT的大数据量的插入会影响插入的性能，因为另一个事务中的插入会被阻塞。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(auto_inc_col) <span class="keyword">from</span> t <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>

<p>在InnoDB存储引擎中，自增长值得列必须是索引，同时必须是索引的第一个列。</p>
<h3 id="5、外键和锁"><a href="#5、外键和锁" class="headerlink" title="5、外键和锁"></a>5、外键和锁</h3><p>​		在InnoDB存储引擎中，对于一个外键列，如果没有显式地对这个列加索引，InnoDB存储引擎自动对其加一个索引，因为这样可以避免表锁———这比Oracle数据库做得好。</p>
<p>​		对于外键值的插入或更新，首先需要查询父表中的记录，即SELECT父表。但是对于父表的SELECT操作，不是使用一致性非锁定读方式，因为这样会发生数据不一致问题，因此这时使用的是SELECT···LOCK IN SHARE MODE方式，主动对父表加S锁。</p>
<p>示例：</p>
<table>
<thead>
<tr>
<th>时间</th>
<th>会话A</th>
<th>会话B</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>BEGIN</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>DELETE FROM parent WHERE id&#x3D;3;</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td></td>
<td>BEGIN</td>
</tr>
<tr>
<td>4</td>
<td></td>
<td>INSERT INTO child SELECT 2,3#第二列是外键，执行该句被阻塞（waiting）</td>
</tr>
</tbody></table>
<h2 id="四、锁的算法"><a href="#四、锁的算法" class="headerlink" title="四、锁的算法"></a>四、锁的算法</h2><h3 id="1、行锁的3种算法"><a href="#1、行锁的3种算法" class="headerlink" title="1、行锁的3种算法"></a>1、行锁的3种算法</h3><p>InnoDB存储引擎有3种行锁的算法，分别是：</p>
<ul>
<li>Record Lock：单个行记录上的锁</li>
<li>Gap Lock：间隙锁，锁定一个范围，不包含记录本身</li>
<li>Next-Key Lock：Gap Lock+Record Lock，锁定一个范围，并且锁定记录本身</li>
</ul>
<p>Record Lock总是会去锁住<strong>索引</strong>记录，如果InnoDB存储引擎表在建立的时候没有设置任何一个索引，那么这时InnoDB存储引擎会使用隐式的主键来锁定。</p>
<blockquote>
<p><strong>使用算法需要添加索引</strong></p>
</blockquote>
<p>InnoDB对于行的查询都是采用Next-Key Lock算法。</p>
<p>例如：</p>
<p>​	一个索引有10，11，13和20，区间：</p>
<p>(-∞,10]</p>
<p>(10,11]</p>
<p>(11,13]</p>
<p>(13,20]</p>
<p>(20,+∞)</p>
<p>若事务T1已经通过next-key locking锁定了如下范围：</p>
<p>(10,11]、(11,13]</p>
<p>当插入新的记录12时，锁定的范围会变成:</p>
<p>(10,11]、(11,12]、(12,13]</p>
<p><strong>唯一索引</strong>：当查询的索引含有<strong>唯一属性</strong>时，InnoDB存储引擎会对Next-Key Lock进行优化，将其降级为Record Lock，即仅锁住索引本身，而不是范围，提高应用的并发性。</p>
<p><strong>辅助索引情况</strong></p>
<p>实例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> z ( a <span class="type">int</span>,b <span class="type">int</span>,<span class="keyword">PRIMARY</span> KEY(a),KEY(b));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> z <span class="keyword">select</span> <span class="number">1</span>,<span class="number">1</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> z <span class="keyword">select</span> <span class="number">3</span>,<span class="number">1</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> z <span class="keyword">select</span> <span class="number">5</span>,<span class="number">3</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> z <span class="keyword">select</span> <span class="number">7</span>,<span class="number">6</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> z <span class="keyword">select</span> <span class="number">10</span>,<span class="number">8</span>;</span><br></pre></td></tr></table></figure>

<p>事务A</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> z <span class="keyword">where</span> b<span class="operator">=</span><span class="number">3</span> <span class="keyword">for</span> <span class="keyword">update</span></span><br></pre></td></tr></table></figure>

<p>sql通过索引列b进行查询，使用传统的Next-Key Locking技术加锁。</p>
<p>由于有两个索引，需要分别进行锁定。</p>
<p>对于辅助索引，加上的是Next-Key Lock,锁定的范围是**(1,3)<strong>，特别需要注意的是，InnoDB存储引擎会对辅助索引下一个键值加上gap lock，即还有一个辅助索引范围为</strong>(3,6)**的锁。</p>
<p>Gap Lock的作用是为了阻止多个事务将记录插入到同一范围内，而这会导致Phantom Problem问题的产生。</p>
<h3 id="2、解决Phantom-Problem（幻读）"><a href="#2、解决Phantom-Problem（幻读）" class="headerlink" title="2、解决Phantom Problem（幻读）"></a>2、解决Phantom Problem（幻读）</h3><p>Phantom Problem指同一事务下，连续执行两次同样的SQL语句可能导致不同的结果，第二次的SQL语句可能会返回之前不存在的行。</p>
<p>​		InnoDB存储引擎默认的事务隔离级别是<strong>REPEATABLE READ</strong>，在该隔离级别下，其采用Next-Key Locking方式加锁。</p>
<p>​		而在事务隔离级别<strong>READ COMMITED</strong>下，其仅采用Record Lock；</p>
<p>实现唯一性检查：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> col <span class="operator">=</span> xxx LOCK <span class="keyword">IN</span> SHARE MODE;</span><br><span class="line"></span><br><span class="line">If <span class="keyword">not</span> found <span class="keyword">any</span> <span class="type">row</span>:</span><br><span class="line">	# <span class="keyword">unique</span> <span class="keyword">for</span> <span class="keyword">insert</span> <span class="keyword">value</span></span><br><span class="line">	<span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">table</span> <span class="keyword">VALUES</span> (...);</span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>时间</th>
<th>会话A</th>
<th>会话B</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>begin</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>select * from z where b &#x3D; 4 lock in share mode；（S锁）</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td></td>
<td>select * from z where b &#x3D; 4 lock in share mode；（S锁）</td>
</tr>
<tr>
<td>4</td>
<td>INSERT INTO z SELECT 4，4；#阻塞</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td></td>
<td>INSERT INTO z SELECT 4，4；<br>ERROR 1213（40001）:Deadlock found when trying to get lock;try restarting transaction#抛出死锁异常</td>
</tr>
<tr>
<td>6</td>
<td>#INSERT插入成功</td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> session tx_isolation<span class="operator">=</span><span class="number">0</span> #设置事务隔离级别</span><br></pre></td></tr></table></figure>



<p>锁定由Next-Key Lock算法降级为了Record Lock，从而提高应用的并发性。</p>
<h2 id="五、锁问题"><a href="#五、锁问题" class="headerlink" title="五、锁问题"></a>五、锁问题</h2><h3 id="1、脏读"><a href="#1、脏读" class="headerlink" title="1、脏读"></a>1、脏读</h3><p>脏数据：指事务对缓冲池中行记录的修改，并且还没有被提交（commit）。</p>
<p>如果读到了脏数据，即一个事务可以读到另外一个事务中未提交的数据，显然违反了数据库隔离性。</p>
<p>脏读：指的是不同的事务下，当前事务可以读到另外事务未提交的数据，可以读到脏数据。</p>
<p>示例：</p>
<table>
<thead>
<tr>
<th>时间</th>
<th>会话A</th>
<th>会话B</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>set session tx_isolation&#x3D;0;</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td></td>
<td>set session tx_isolation&#x3D;0;</td>
</tr>
<tr>
<td>3</td>
<td></td>
<td>begin;</td>
</tr>
<tr>
<td>4</td>
<td></td>
<td>mysql&gt; select * from l;<br>a<br>1<br>2</td>
</tr>
<tr>
<td>5</td>
<td>insert into l select 3;</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td></td>
<td>mysql&gt; select * from l;<br/>a<br/>1<br/>2<br>3</td>
</tr>
</tbody></table>
<p>脏读发生条件需要事务隔离级别为READ UNCOMMITTED</p>
<ul>
<li>InnoDB存储引擎默认的事务隔离级别为<strong>READ REPEATABLE</strong></li>
<li>Microsoft SQL Server数据库为READ COMMITTED</li>
<li>Oracle数据库也是READ COMMITTED</li>
</ul>
<h3 id="2、不可重复读"><a href="#2、不可重复读" class="headerlink" title="2、不可重复读"></a>2、不可重复读</h3><p>不可重复读和脏读的区别是：脏读是读到未提交的数据，而不可重复读读到的却是已经提交的数据。</p>
<table>
<thead>
<tr>
<th>时间</th>
<th>会话A</th>
<th>会话B</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>set session tx_isolation&#x3D;1</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td></td>
<td>set session tx_isolation&#x3D;1</td>
</tr>
<tr>
<td>3</td>
<td>begin</td>
<td>begin</td>
</tr>
<tr>
<td>4</td>
<td>mysql&gt; select * from l;<br>a<br>1</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td></td>
<td>insert into l select 2;</td>
</tr>
<tr>
<td>6</td>
<td></td>
<td>commit;</td>
</tr>
<tr>
<td>7</td>
<td>mysql&gt; select * from l;<br/>a<br/>1<br>2</td>
<td></td>
</tr>
</tbody></table>
<p>隔离级别READ COMMITTED下允许不可重复读现象</p>
<p>在NextKey Lock算法下，对于索引的扫描，不仅是锁住扫描到的所有，还所著索引覆盖的范围(gap)。</p>
<p>InnoDB存储引擎的默认事务隔离级别是READ REPEATABLE，采用Next-Key Lock算法，避免了不可重复读现象。</p>
<h3 id="3、丢失更新"><a href="#3、丢失更新" class="headerlink" title="3、丢失更新"></a>3、丢失更新</h3><p>一个事务的更新操作被另一个事务的更新操作覆盖，导致数据结果不一致。</p>
<p>示例：</p>
<ul>
<li>事务T1将行记录r更新为v1，但是事务T1并未提交</li>
<li>与此同时，事务T2将行记录r更新为v2，事务T2未提交</li>
<li>事务T1提交。</li>
<li>事务T2提交。</li>
</ul>
<p>在当前数据库的任何隔离级别下，都不会导致数据库理论意义上丢失更新问题。因为即使是READ UNCOMMITTED的事务隔离级别，对于行的DML操作，需要对行或其他粗粒度级别的对象加锁。</p>
<p><strong>逻辑意义的丢失更新问题</strong></p>
<p>示例：</p>
<ul>
<li>事务T1查询一行数据，放入本地内存，并显示给一个终端用户User1.</li>
<li>事务T2也查询改行数据，并将取得的数据显示给终端用户User2</li>
<li>User1修改这行记录，更新数据库并提交。</li>
<li>User2修改这行记录，更新数据库并提交。</li>
</ul>
<p>（重点）需要在数据库层解决这个问题，避免任何可能发生丢失更新的情况。</p>
<blockquote>
<p>最好将操作串行化</p>
</blockquote>
<p>处理方法：</p>
<table>
<thead>
<tr>
<th>时间</th>
<th>会话A</th>
<th>会话B</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>begin;</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>select cash into @cash from account where user &#x3D;pUser for update;</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td></td>
<td>select cash into @cash from account where user &#x3D;pUser for update;#等待</td>
</tr>
<tr>
<td></td>
<td>···</td>
<td>···</td>
</tr>
<tr>
<td>m</td>
<td>update account set cash&#x3D;@cash-9000 where user&#x3D;pUser;</td>
<td></td>
</tr>
<tr>
<td>m+1</td>
<td>commit;</td>
<td></td>
</tr>
<tr>
<td>m+2</td>
<td></td>
<td>update account set cash&#x3D;@cash-1 where user&#x3D;pUser;</td>
</tr>
<tr>
<td>m+3</td>
<td></td>
<td>commit;</td>
</tr>
</tbody></table>
<h2 id="六、阻塞"><a href="#六、阻塞" class="headerlink" title="六、阻塞"></a>六、阻塞</h2><blockquote>
<p>因为不同锁之间的兼容性关系，有些时刻一个事务中的锁需要等待另一个事务中的锁释放它所占用的资源</p>
</blockquote>
<p>参数innodb_lock_wait_timeout</p>
<ul>
<li>用来控制等待的时间（默认50秒）</li>
<li>动态的</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> @<span class="variable">@innodb</span>_lock_wait_timeout<span class="operator">=</span><span class="number">60</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>



<p>参数innodb_rollback_on_timeout</p>
<ul>
<li>设定是否在等待超时时对进行中的事务进行回滚操作（默认是OFF，不回滚）</li>
<li>静态，不可在启动时修改</li>
</ul>
<blockquote>
<p>默认情况下InnoDB存储引擎不会回滚超时引发的错误异常</p>
</blockquote>
<h2 id="七、死锁"><a href="#七、死锁" class="headerlink" title="七、死锁"></a>七、死锁</h2><h3 id="1、死锁的概念"><a href="#1、死锁的概念" class="headerlink" title="1、死锁的概念"></a>1、死锁的概念</h3><p><strong>死锁指两个或两个以上的事务在执行过程中，因争夺锁资源而造成的一种互相等待的现象。</strong></p>
<h3 id="2、死锁概率"><a href="#2、死锁概率" class="headerlink" title="2、死锁概率"></a>2、死锁概率</h3><ul>
<li>系统中事务的数量（n），数量越多发生死锁的概率越大</li>
<li>每个事务操作的数量（r），每个事务操作的数量越多，发生死锁的概率越大</li>
<li>操作数据的集合（R），越小则发生死锁的概率越大</li>
</ul>
<h3 id="3、死锁的示例"><a href="#3、死锁的示例" class="headerlink" title="3、死锁的示例"></a>3、死锁的示例</h3><p>1213错误提示，表示事务发生了死锁。</p>
<h4 id="（1）AB-BA死锁："><a href="#（1）AB-BA死锁：" class="headerlink" title="（1）AB-BA死锁："></a>（1）AB-BA死锁：</h4><table>
<thead>
<tr>
<th>时间</th>
<th>会话A</th>
<th>会话B</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>begin;</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>mysql&gt; select * from l where a&#x3D;2 for update;<br>a<br>2</td>
<td>begin;</td>
</tr>
<tr>
<td>3</td>
<td></td>
<td>mysql&gt; select * from l where a&#x3D;5 for update;<br>a<br>5</td>
</tr>
<tr>
<td>4</td>
<td>mysql&gt; select * from l where a&#x3D;5 for update;<br>#等待</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td></td>
<td>mysql&gt; select * from l where a&#x3D;2 for update;<br>ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</td>
</tr>
</tbody></table>
<p>InnoDB存储引擎并不会回滚大部分的错误异常，但是死锁除外。发现死锁后，InnoDB存储引擎会马上回滚一个事务。因此如果在应用程序中捕获了1213错误，并不需要对其进行回滚。</p>
<h4 id="（2）持有X锁，等待队列存在S锁"><a href="#（2）持有X锁，等待队列存在S锁" class="headerlink" title="（2）持有X锁，等待队列存在S锁"></a>（2）持有X锁，等待队列存在S锁</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> l (</span><br><span class="line">    a <span class="type">int</span> <span class="keyword">primary</span> key</span><br><span class="line">)engine<span class="operator">=</span>InnoDB</span><br><span class="line">inset <span class="keyword">into</span> l <span class="keyword">values</span>(<span class="number">1</span>);</span><br><span class="line">inset <span class="keyword">into</span> l <span class="keyword">values</span>(<span class="number">2</span>);</span><br><span class="line">inset <span class="keyword">into</span> l <span class="keyword">values</span>(<span class="number">5</span>);</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>时间</th>
<th>会话A</th>
<th>会话B</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>begin;</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td></td>
<td>begin;</td>
</tr>
<tr>
<td>3</td>
<td>select * from l where a&#x3D;5 for update;</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td></td>
<td>select * from l where a&lt;&#x3D;5 lock in share mode;<br>–等待</td>
</tr>
<tr>
<td>5</td>
<td>insert into t values(4);<br>ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td></td>
<td>–事务获得锁，正常运行</td>
</tr>
</tbody></table>
<p>会话A持有X锁，会话B之后持有S锁，进入等待，此时会话A插入记录4，发生死锁。原因是会话A持有记录5的X锁，会话B持有记录1，记录2的S锁，等待记录5的S锁，此时会话A插入记录4，会话B在持有记录5的S锁之后，还要获得记录4的S锁，不合理。</p>
<p>因此，InnoDB存储引擎主动选择死锁。回滚的是undo log记录大的事务。</p>
<h2 id="八、锁升级"><a href="#八、锁升级" class="headerlink" title="八、锁升级"></a>八、锁升级</h2><blockquote>
<p><strong>InnoDB存储引擎不存在锁升级的问题。</strong></p>
</blockquote>
<p>因为其不是根据每个记录来产生行锁的，相反，其根据每个事务访问的每个页对锁进行管理的，采用的是位图的方式。因此不管一个事务锁住页中一个记录还是多个记录，开销通常是一致的。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%94%81/" rel="tag">锁</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-Mysql索引"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/07/28/Mysql%E7%B4%A2%E5%BC%95/"
    >Mysql索引</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/07/28/Mysql%E7%B4%A2%E5%BC%95/" class="article-date">
  <time datetime="2022-07-28T03:34:25.000Z" itemprop="datePublished">2022-07-28</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="MySql索引"><a href="#MySql索引" class="headerlink" title="MySql索引"></a>MySql索引</h1><h2 id="一、什么是索引（what）"><a href="#一、什么是索引（what）" class="headerlink" title="一、什么是索引（what）"></a>一、什么是索引（what）</h2><p>索引：对数据库中一列或多列的值进行排序的一种结构</p>
<h2 id="二、为什么用索引（why）"><a href="#二、为什么用索引（why）" class="headerlink" title="二、为什么用索引（why）"></a>二、为什么用索引（why）</h2><p>当表中由大量记录时，若要对表进行查询</p>
<p>第一种方式，可进行全表搜索，是将所有记录一一取出，和查询条件进行一一对比，然后返回满足条件的记录，这样做会消耗大量数据库系统时间，并造成大量磁盘I&#x2F;O操作。</p>
<p>第二种方式，在表中建立索引，然后在索引中找到符合查询条件的索引值，最后通过保存在索引中的ROWID（相当于页码）快速找到表中对应的记录。</p>
<p>优点：</p>
<ul>
<li>索引大大加快数据的检索速度</li>
<li>创建唯一性索引，保证数据库表中每一行数据的唯一性。</li>
<li>加速表和表之间的连接</li>
<li>在使用分组和排序子句进行数据检索时，可以显著减少查询中分组和排序的时间。</li>
</ul>
<p>缺点：</p>
<ul>
<li>额外的占用物理空间</li>
<li>对表中数据进行增加、删除和修改的时候，索引也要动态的维护，降低了数据的维护速度。</li>
</ul>
<h2 id="三、如何使用索引（how）"><a href="#三、如何使用索引（how）" class="headerlink" title="三、如何使用索引（how）"></a>三、如何使用索引（how）</h2><p>InnoDB存储引擎支持以下几种常见的索引：</p>
<ul>
<li>B+树索引</li>
<li>全文索引</li>
<li>哈希索引</li>
</ul>
<p>B+树索引就是传统意义上的索引，目前关系型数据库系统中查找最为常用和最为有效的索引。</p>
<h2 id="四、B-树"><a href="#四、B-树" class="headerlink" title="四、B+树"></a>四、B+树</h2><p>​		B+树是为磁盘或其他直接存取辅助设备设计的一种平衡查找树。在B+树中，所有记录节点都是按键值的大小顺序存放在同一层的叶子节点上，由各叶子节点指针进行连接。</p>
<p><img src="/images/MySql%E7%B4%A2%E5%BC%95/%E9%AB%98%E5%BA%A6%E4%B8%BA2%E7%9A%84B+tree.jpg" alt="高度为2的B+tree"></p>
<h3 id="1、插入操作"><a href="#1、插入操作" class="headerlink" title="1、插入操作"></a>1、插入操作</h3><table>
<thead>
<tr>
<th>Leaf Page满</th>
<th>Index Page满</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>No</td>
<td>No</td>
<td>直接将记录插入到叶子节点</td>
</tr>
<tr>
<td>Yes</td>
<td>No</td>
<td>1）拆分Leaf Page<br>2）将中间的节点放入到Index Page中<br>3）小于中间节点的记录放左边<br>4）大于或等于中间节点的记录放右边</td>
</tr>
<tr>
<td>Yes</td>
<td>Yes</td>
<td>1）拆分Leaf Page<br/>2）将中间的节点放入到Index Page中<br/>3）小于中间节点的记录放左边<br/>4）大于或等于中间节点的记录放右边<br>5）小于中间节点的记录放左边<br>6）大于中间节点的记录放右边<br>7）中间节点放入上一层Index Page</td>
</tr>
</tbody></table>
<p>示例：</p>
<p><img src="/images/MySql%E7%B4%A2%E5%BC%95/%E5%9B%BE5-7.jpg" alt="直接插入28"></p>
<p><img src="/images/MySql%E7%B4%A2%E5%BC%95/%E5%9B%BE5-8.jpg" alt="插入70"></p>
<p><img src="/images/MySql%E7%B4%A2%E5%BC%95/%E5%9B%BE5-9.jpg" alt="插入95"></p>
<h4 id="旋转功能"><a href="#旋转功能" class="headerlink" title="旋转功能"></a><strong>旋转功能</strong></h4><p>why</p>
<p>​		为了保持平衡，对于新插入的键值可能需要做大量的拆分页（split）操作。因为B+树结构主要用于磁盘，所有应该再可能的情况下尽量减少页的拆分操作。</p>
<p>因此，B+树提供了类似与平衡二叉树的旋转功能。</p>
<p>how</p>
<p>​		旋转发生在Leaf Page已经满，但是其左右兄弟节点没有满的情况下。会先将记录移到所在页的兄弟节点上。</p>
<p>通常情况，做兄弟会被首先检查用来做旋转操作。</p>
<p>示例：</p>
<p><img src="/images/MySql%E7%B4%A2%E5%BC%95/%E5%9B%BE5-7.jpg" alt="准备插入70"></p>
<p><img src="/images/MySql%E7%B4%A2%E5%BC%95/B+tree%E7%9A%84%E6%97%8B%E8%BD%AC.jpg" alt="旋转后"></p>
<h3 id="2、删除操作"><a href="#2、删除操作" class="headerlink" title="2、删除操作"></a>2、删除操作</h3><p>​		B+树使用填充因子（fill factor）来控制树的删除变化，50%是填充因子可设的最小值。</p>
<table>
<thead>
<tr>
<th>叶子节点小于填充因子</th>
<th>中间节点小于填充因子</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>No</td>
<td>No</td>
<td>直接将记录从叶子节点删除，如果该节点还是Index Page的节点，用该节点的右节点代替</td>
</tr>
<tr>
<td>Yes</td>
<td>No</td>
<td>合并叶子节点和它的兄弟节点，同时更新Index Page</td>
</tr>
<tr>
<td>Yes</td>
<td>Yes</td>
<td>1）合并叶子节点和它的兄弟节点<br>2）更新Index Page<br>3）合并Index Page和它的兄弟节点</td>
</tr>
</tbody></table>
<p><img src="/images/MySql%E7%B4%A2%E5%BC%95/%E5%9B%BE5-11.jpg" alt="删除70"></p>
<p><img src="/images/MySql%E7%B4%A2%E5%BC%95/%E5%9B%BE5-12.jpg" alt="删除25"></p>
<p><img src="/images/MySql%E7%B4%A2%E5%BC%95/%E5%9B%BE5-13.jpg" alt="删除60"></p>
<h2 id="五、B-树索引"><a href="#五、B-树索引" class="headerlink" title="五、B+树索引"></a>五、B+树索引</h2><blockquote>
<p>数据库中的B+树索引可以分为<strong>聚集索引</strong>和<strong>辅助索引</strong>。</p>
</blockquote>
<p>聚集索引与辅助索引不同的是，叶子节点存放的是否是一整行的信息。</p>
<h3 id="1、聚集索引"><a href="#1、聚集索引" class="headerlink" title="1、聚集索引"></a>1、聚集索引</h3><p>​		聚集索引（clustered index）就是按照每张表的主键构造一棵B+树，同时叶子节点中存放的即为整张表的行记录数据，也将聚集索引的叶子节点称为数据页。聚集索引的这个特性决定了索引组织表中数据也是索引的一部分。</p>
<p>​		同B+树数据结构一样，每个数据页都通过一个<strong>双向链表</strong>进行链接。</p>
<p><strong>聚集索引的存储</strong></p>
<p>​		聚集索引的存储并不是物理上连续的，而是逻辑上连续的。其中有两点：</p>
<ul>
<li>1、页通过双向链表链接，页按照主键顺序排序</li>
<li>2、页中的记录通过双向链表进行维护的。物理存储上可以同样不按照主键存储。</li>
</ul>
<p>​		聚集索引的另一个好处是，对于主键的排序查找和范围查找速度非常快。</p>
<h3 id="2、辅助索引"><a href="#2、辅助索引" class="headerlink" title="2、辅助索引"></a>2、辅助索引</h3><p><strong>概念</strong></p>
<p>​		也称非聚集索引，叶子节点并不包含记录的全部数据。叶子节点除了包含键值外，索引行中还包含了一个书签（bookmark）。用来告诉InnoDB存储引擎那里可以找到与索引相对应的行数据。</p>
<p>​		由于InnoDB存储引擎表是索引组织表，因此InnoDB存储引擎的辅助索引的书签就是相应行数据的聚集索引键。</p>
<p><img src="/images/MySql%E7%B4%A2%E5%BC%95/%E5%9B%BE5-15.jpg" alt="辅助索引与聚集索引关系"></p>
<p>​		当通过辅助索引来寻找数据时，InnoDB存储引擎会遍历辅助索引并通过叶级别的指针获得指向主键索引的主键，然后通过主键索引找到一个完整的行记录。</p>
<h2 id="六、Cardinality值"><a href="#六、Cardinality值" class="headerlink" title="六、Cardinality值"></a>六、Cardinality值</h2><h3 id="1、什么是Cardinality"><a href="#1、什么是Cardinality" class="headerlink" title="1、什么是Cardinality"></a>1、什么是Cardinality</h3><p>一般的经验是，访问表中很少一部分时使用B+树索引才有意义。</p>
<ul>
<li><p>低选择性：对于性别、地区、类型，可取值的范围很小。</p>
</li>
<li><p>高选择性：如果某个字段的取值范围很广，几乎没有重复。</p>
</li>
</ul>
<blockquote>
<p>高选择性使用B+树索引最适合的。</p>
</blockquote>
<p><strong>如何查看索引是否是高选择性？</strong></p>
<p>通过<strong>SHOW INDEX</strong>结果中的列Cardinality来观察。</p>
<p>Cardinality表示索引中不重复记录数量的<strong>预估值</strong>。</p>
<p>实际应用中，Cardinality&#x2F;n_rows_in_table应尽可能地接近1.如果非常小，需要考虑是否有必要创建这个索引。</p>
<p>所以在访问高选择性属性地字段并从表中取出很少一部分数据时，对这个字段添加B+树索引非常有必要地。</p>
<h3 id="2、InnoDB存储引擎的Cardinality统计"><a href="#2、InnoDB存储引擎的Cardinality统计" class="headerlink" title="2、InnoDB存储引擎的Cardinality统计"></a>2、InnoDB存储引擎的Cardinality统计</h3><p>​		数据库对于Cardinality的统计是通过采样（Sample）的方法来完成的。</p>
<p>​		在InnoDB存储引擎中，Cardinality统计信息的更新发生在两个操作中：INSERT和UPDATE。</p>
<p>​		InnoDB存储引擎内部对更新Cardinality信息的策略为：</p>
<ul>
<li><p>表中1&#x2F;16的数据已发生过变化</p>
</li>
<li><p>stat_modeified_counter&gt;2 000 000 000</p>
<p>策略二表示，如果对表中某一行数据频繁地进行更新操作，表中数据实际并没有增加，实际发生变化地还是这一行数据，则第一种更新策略就无法适用这种情况。</p>
<p>故InnoDB存储引擎内部有一个计数器stat_modified_counter,用来表示变化次数，当stat_modified_counter大于2 000 000 000时，同样需要更新Cardinality信息。</p>
</li>
</ul>
<p><strong>采样过程</strong></p>
<p>默认InnoDB存储引擎对8个叶子节点（Leaf Page）进行采样。</p>
<ul>
<li>取得B+树索引中叶子节点的数量，记为A</li>
<li>随机取得B+树索引中的8个叶子节点。统计每个页不同记录的个数，记为P1，P2，。。。。，P8</li>
<li>根据采样信息给出Cardinality的预估值：Cardinality&#x3D;（P1+P2+…+P8）*A、8。</li>
</ul>
<h2 id="七、B-树索引的使用"><a href="#七、B-树索引的使用" class="headerlink" title="七、B+树索引的使用"></a>七、B+树索引的使用</h2><h3 id="1、不同应用中B-树索引的使用"><a href="#1、不同应用中B-树索引的使用" class="headerlink" title="1、不同应用中B+树索引的使用"></a>1、不同应用中B+树索引的使用</h3><p>OLTP（Online Transaction Processing在线事务处理）</p>
<ul>
<li>主要是对数据的增删改，侧重实时性</li>
<li>查询操作只从数据库中取得一小部分数据</li>
<li>这种情况下，B+树索引建立后，对该索引的使用只是通过该索引取得表中少部分数据，这时最有意义。</li>
</ul>
<p>OLAP（Online Analytical Processing在线分析处理）</p>
<ul>
<li>对数据的查询，侧重大数据量查询</li>
<li>需要访问表中大量数据，根据数据产生查询结果，这些查询多是面向分析的查询</li>
<li>索引的添加根据的应该是宏观的信息，而不是微观<strong>（具体怎么添加索引？）</strong></li>
</ul>
<h3 id="2、联合索引"><a href="#2、联合索引" class="headerlink" title="2、联合索引"></a>2、联合索引</h3><blockquote>
<p>对表上对各列进行索引</p>
</blockquote>
<p><img src="/images/MySql%E7%B4%A2%E5%BC%95/%E5%9B%BE5-22.png" alt="多个键值的B+树"></p>
<p>假定两个键值的名称分别为a、b</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">对于条件<span class="keyword">where</span> a<span class="operator">=</span> XX <span class="keyword">and</span> b<span class="operator">=</span> XX</span><br><span class="line">以及 <span class="keyword">where</span> a<span class="operator">=</span> XX 都是可用的</span><br><span class="line">但是 <span class="keyword">where</span> b<span class="operator">=</span> XX 不可用</span><br></pre></td></tr></table></figure>

<p>优势，已经对第二个键值进行了排序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">where</span> a<span class="operator">=</span>xx <span class="keyword">order</span> <span class="keyword">by</span> b可用</span><br></pre></td></tr></table></figure>

<h3 id="3、覆盖索引"><a href="#3、覆盖索引" class="headerlink" title="3、覆盖索引"></a>3、覆盖索引</h3><p>覆盖索引（overing index）</p>
<p>从辅助索引中就可以得到查询的记录，不需要查询聚集索引中的记录。</p>
<p>优势：</p>
<ul>
<li>由于覆盖索引是辅助索引不包含整行记录的索引信息，大小远小于聚集索引，减少IO操作。</li>
<li>对统计问题而言，由于bug_log表上有辅助索引，辅助索引远小于聚集索引，选择辅助索引可以减少IO操作，优化器自动选择辅助索引。（表现为possible_keys列为null，但实际使用了索引）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> bug_log</span><br></pre></td></tr></table></figure>

<p>联合索引</p>
<p>SQL查询是统计操作，并且可以利用到覆盖索引的信息，因此优化器会选择联合索引。</p>
<h3 id="4、优化器选择不使用索引的情况"><a href="#4、优化器选择不使用索引的情况" class="headerlink" title="4、优化器选择不使用索引的情况"></a>4、优化器选择不使用索引的情况</h3><p>对于不能进行索引覆盖的情况，优化器选择辅助索引的情况是，<strong>通过辅助索引查找的数据是少量的</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> orderdetails</span><br><span class="line"><span class="keyword">WHERE</span> orderid<span class="operator">&gt;</span><span class="number">10000</span> <span class="keyword">and</span> orderid<span class="operator">&lt;</span><span class="number">102000</span>;</span><br></pre></td></tr></table></figure>



<p>可使用FORCXE INDEX强制使用某个索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">FROM</span> orderdetails FORCE INDEX(OrderID)</span><br><span class="line"><span class="keyword">WHERE</span> orderid<span class="operator">&gt;</span><span class="number">10000</span> <span class="keyword">and</span> orderid<span class="operator">&lt;</span><span class="number">102000</span>;</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%B4%A2%E5%BC%95/" rel="tag">索引</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-学习方法"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/07/26/%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95/"
    >学习方法</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/07/26/%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95/" class="article-date">
  <time datetime="2022-07-26T02:29:00.000Z" itemprop="datePublished">2022-07-26</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95/">学习方法</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="学习思维What、why、how"><a href="#学习思维What、why、how" class="headerlink" title="学习思维What、why、how"></a>学习思维What、why、how</h1><h2 id="一、what"><a href="#一、what" class="headerlink" title="一、what"></a>一、what</h2><p>是什么</p>
<h2 id="二、Why"><a href="#二、Why" class="headerlink" title="二、Why"></a>二、Why</h2><p>为什么使用</p>
<h2 id="三、How"><a href="#三、How" class="headerlink" title="三、How"></a>三、How</h2><p>如何使用</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95/" rel="tag">学习方法</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-xxl-job学习"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/07/26/xxl-job%E5%AD%A6%E4%B9%A0/"
    >xxl-job学习笔记</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/07/26/xxl-job%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time datetime="2022-07-26T00:58:25.000Z" itemprop="datePublished">2022-07-26</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringCloud%E7%BB%84%E4%BB%B6/">SpringCloud组件</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="xxl-job"><a href="#xxl-job" class="headerlink" title="xxl-job"></a>xxl-job</h1><blockquote>
<p>官网：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a></p>
</blockquote>
<h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><h3 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h3><p>XXL-JOB是一个分布式任务调度平台</p>
<p>开发迅速、学习简单、轻量级、易扩展</p>
<h3 id="2、下载"><a href="#2、下载" class="headerlink" title="2、下载"></a>2、下载</h3><p><strong>源码仓库地址</strong></p>
<table>
<thead>
<tr>
<th>地址</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job">https://github.com/xuxueli/xxl-job</a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://gitee.com/xuxueli0323/xxl-job">http://gitee.com/xuxueli0323/xxl-job</a></td>
</tr>
</tbody></table>
<p><strong>中央仓库地址</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- http://repo1.maven.org/maven2/com/xuxueli/xxl-job-core/ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;最新稳定版本&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="二、快速入门"><a href="#二、快速入门" class="headerlink" title="二、快速入门"></a>二、快速入门</h2><h3 id="1、初始化调度数据库"><a href="#1、初始化调度数据库" class="headerlink" title="1、初始化调度数据库"></a>1、初始化调度数据库</h3><p>项目源码中，“调度数据库初始化SQL脚本” 位置为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/xxl-job/doc/db/tables_xxl_job.sql</span><br></pre></td></tr></table></figure>

<p>调度中心支持集群部署，集群情况下各节点务必连接同一个mysql实例;</p>
<p>如果mysql做主从,调度中心集群节点务必强制走主库;</p>
<h3 id="2、编译源码"><a href="#2、编译源码" class="headerlink" title="2、编译源码"></a>2、编译源码</h3><p>解压源码，导入IDE</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xxl-job-admin：调度中心</span><br><span class="line">xxl-job-core：公共依赖</span><br><span class="line">xxl-job-executor-samples：执行器Sample示例（选择合适的版本执行器，可直接使用，也可以参考其并将现有项目改造成执行器）</span><br><span class="line">    ：xxl-job-executor-sample-springboot：Springboot版本，通过Springboot管理执行器，推荐这种方式；</span><br><span class="line">    ：xxl-job-executor-sample-frameless：无框架版本；</span><br></pre></td></tr></table></figure>

<h3 id="3、配置部署“调度中心”"><a href="#3、配置部署“调度中心”" class="headerlink" title="3、配置部署“调度中心”"></a>3、配置部署“调度中心”</h3><p>调度中心项目:xxl-job-admin</p>
<p>作用：统一管理任务调度平台上调度任务，负责触发调度执行，并且提供任务管理平台。</p>
<h4 id="步骤一：调度中心配置"><a href="#步骤一：调度中心配置" class="headerlink" title="步骤一：调度中心配置"></a>步骤一：调度中心配置</h4><p>调度中心配置文件地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/xxl-job/xxl-job-admin/src/main/resources/application.properties</span><br></pre></td></tr></table></figure>

<p>内容说明:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 调度中心JDBC链接：链接地址请保持和创建的调度数据库的地址一致</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://127.0.0.1:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root_pwd</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="comment">### 报警邮箱</span></span><br><span class="line"><span class="attr">spring.mail.host</span>=<span class="string">smtp.qq.com</span></span><br><span class="line"><span class="attr">spring.mail.port</span>=<span class="string">25</span></span><br><span class="line"><span class="attr">spring.mail.username</span>=<span class="string">xxx@qq.com</span></span><br><span class="line"><span class="attr">spring.mail.password</span>=<span class="string">xxx</span></span><br><span class="line"><span class="attr">spring.mail.properties.mail.smtp.auth</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.mail.properties.mail.smtp.starttls.enable</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.mail.properties.mail.smtp.starttls.required</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.mail.properties.mail.smtp.socketFactory.class</span>=<span class="string">javax.net.ssl.SSLSocketFactory</span></span><br><span class="line"><span class="comment">### 调度中心通讯TOKEN [选填]：非空时启用；</span></span><br><span class="line"><span class="attr">xxl.job.accessToken</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 调度中心国际化配置 [必填]： 默认为 &quot;zh_CN&quot;/中文简体, 可选范围为 &quot;zh_CN&quot;/中文简体, &quot;zh_TC&quot;/中文繁体 and &quot;en&quot;/英文；</span></span><br><span class="line"><span class="attr">xxl.job.i18n</span>=<span class="string">zh_CN</span></span><br><span class="line"><span class="comment">## 调度线程池最大线程配置【必填】</span></span><br><span class="line"><span class="attr">xxl.job.triggerpool.fast.max</span>=<span class="string">200</span></span><br><span class="line"><span class="attr">xxl.job.triggerpool.slow.max</span>=<span class="string">100</span></span><br><span class="line"><span class="comment">### 调度中心日志表数据保存天数 [必填]：过期日志自动清理；限制大于等于7时生效，否则, 如-1，关闭自动清理功能；</span></span><br><span class="line"><span class="attr">xxl.job.logretentiondays</span>=<span class="string">30</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤二：部署项目"><a href="#步骤二：部署项目" class="headerlink" title="步骤二：部署项目"></a>步骤二：部署项目</h4><p>调度中心访问地址：<a target="_blank" rel="noopener" href="http://localhost:8080/xxl-job-admin%EF%BC%88%E6%89%A7%E8%A1%8C%E5%99%A8%E4%BC%9A%E4%BD%BF%E7%94%A8%E8%AF%A5%E5%9C%B0%E5%9D%80%E4%BD%9C%E4%B8%BA%E5%9B%9E%E8%B0%83%E5%9C%B0%E5%9D%80%EF%BC%89">http://localhost:8080/xxl-job-admin（执行器会使用该地址作为回调地址）</a></p>
<p>默认登录账号 “admin&#x2F;123456”</p>
<p><img src="/images/xxl-job%E5%AD%A6%E4%B9%A0/%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83%E9%A6%96%E9%A1%B5.png" alt="首页"></p>
<h4 id="步骤三：调度中心集群（可选）："><a href="#步骤三：调度中心集群（可选）：" class="headerlink" title="步骤三：调度中心集群（可选）："></a>步骤三：调度中心集群（可选）：</h4><p>调度中心支持集群部署，提升调度系统容灾和可用性。</p>
<p>调度中心集群部署时：</p>
<ul>
<li>DB配置保持一致</li>
<li>集群机器时钟保持一致（单机集群忽视）</li>
<li>建议：推荐通过nginx为调度中心集群做负载均衡，分配域名。调度中心访问、执行器回调配置、调用API服务等操作均通过改域名进行。</li>
</ul>
<h4 id="其他：Docker镜像方式搭建调度中心"><a href="#其他：Docker镜像方式搭建调度中心" class="headerlink" title="其他：Docker镜像方式搭建调度中心"></a>其他：Docker镜像方式搭建调度中心</h4><p>下载镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// Docker地址：https://hub.docker.com/r/xuxueli/xxl-job-admin/     (建议指定版本号)</span><br><span class="line">docker pull xuxueli/xxl-job-admin:&#123;指定版本&#125;</span><br></pre></td></tr></table></figure>

<p>创建容器并运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8080:8080 -v /tmp:/data/applogs --name xxl-job-admin  -d xuxueli/xxl-job-admin:&#123;指定版本&#125;</span><br><span class="line">/**</span><br><span class="line">* 如需自定义 mysql 等配置，可通过 &quot;-e PARAMS&quot; 指定，参数格式 PARAMS=&quot;--key=value  --key2=value2&quot; ；</span><br><span class="line">* 配置项参考文件：/xxl-job/xxl-job-admin/src/main/resources/application.properties</span><br><span class="line">* 如需自定义 JVM内存参数 等配置，可通过 &quot;-e JAVA_OPTS&quot; 指定，参数格式 JAVA_OPTS=&quot;-Xmx512m&quot; ；</span><br><span class="line">*/</span><br><span class="line">docker run -e PARAMS=&quot;--spring.datasource.url=jdbc:mysql://127.0.0.1:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai --spring.datasource.username=root --spring.datasource.password=123456&quot; -p 8080:8080 -v /tmp:/data/applogs --name xxl-job-admin  -d xuxueli/xxl-job-admin:&#123;指定版本&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">	如果数据库部署在容器中</span><br><span class="line">	--link &lt;name or id&gt;:alias</span><br><span class="line">	其中，name和id是源容器的name和id，alias是源容器在link下的别名。</span><br><span class="line">**/</span><br><span class="line">--link mysql:mysql</span><br></pre></td></tr></table></figure>

<h3 id="4、配置部署“执行器项目”"><a href="#4、配置部署“执行器项目”" class="headerlink" title="4、配置部署“执行器项目”"></a>4、配置部署“执行器项目”</h3><p>执行器：xxl-job-executor-sample-springboot;(可以参考，将现有项目改成执行器)</p>
<p>作用：负责接收“调度中心”的调度并执行；可直接部署执行器，也可以将执行器集成到现有业务项目中。</p>
<h4 id="步骤一：maven依赖"><a href="#步骤一：maven依赖" class="headerlink" title="步骤一：maven依赖"></a>步骤一：maven依赖</h4><p>确认pom文件中引入了 “xxl-job-core” 的maven依赖；</p>
<h4 id="步骤二：执行器配置"><a href="#步骤二：执行器配置" class="headerlink" title="步骤二：执行器配置"></a>步骤二：执行器配置</h4><p>执行器配置，配置文件地址：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/xxl-job/xxl-job-executor-samples/xxl-job-executor-sample-springboot/src/main/resources/application.properties</span><br></pre></td></tr></table></figure>

<p>执行器配置，配置内容说明：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 调度中心部署根地址 [选填]：如调度中心集群部署存在多个地址则用逗号分隔。执行器将会使用该地址进行&quot;执行器心跳注册&quot;和&quot;任务结果回调&quot;；为空则关闭自动注册；</span></span><br><span class="line"><span class="attr">xxl.job.admin.addresses</span>=<span class="string">http://127.0.0.1:8080/xxl-job-admin</span></span><br><span class="line"><span class="comment">### 执行器通讯TOKEN [选填]：非空时启用；</span></span><br><span class="line"><span class="attr">xxl.job.accessToken</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 执行器AppName [选填]：执行器心跳注册分组依据；为空则关闭自动注册</span></span><br><span class="line"><span class="attr">xxl.job.executor.appname</span>=<span class="string">xxl-job-executor-sample</span></span><br><span class="line"><span class="comment">### 执行器注册 [选填]：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。从而更灵活的支持容器类型执行器动态IP和动态映射端口问题。</span></span><br><span class="line"><span class="attr">xxl.job.executor.address</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 执行器IP [选填]：默认为空表示自动获取IP，多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯实用；地址信息用于 &quot;执行器注册&quot; 和 &quot;调度中心请求并触发任务&quot;；</span></span><br><span class="line"><span class="attr">xxl.job.executor.ip</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 执行器端口号 [选填]：小于等于0则自动获取；默认端口为9999，单机部署多个执行器时，注意要配置不同执行器端口；</span></span><br><span class="line"><span class="attr">xxl.job.executor.port</span>=<span class="string">9999</span></span><br><span class="line"><span class="comment">### 执行器运行日志文件存储磁盘路径 [选填] ：需要对该路径拥有读写权限；为空则使用默认路径；</span></span><br><span class="line"><span class="attr">xxl.job.executor.logpath</span>=<span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line"><span class="comment">### 执行器日志文件保存天数 [选填] ： 过期日志自动清理, 限制值大于等于3时生效; 否则, 如-1, 关闭自动清理功能；</span></span><br><span class="line"><span class="attr">xxl.job.executor.logretentiondays</span>=<span class="string">30</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤三：执行器组件配置"><a href="#步骤三：执行器组件配置" class="headerlink" title="步骤三：执行器组件配置"></a>步骤三：执行器组件配置</h4><p>执行器组件，配置文件地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/xxl-job/xxl-job-executor-samples/xxl-job-executor-sample-springboot/src/main/java/com/xxl/job/executor/core/config/XxlJobConfig.java</span><br></pre></td></tr></table></figure>

<p>配置内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> XxlJobSpringExecutor <span class="title function_">xxlJobExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);</span><br><span class="line">    <span class="type">XxlJobSpringExecutor</span> <span class="variable">xxlJobSpringExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobSpringExecutor</span>();</span><br><span class="line">    xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">    xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">    xxlJobSpringExecutor.setIp(ip);</span><br><span class="line">    xxlJobSpringExecutor.setPort(port);</span><br><span class="line">    xxlJobSpringExecutor.setAccessToken(accessToken);</span><br><span class="line">    xxlJobSpringExecutor.setLogPath(logPath);</span><br><span class="line">    xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br><span class="line">    <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>jobHandler，具体任务内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * XxlJob开发示例（Bean模式）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 开发步骤：</span></span><br><span class="line"><span class="comment"> *      1、任务开发：在Spring Bean实例中，开发Job方法；</span></span><br><span class="line"><span class="comment"> *      2、注解配置：为Job方法添加注解 &quot;<span class="doctag">@XxlJob</span>(value=&quot;自定义jobhandler名称&quot;, init = &quot;JobHandler初始化方法&quot;, destroy = &quot;JobHandler销毁方法&quot;)&quot;，注解value值对应的是调度中心新建任务的JobHandler属性的值。</span></span><br><span class="line"><span class="comment"> *      3、执行日志：需要通过 &quot;XxlJobHelper.log&quot; 打印执行日志；</span></span><br><span class="line"><span class="comment"> *      4、任务结果：默认任务结果为 &quot;成功&quot; 状态，不需要主动设置；如有诉求，比如设置任务结果为失败，可以通过 &quot;XxlJobHelper.handleFail/handleSuccess&quot; 自主设置任务结果；</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xuxueli 2019-12-11 21:52:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SampleXxlJob</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(SampleXxlJob.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、简单任务示例（Bean模式）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;demoJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demoJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        XxlJobHelper.log(<span class="string">&quot;XXL-JOB, Hello World.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            XxlJobHelper.log(<span class="string">&quot;beat at:&quot;</span> + i);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// default success</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="步骤四：部署执行器项目"><a href="#步骤四：部署执行器项目" class="headerlink" title="步骤四：部署执行器项目"></a>步骤四：部署执行器项目</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xxl-job-executor-sample-springboot：项目编译打包成springboot类型的可执行JAR包，命令启动即可；</span><br><span class="line">xxl-job-executor-sample-frameless：项目编译打包成JAR包，命令启动即可；</span><br></pre></td></tr></table></figure>

<h4 id="步骤五：执行器集群（可选）"><a href="#步骤五：执行器集群（可选）" class="headerlink" title="步骤五：执行器集群（可选）"></a>步骤五：执行器集群（可选）</h4><p>执行器支持集群部署，提升调度系统可用性，同时提升任务处理能力。</p>
<p>执行器集群部署时，几点要求和建议：</p>
<ul>
<li>执行器回调地址（xxl.job.admin.addresses）需要保持一致；执行器根据该配置进行执行器自动注册等操作。</li>
<li>同一个执行器集群内AppName（xxl.job.executor.appname）需要保持一致；调度中心根据该配置动态发现不同集群的在线执行器列表。</li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringCloud%E7%BB%84%E4%BB%B6/" rel="tag">SpringCloud组件</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/" rel="tag">分布式任务调度</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-Sleuth+Zipkin链路追踪"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/07/22/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/"
    >Sleuth+Zipkin链路追踪</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/07/22/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/" class="article-date">
  <time datetime="2022-07-22T09:04:25.000Z" itemprop="datePublished">2022-07-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringCloud/">SpringCloud</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="Sleuth-Zipkin"><a href="#Sleuth-Zipkin" class="headerlink" title="Sleuth+Zipkin"></a>Sleuth+Zipkin</h1><h2 id="一、什么是链路追踪"><a href="#一、什么是链路追踪" class="headerlink" title="一、什么是链路追踪"></a>一、什么是链路追踪</h2><blockquote>
<p>指一次任务的开始到结束，期间调用的所有系统及耗时（时间跨度）都可以完整记录下来</p>
</blockquote>
<h2 id="二、什么是Sleuth"><a href="#二、什么是Sleuth" class="headerlink" title="二、什么是Sleuth"></a>二、什么是Sleuth</h2><p>Spring Cloud Sleuth为SpringCloud实现了分布式跟踪解决方案。兼容Zipkin，HTrace和其他基于日志的追踪系统，例如ELK（Elasticsearch、LogStash、Kibana）。</p>
<p>Spring Cloud Sleuth提供了以下功能</p>
<ul>
<li>链路追踪：通过Sleuth可以很清楚看出一个请求经过了哪些服务，可以很方便的理清服务间的调用关系等。</li>
<li>性能分析：观察每个采样请求的耗时，可分析哪些服务调用比较耗时。当服务调用的耗时随着请求量的增大而增大时，可以对服务的扩容提供一定的提醒。</li>
<li>数据分析，优化链路：对于频繁调用一个服务，或并行调用等，可以针对业务进行优化。</li>
<li>可视化错误：对于程序未捕获的异常，可以配合Zipkin查看。</li>
</ul>
<h2 id="三、专业术语"><a href="#三、专业术语" class="headerlink" title="三、专业术语"></a>三、专业术语</h2><h3 id="Span"><a href="#Span" class="headerlink" title="Span"></a>Span</h3><p>基本工作单位，一次请求称为一个Span，Dapper记录的是Span的名称，以及每个Span的ID和父ID，以重建在一次追踪过程中不同Span之间的关系。</p>
<p>图中一个矩形框为一个Span。</p>
<p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/1.webp" alt="请求"></p>
<blockquote>
<p>开始追踪的初始跨度成为root span。</p>
</blockquote>
<p>Dapper记录了span名称，以及每个span的ID和父span ID，以重建在一次追踪过程中不同span之间的关系。如果一个span没有父ID被称为root span。所有span都挂在一个特定的Trace上，也共用一个trace id。</p>
<p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/2.webp" alt="请求"></p>
<h3 id="Trace"><a href="#Trace" class="headerlink" title="Trace"></a>Trace</h3><p>一系列Span组成的树状结构，一个Trace认为是一次完整的链路，内部包含n多个Span。Trace和Span存在一对多关系，Span与Span存在父子关系。</p>
<p>举个例子：客户端调用服务A、服务B、服务C、服务F，而每个服务例如C就是一个Span，如果在服务C中另启现场调用D，D为C的子Span，如果在服务D中另起线程调用了E，那么E就是D的子Span，C-&gt;D-&gt;E的链路是一条Trace。</p>
<p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/3.webp" alt="Trace"></p>
<h3 id="Annotation"><a href="#Annotation" class="headerlink" title="Annotation"></a>Annotation</h3><p>用来及时记录一个事件的存在，一些核心annotations用来定义一个请求的开始和结束。</p>
<ul>
<li>cs-Client Sent:客户端发起一个请求，描述span开始</li>
<li>sr-Server Received:服务端获得请求并准备开始处理它，如果sr减去cs时间戳便可得到网络延迟。</li>
<li>ss-Server Sent:请求处理完成（当请求返回客户端），如果ss减去sr时间戳便可得到服务端处理请求需要的时间。</li>
<li>cr-Client Received:表示span结束，客户端成功接收到服务端的回复，如果cr减去cs时间戳便可得到客户端从服务端获取回复的所有所需时间。</li>
</ul>
<h2 id="四、实现原理"><a href="#四、实现原理" class="headerlink" title="四、实现原理"></a>四、实现原理</h2><p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/4.webp" alt="调用链"></p>
<p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/5.webp" alt="增加标识spanid"></p>
<p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/6.webp" alt="请求唯一表示traceid"></p>
<p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/7.webp" alt="问：无法分辨层级顺序"></p>
<p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/8.webp" alt="调用方标识parentid"></p>
<p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/9.webp" alt="时间戳timestamp"></p>
<p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/10.webp" alt="返回时间戳timestamp"></p>
<p>如何计算网络延迟？</p>
<ul>
<li>Client Sent 简称 cs，客户端发起调用请求到服务端。</li>
<li>Server Received 简称 sr，指服务端接收到了客户端的调用请求。</li>
<li>Server Sent 简称 ss，指服务端完成了处理，准备将信息返给客户端。</li>
<li>Client Received 简称 cr，指客户端接收到了服务端的返回信息。</li>
</ul>
<p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/11.webp" alt="计算耗时"></p>
<p>其实 span 内除了记录这几个参数之外，还可以记录一些其他信息，比如发起调用服务名称、被调服务名称、返回结果、IP、调用服务的名称等，最后，我们再把相同 parentid 的 span 信息合成一个大的 span 块，就完成了一个完整的调用链。</p>
<h2 id="五、实操"><a href="#五、实操" class="headerlink" title="五、实操"></a>五、实操</h2><h3 id="1、添加依赖"><a href="#1、添加依赖" class="headerlink" title="1、添加依赖"></a>1、添加依赖</h3><p>在需要进行链路追踪的项目中（服务网关、商品服务、订单服务）添加spring-cloud-starter-sleuth依赖。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;!--</span> <span class="string">spring</span> <span class="string">cloud</span> <span class="string">sleuth</span> <span class="string">依赖</span> <span class="string">--&gt;</span></span><br><span class="line"><span class="string">&lt;dependency&gt;</span></span><br><span class="line">    <span class="string">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line">    <span class="string">&lt;artifactId&gt;spring-cloud-starter-sleuth&lt;/artifactId&gt;</span></span><br><span class="line"><span class="string">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2、记录日志"><a href="#2、记录日志" class="headerlink" title="2、记录日志"></a>2、记录日志</h3><p>在需要进行链路追踪的项目中添加logback.xml日志文件，内容如下（logback日志的输出级别需要是DEBUG级别）：</p>
<p>注意修改&lt;property  name&#x3D;”log.path” value&#x3D;”${catalina.base}&#x2F;gateway-server&#x2F;logs”&#x2F;&gt;中项目名。</p>
<p>日志核心配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [$&#123;applicationName&#125;,%X&#123;X-B3-TraceId:-&#125;,%X&#123;X-B3-SpanId:-&#125;] [%thread] %-5level %logger&#123;50&#125; - %msg%n</span><br></pre></td></tr></table></figure>



<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 日志级别从低到高分为TRACE &lt; DEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATAL，如果设置为WARN，则低于WARN的信息都不会输出 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- scan: 当此属性设置为true时，配置文件如果发生改变，将会被重新加载，默认值为true --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- scanPeriod: 设置监测配置文件是否有修改的时间间隔，如果没有给出时间单位，默认单位是毫秒。当scan为true时，此属性生效。默认的时间间隔为1分钟。 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- de<span class="doctag">bug:</span> 当此属性设置为true时，将打印出logback内部日志信息，实时查看logback运行状态。默认值为false。 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">scan</span>=<span class="string">&quot;true&quot;</span> <span class="attr">scanPeriod</span>=<span class="string">&quot;10 seconds&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 日志上下文名称 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">contextName</span>&gt;</span>my_logback<span class="tag">&lt;/<span class="name">contextName</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- name的值是变量的名称，value的值是变量定义的值。通过定义的值会被插入到logger上下文中。定义变量后，可以使“$&#123;&#125;”来使用变量。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;log.path&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;catalina.base&#125;/gateway-server/logs&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 加载 Spring 配置文件信息 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">springProperty</span> <span class="attr">scope</span>=<span class="string">&quot;context&quot;</span> <span class="attr">name</span>=<span class="string">&quot;applicationName&quot;</span> <span class="attr">source</span>=<span class="string">&quot;spring.application.name&quot;</span> <span class="attr">defaultValue</span>=<span class="string">&quot;localhost&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 日志输出格式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;LOG_PATTERN&quot;</span> <span class="attr">value</span>=<span class="string">&quot;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [$&#123;applicationName&#125;,%X&#123;X-B3-TraceId:-&#125;,%X&#123;X-B3-SpanId:-&#125;] [%thread] %-5level %logger&#123;50&#125; - %msg%n&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--输出到控制台--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;CONSOLE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--此日志appender是为开发使用，只配置最底级别，控制台输出的日志级别是大于或等于此级别的日志信息--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.ThresholdFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>DEBUG<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 设置字符集 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 输出到文件 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 时间滚动输出 level为 DEBUG 日志 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;DEBUG_FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 正在记录的日志文件的路径及文件名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;log.path&#125;/log_debug.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文件输出格式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span> <span class="comment">&lt;!-- 设置字符集 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 日志归档 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/debug/log-debug-%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文件保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>15<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 此日志文件只记录debug级别的 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>DEBUG<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 时间滚动输出 level为 INFO 日志 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;INFO_FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 正在记录的日志文件的路径及文件名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;log.path&#125;/log_info.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文件输出格式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 每天日志归档路径以及格式 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/info/log-info-%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文件保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>15<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 此日志文件只记录info级别的 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>INFO<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 时间滚动输出 level为 WARN 日志 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;WARN_FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 正在记录的日志文件的路径及文件名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;log.path&#125;/log_warn.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文件输出格式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span> <span class="comment">&lt;!-- 此处设置字符集 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/warn/log-warn-%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 每个日志文件最大100MB --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文件保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>15<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 此日志文件只记录warn级别的 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>WARN<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 时间滚动输出 level为 ERROR 日志 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;ERROR_FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 正在记录的日志文件的路径及文件名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;log.path&#125;/log_error.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文件输出格式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span> <span class="comment">&lt;!-- 此处设置字符集 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/error/log-error-%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文件保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>15<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 日志量最大 10 GB --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">totalSizeCap</span>&gt;</span>10GB<span class="tag">&lt;/<span class="name">totalSizeCap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 此日志文件只记录ERROR级别的 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 对于类路径以 com.example.logback 开头的Logger,输出级别设置为warn,并且只输出到控制台 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 这个logger没有指定appender，它会继承root节点中定义的那些appender --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;logger name=&quot;com.example.logback&quot; level=&quot;warn&quot;/&gt; --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--通过 LoggerFactory.getLogger(&quot;myLog&quot;) 可以获取到这个logger--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--由于这个logger自动继承了root的appender，root中已经有stdout的appender了，自己这边又引入了stdout的appender--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--如果没有设置 additivity=&quot;false&quot; ,就会导致一条日志在控制台输出两次的情况--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--additivity表示要不要使用rootLogger配置的appender进行输出--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;myLog&quot;</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span> <span class="attr">additivity</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;CONSOLE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 日志输出级别及方式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;CONSOLE&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;DEBUG_FILE&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;INFO_FILE&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;WARN_FILE&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;ERROR_FILE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3、访问"><a href="#3、访问" class="headerlink" title="3、访问"></a>3、访问</h3><p>访问项目链接，得到日志打印结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[order-service,95aa725089b757f8,f4ee41a6dcf08717]</span><br></pre></td></tr></table></figure>

<p>通过打印信息可以得知，整个链路的 traceId 为：95aa725089b757f8，spanId 为：e494e064842ce4e8 和 f4ee41a6dcf08717。</p>
<h2 id="六、使用-Zipkin-进行链路跟踪"><a href="#六、使用-Zipkin-进行链路跟踪" class="headerlink" title="六、使用 Zipkin 进行链路跟踪"></a>六、使用 Zipkin 进行链路跟踪</h2><h3 id="1、什么是Zipkin"><a href="#1、什么是Zipkin" class="headerlink" title="1、什么是Zipkin"></a>1、什么是Zipkin</h3><p>​		Zipkin是Twitter公司开发贡献的一款开源的分布式实时数据追踪系统（Distributed Tracking System），基于Google Dapper的论文设计而来，其主要功能是聚集各个异构系统的实时监控数据。</p>
<p>​		它可以收集各个服务器上请求链路的跟踪数据，并通过Rest API接口来辅助我们查询跟踪数据，实现对分布式系统的实时监控，及时发现系统中出现的延迟升高问题并找出系统性能瓶颈的根源。除了面向开发的API接口之外，它还提供了方便的UI组件，每个服务向Zipkin报告计时数据，Zipkin会根据调用关系生成依赖关系图，帮助我们直观的搜索跟踪信息和分析请求链路明细。Zipkin提供了可插拔数据存储方式：In-Memory、MySql、Cassandra以及Elasticsearch。</p>
<p>分布式跟踪系统还有其他比较成熟的实现，例如：Naver 的 PinPoint、Apache 的 HTrace、阿里的鹰眼 Tracing、京东的 Hydra、新浪的 Watchman，美团点评的 CAT，Apache 的 SkyWalking 等。</p>
<p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/12.webp" alt="Zipkin"></p>
<h3 id="2、工作原理"><a href="#2、工作原理" class="headerlink" title="2、工作原理"></a>2、工作原理</h3><p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/13.webp" alt="工作原理"></p>
<p>共有四个组件构成Zipkin：</p>
<ul>
<li>Collector：收集器组件，处理从外部系统发送过来的跟踪信息，将这些信息转换为Zipkin内部处理的Span格式，以支持后续的存储、分析、展示等功能。</li>
<li>Storage：存储组件，处理收集器接收到的跟踪信息，默认将信息存储在内存中，可以修改存储策略使用其他存储组件，支持MySQL，Elasticsearch等。</li>
<li>Web UI：UI组件，基于API组件实现的上层应用，提供Web页面，用来展示Zipkin中的调用链和系统依赖关系等。</li>
<li>RESTful API：API组件，为Web界面提供查询存储中数据的接口。</li>
</ul>
<p>Zipkin分为两端，一个Zipkin服务端，一个是Zipkin客户端，客户端也就是微服务的应用，客户端回配置服务端的URL地址，一旦发生服务间的调用时，会被配置在微服务里的Sleuth的监听器监听，并生成相应的Trace和Span信息发送给服务端。发送的方式有两种，一种是消息总线的方式如RabbitMQ发送，还有一种是HTTP报文的方式发送。</p>
<h3 id="3、服务端部署"><a href="#3、服务端部署" class="headerlink" title="3、服务端部署"></a>3、服务端部署</h3><p>服务端是一个独立的可执行的jar包，官方下载地址：<a target="_blank" rel="noopener" href="https://search.maven.org/remote_content?g=io.zipkin&amp;a=zipkin-server&amp;v=LATEST&amp;c=exec%EF%BC%8C">https://search.maven.org/remote_content?g=io.zipkin&amp;a=zipkin-server&amp;v=LATEST&amp;c=exec，</a></p>
<p>使用java -jar zipkin.jar命令启动，端口默认为9411。</p>
<p>我们下载的jar包为： zipkin-server-2.23.18-exec.jar，启动命令如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar zipkin-server-<span class="number">2.20</span><span class="number">.1</span>-exec.jar</span><br></pre></td></tr></table></figure>

<p>访问：<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=sNLi3f42oHgjTRHVdyZygA==.1A8iamJraEKLOUvTRuKMLir9F/vf+vS1f5BdjKsJ3Dg=">http://localhost:9411/</a> 结果如下：</p>
<p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/14.webp" alt="工作原理"></p>
<h3 id="4、客户端部署"><a href="#4、客户端部署" class="headerlink" title="4、客户端部署"></a>4、客户端部署</h3><h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><p>在需要进行链路追踪的项目中（服务网关、商品服务、订单服务）添加 spring-cloud-starter-zipkin 依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- spring cloud zipkin 依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>在需要进行链路追踪的项目中（服务网关、商品服务、订单服务）配置Zipkin服务端地址及数据传输方式。默认即如下配置。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  zipkin:</span><br><span class="line">    base-url: http://localhost:9411/ # 服务端地址</span><br><span class="line">    sender:</span><br><span class="line">      type: web                      # 数据传输方式，web 表示以 HTTP 报文的形式向服务端发送数据</span><br><span class="line">  sleuth:</span><br><span class="line">    sampler:</span><br><span class="line">      probability: 1.0               # 收集数据百分比，默认 0.1（10%）</span><br></pre></td></tr></table></figure>

<h4 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h4><p>访问：<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=NiINZULRaEEEPCpSpKh9LA==.WveUv7aWuQTmc+ukxCGhRtnpfHsyV/zaOTVljc/AWHo=">http://localhost:9411/</a> 根据时间过滤点击搜索结果如下：</p>
<p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/15.webp" alt="页面"></p>
<p>点击对应的追踪信息可查看请求链路详细。</p>
<p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/16.webp" alt="链路详情"></p>
<p>通过依赖可以查看链路中服务的依赖关系。</p>
<p><img src="/images/Sleuth+Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/17.webp" alt="依赖"></p>
<p>Zipkin Server默认存储追踪数据至内存中（容易丢失数据，一旦服务停止，数据会消失）。Zipkin支持修改存储策略是用其他存储组件，支持MySQL，Elasticsearch等。</p>
<h3 id="5、指定mysql启动"><a href="#5、指定mysql启动" class="headerlink" title="5、指定mysql启动"></a>5、指定mysql启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java -jar zipkin.jar </span><br><span class="line"></span><br><span class="line">--zipkin.storage.type=mysql</span><br><span class="line"></span><br><span class="line">--zipkin.storage.mysql.host=127.0.0.1</span><br><span class="line"></span><br><span class="line">--zipkin.storage.mysql.port=3306</span><br><span class="line"></span><br><span class="line">--zipkin.storage.mysql.username=root</span><br><span class="line"></span><br><span class="line">--zipkin.storage.mysql.password=123456</span><br><span class="line"></span><br><span class="line">--zipkin.storage.mysql.db=zipkin</span><br></pre></td></tr></table></figure>



<h4 id="（1）创建zipkin数据库"><a href="#（1）创建zipkin数据库" class="headerlink" title="（1）创建zipkin数据库"></a>（1）创建zipkin数据库</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE IF NOT EXISTS zipkin_spans (</span><br><span class="line">  `trace_id_high` BIGINT NOT NULL DEFAULT 0 COMMENT &#x27;If non zero, this means the trace uses 128 bit traceIds instead of 64 bit&#x27;,</span><br><span class="line">  `trace_id` BIGINT NOT NULL,</span><br><span class="line">  `id` BIGINT NOT NULL,</span><br><span class="line">  `name` VARCHAR(255) NOT NULL,</span><br><span class="line">  `remote_service_name` VARCHAR(255),</span><br><span class="line">  `parent_id` BIGINT,</span><br><span class="line">  `debug` BIT(1),</span><br><span class="line">  `start_ts` BIGINT COMMENT &#x27;Span.timestamp(): epoch micros used for endTs query and to implement TTL&#x27;,</span><br><span class="line">  `duration` BIGINT COMMENT &#x27;Span.duration(): micros used for minDuration and maxDuration query&#x27;,</span><br><span class="line">  PRIMARY KEY (`trace_id_high`, `trace_id`, `id`)</span><br><span class="line">) ENGINE=InnoDB ROW_FORMAT=COMPRESSED CHARACTER SET=utf8 COLLATE utf8_general_ci;</span><br><span class="line"></span><br><span class="line">ALTER TABLE zipkin_spans ADD INDEX(`trace_id_high`, `trace_id`) COMMENT &#x27;for getTracesByIds&#x27;;</span><br><span class="line">ALTER TABLE zipkin_spans ADD INDEX(`name`) COMMENT &#x27;for getTraces and getSpanNames&#x27;;</span><br><span class="line">ALTER TABLE zipkin_spans ADD INDEX(`remote_service_name`) COMMENT &#x27;for getTraces and getRemoteServiceNames&#x27;;</span><br><span class="line">ALTER TABLE zipkin_spans ADD INDEX(`start_ts`) COMMENT &#x27;for getTraces ordering and range&#x27;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE IF NOT EXISTS zipkin_annotations (</span><br><span class="line">  `trace_id_high` BIGINT NOT NULL DEFAULT 0 COMMENT &#x27;If non zero, this means the trace uses 128 bit traceIds instead of 64 bit&#x27;,</span><br><span class="line">  `trace_id` BIGINT NOT NULL COMMENT &#x27;coincides with zipkin_spans.trace_id&#x27;,</span><br><span class="line">  `span_id` BIGINT NOT NULL COMMENT &#x27;coincides with zipkin_spans.id&#x27;,</span><br><span class="line">  `a_key` VARCHAR(255) NOT NULL COMMENT &#x27;BinaryAnnotation.key or Annotation.value if type == -1&#x27;,</span><br><span class="line">  `a_value` BLOB COMMENT &#x27;BinaryAnnotation.value(), which must be smaller than 64KB&#x27;,</span><br><span class="line">  `a_type` INT NOT NULL COMMENT &#x27;BinaryAnnotation.type() or -1 if Annotation&#x27;,</span><br><span class="line">  `a_timestamp` BIGINT COMMENT &#x27;Used to implement TTL; Annotation.timestamp or zipkin_spans.timestamp&#x27;,</span><br><span class="line">  `endpoint_ipv4` INT COMMENT &#x27;Null when Binary/Annotation.endpoint is null&#x27;,</span><br><span class="line">  `endpoint_ipv6` BINARY(16) COMMENT &#x27;Null when Binary/Annotation.endpoint is null, or no IPv6 address&#x27;,</span><br><span class="line">  `endpoint_port` SMALLINT COMMENT &#x27;Null when Binary/Annotation.endpoint is null&#x27;,</span><br><span class="line">  `endpoint_service_name` VARCHAR(255) COMMENT &#x27;Null when Binary/Annotation.endpoint is null&#x27;</span><br><span class="line">) ENGINE=InnoDB ROW_FORMAT=COMPRESSED CHARACTER SET=utf8 COLLATE utf8_general_ci;</span><br><span class="line"></span><br><span class="line">ALTER TABLE zipkin_annotations ADD UNIQUE KEY(`trace_id_high`, `trace_id`, `span_id`, `a_key`, `a_timestamp`) COMMENT &#x27;Ignore insert on duplicate&#x27;;</span><br><span class="line">ALTER TABLE zipkin_annotations ADD INDEX(`trace_id_high`, `trace_id`, `span_id`) COMMENT &#x27;for joining with zipkin_spans&#x27;;</span><br><span class="line">ALTER TABLE zipkin_annotations ADD INDEX(`trace_id_high`, `trace_id`) COMMENT &#x27;for getTraces/ByIds&#x27;;</span><br><span class="line">ALTER TABLE zipkin_annotations ADD INDEX(`endpoint_service_name`) COMMENT &#x27;for getTraces and getServiceNames&#x27;;</span><br><span class="line">ALTER TABLE zipkin_annotations ADD INDEX(`a_type`) COMMENT &#x27;for getTraces and autocomplete values&#x27;;</span><br><span class="line">ALTER TABLE zipkin_annotations ADD INDEX(`a_key`) COMMENT &#x27;for getTraces and autocomplete values&#x27;;</span><br><span class="line">ALTER TABLE zipkin_annotations ADD INDEX(`trace_id`, `span_id`, `a_key`) COMMENT &#x27;for dependencies job&#x27;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE IF NOT EXISTS zipkin_dependencies (</span><br><span class="line">  `day` DATE NOT NULL,</span><br><span class="line">  `parent` VARCHAR(255) NOT NULL,</span><br><span class="line">  `child` VARCHAR(255) NOT NULL,</span><br><span class="line">  `call_count` BIGINT,</span><br><span class="line">  `error_count` BIGINT,</span><br><span class="line">  PRIMARY KEY (`day`, `parent`, `child`)</span><br><span class="line">) ENGINE=InnoDB ROW_FORMAT=COMPRESSED CHARACTER SET=utf8 COLLATE utf8_general_ci;</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Sleuth/" rel="tag">Sleuth</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Zipkin/" rel="tag">Zipkin</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/" rel="tag">链路追踪</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-SpringBoot(私教)"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/07/18/SpringBoot(%E7%A7%81%E6%95%99)/"
    >SpringBoot</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/07/18/SpringBoot(%E7%A7%81%E6%95%99)/" class="article-date">
  <time datetime="2022-07-18T01:30:24.519Z" itemprop="datePublished">2022-07-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringBoot/">SpringBoot</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="一、基本介绍"><a href="#一、基本介绍" class="headerlink" title="一、基本介绍"></a>一、基本介绍</h1><h2 id="1、什么是SpringBoot"><a href="#1、什么是SpringBoot" class="headerlink" title="1、什么是SpringBoot"></a>1、什么是SpringBoot</h2><p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-boot">https://spring.io/projects/spring-boot</a></p>
<h2 id="2、核心思想-约定优于配置"><a href="#2、核心思想-约定优于配置" class="headerlink" title="2、核心思想-约定优于配置"></a>2、核心思想-约定优于配置</h2><p><strong>What</strong>:</p>
<p>​	约定优于配置，又称按约定编程。一种软件设计规范。</p>
<p>​	本质上对系统、类库或框架中一些东西假定一个大众化合理的默认值（缺省值）。</p>
<p>​	加入所期待的配置与约定配置一致，可以不做任何配置，约定不符合期待时才需要对约定进行替换配置。</p>
<p><strong>Why</strong>:</p>
<p>​	大大减少了配置项</p>
<p><strong>How</strong>:</p>
<ul>
<li><p>起步依赖</p>
<p>如果没有需要特定依赖版本，可以使用spring-boot管理好的依赖减少配置</p>
</li>
<li><p>自动配置</p>
<p>按照spring的约定，存在某些条件的情况下自动配置bean到容器内。比如RedisAutoConfiguration在容器中不存在RedisTemplate的时候注入该bean。</p>
</li>
</ul>
<h2 id="3、SpringBoot的优势"><a href="#3、SpringBoot的优势" class="headerlink" title="3、SpringBoot的优势"></a>3、SpringBoot的优势</h2><ul>
<li>一键启动，极大的降低了构架应用的门槛</li>
<li>直接内嵌tomcat，jetty，undertow，无需打成war包</li>
<li>提供了starter机制简化构建配置</li>
<li>提供了健康检查，监控等能力</li>
<li><strong>自动配置</strong> 自动配置满足条件的spring和第三方依赖，不在大量依赖xml配置</li>
<li><strong>起步依赖</strong> 将具备某种功能的坐标打包到一起，并提供一些默认的功能，避免各种依赖冲突问题</li>
</ul>
<h1 id="二、常用功能"><a href="#二、常用功能" class="headerlink" title="二、常用功能"></a>二、常用功能</h1><h2 id="1、配置文件"><a href="#1、配置文件" class="headerlink" title="1、配置文件"></a>1、配置文件</h2><ul>
<li><strong>加载路径优先级</strong></li>
</ul>
<p>全局配置文件能够对一些默认配置值进行修改及自定义配置</p>
<p>Spring Boot使用一个application.properties或者application.yaml的文件作为全局配置文件</p>
<p>查找配置文件的路径如下图</p>
<p><img src="/images/SpringBootS_1.jpg" alt="配置路径"></p>
<p>①先去项目根目录找config文件夹下找配置文件</p>
<p>②再去根目录下找配置文件</p>
<p>③去resources下找config文件夹下找配置文件</p>
<p>④去resources下找配置文件</p>
<p>⑤相同配置序号低的配置会覆盖低的，即读取第一个读到的</p>
<p>⑥不同配置取并集</p>
<p>⑦有profile优先profile</p>
<ul>
<li><strong>加载类型优先级</strong></li>
</ul>
<p>SpringBoot2.4改进了处理application.properties和application.yml配置文件的方式</p>
<p>2.4.0之前版本，优先级properties&gt;yaml</p>
<p>2.4.0，优先级yaml&gt;properties</p>
<p>如果想继续使用SpringBoot2.3配置逻辑，可以通过在application.properties或者application.yaml配置文件中添加</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.config.use-legacy-processing</span> = <span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>Tips:强烈不建议同时使用两种类型的配置，每次阅读配置需要辨别，容易产生Bug</p>
<ul>
<li><p>properties配置</p>
<p>java特有配置格式，可以理解为Map&lt;String,String&gt;的kv结构</p>
</li>
<li><p>yml配置（推荐使用）</p>
<p>YAML是Spring Boot支持的一种JSON超集文件格式，以数据为中心</p>
<p>比如properties、xml等更适合做配置文件</p>
<p>​	①yml和xml相比，少了一些结构化的代码，使数据更直接，一目了然，相比properties文件更简洁</p>
<p>​	②YAML文件的扩展名可以使用.yml或者.yaml</p>
<p>​	③application.yml文件使用”key:(空格) value“格式配置属性，使用缩进控制层级关系。</p>
<p>可以表示Map，List，String，对象等</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">	<span class="attr">id:</span> <span class="number">1</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">哈哈哈</span></span><br><span class="line">	<span class="attr">hobby:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">吃</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">睡</span></span><br><span class="line">	<span class="attr">map:</span> &#123; <span class="attr">k1:</span> <span class="string">v1</span>,<span class="attr">k2:</span> <span class="string">v2</span>&#125;</span><br><span class="line">	<span class="attr">pet:</span></span><br><span class="line">		<span class="attr">name:</span> <span class="string">旺财</span></span><br><span class="line">		<span class="attr">type:</span> <span class="string">狗子</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>自定义配置属性提示</p>
<p>1.定义配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;person&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List hobby;</span><br><span class="line">    <span class="keyword">private</span> String[] family;</span><br><span class="line">    <span class="keyword">private</span> Map map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.引入configuration-processor依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3.重新编译代码</p>
<p>​	会生成一个json就可以使用ide的提示</p>
<p><img src="/images/SpringBootS_2.jpg" alt="配置路径"></p>
</li>
</ul>
<h2 id="2、属性注入"><a href="#2、属性注入" class="headerlink" title="2、属性注入"></a>2、属性注入</h2><blockquote>
<p><strong>属性注入解决了配置到类的映射问题</strong></p>
</blockquote>
<p>使用SpringBoot全局配置文件设置属性时：</p>
<p>如果配置属性是SpringBoot已有属性，例如服务器端口server.port，那么Spring Boot内部会自动扫描并读取这些配置文件中的属性值并覆盖默认属性。</p>
<p>如果配置的属性是用户自定义属性，必须在程序中注入这些配置属性方可生效。</p>
<h3 id="（1）使用方式"><a href="#（1）使用方式" class="headerlink" title="（1）使用方式"></a>（1）使用方式</h3><p>@Configuration:声明一个类作为配置类</p>
<p>@Bean:声明在方法上，将方法的返回值加入Bean容器</p>
<p>@Value:属性注入，属性上添加注解</p>
<p>@ConfigurationProperties(prefix &#x3D; “jdbc”)：批量属性注入</p>
<p>@PropertySource(“classpath:&#x2F;jdbc.properties”)指定外部属性文件。在类上添加</p>
<ul>
<li><p>@ConfigurationProperties批量注入</p>
<p>适用于相同业务的一组属性的批量注入场景</p>
<p>@EnableCOnfigurationProperties是SpringBoot提供的一个注解，使用该注解用于启用应用对另外一个注解@ConfigurationProperties的支持，用于设置一组使用了注解@ConfigurationProperties的类，用于作为bean定义注册到容器中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;jdbc&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDBCProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String driverClassName;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//一般放在SpringBootDemoApplication.class中</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(JDBCProperties.class)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


</li>
<li><p>自定义配置类</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;another&quot;)</span></span><br><span class="line">    <span class="meta">@Bean</span><span class="comment">//只构造一次</span></span><br><span class="line">    <span class="keyword">public</span> AnotherComponent <span class="title function_">anotherComponent</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AnotherComponent</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnotherComponent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> enabled;</span><br><span class="line">    <span class="keyword">private</span> InetAddress remoteAddress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">another:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">remoteAddress:</span> <span class="string">localhost</span></span><br></pre></td></tr></table></figure>

<h3 id="（2）松散绑定"><a href="#（2）松散绑定" class="headerlink" title="（2）松散绑定"></a>（2）松散绑定</h3><p>SpringBoot使用一些宽松的规则将环境属性绑定到@ConfigurationProperties bean，因此环境属性名和bean属性名不需要完全匹配。此特性可以减少写代码适配字段格式的问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(&quot;acme.my-person.person&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OwnerProperties</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String firstName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">acme:</span></span><br><span class="line">	<span class="attr">my-person:</span></span><br><span class="line">		<span class="attr">person:</span></span><br><span class="line">			<span class="attr">first-name:</span> <span class="string">泰森</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>属性文件中配置</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>acme.my-project.person.first-name</td>
<td>羊肉串模式case，推荐使用</td>
</tr>
<tr>
<td>acme.myProject.person.firstName</td>
<td>标准驼峰模式</td>
</tr>
<tr>
<td>acme.my_project.person.first_name</td>
<td>下划线模式</td>
</tr>
<tr>
<td>ACME_MYPROJECT_PERSON_FIRSTNAME</td>
<td>大写下划线，如果使用系统环境时候推荐使用</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>特征</th>
<th>@ConfiguartionProperties</th>
<th>@Value</th>
</tr>
</thead>
<tbody><tr>
<td>宽松的绑定</td>
<td>yes</td>
<td>Limited</td>
</tr>
<tr>
<td>元数据支持</td>
<td>yes</td>
<td>no</td>
</tr>
<tr>
<td>SpEL表达式</td>
<td>no</td>
<td>yes</td>
</tr>
<tr>
<td>应用场景</td>
<td>批量属性绑定</td>
<td>单个属性绑定</td>
</tr>
</tbody></table>
<p>如果您确实想使用@Value，我们建议您使用它们的规范形式来引用属性名(kebabcase只使用小写字母)。这将允许Spring Boot使用与松散绑定@ConfigurationProperties时相同的逻辑。(建议使用小写)</p>
<h1 id="三、源码剖析"><a href="#三、源码剖析" class="headerlink" title="三、源码剖析"></a>三、源码剖析</h1><blockquote>
<p>带注释的源码地址<a target="_blank" rel="noopener" href="https://github.com/hehan-wang/spring-boot-2.2.9.RELEASE.git">https://github.com/hehan-wang/spring-boot-2.2.9.RELEASE.git</a></p>
</blockquote>
<h2 id="1、起步依赖"><a href="#1、起步依赖" class="headerlink" title="1、起步依赖"></a>1、起步依赖</h2><ul>
<li>为什么spring-boot项目很多常用包不用指定版本？</li>
</ul>
<p>①首先spring-boot项目会设置spring-boot-starter-parent作为父依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>②然后父依赖中又有父依赖spring-boot-dependencies</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">&lt;!--设置java版本等属性--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource.delimiter</span>&gt;</span>@<span class="tag">&lt;/<span class="name">resource.delimiter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--设置资源过滤，保留spring需要的配置文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;basedir&#125;/src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/application*.yml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/application*.yaml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/application*.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;basedir&#125;/src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/application*.yml<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/application*.yaml<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/application*.properties<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--设置插件的版本管理--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;kotlin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">jvmTarget</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">jvmTarget</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">javaParameters</span>&gt;</span>true<span class="tag">&lt;/<span class="name">javaParameters</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">id</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">phase</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">id</span>&gt;</span>test-compile<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">phase</span>&gt;</span>test-compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>test-compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">          ....</span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>③使用maven真正完成依赖管理在父依赖spring-boot-dependencies</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">&lt;!--spring定义好一些常用包的依赖版本--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activemq.version</span>&gt;</span>5.16.5<span class="tag">&lt;/<span class="name">activemq.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">antlr2.version</span>&gt;</span>2.7.7<span class="tag">&lt;/<span class="name">antlr2.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appengine-sdk.version</span>&gt;</span>1.9.97<span class="tag">&lt;/<span class="name">appengine-sdk.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artemis.version</span>&gt;</span>2.19.1<span class="tag">&lt;/<span class="name">artemis.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aspectj.version</span>&gt;</span>1.9.7<span class="tag">&lt;/<span class="name">aspectj.version</span>&gt;</span></span><br><span class="line">    。。。。。。</span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--spring-boot-dependencies的dependencyManagement节点在这里，dependencies定义了SpringBoot版本的依赖的组件以及相应版本--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- SPring Boot --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-test-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-actuator-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>parent只有版本管理，真正依赖何时导入？</li>
</ul>
<p><strong>spring-boot-starter-web</strong>引入了tomcat，spring-mvc等web需要的相关依赖。版本号由<strong>spring-boot-dependencies</strong>中统一管理。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2、启动类注解（前置知识）"><a href="#2、启动类注解（前置知识）" class="headerlink" title="2、启动类注解（前置知识）"></a>2、启动类注解（前置知识）</h2><blockquote>
<p>两步走</p>
<p>​	1.找入口</p>
<p>​	2.抓主线</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span><span class="comment">//标注在类上说明这个类是`SpringBoot`的主配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBootMytestApplication</span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(SpringBootMytestApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>导入流程</p>
<p><img src="/images/SpringBootS_3.jpg" alt="注解"></p>
<p>@SpringBootApplication</p>
<p>注解引入了其他三个注解</p>
<p>@SpringBootConfiguration&#x2F;&#x2F;标明该类为配置类</p>
<p>@EnableAutoConfiguration&#x2F;&#x2F;启动自动配置功能</p>
<p>@ComponentScan</p>
<blockquote>
<p><strong>思考如何让注解上面的注解生效呢？</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(</span></span><br><span class="line"><span class="meta">    excludeFilters = &#123;@Filter(</span></span><br><span class="line"><span class="meta">    type = FilterType.CUSTOM,</span></span><br><span class="line"><span class="meta">    classes = &#123;TypeExcludeFilter.class&#125;</span></span><br><span class="line"><span class="meta">), @Filter(</span></span><br><span class="line"><span class="meta">    type = FilterType.CUSTOM,</span></span><br><span class="line"><span class="meta">    classes = &#123;AutoConfigurationExcludeFilter.class&#125;</span></span><br><span class="line"><span class="meta">)&#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>@SpringBootConfiguration</strong></p>
<p>引入了@Configuration，表示该类与@Configuration的作用相同，表示当前类为spring配置类，可以使用@bean标签</p>
<p><strong>@EnableAutoConfiguration</strong></p>
<ul>
<li><p>@AutoCOnfigurationPackage</p>
<p>@Import(AutoCOnfigurationPackages.Registrar.class)</p>
<p>AutoConfigUrationPackages.Registrar功能，注册org.springframework.boot.autoconfigure.AutoConfigurationPackages.BasePackages，他有一个参数，这个参数是使用了@AutoConfigurationPackage这个注解的类所在的包路径，保存自动配置类以供以后使用。</p>
</li>
<li><p>@Import(AutoConfigurationImportSelector.class)</p>
</li>
</ul>
<p><img src="/images/SpringBootS_4.jpg" alt="AutoConfigurationImportSelector继承关系"></p>
<p>入口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeferredImportSelector</span> <span class="keyword">extends</span> <span class="title class_">ImportSelector</span> &#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">default</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">DeferredImportSelector</span>.Group&gt; getImportGroup() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Group</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(AnnotationMetadata var1, DeferredImportSelector var2)</span>;</span><br><span class="line"></span><br><span class="line">        Iterable&lt;DeferredImportSelector.Group.Entry&gt; selectImports();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>org.springframework.boot.autoconfigure.AutoConfigurationImportSelector#getImportGroup实现了org.springframework.context.annotation.DeferredImportSelector#getImportGroup交给AutoConfigurationGroup的process方法处理</li>
<li>AutoConfigurationGroup实现了org.springframework.context.annotation.DeferredImportSelector.Group所以重点关注<strong>process方法</strong>，<strong>selectImports方法</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.annotation.ConfigurationClassParser.DeferredImportSalectorGrouping#getImports</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> Iterable&lt;Group.Entry&gt; getImports()&#123;</span><br><span class="line">	<span class="keyword">for</span>(DeferredImportSelectorHolder deferredImport : <span class="built_in">this</span>.deferredImports)&#123;</span><br><span class="line">        <span class="built_in">this</span>.group.process(deferredImport.getCOnfigurationClass().getMetadata(),deferredImport.getImportSelector());</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.group.selectImports();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6/" rel="tag">框架</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%A7%81%E6%95%99/" rel="tag">私教</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-SpringMVC(私)"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/07/16/SpringMVC(%E7%A7%81)/"
    >SpringMVC</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/07/16/SpringMVC(%E7%A7%81)/" class="article-date">
  <time datetime="2022-07-16T00:58:25.000Z" itemprop="datePublished">2022-07-16</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringMVC/">SpringMVC</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="一、SpringMVC介绍"><a href="#一、SpringMVC介绍" class="headerlink" title="一、SpringMVC介绍"></a>一、SpringMVC介绍</h1><h2 id="1、MVC模式"><a href="#1、MVC模式" class="headerlink" title="1、MVC模式"></a>1、MVC模式</h2><p>MVC全名是Model-View-Controller，模型-视图-控制器的缩写</p>
<p><img src="/images/SpringMVC_1.jpg" alt="MVC模式"></p>
<ul>
<li>Model（模型）：模型包含业务模型和数据模型，数据模型用于封装数据，业务模型用于处理业务。</li>
</ul>
<p><strong>模型就是当我们使用软件去解决真实世界中各种实际问题的时候，对那些我们关心的实际事物的抽象和简化</strong></p>
<p>贫血模型（Anemic Domain Model）</p>
<blockquote>
<p><strong>模型实体在设计和实现上，不包含或包含很少的逻辑</strong></p>
</blockquote>
<p>实体只有简单属性和getter&#x2F;setter方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Book</span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> onLoan;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="type">int</span> id)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isOnLoan</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.loan;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOnLoan</span><span class="params">(<span class="type">boolean</span> onLoan)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.onLoan = onLoan;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookService</span>&#123;</span><br><span class="line">    <span class="comment">//借出的方法 比如需要校验参数，可能需要查询数据库，可能需要将从数据源获得的原始数据装配到返回对象中，可能需要应用过滤条件，这里的内容，就是逻辑</span></span><br><span class="line">    <span class="keyword">public</span> Bool <span class="title function_">lendOut</span><span class="params">(<span class="type">int</span> bookId,Date date)</span>&#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">valid</span> <span class="operator">=</span> isValid(bookId);</span><br><span class="line">        <span class="keyword">if</span>(!valid) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> getById(bookId);</span><br><span class="line">        book.setOnLoan(<span class="literal">true</span>);<span class="comment">//借出</span></span><br><span class="line">        updateById(book);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>充血模型（Rich Domain Model）</strong></p>
<blockquote>
<p>充血模型的设计中，领域模型实体就是有血有肉的了，既包含数据，也包含逻辑，具备了高程度的完备性和自洽性。复核面向对象思想</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Book</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> onLoan;</span><br><span class="line">    <span class="comment">//在这种方式下，lendOut方法不需要传入bookId，</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lendOut</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.onLoan = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookService</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Bool <span class="title function_">lendOut</span><span class="params">(<span class="type">int</span> bookId,Date date)</span>&#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">valid</span> <span class="operator">=</span> isValid(bookId);</span><br><span class="line">        <span class="keyword">if</span>(!valid) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> getById(bookId);</span><br><span class="line">        book.lendOut();<span class="comment">//调用book的借出方法</span></span><br><span class="line">        <span class="comment">//book.setOnLoan(true);//借出</span></span><br><span class="line">        updateById(book);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果lendOut()逻辑非常复杂，优势就体现出来了</p>
<p><strong>思考</strong></p>
<p>1.如何选择？</p>
<p>业务逻辑比较简单，就没必要做充血建模，即便设计成充血模型，类也非常单薄，看起来也奇怪。</p>
<p>2.哪些逻辑放在Domain中哪些放到service中？</p>
<ul>
<li><p>​	<br>    - Service类负责与Repository交流。从数据库读取数据转化成domain需要在service完成，使domain跟数据库解耦。</p>
<ul>
<li>Service负责跨领域模型的业务聚合功能，如保存订单和保存支付记录。</li>
<li>Service类负责一些非功能性及与第三方系统交互的工作。比如幂等、事务、发邮件、发消息、记录日志、调用其他系统的RPC接口等，都可以放到Service类中。</li>
<li>相同领域的业功能放在一个Domain里。</li>
</ul>
</li>
<li><p>View（视图）：通常指jsp、html、json。作用展示数据。通常视图是依据模型数据创建的。</p>
</li>
<li><p>Controller（控制器）：处理用户交互部分。作用处理程序逻辑的。</p>
<p>MVC提倡：每一层只编写自己的东西，不编写任何其他的代码；分层是为了解耦，解耦是为了维护方便和分工协作。</p>
</li>
</ul>
<h2 id="2、什么是SpringMVC"><a href="#2、什么是SpringMVC" class="headerlink" title="2、什么是SpringMVC"></a>2、什么是SpringMVC</h2><blockquote>
<p>SpringMVC全名叫SpringWebMVC，是一种基于ServletAPI，基于Java实现MVC设计模型的请求驱动类型的轻量级Web框架。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html">https://docs.spring.io/spring-framework/docs/current/reference/html/web.html</a></p>
<h1 id="二、SpringMVC应用"><a href="#二、SpringMVC应用" class="headerlink" title="二、SpringMVC应用"></a>二、SpringMVC应用</h1><h2 id="1、开发流程"><a href="#1、开发流程" class="headerlink" title="1、开发流程"></a>1、开发流程</h2><ul>
<li>①配置DIspatcherServlet</li>
<li>②开发处理业务逻辑的Handler(@Controller,@RequestMapping)</li>
<li>③xml配置controller包扫描springmvc三大件<ul>
<li>DispatcherServlet前端控制器（老大）</li>
<li>ViewResolver视图解析器</li>
<li>HandlerMapping处理器映射器</li>
<li>HandlerAdapter处理器适配器</li>
</ul>
</li>
<li>④将springmvc.xml文件路径配置到web.xml中</li>
</ul>
<h2 id="2、参数绑定"><a href="#2、参数绑定" class="headerlink" title="2、参数绑定"></a>2、参数绑定</h2><p><img src="/images/SpringMVC_2.jpg" alt="参数绑定"></p>
<h2 id="3、拦截器"><a href="#3、拦截器" class="headerlink" title="3、拦截器"></a>3、拦截器</h2><p><img src="/images/SpringMVC_3.jpg" alt="参数绑定"></p>
<ul>
<li><p>三处的拦截点</p>
<ul>
<li>handler执行前（权限校验）</li>
<li>handler执行后 跳转页面之前</li>
<li>页面渲染后执行</li>
</ul>
</li>
<li><p>实现</p>
<ul>
<li>class MyIntereceptor implements HandlerInterceptor</li>
<li>springmvc.xml加入&lt;mvc:interceptors&gt;&lt;&#x2F;&gt;</li>
</ul>
</li>
<li><p>多个拦截器执行顺序</p>
<ul>
<li><p>PreHandle按照注册正序调用</p>
<p>PostHandle，afterCompletion倒叙调用</p>
</li>
<li><p><img src="/images/SpringMVC_4.jpg" alt="参数绑定"></p>
</li>
</ul>
</li>
</ul>
<h2 id="4、异常处理"><a href="#4、异常处理" class="headerlink" title="4、异常处理"></a>4、异常处理</h2><p>用处：全局异常处理</p>
<ul>
<li>@ControllerAdvice捕获全局Controller异常</li>
<li>方法加@ExceptionHandler之恶能捕获当前Controller异常</li>
<li>返回ModelAndView可以跳转页面</li>
</ul>
<h1 id="三、源码剖析"><a href="#三、源码剖析" class="headerlink" title="三、源码剖析"></a>三、源码剖析</h1><h2 id="1、九大组件"><a href="#1、九大组件" class="headerlink" title="1、九大组件"></a>1、九大组件</h2><h3 id="（1）HandlerMapping（处理器映射器）"><a href="#（1）HandlerMapping（处理器映射器）" class="headerlink" title="（1）HandlerMapping（处理器映射器）"></a><u>（1）HandlerMapping（处理器映射器）</u></h3><p>用来查找Handler（处理器），具体表现形式可以是类，也可以是方法。例如，标注了@RequestMapping的每个方法都可以看成一个Handler。</p>
<p>Handler负责具体实际的请求处理，请求到达后，HandlerMapping的作用是找到请求相应的处理器Handler和Interceptor。</p>
<h3 id="（2）HandlerAdapter（处理器适配器）"><a href="#（2）HandlerAdapter（处理器适配器）" class="headerlink" title="（2）HandlerAdapter（处理器适配器）"></a><u>（2）HandlerAdapter（处理器适配器）</u></h3><p>HandlerAdapter是一个适配器。因为SpringMVC中的Handler可以是任意形式的，只要能处理请求即可。但是把请求交给Servlet的时候，由于Servlet的方法结构都是doService(HttpServletRequest reqHttpServletResponse resp)形式的，要让固定的Servlet处理方法调用Handler来进行处理，便是HandlerAdapter的职责。</p>
<h3 id="（3）HandlerExceptionResolver"><a href="#（3）HandlerExceptionResolver" class="headerlink" title="（3）HandlerExceptionResolver"></a>（3）HandlerExceptionResolver</h3><p>用于处理Handler产生的异常情况。作用是根据异常设置ModelAndView，之后交给渲染方法进行渲染，渲染方法会将ModelAndView渲染成页面。</p>
<h3 id="（4）ViewResolver"><a href="#（4）ViewResolver" class="headerlink" title="（4）ViewResolver"></a><u>（4）ViewResolver</u></h3><p>视图解析器，用于将String类型的视图名和Locale解析为View类型的试图，只有一个resolveViewName()方法。</p>
<p>Controller层返回的String类型视图名viewName最终会在这里被解析成为View。View是用来渲染页面的，会将程序返回的参数和数据填入模板中，生成html文件。</p>
<p>ViewResolver主要完成两件事：找到渲染所用的模板和所用的技术（视图的类型，如JSP）并填入参数。</p>
<p>默认情况下，SpringMVC会自动为我们配置一个InternalResourceViewResolver，是针对JSP类型视图的。</p>
<h3 id="（5）RequestToViewNameTranslator"><a href="#（5）RequestToViewNameTranslator" class="headerlink" title="（5）RequestToViewNameTranslator"></a>（5）RequestToViewNameTranslator</h3><p>从请求中获取ViewName</p>
<p>因为ViewResolver根据ViewName查找View，但有的Handler处理完成之后，没有设置View，也没有设置ViewName，便要通过这个组件从请求中查找ViewName。</p>
<h3 id="（6）LocaleResolver"><a href="#（6）LocaleResolver" class="headerlink" title="（6）LocaleResolver"></a>（6）LocaleResolver</h3><p>ViewResolver组件的resolverViewName需要两个参数，一个是视图名，一个是Locale。</p>
<p>LocaleResolver用于从请求中解析出Locale，比如中国Locale是zh—CN，用来表示一个区域，这个也是i18n的基础</p>
<h3 id="（7）ThemeResolver"><a href="#（7）ThemeResolver" class="headerlink" title="（7）ThemeResolver"></a>（7）ThemeResolver</h3><p>用于解析主题。主题是样式、图片及它们所形成的显示效果的集合。</p>
<h3 id="（8）MultipartResolver"><a href="#（8）MultipartResolver" class="headerlink" title="（8）MultipartResolver"></a>（8）MultipartResolver</h3><p>用于上传请求，将普通请求包装成MultipartHttpServletRequest来实现。</p>
<h3 id="（9）FlashMapManager"><a href="#（9）FlashMapManager" class="headerlink" title="（9）FlashMapManager"></a>（9）FlashMapManager</h3><p>FlashMap用于重定向时的参数传递。</p>
<p>重定向之前将要传递的数据写入请求（可以通过ServletRequestAttributes.getRequest()方法获得）的属性OUTPUT_FLASH_MAP_ATTRIBUTE中，这样在重定向之后的Handler中Spring就会自动将其设置到Model中。</p>
<p>FlashMapManager就是用来管理FlashMap的。</p>
<h2 id="2、处理流程"><a href="#2、处理流程" class="headerlink" title="2、处理流程"></a>2、处理流程</h2><p><img src="/images/SpringMVC_5.jpg" alt="处理流程"></p>
<ul>
<li>第一步：用户发送请求至前端控制器DispatcherServlet</li>
<li>第二步：DispatcherServlet收到请求调用HandlerMapping处理器映射器</li>
<li>第三步：处理器映射器根据请求Url找到具体的Handler（后端控制器），生成处理器对象及处理器拦截器（如果 有则生成）一并返回DispatcherServlet</li>
<li>第四步：DispatcherServlet调用HandlerAdapter处理器适配器去调用Handler</li>
<li>第五步：处理器适配器执行Handler</li>
<li>第六步：Handler执行完成给处理器适配器返回ModelAndView</li>
<li>第七步：处理器适配器向前端控制器返回ModelAndView，ModelAndView是SpringMVC框架的一个底层对象，包括Model和View</li>
<li>第八步：前端控制器请求视图解析器去视图解析，根据逻辑视图名来解析真正的视图</li>
<li>第九步：视图解析器向前端控制器返回View</li>
<li>第十步：前端控制器进行视图渲染，就是将模型数据（在ModelAndView对象中）填充到request域</li>
<li>第十一步：前端控制器向用户响应结果</li>
</ul>
<h2 id="3、请求主流程源码"><a href="#3、请求主流程源码" class="headerlink" title="3、请求主流程源码"></a>3、请求主流程源码</h2><p><img src="/images/SpringMVC_6.jpg" alt="请求主流程"></p>
<p>SpringMVC的源码分两步。初始化，运行时。</p>
<blockquote>
<p>运行时入口：</p>
<p>Javax.servlet.http.HttpServlet#doPost</p>
<p>–&gt;org.springframework.web.servlet.DispatcherServlet#doDispatch</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="type">HttpServletRequest</span> <span class="variable">processedRequest</span> <span class="operator">=</span> request;</span><br><span class="line">		<span class="type">HandlerExecutionChain</span> <span class="variable">mappedHandler</span> <span class="operator">=</span> <span class="literal">null</span>;<span class="comment">//handlerMapping拿出来的handler+拦截器组成的链</span></span><br><span class="line">		<span class="type">boolean</span> <span class="variable">multipartRequestParsed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">WebAsyncManager</span> <span class="variable">asyncManager</span> <span class="operator">=</span> WebAsyncUtils.getAsyncManager(request);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">			<span class="type">Exception</span> <span class="variable">dispatchException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//1、检查文件是否有上传的请求</span></span><br><span class="line">				processedRequest = checkMultipart(request);</span><br><span class="line">				multipartRequestParsed = (processedRequest != request);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Determine handler for the current request.</span></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                2、去的处理当前请求的Controller，这里也成为Handler，即处理器</span></span><br><span class="line"><span class="comment">                这里并不是直接返回Controller，而是返回HandlerExecutionChain 请求处理链对象</span></span><br><span class="line"><span class="comment">                该对象封装了Handler和Inteceptor</span></span><br><span class="line"><span class="comment">                **/</span></span><br><span class="line">				mappedHandler = getHandler(processedRequest);</span><br><span class="line">				<span class="keyword">if</span> (mappedHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//如果handler为空，返回404</span></span><br><span class="line">					noHandlerFound(processedRequest, response);</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Determine handler adapter for the current request.</span></span><br><span class="line">                <span class="comment">//3、获取处理请求的处理器适配器 HandlerAdapter</span></span><br><span class="line">				<span class="type">HandlerAdapter</span> <span class="variable">ha</span> <span class="operator">=</span> getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Process last-modified header, if supported by the handler.</span></span><br><span class="line">                <span class="comment">//处理 last-modified 请求头</span></span><br><span class="line">				<span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> request.getMethod();</span><br><span class="line">				<span class="type">boolean</span> <span class="variable">isGet</span> <span class="operator">=</span> <span class="string">&quot;GET&quot;</span>.equals(method);</span><br><span class="line">				<span class="keyword">if</span> (isGet || <span class="string">&quot;HEAD&quot;</span>.equals(method)) &#123;</span><br><span class="line">					<span class="type">long</span> <span class="variable">lastModified</span> <span class="operator">=</span> ha.getLastModified(request, mappedHandler.getHandler());</span><br><span class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">						logger.debug(<span class="string">&quot;Last-Modified value for [&quot;</span> + getRequestUri(request) + <span class="string">&quot;] is: &quot;</span> + lastModified);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;</span><br><span class="line">						<span class="keyword">return</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Actually invoke the handler.</span></span><br><span class="line">                <span class="comment">//4、实际处理器处理请求，返回结果视图对象</span></span><br><span class="line">				mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">//结果视图对象的处理</span></span><br><span class="line">				applyDefaultViewName(processedRequest, mv);</span><br><span class="line">				mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">				dispatchException = ex;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line">				<span class="comment">// As of 4.3, we&#x27;re processing Errors thrown from handler methods as well,</span></span><br><span class="line">				<span class="comment">// making them available for @ExceptionHandler methods and other scenarios.</span></span><br><span class="line">				dispatchException = <span class="keyword">new</span> <span class="title class_">NestedServletException</span>(<span class="string">&quot;Handler dispatch failed&quot;</span>, err);</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">//5.处理视图</span></span><br><span class="line">			processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line">			triggerAfterCompletion(processedRequest, response, mappedHandler,</span><br><span class="line">					<span class="keyword">new</span> <span class="title class_">NestedServletException</span>(<span class="string">&quot;Handler processing failed&quot;</span>, err));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">				<span class="comment">// Instead of postHandle and afterCompletion</span></span><br><span class="line">				<span class="keyword">if</span> (mappedHandler != <span class="literal">null</span>) &#123;</span><br><span class="line">					mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// Clean up any resources used by a multipart request.</span></span><br><span class="line">				<span class="keyword">if</span> (multipartRequestParsed) &#123;</span><br><span class="line">					cleanupMultipart(processedRequest);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>上面5步在进入源码debug继续追踪</p>
<h2 id="4、初始化主流程源码"><a href="#4、初始化主流程源码" class="headerlink" title="4、初始化主流程源码"></a>4、初始化主流程源码</h2><blockquote>
<p>初始化找入口：</p>
<p>org.springframework.web.servlet.FrameworkServlet.ContextRefreshListener#onApplicationEvent接收事件</p>
<p>–&gt;org.springframework.web.servlet.DispatcherServlet#initStrategies</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	初始化组件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initStrategies</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    	<span class="comment">//多文件上传组件</span></span><br><span class="line">        <span class="built_in">this</span>.initMultipartResolver(context);</span><br><span class="line">    	<span class="comment">//初始化本地语言环境</span></span><br><span class="line">        <span class="built_in">this</span>.initLocaleResolver(context);</span><br><span class="line">    	<span class="comment">//初始化模板处理器</span></span><br><span class="line">        <span class="built_in">this</span>.initThemeResolver(context);</span><br><span class="line">    	<span class="comment">//初始化HandlerMapping</span></span><br><span class="line">        <span class="built_in">this</span>.initHandlerMappings(context);</span><br><span class="line">    	<span class="comment">//初始化参数适配器</span></span><br><span class="line">        <span class="built_in">this</span>.initHandlerAdapters(context);</span><br><span class="line">    	<span class="comment">//初始化异常拦截器</span></span><br><span class="line">        <span class="built_in">this</span>.initHandlerExceptionResolvers(context);</span><br><span class="line">    	<span class="comment">//初始化视图预处理器</span></span><br><span class="line">        <span class="built_in">this</span>.initRequestToViewNameTranslator(context);</span><br><span class="line">    	<span class="comment">//初始化视图转换器</span></span><br><span class="line">        <span class="built_in">this</span>.initViewResolvers(context);</span><br><span class="line">    	<span class="comment">//初始化FlashMap管理器</span></span><br><span class="line">        <span class="built_in">this</span>.initFlashMapManager(context);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>初始化HandlerMapping</p>
<p><strong>注册容器里所有handler到AbstractHandlerMethodMapping#mappingRegistry中</strong></p>
<p>org.springframework.web.servlet.handler.AbstractHandlerMethodMapping#initHandlerMethods</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initHandlerMethods</span><span class="params">()</span> &#123; <span class="comment">//初始化handler的映射关系</span></span><br><span class="line">    String[] var1 = <span class="built_in">this</span>.getCandidateBeanNames();</span><br><span class="line">    <span class="type">int</span> <span class="variable">var2</span> <span class="operator">=</span> var1.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var3</span> <span class="operator">=</span> <span class="number">0</span>; var3 &lt; var2; ++var3) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> var1[var3];</span><br><span class="line">        <span class="keyword">if</span> (!beanName.startsWith(<span class="string">&quot;scopedTarget.&quot;</span>)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.processCandidateBean(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.handlerMethodsInitialized(<span class="built_in">this</span>.getHandlerMethods());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>org.springframework.web.servlet.handler.AbstractHandlerMethodMapping.MappingRegistry#register</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(T mapping, Object handler, Method method)</span> &#123;<span class="comment">//核心注册方法</span></span><br><span class="line">            <span class="keyword">if</span> (KotlinDetector.isKotlinType(method.getDeclaringClass()) &amp;&amp; AbstractHandlerMethodMapping.KotlinDelegate.isSuspend(method)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unsupported suspending handler method detected: &quot;</span> + method);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.readWriteLock.writeLock().lock();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> AbstractHandlerMethodMapping.<span class="built_in">this</span>.createHandlerMethod(handler, method);</span><br><span class="line">                    <span class="built_in">this</span>.validateMethodMapping(handlerMethod, mapping);</span><br><span class="line">                    <span class="built_in">this</span>.mappingLookup.put(mapping, handlerMethod);</span><br><span class="line">                    List&lt;String&gt; directUrls = <span class="built_in">this</span>.getDirectUrls(mapping);</span><br><span class="line">                    <span class="type">Iterator</span> <span class="variable">var6</span> <span class="operator">=</span> directUrls.iterator();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> (String)var6.next();</span><br><span class="line">                        <span class="built_in">this</span>.urlLookup.add(url, mapping);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (AbstractHandlerMethodMapping.<span class="built_in">this</span>.getNamingStrategy() != <span class="literal">null</span>) &#123;</span><br><span class="line">                        name = AbstractHandlerMethodMapping.<span class="built_in">this</span>.getNamingStrategy().getName(handlerMethod, mapping);</span><br><span class="line">                        <span class="built_in">this</span>.addMappingName(name, handlerMethod);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">CorsConfiguration</span> <span class="variable">corsConfig</span> <span class="operator">=</span> AbstractHandlerMethodMapping.<span class="built_in">this</span>.initCorsConfiguration(handler, method, mapping);</span><br><span class="line">                    <span class="keyword">if</span> (corsConfig != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.corsLookup.put(handlerMethod, corsConfig);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">this</span>.registry.put(mapping, <span class="keyword">new</span> <span class="title class_">AbstractHandlerMethodMapping</span>.MappingRegistration(mapping, handlerMethod, directUrls, name));</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="built_in">this</span>.readWriteLock.writeLock().unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<h1 id="四、SpringMVC中的设计模式"><a href="#四、SpringMVC中的设计模式" class="headerlink" title="四、SpringMVC中的设计模式"></a>四、SpringMVC中的设计模式</h1><h2 id="1、适配器模式"><a href="#1、适配器模式" class="headerlink" title="1、适配器模式"></a>1、适配器模式</h2><h3 id="（1）适配器模式介绍"><a href="#（1）适配器模式介绍" class="headerlink" title="（1）适配器模式介绍"></a>（1）适配器模式介绍</h3><ul>
<li><strong>what</strong></li>
</ul>
<p>将一个接口转化成需要的另一个接口 使不兼容的类可以在一起工作</p>
<ul>
<li><strong>when</strong></li>
</ul>
<p>①、封装有缺陷接口</p>
<p>假设我们依赖的外部系统在接口设计方面有缺陷（比如包含大量静态方法，参数列表过长方法，名称丑陋代码），引入后会影响我们自身代码的可测试性。为了隔离设计上的缺陷，我们希望对外部系统提供的接口进行二次封装，抽象出更好的接口设计，这个时候就可以使用适配器模式了。</p>
<p>②、统一多个类的接口设计</p>
<p>某个功能的实现依赖多个外部系统，他们的方法签名完全不一致。通过适配器，将接口适配为统一的接口定义，然后就可以使用多态的特性服用代码逻辑。</p>
<p>③、兼容老版本</p>
<p>在做版本升级时候，对于一些要废弃的接口，不直接将其删除，暂时保留，标注为deprecated，并将内部实现逻辑委托为新的接口实现。让项目有个过渡期，而不是强制进行代码修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Collections</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Enumeration <span class="title function_">emumeration</span><span class="params">(<span class="keyword">final</span> Collection c)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Enumeration</span>()&#123;</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">i</span> <span class="operator">=</span> c.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasMoreElements</span><span class="params">()</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> i.hasNext();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">nextElement</span><span class="params">()</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> i.next();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>④、替换依赖外部系统</p>
<p>当我们把项目中依赖的一个外部系统A替换为另一个外部系统B的时候，利用适配器模式，把B适配成A，可以减少对代码的改动。</p>
<p>⑤、适配不同数据格式</p>
<p>它还可以用在不同格式的数据之间的适配</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; stooges = Arrays.asList(<span class="string">&quot;A&quot;</span>,<span class="string">&quot;B&quot;</span>,<span class="string">&quot;C&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>how</strong></li>
</ul>
<p>①、基于继承</p>
<p>②、基于实现</p>
<p>③、基于传参数（spring中使用这种）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ITarget</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">f1</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">f2</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">fc</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Adaptee</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fa</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fb</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fc</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//基于继承</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Adaptor</span> <span class="keyword">extends</span> <span class="title class_">Adaptee</span> <span class="keyword">implements</span> <span class="title class_">ITarget</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">f1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.fa();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">f2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//重新实现f2()...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这里fc()不需要实现，直接继承自Adaptee，和对象适配器最大的不同点</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//基于组合</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Adaptor2</span> <span class="keyword">implements</span> <span class="title class_">ITarget</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Adaptee adaptee;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Adaptor2</span><span class="params">(Adaptee adaptee)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.adaptee = adaptee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">f1</span><span class="params">()</span> &#123;</span><br><span class="line">        adaptee.fa();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">f2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//重新实现</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fc</span><span class="params">()</span> &#123;</span><br><span class="line">        adaptee.fc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如何选择？</p>
<ul>
<li>被适配类 接口不多都可以</li>
<li>被适配类接口多，并且大部分方法签名相同，使用继承减少代码量</li>
<li>被适配类接口多，并且大部分代码不相同，使用组合结构更灵活</li>
</ul>
<p>类继承在语义上更侧重于相似型，因此越相似的类即方法的名称几乎是一样的情况下，我们更喜欢用类来适配。</p>
<p>组合在语义上更侧重整体与部分，或者说部分可以在整体内自由变化，而变化意味着不相似，或者说方法绝大部分不同，那么使用对象适配的方式更合适。</p>
<ul>
<li><strong>why</strong></li>
</ul>
<p>适配器模式可以看作一种“<strong>补偿模式</strong>”，用来补救设计上的缺陷。</p>
<p>应用这种模式算是“无奈之举”，如果在设计初期，我们就能协调规避接口不兼容问题，那么这种模式就没有应用的机会了。</p>
<h3 id="（2）SpringMVC中的适配器模式"><a href="#（2）SpringMVC中的适配器模式" class="headerlink" title="（2）SpringMVC中的适配器模式"></a>（2）SpringMVC中的适配器模式</h3><p>编写Controller的方式有以下三种，其获取path-&gt;handler的方式完全不一样。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//方法一：通过@Controller、@RequestMapping来定义</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoController</span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/employname&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">getEmployeeName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">model</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;Greeting&quot;</span>);</span><br><span class="line">        model.addObject(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;Dinesh&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> model;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//方法二：实现Controller接口+xml配置文件:配置DemoController与URL的对应关系</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoController</span> <span class="keyword">implements</span> <span class="title class_">Controller</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">handleRequest</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">model</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;Greeting&quot;</span>);</span><br><span class="line">        model.addObject(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;Dinesh Madhwal&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> model;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//方法三：实现Servlet接口 + xml配置文件：配置DemoController类与URL的对应关系</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="built_in">super</span>.doGet(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;Hello World.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Spring采用了适配器模式统一接口设计<strong>HandlerAdapter</strong>中使用了<strong>适配器模式+策略模式</strong>适配多种不同Controller的返回结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerAdapter</span>&#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Object var1)</span>;</span><br><span class="line">    </span><br><span class="line">    ModelAndView <span class="title function_">handle</span><span class="params">(HttpServletRequest var1,HttpServletResponse var2,Object var3)</span><span class="keyword">throws</span> Exception;</span><br><span class="line">    </span><br><span class="line">    <span class="type">long</span> <span class="title function_">getLastModeified</span><span class="params">(HttpServletRequest var1,Object var2)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对应实现Controller接口的Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleControllerHandlerAdapter</span> <span class="keyword">implements</span> <span class="title class_">HandlerAdapter</span>()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleControllerHandlerAdapter</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Object handler)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> handler <span class="keyword">instanceof</span> Controller;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">handle</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                  HttpServletResponse response,Object handler)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">return</span> ((Controller)handler).handleRequest(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getLastModified</span><span class="params">(HttpServletRequest request,Object handler)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> handler <span class="keyword">instanceof</span> LastModified ? ((LastModified)handler).getLastModified(request):-<span class="number">1L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对应实现Servlet接口的Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleServletHandlerAdapter</span> <span class="keyword">implements</span> <span class="title class_">HandlerAdapter</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleServletHandlerAdapter</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Object handler)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> handler <span class="keyword">instanceof</span> Servlet;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">handle</span><span class="params">(HttpServletRequest request,HttpServletResponse response,Object handler)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    ((Servlet)handler).service(request,response);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getLastModified</span><span class="params">(HttpServletRequest request,Object handler)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取适配器类</span></span><br><span class="line">   <span class="keyword">protected</span> HandlerAdapter <span class="title function_">getHandlerAdapter</span><span class="params">(Object handler)</span> <span class="keyword">throws</span> ServletException&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">this</span>.handlerAdapters!=<span class="literal">null</span>)&#123;</span><br><span class="line">           <span class="keyword">for</span> (HandlerAdapter handlerAdapter : <span class="built_in">this</span>.handlerAdapters) &#123;</span><br><span class="line">               <span class="keyword">if</span> (handlerAdapter.supports(handler))&#123;</span><br><span class="line">                   <span class="keyword">return</span> handlerAdapter;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;No adapter for handler [&quot;</span> + handler + <span class="string">&quot;]:The DispatcherServlet configuration needs&quot;</span>+</span><br><span class="line">               <span class="string">&quot; to include a HandlerAdapter that supports this handler&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">	<span class="comment">//统一调用simple方法</span></span><br><span class="line">       mv = ha.handle(processedRequest,response,mappedHandler.getHandler());</span><br></pre></td></tr></table></figure>



<h2 id="2、责任链模式"><a href="#2、责任链模式" class="headerlink" title="2、责任链模式"></a>2、责任链模式</h2><h3 id="（1）责任链模式介绍"><a href="#（1）责任链模式介绍" class="headerlink" title="（1）责任链模式介绍"></a>（1）责任链模式介绍</h3><ul>
<li><p>what</p>
<p>将请求的发送和接收解耦，让多个接收对象都有机会处理这个请求。将这些接收对象串成一条链，并沿着这条链传递这个请求，直到链上的某个接收对象能够处理它为止。</p>
</li>
<li><p>when</p>
<p>①Servlet Filter</p>
<p>②Spring Interceptor</p>
<p>③敏感词过滤</p>
<p>④多logger日志打印</p>
</li>
<li><p>how</p>
</li>
<li><p>why</p>
<p>符合开闭原则 复用性 扩展性。新增一个过滤器不用修改其他代码</p>
</li>
</ul>
<h3 id="（2）SpringMvc中的责任链"><a href="#（2）SpringMvc中的责任链" class="headerlink" title="（2）SpringMvc中的责任链"></a>（2）SpringMvc中的责任链</h3><p>SpringMVC中提供了拦截器的功能，用来做一些通用逻辑的处理。使用到了责任链模式注册多个拦截器形成链式调用。</p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a><strong>使用</strong></h4><p>1、自定义拦截器（可以是多个）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Interceptor1</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * handler方法逻辑执行之前进行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;preHandle.....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * handler方法逻辑执行之后，页面尚未跳转之前进行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;postHandle.....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    页面渲染完成后执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterCompletion.....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/**/&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.liang.interceptor.Interceptor1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h4><p>1、构建拦截器链</p>
<p>org.springframework.web.servlet.handler.AbstractHandlerMapping#getHandlerExecutionChain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandlerExecutionChain</span><span class="params">(Object handler, HttpServletRequest request)</span> &#123;</span><br><span class="line">     <span class="type">HandlerExecutionChain</span> <span class="variable">chain</span> <span class="operator">=</span> handler <span class="keyword">instanceof</span> HandlerExecutionChain ? (HandlerExecutionChain)handler : <span class="keyword">new</span> <span class="title class_">HandlerExecutionChain</span>(handler);</span><br><span class="line">     <span class="type">String</span> <span class="variable">lookupPath</span> <span class="operator">=</span> <span class="built_in">this</span>.urlPathHelper.getLookupPathForRequest(request);</span><br><span class="line">     <span class="type">Iterator</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="built_in">this</span>.adaptedInterceptors.iterator();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">while</span>(var5.hasNext()) &#123;</span><br><span class="line">         <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> (HandlerInterceptor)var5.next();</span><br><span class="line">         <span class="keyword">if</span> (interceptor <span class="keyword">instanceof</span> MappedInterceptor) &#123;</span><br><span class="line">             <span class="type">MappedInterceptor</span> <span class="variable">mappedInterceptor</span> <span class="operator">=</span> (MappedInterceptor)interceptor;</span><br><span class="line">             <span class="keyword">if</span> (mappedInterceptor.matches(lookupPath, <span class="built_in">this</span>.pathMatcher)) &#123;</span><br><span class="line">                 chain.addInterceptor(mappedInterceptor.getInterceptor());<span class="comment">//如果拦截器匹配到当前path 添加到拦截链</span></span><br><span class="line">             &#125;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             chain.addInterceptor(interceptor);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> chain;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>2、链式调用HandlerExecutionChain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">applyPreHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;<span class="comment">//前置处理</span></span><br><span class="line">        HandlerInterceptor[] interceptors = <span class="built_in">this</span>.getInterceptors();</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; interceptors.length; <span class="built_in">this</span>.interceptorIndex = i++) &#123;<span class="comment">//从前往后</span></span><br><span class="line">                <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> interceptors[i];</span><br><span class="line">                <span class="keyword">if</span> (!interceptor.preHandle(request, response, <span class="built_in">this</span>.handler)) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.triggerAfterCompletion(request, response, (Exception)<span class="literal">null</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">applyPostHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> ModelAndView mv)</span> <span class="comment">//后置处理</span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HandlerInterceptor[] interceptors = <span class="built_in">this</span>.getInterceptors();</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> interceptors.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;<span class="comment">//从后到前</span></span><br><span class="line">                <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> interceptors[i];</span><br><span class="line">                interceptor.postHandle(request, response, <span class="built_in">this</span>.handler, mv);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">triggerAfterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> Exception ex)</span><span class="comment">//最终处理 ex正常返回为null，错误返回有值 </span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HandlerInterceptor[] interceptors = <span class="built_in">this</span>.getInterceptors();</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorIndex; i &gt;= <span class="number">0</span>; --i) &#123;<span class="comment">//将注册的拦截器进行链式调度</span></span><br><span class="line">                <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> interceptors[i];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    interceptor.afterCompletion(request, response, <span class="built_in">this</span>.handler, ex);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var8) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;HandlerInterceptor.afterCompletion threw exception&quot;</span>, var8);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6/" rel="tag">框架</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%A7%81%E6%95%99/" rel="tag">私教</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-SpringFrameWork(私)"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/07/13/SpringFrameWork(%E7%A7%81)/"
    >SpringFrameWork</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/07/13/SpringFrameWork(%E7%A7%81)/" class="article-date">
  <time datetime="2022-07-13T14:38:25.000Z" itemprop="datePublished">2022-07-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringFrameWork/">SpringFrameWork</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="一、Spring概念"><a href="#一、Spring概念" class="headerlink" title="一、Spring概念"></a>一、Spring概念</h1><h2 id="1、什么是Spring"><a href="#1、什么是Spring" class="headerlink" title="1、什么是Spring"></a>1、什么是Spring</h2><p>分层的full-stack（全栈）轻量级开源框架</p>
<p>IoC和AOP为内核</p>
<h2 id="2、Why-Spring"><a href="#2、Why-Spring" class="headerlink" title="2、Why Spring"></a>2、Why Spring</h2><p><a target="_blank" rel="noopener" href="https://spring.io/why-spring">https://spring.io/why-spring</a></p>
<ul>
<li>方便解耦、简化开发（Ioc容器，依赖反转）</li>
<li>AOP编程支持</li>
<li>声明式事务的支持（@Transactional）</li>
<li>方便程序的测试</li>
<li>降低JavaEE API使用难度</li>
<li>源码时经典的Java学习规范</li>
</ul>
<h2 id="3、核心架构"><a href="#3、核心架构" class="headerlink" title="3、核心架构"></a>3、核心架构</h2><p><img src="/images/SpringFrameWork_1.jpg" alt="Spring架构"></p>
<ul>
<li><p>Spring核心容器（Core Container）</p>
<p>①核心部分，管理Sping应用中bean的创建、配置和管理。②该模块包括了Spring bean工厂，为Spring提供了DI功能。③所有Spring模块构建于核心容器之上。</p>
</li>
<li><p>面向切面编程（AOP）</p>
<p>Aspects Spring。AOP帮助应用对象解耦。</p>
</li>
<li><p>数据访问与集成（Data Access&#x2F;Integration）</p>
<p>①Spring的JDBC和DAO模块封装了大量样板代码。②Spring AOP为数据访问提供了事务管理服务③Spring还对ORM进行了集成，如Hibernate、MyBatis等。该模块由JDBC、Transactions、ORM、OXM和JMS等模块组成</p>
</li>
<li><p>Web</p>
</li>
<li><p>Test</p>
</li>
</ul>
<h1 id="二、核心思想"><a href="#二、核心思想" class="headerlink" title="二、核心思想"></a>二、核心思想</h1><h2 id="1、工厂模式（Factory）"><a href="#1、工厂模式（Factory）" class="headerlink" title="1、工厂模式（Factory）"></a>1、工厂模式（Factory）</h2><p>简单工厂（Simple Factory）、工厂方法（Factory Method）和抽象工厂（Abstract Factory）</p>
<hr>
<p>复杂度无法消除，只能被转移：</p>
<ul>
<li>不用工厂模式，if-else逻辑、创建逻辑和业务代码<strong>耦合</strong>在一起</li>
<li>简单工厂是将不同创建逻辑放到一个工厂中，对象创建逻辑在这个工厂类中</li>
<li>工厂方法是不同创建逻辑放到不同工厂类中，先用一个工厂类来得到某个工厂类，再用这个工厂类来创建，对象创建在工厂类的工厂中</li>
<li>抽象工厂是工厂的工厂，创建多个类型相关的对象（spring ioc容器和FactorBean的关系）</li>
</ul>
<p>原始代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(String ruleConfigFilePath)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ruleConfigFileExtension</span> <span class="operator">=</span> getFileExtension(ruleConfigFilePath);</span><br><span class="line">        <span class="type">IRuleConfigParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;json&quot;</span>.equalsIgnoreCase(ruleConfigFileExtension))&#123;</span><br><span class="line">            parser = <span class="keyword">new</span> <span class="title class_">JsonRuleConfigParser</span>();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;xml&quot;</span>.equalsIgnoreCase(ruleConfigFileExtension))&#123;</span><br><span class="line">            parser = <span class="keyword">new</span> <span class="title class_">XmlRuleConfigParser</span>();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;yaml&quot;</span>.equalsIgnoreCase(ruleConfigFileExtension))&#123;</span><br><span class="line">            parser=<span class="keyword">new</span> <span class="title class_">YamlRuleConfigParser</span>();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;properties&quot;</span>.equalsIgnoreCase(ruleConfigFileExtension))&#123;</span><br><span class="line">            parser = <span class="keyword">new</span> <span class="title class_">PropertiesRuleConfigParser</span>();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Rule config file format is not supported: &quot;</span>+ruleConfigFilePath);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">configText</span> <span class="operator">=</span> <span class="string">&quot;牛皮666&quot;</span>;</span><br><span class="line">        parser.parse(configText);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getFileExtension</span><span class="params">(String filePath)</span>&#123;</span><br><span class="line">        <span class="comment">//解析文件拓展名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">substring</span> <span class="operator">=</span> filePath.substring(filePath.lastIndexOf(<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> substring;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>简单工厂模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String,IRuleConfigParser&gt; map;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RuleConfigParserFactory</span><span class="params">()</span>&#123;</span><br><span class="line">        map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;json&quot;</span>,<span class="keyword">new</span> <span class="title class_">JsonRuleConfigParser</span>());</span><br><span class="line">        map.put(<span class="string">&quot;xml&quot;</span>,<span class="keyword">new</span> <span class="title class_">XmlRuleConfigParser</span>());</span><br><span class="line">        map.put(<span class="string">&quot;yaml&quot;</span>,<span class="keyword">new</span> <span class="title class_">YamlRuleConfigParser</span>());</span><br><span class="line">        map.put(<span class="string">&quot;properties&quot;</span>,<span class="keyword">new</span> <span class="title class_">PropertiesRuleConfigParser</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(String ruleConfigFilePath)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ruleConfigFileExtension</span> <span class="operator">=</span> getFileExtension(ruleConfigFilePath);</span><br><span class="line">        <span class="type">IRuleConfigParser</span> <span class="variable">parser</span> <span class="operator">=</span> map.get(ruleConfigFileExtension);</span><br><span class="line">        <span class="type">String</span> <span class="variable">configText</span> <span class="operator">=</span> <span class="string">&quot;牛皮666&quot;</span>;</span><br><span class="line">        parser.parse(configText);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getFileExtension</span><span class="params">(String filePath)</span>&#123;</span><br><span class="line">        <span class="comment">//解析文件拓展名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">substring</span> <span class="operator">=</span> filePath.substring(filePath.lastIndexOf(<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> substring;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/SpringFrameWork_2.jpg" alt="工厂模式"></p>
<h3 id="工厂模式使用场景"><a href="#工厂模式使用场景" class="headerlink" title="工厂模式使用场景"></a><strong>工厂模式使用场景</strong></h3><p>创建对象较复杂场景</p>
<p>（1）需要很多if else，动态根据类型创建对象场景。可将if else收敛到工厂类内(Map简化if else)，提供易用的API。</p>
<p>（2）对象创建复杂的场景，比如一个对象要注入其他对象的情况。(spring ioc)</p>
<p><strong>优势</strong></p>
<p>（1）封装变化：创建逻辑方便查看</p>
<p>（2）代码复用：创建代码抽离到独立的工厂类可以复用</p>
<p>（3）隔离复杂性：复杂的创建逻辑封装，调用者无需了解如何创建</p>
<p>（4）控制复杂度：创建代码抽离出来，代码更简洁</p>
<h2 id="2、代理模式（Proxy）"><a href="#2、代理模式（Proxy）" class="headerlink" title="2、代理模式（Proxy）"></a>2、代理模式（Proxy）</h2><p>不改变原始类，引入代理类附加功能</p>
<hr>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a><strong>使用场景</strong></h3><p>非功能性通用需求</p>
<p>操作日志，事务、监控、统计、鉴权、限流、幂等，异常处理，RPC客户端（Feign，Dubbo），缓存（@Cached），SpringAOP。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a><strong>实现</strong></h3><p>需要打印所有接口的请求耗时。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">	<span class="keyword">public</span> UserVo <span class="title function_">register</span><span class="params">(String telephone,String password)</span>&#123;</span><br><span class="line">		<span class="type">long</span> <span class="variable">startTimetamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// ...省略register逻辑...</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">endTimeStamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">responseTime</span> <span class="operator">=</span> endTimeStamp - startTimetamp;</span><br><span class="line">        <span class="comment">//返回UserVo数据</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果多个接口增加代码</p>
<p>①耦合：监控代码跟业务代码不应该放在一个类中，不符合单一职责原则。</p>
<p>②重复：工作量大。不符合DRY（dont repeat youself）原则</p>
<h3 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a><strong>静态代理</strong></h3><p>①实现被代理对象：要求被代理类和代理类同时实现相应的一套接口，通过代理类重写接口的方法，实际上调用的是原始对象的同样的方法。</p>
<p>②继承被代理对象：代理类继承原始类，然后扩展附加功能。</p>
<p>委托实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lsm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UserControllerProxy.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 委托实现(继承接口，通过构造传递被委托对象，对外使用委托对象调用方法)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2022年07月14日 14:17:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserControllerProxy</span> <span class="keyword">implements</span> <span class="title class_">IUserController</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserController userController;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserControllerProxy</span><span class="params">(UserController userController)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userController = userController;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserVo <span class="title function_">login</span><span class="params">(String telemphone, String password)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">UserVo</span> <span class="variable">login</span> <span class="operator">=</span> userController.login(telemphone, password);</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">responseTime</span> <span class="operator">=</span> endTime - startTime;</span><br><span class="line">        <span class="keyword">return</span> login;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserVo <span class="title function_">register</span><span class="params">(String telemphone, String password)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">UserVo</span> <span class="variable">register</span> <span class="operator">=</span> userController.register(telemphone, password);</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">responseTime</span> <span class="operator">=</span> endTime - startTime;</span><br><span class="line">        <span class="keyword">return</span> register;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">IUserController</span> <span class="variable">userController</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserControllerProxy</span>(<span class="keyword">new</span> <span class="title class_">UserController</span>());</span><br><span class="line">userController.login();</span><br></pre></td></tr></table></figure>

<p>继承实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lsm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UserControllerProxyExtend.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 继承实现(继承后，重写父类方法，编写代理代码，中间调用父类方法实现)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2022年07月14日 14:23:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserControllerProxyExtend</span> <span class="keyword">extends</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserVo <span class="title function_">login</span><span class="params">(String telemphone, String password)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">UserVo</span> <span class="variable">login</span> <span class="operator">=</span> <span class="built_in">super</span>.login(telemphone, password);</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">responseTime</span> <span class="operator">=</span> endTime - startTime;</span><br><span class="line">        <span class="keyword">return</span> login;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserVo <span class="title function_">register</span><span class="params">(String telemphone, String password)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">UserVo</span> <span class="variable">register</span> <span class="operator">=</span> <span class="built_in">super</span>.register(telemphone, password);</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">responseTime</span> <span class="operator">=</span> endTime - startTime;</span><br><span class="line">        <span class="keyword">return</span> register;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">IUserController</span> <span class="variable">userController</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserControllerProxy</span>();</span><br><span class="line">userController.login();</span><br></pre></td></tr></table></figure>

<p>新问题，当类或者方法增加时，维护代理类的数量也会线性增加。</p>
<p>所以，使用动态代理，主流方式。</p>
<h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a><strong>动态代理</strong></h3><p>运行时，动态创建原始类对应的代理类，然后在系统中用代理类替换掉原始类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lsm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> MetricDynamicProxy.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 生成代理类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2022年07月14日 14:37:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MetricDynamicProxy</span>&lt;T&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T t;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">createProxy</span><span class="params">(T t)</span> &#123;</span><br><span class="line">        Class&lt;?&gt;[] interfaces = t.getClass().getInterfaces();</span><br><span class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(getClass().getClassLoader(), interfaces, <span class="keyword">new</span> <span class="title class_">LogDynamicProxyHandler</span>&lt;&gt;(t));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LogDynamicProxyHandler</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> T t;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">LogDynamicProxyHandler</span><span class="params">(T t)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.t = t;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">startTimestamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(t, args);<span class="comment">//原始方法调用</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">endTimeStamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="type">long</span> <span class="variable">responseTime</span> <span class="operator">=</span> endTimeStamp - startTimestamp;</span><br><span class="line">            <span class="type">String</span> <span class="variable">apiName</span> <span class="operator">=</span> t.getClass().getName() + <span class="string">&quot;:&quot;</span> + method.getName();</span><br><span class="line">            System.out.println(apiName + <span class="string">&quot; cost:&quot;</span> + responseTime);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/images/SpringFrameWork_3.jpg" alt="动态代理"></p>
<p><strong>动态代理实现方案</strong></p>
<p><strong><u>Java的动态代理本质上是字节码生成技术，动态生成类加载到JVM</u></strong></p>
<p>①Jdk代理</p>
<p>使用反射包下的Proxy类实现</p>
<p>②cglib</p>
<p>利用ASM开源包，对被代理对象类的class文件加载进来，通过修改其字节码生成子类来处理。</p>
<p>③ASM</p>
<p>Java字节码操控框架。动态生成类或者增强既有类的功能。ASM可直接产生一个二进制class文件，也可在类被加载入Java虚拟机之前动态改变类行为。</p>
<p>④javassist</p>
<p>字节码操作框架。API比ASM高级，无需掌握繁琐的java字节码指令</p>
<p>⑤byte-buddy</p>
<p>Byte Buddy是一个代码生成和操作库，用于在Java应用程序运行时创建和修改Java类，无需编译器的帮助。</p>
<p>允许创建任意类，不限于实现用于创建运行时代理的接口。</p>
<p>提供了一种可以使用Java代理或在构建过程中手动更改类的api</p>
<ul>
<li>无需理解字节码指令，即可使用简单的API就能很容易操作字节码，控制类和方法</li>
<li>已支持Java11，库轻量，仅取决于Java字节代码解析器库ASM的访问者API，本身不需要任何其他依赖项</li>
<li>比起JDK动态代理、cglib、javassist、Byte Buddy在性能上具有一定优势</li>
</ul>
<h2 id="3、Spring-IOC"><a href="#3、Spring-IOC" class="headerlink" title="3、Spring IOC"></a>3、Spring IOC</h2><p>简介</p>
<ul>
<li>什么是IOC（Inverse Of Control）</li>
</ul>
<p>Spring IOC容器采用了上述工厂模式的思想，是整个Spring的基础</p>
<p>对象创建权交给容器管理</p>
<ul>
<li>解决了什么问题</li>
</ul>
<p>解耦：解决对象间耦合的问题：通过接口注入对象，可以方便切换实现。</p>
<p>原本service需要各自创建不同dao对象，现在可以直接使用容器建好的对象。</p>
<p><strong>IOC vs DI</strong></p>
<p>DI（Dependency Injection）依赖注入是IOC的一种实现方式。</p>
<p>也可通过“依赖查找”(Dependency Lookup)解决</p>
<p>IOC：对象角度，对象实例化及管理权交给（反转）容器</p>
<p>DI：容器角度，容器会把对象依赖的其他对象注入（送进去）（例如对象的属性是个对象）</p>
<p><strong>依赖注入 vs 依赖查找</strong></p>
<p>实现控制反转两种方式：依赖注入和依赖查找</p>
<p>区别：</p>
<ul>
<li>依赖注入，@Autowired，被动接收对象，通过类型或名称判断将不同对象注入到不同属性中</li>
<li>依赖查找，beanFactory.getBean()，主动索取相应类型的对象，获得依赖对象的时间也可以在代码中自由控制</li>
</ul>
<h2 id="4、Spring-AOP"><a href="#4、Spring-AOP" class="headerlink" title="4、Spring AOP"></a>4、Spring AOP</h2><ul>
<li>什么是AOP（what）</li>
</ul>
<p>Aspect oriented Programming 面向切面编程&#x2F;面向方面编程</p>
<p>把通用无关代码做成切片，按需插入业务代码中。代理模式</p>
<p><img src="/images/SpringFrameWork_4.jpg" alt="AOP思想"></p>
<ul>
<li>解决了什么问题（why）</li>
</ul>
<p>不改变原有业务逻辑情况下，增强横切逻辑代码，根本上解耦合，避免横切逻辑代码重复</p>
<ul>
<li>如何解决的</li>
</ul>
<p>Java动态代理</p>
<h1 id="三、手写IOC实现"><a href="#三、手写IOC实现" class="headerlink" title="三、手写IOC实现"></a>三、手写IOC实现</h1><p>实现一个简单的DI容器的核心三个功能：配置解析、对象创建和对象生命周期管理</p>
<p>直播7一小时38</p>
<p>配置解析:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lsm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> XmlBeanConfigParser.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2022年07月15日 10:33:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XmlBeanConfigParser</span> <span class="keyword">implements</span> <span class="title class_">BeanConfigParser</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;BeanDefinition&gt; <span class="title function_">parse</span><span class="params">(InputStream inputStream)</span> &#123;</span><br><span class="line">        <span class="type">List</span> <span class="variable">beanDefinitions</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">DocumentBuilderFactory</span> <span class="variable">documentBuilderFactory</span> <span class="operator">=</span> DocumentBuilderFactory.newInstance();</span><br><span class="line">            <span class="type">DocumentBuilder</span> <span class="variable">documentBuilder</span> <span class="operator">=</span> documentBuilderFactory.newDocumentBuilder();</span><br><span class="line">            <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> documentBuilder.parse(inputStream);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> read it later, 关于 xml 为什么需要 normalize 一下</span></span><br><span class="line">            <span class="comment">//optional, but recommended</span></span><br><span class="line">            <span class="comment">//read this - http://stackoverflow.com/questions/13786607/normalization-in-dom-parsing-with-java-how-does-it-work</span></span><br><span class="line">            doc.getDocumentElement().normalize();</span><br><span class="line"></span><br><span class="line">            <span class="type">NodeList</span> <span class="variable">beanList</span> <span class="operator">=</span> doc.getElementsByTagName(<span class="string">&quot;bean&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; beanList.getLength(); i++) &#123;</span><br><span class="line">                <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> beanList.item(i);</span><br><span class="line">                <span class="keyword">if</span> (node.getNodeType() != Node.ELEMENT_NODE) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                <span class="type">Element</span> <span class="variable">element</span> <span class="operator">=</span> (Element) node;</span><br><span class="line">                <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>(</span><br><span class="line">                        element.getAttribute(<span class="string">&quot;id&quot;</span>),</span><br><span class="line">                        element.getAttribute(<span class="string">&quot;class&quot;</span>)</span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">if</span> (element.getAttribute(<span class="string">&quot;scope&quot;</span>).equals(<span class="string">&quot;singleton&quot;</span>))&#123;</span><br><span class="line">                    beanDefinition.setScope(BeanDefinition.Scope.SINGLETON);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (element.getAttribute(<span class="string">&quot;lazy-init&quot;</span>).equals(<span class="string">&quot;true&quot;</span>))&#123;</span><br><span class="line">                    beanDefinition.setLazyInit(<span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                loadConstructorArgs(</span><br><span class="line">                        element.getElementsByTagName(<span class="string">&quot;constructor-arg&quot;</span>),</span><br><span class="line">                        beanDefinition</span><br><span class="line">                );</span><br><span class="line">                beanDefinitions.add(beanDefinition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanDefinitions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadConstructorArgs</span><span class="params">(NodeList nodes, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nodes.getLength(); i++) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">item</span> <span class="operator">=</span> nodes.item(i);</span><br><span class="line">            <span class="keyword">if</span> (item.getNodeType() != Node.ELEMENT_NODE) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="type">Element</span> <span class="variable">element</span> <span class="operator">=</span> (Element) item;</span><br><span class="line"></span><br><span class="line">            BeanDefinition.<span class="type">ConstructorArg</span> <span class="variable">constructorArg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (!element.getAttribute(<span class="string">&quot;type&quot;</span>).isEmpty())&#123;</span><br><span class="line">                constructorArg = <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>.ConstructorArg.Builder()</span><br><span class="line">                        .setArg(element.getAttribute(<span class="string">&quot;value&quot;</span>))</span><br><span class="line">                        .setType(String.class)</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!element.getAttribute(<span class="string">&quot;ref&quot;</span>).isEmpty())&#123;</span><br><span class="line">                constructorArg = <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>.ConstructorArg.Builder()</span><br><span class="line">                        .setArg(element.getAttribute(<span class="string">&quot;ref&quot;</span>))</span><br><span class="line">                        .setRef(<span class="literal">true</span>)</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line">            beanDefinition.addConstructorArg(constructorArg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对象创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">createBean</span><span class="params">(BeanDefinition beanDefinition)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (beanDefinition.isSingleton()&amp;&amp;singletonObjects.containsKey(beanDefinition.getId()))&#123;</span><br><span class="line">            <span class="keyword">return</span> singletonObjects.get(beanDefinition.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//Class路径如何计算</span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">beanClass</span> <span class="operator">=</span> Class.forName(beanDefinition.getClassName());</span><br><span class="line">            List&lt;BeanDefinition.ConstructorArg&gt; constructorArgs = beanDefinition.getConstructorArgs();</span><br><span class="line">            <span class="keyword">if</span> (constructorArgs.isEmpty())&#123;</span><br><span class="line">                bean = beanClass.newInstance();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                Class[] argClasses = <span class="keyword">new</span> <span class="title class_">Class</span>[constructorArgs.size()];</span><br><span class="line">                Object[] argObjects = <span class="keyword">new</span> <span class="title class_">Object</span>[constructorArgs.size()];</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; constructorArgs.size(); i++) &#123;</span><br><span class="line">                    BeanDefinition.<span class="type">ConstructorArg</span> <span class="variable">arg</span> <span class="operator">=</span> constructorArgs.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (!arg.isRef())&#123;<span class="comment">//非引用资源</span></span><br><span class="line">                        argClasses[i] = arg.getType();</span><br><span class="line">                        argObjects[i] = arg.getArg();</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="type">BeanDefinition</span> <span class="variable">refbeanDefinition</span> <span class="operator">=</span> beanDefinations.get(arg.getArg());</span><br><span class="line">                        <span class="keyword">if</span> (refbeanDefinition == <span class="literal">null</span>)&#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchBeanDefinitionException</span>(<span class="string">&quot;Bean is not defined: &quot;</span> + arg.getArg());</span><br><span class="line">                        &#125;</span><br><span class="line">                        argObjects[i] = createBean(refbeanDefinition);</span><br><span class="line">                        argClasses[i] = argObjects[i].getClass();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                bean = beanClass.getConstructor(argClasses).newInstance(argObjects);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (ClassNotFoundException | InstantiationException | IllegalAccessException | NoSuchMethodException | InvocationTargetException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bean!=<span class="literal">null</span> &amp;&amp; beanDefinition.isSingleton())&#123;</span><br><span class="line">            singletonObjects.putIfAbsent(beanDefinition.getId(),bean);</span><br><span class="line">            <span class="keyword">return</span> singletonObjects.get(beanDefinition.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>对象生命周期管理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBeanDefinitions</span><span class="params">(List&lt;BeanDefinition&gt; beanDefinitionList)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (BeanDefinition beanDefinition : beanDefinitionList) &#123;</span><br><span class="line">            <span class="built_in">this</span>.beanDefinations.putIfAbsent(beanDefinition.getId(),beanDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (BeanDefinition beanDefinition : beanDefinitionList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanDefinition.isLazyInit() == <span class="literal">false</span> &amp;&amp; beanDefinition.isSingleton())&#123;</span><br><span class="line">                createBean(beanDefinition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>理解：懒加载先不创建对象，使用时创建。创建同时进行初始化</p>
<p>spring生命周期：创建阶段–&gt;初始化阶段–&gt;销毁阶段</p>
<p><strong>创建阶段</strong>：</p>
<ul>
<li>当<code>scope=&quot;singleton&quot;</code>：表示只创建一个对象（单例），Spring 工厂（IoC 容器）创建的同时，创建对象。</li>
<li>当<code>scope=&quot;prototype&quot;</code>：Spring 工厂在获取对象 <code>ctx.getBean(&quot;xxx&quot;)</code> 的同时，创建对象。</li>
</ul>
<p><strong>初始化阶段</strong>：</p>
<ul>
<li>InitializingBean接口</li>
<li>配置init-method</li>
</ul>
<p><strong>销毁阶段</strong>：</p>
<ul>
<li><p>DisposableBean 接口</p>
<p>实现<code>DisposableBean</code>接口，重写<code>destroy()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Product</span> <span class="keyword">implements</span> <span class="title class_">DisposableBean</span> &#123;</span><br><span class="line">    <span class="comment">// 程序员根据自己的需求, 定义销毁方法, 完成销毁操作</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Product.destroy&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 destroy-method</p>
<p>对象中提供一个普通的销毁方法，配置文件种配置<code>destroy-method</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Product</span> &#123;</span><br><span class="line">	<span class="comment">// 程序员根据自己的需求, 定义销毁方法, 完成销毁操作</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myDestory</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Product.myDestory&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;product&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.zqc.Product&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;myDestory&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="四、IOC应用"><a href="#四、IOC应用" class="headerlink" title="四、IOC应用"></a>四、IOC应用</h1><h2 id="1、BeanFactory与ApplicationContext区别"><a href="#1、BeanFactory与ApplicationContext区别" class="headerlink" title="1、BeanFactory与ApplicationContext区别"></a>1、BeanFactory与ApplicationContext区别</h2><p><img src="/images/SpringFrameWork_5.jpg" alt="继承关系"></p>
<p>ApplicationContext是具备应用特性的BeanFactory超集</p>
<p>ApplicationContext除了IoC容器角色，还有提供：</p>
<p>面向切面（AOP），配置元信息（Configuartion Metadata），资源管理（Resources），事件（Events），国际化（i18n），注解（Annotations），Environment抽象（Environment Abstraction）</p>
<h2 id="2、启动IOC容器的方式"><a href="#2、启动IOC容器的方式" class="headerlink" title="2、启动IOC容器的方式"></a>2、启动IOC容器的方式</h2><p>Java环境下启动：</p>
<p>ClassPathXmlApplicationContex：从类的根路径下加载配置文件（推荐使用）<br>FileSystemXmlApplicationContext：从磁盘路径上加载配置文件<br>AnnotationConfigApplicationContext：纯注解模式下启动Spring容器 </p>
<p>Web环境下启动：</p>
<p>基于web.xml</p>
<ul>
<li><p>使用方式</p>
<p><img src="/images/SpringFrameWork_6.jpg" alt="使用方式"></p>
</li>
<li><p>懒加载</p>
<p><img src="/images/SpringFrameWork_7.jpg" alt="懒加载"></p>
</li>
<li><p>FactoryBean&#x2F;BeanFactory区别</p>
<p><img src="/images/SpringFrameWork_8.jpg" alt="区别"></p>
</li>
<li><p>后置处理器</p>
<p>BeanPostProcessor bean对象实例化后做一些事</p>
<p>BeanFactoryPostProcessor工厂实例化后做一些事情</p>
</li>
</ul>
<blockquote>
<p>SpringBean生命周期（重点）<strong>（断点实操）</strong></p>
</blockquote>
<p><img src="/images/SpringFrameWork_9.jpg" alt="生命周期"></p>
<p>（1）根据配置情况调用Bean构造方法实例化bean</p>
<p>（2）使用依赖注入完成属性注入</p>
<p>（3）调用BeanNameAware的setBeanName()方法</p>
<p>（4）调用BeanFactoryAware的setBeanFactory()方法</p>
<p>（5）调用ApplicationContextAware的setApplicationContext()方法</p>
<p>（6）调用BeanPostProcessor的预始化方法</p>
<p>（7）执行@PostConstruct方法</p>
<p>（8）调用InitializatingBean的afterPropertiesSet()方法</p>
<p>（9）调用自定义init-method</p>
<p>（10）调用BeanPostProcessor的后初始化方法</p>
<p>（11）如果是singleton bean交给spring缓冲池，prototype返回调用者</p>
<p>（12）调用DispoableBean的destory方法</p>
<p>（13）调用@PreDestory destory-method</p>
<h2 id="3、其他依赖注入框架"><a href="#3、其他依赖注入框架" class="headerlink" title="3、其他依赖注入框架"></a>3、其他依赖注入框架</h2><p>java SE</p>
<ul>
<li>java Beans</li>
<li>Java ServiceLoader SPI</li>
<li>JNDI（Java Naming and Directory Interface）</li>
</ul>
<p>Java EE</p>
<ul>
<li>EJB（Enterprise Java Beans）</li>
<li>Servlet</li>
</ul>
<h1 id="五、IOC源码分析"><a href="#五、IOC源码分析" class="headerlink" title="五、IOC源码分析"></a>五、IOC源码分析</h1><p>源码分析方式</p>
<p>原则上：</p>
<ul>
<li>定焦原则：抓主线</li>
<li>宏观原则：站在上帝视角，关注架构，淡化细节</li>
</ul>
<p>技巧上：</p>
<ul>
<li>断点（观察调用栈）</li>
<li>反调（find usages）</li>
<li>经验（Spring中doXX具体处理的地方）</li>
</ul>
<h2 id="1、主流程（断点实操）"><a href="#1、主流程（断点实操）" class="headerlink" title="1、主流程（断点实操）"></a>1、主流程<strong>（断点实操）</strong></h2><p>org.springframework.context.support.AbstractApplicationContext#refresh</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">    	<span class="comment">//对象加锁</span></span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">            <span class="type">StartupStep</span> <span class="variable">contextRefresh</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.refresh&quot;</span>);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">            刷新前预处理</span></span><br><span class="line"><span class="comment">            设置Spring容器启动时间，</span></span><br><span class="line"><span class="comment">            开启活跃状态，撤销关闭状态</span></span><br><span class="line"><span class="comment">            验证环境里一些必须存在的属性等</span></span><br><span class="line"><span class="comment">            **/</span></span><br><span class="line">            <span class="built_in">this</span>.prepareRefresh();</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            获取BeanFactory;默认实现是DefaultListableBeanFactory加载BeanDefition并注册到BeanDefitionRegistory</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> <span class="built_in">this</span>.obtainFreshBeanFactory();</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            BeanFactory预准备工作（BeanFactory进行一些设置，比如context的类加载器等）</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="built_in">this</span>.prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                	BeanFactory准备工作完成后进行的后置处理工作</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="built_in">this</span>.postProcessBeanFactory(beanFactory);</span><br><span class="line">                <span class="type">StartupStep</span> <span class="variable">beanPostProcess</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.beans.post-process&quot;</span>);</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">               		实例化实现了BeanFactoryPostProcessor接口的Bean，并调用方法</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="built_in">this</span>.invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                	注册BeanPostProcessor（Bean的后置处理器），在创建bean的前后等执行</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="built_in">this</span>.registerBeanPostProcessors(beanFactory);</span><br><span class="line">                beanPostProcess.end();</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                	初始化MessageSource组件（做国际化功能；消息绑定，消息解析）</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="built_in">this</span>.initMessageSource();</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                	初始化事件派发器</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="built_in">this</span>.initApplicationEventMulticaster();</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                	子类重写这个方法，在容器刷新的时候可以自定义逻辑；如创建Tomcat，Jetty等WEB服务器</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="built_in">this</span>.onRefresh();</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">					注册应用的监听器。就是注册实现了ApplicationListener接口的监听器bean</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">                <span class="built_in">this</span>.registerListeners();</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">					初始化所有剩下的非懒加载的单例bean</span></span><br><span class="line"><span class="comment">					初始化创建非懒加载方式的单例Bean实例（未设置属性）</span></span><br><span class="line"><span class="comment">                    填充属性</span></span><br><span class="line"><span class="comment">                    初始化方法调用（比如调用afterPropertiesSet方法、init-method方法）</span></span><br><span class="line"><span class="comment">                    调用BeanPostProcessor（后置处理器）对实例bean进行后置处理</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">                <span class="built_in">this</span>.finishBeanFactoryInitialization(beanFactory);</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">					完成context的刷新。主要是调用LifecycleProcessor的onRefresh()方法，并且发布事件（ContextRefreshedEvent）</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">                <span class="built_in">this</span>.finishRefresh();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (BeansException var10) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.logger.isWarnEnabled()) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.logger.warn(<span class="string">&quot;Exception encountered during context initialization - cancelling refresh attempt: &quot;</span> + var10);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">this</span>.destroyBeans();</span><br><span class="line">                <span class="built_in">this</span>.cancelRefresh(var10);</span><br><span class="line">                <span class="keyword">throw</span> var10;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.resetCommonCaches();</span><br><span class="line">                contextRefresh.end();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="2、懒加载"><a href="#2、懒加载" class="headerlink" title="2、懒加载"></a>2、懒加载</h2><p>初始化bean时会判断lazy-init这个字段</p>
<p>getBean时才创建AbstractBeanFactory.doGetBean()</p>
<h2 id="3、Spring循环依赖解决"><a href="#3、Spring循环依赖解决" class="headerlink" title="3、Spring循环依赖解决"></a>3、Spring循环依赖解决</h2><h3 id="（1）产生的原因"><a href="#（1）产生的原因" class="headerlink" title="（1）产生的原因"></a>（1）产生的原因</h3><p>循环依赖就是2个或以上的bean，对象的属性相互依赖形成环，造成死循环，无法构建成功</p>
<p><img src="/images/SpringFrameWork_10.jpg" alt="循环依赖"></p>
<h3 id="（2）解决循环依赖"><a href="#（2）解决循环依赖" class="headerlink" title="（2）解决循环依赖"></a>（2）解决循环依赖</h3><p>无法解决</p>
<p>①单例bean构造器参数循环依赖（无法解决）</p>
<p>②prototype原型bean循环依赖（无法解决）</p>
<p>可以自动解决</p>
<p>①单例的bean set注入或者@Autowired</p>
<h3 id="（3）解决方案（画时序图、断点实操）"><a href="#（3）解决方案（画时序图、断点实操）" class="headerlink" title="（3）解决方案（画时序图、断点实操）"></a>（3）解决方案<strong>（画时序图、断点实操）</strong></h3><blockquote>
<p><strong>使用三级缓存</strong>，整体思路把创建一半的对象放入缓存中</p>
</blockquote>
<p>解决过程</p>
<p>BeanA&lt;–&gt;BeanB循环依赖</p>
<p>①实例化A把自己放入三级缓存，发现A依赖B，去创建B</p>
<p>②B的创建过程中发现依赖A，去三级缓存找A，放入二级缓存</p>
<p>③升级过程中可以自定义扩展</p>
<p>④B构建完整放入，一级缓存，完成创建</p>
<p>⑤A从一级缓存找B，完成创建</p>
<p><img src="/images/SpringFrameWork_11.jpg" alt="三级缓存"></p>
<p><img src="/images/SpringFrameWork_12.jpg" alt="时序图"></p>
<h1 id="六、AOP应用"><a href="#六、AOP应用" class="headerlink" title="六、AOP应用"></a>六、AOP应用</h1><p>术语</p>
<ul>
<li>JoinPoint连接点：每个方法的特殊时期都是连接点</li>
<li>PointCut切入点：真正感兴趣的方法</li>
<li>Advice增强：增强逻辑+访问信息</li>
<li>Target目标对象</li>
<li>Proxy代理对象</li>
<li>Weaving织入</li>
<li>Aspect切面：切面&#x3D;切入点+增强&#x3D;切入点+横切逻辑+方位信息</li>
</ul>
<p>使用方式</p>
<p>①xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;logAspect&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;beanId&quot;</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">aop:poingcut</span> <span class="attr">id</span>=<span class="string">&quot;pt1&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">methos</span>=<span class="string">&quot;before-method&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pt1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:before</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">aop:poingcut</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>②xml+注解</p>
<ul>
<li>@Aspect</li>
<li>@Pointcut</li>
<li>@Before</li>
<li>@After</li>
<li>@Around</li>
<li>@AfterThrowing</li>
<li>@AfterReturning</li>
<li>&lt;aop:aspectj-autoproxy proxy-target-class&#x3D;”true”&gt;为true使用cglib</li>
</ul>
<p>③注解</p>
<p>​	@EnableAspectJAutoProxy</p>
<h1 id="七、AOP源码分析"><a href="#七、AOP源码分析" class="headerlink" title="七、AOP源码分析"></a>七、AOP源码分析</h1><blockquote>
<p>AOP基于BeanPostProcessor+动态代理实现（cglib&#x2F;jdk）。生成代理类的实例注入到工厂中</p>
</blockquote>
<p>代理类创建流程</p>
<p>AOP创建Proxy对象的地方有两个：</p>
<ul>
<li>常规bean的就是在BeanFactory.initializeBean()方法里面调用初始化方法后，调用applyBeanPostProcessorsAfterInitialization() –&gt;AbstractAutoProxyCreator.wrapIfNecessary()生成proxy对象。</li>
<li>还有就是在存在循环依赖的时候，在doCreateBean()–&gt;addSingletonFactory(beanName,()–&gt;getEarlyBeanReference(beanName,mbd,bean));–&gt;然后再getSingleton()的时候从三级缓存中取对象的时候，会调用getEarlyBeanReference()–&gt;AbstractAutoProxyCreator.wrapIfNecessary()生成proxy对象</li>
</ul>
<p>常规流程：</p>
<h1 id="八、声明式事务"><a href="#八、声明式事务" class="headerlink" title="八、声明式事务"></a>八、声明式事务</h1><p><strong>使用方式</strong></p>
<p>可以使用xml,xml+注解，注解三种形式使用</p>
<ul>
<li>xml或者注解实现事务控制</li>
<li>PlatformTransactionManager事务处理接口</li>
<li>xml模式<ul>
<li>&lt;bean id&#x3D;”transactionManager” class&#x3D;”org.springframework.jdbc.DataSourceTransactionManager” &gt;</li>
<li>&lt;tx:advice&gt;</li>
</ul>
</li>
<li>xml+注解<ul>
<li>&lt;tx:annataion-driven transaction-manager&#x3D;”transactionManager”&gt;</li>
<li>@Transaction</li>
</ul>
</li>
<li>注解<ul>
<li>@EnableTransactionManagement</li>
</ul>
</li>
</ul>
<p><strong>源码分析</strong></p>
<p>下面以注解的形式分析源码</p>
<p>入口为@ENableTransactionManagement注解，@Transactional为使用测。</p>
<p><strong>声明式事务基于AOP实现</strong></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6/" rel="tag">框架</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%A7%81%E6%95%99/" rel="tag">私教</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-java并发编程实战笔记"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/07/06/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/"
    >java并发编程实战</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/07/06/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/" class="article-date">
  <time datetime="2022-07-06T02:29:00.000Z" itemprop="datePublished">2022-07-06</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="第一部分-基础知识"><a href="#第一部分-基础知识" class="headerlink" title="第一部分 基础知识"></a>第一部分 基础知识</h2><h3 id="第二章-线程安全性"><a href="#第二章-线程安全性" class="headerlink" title="第二章 线程安全性"></a>第二章 线程安全性</h3><h4 id="2-1-什么是线程安全性"><a href="#2-1-什么是线程安全性" class="headerlink" title="2.1 什么是线程安全性"></a>2.1 什么是线程安全性</h4><p>当多个线程访问某个类时，这个类始终都能表现出正确的行为，这个类就是线程安全的。</p>
<h4 id="2-2-原子性"><a href="#2-2-原子性" class="headerlink" title="2.2 原子性"></a>2.2 原子性</h4><p>（1）竞态条件</p>
<p>在并发编程中，由于不恰当的执行时序儿出现不正确的结果是一种非常重要的情况，他有一个正式的名字：竞态条件（RaceCondition）</p>
<p>延迟初始化</p>
<p>目的：将对象初始化操作推迟到实际被使用才进行（类似于懒汉式）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyInitRace</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ExpensiveObject</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ExpensiveObject <span class="title function_">getInstance</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="literal">null</span>)</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">ExpensiveObject</span></span><br><span class="line">        <span class="keyword">return</span> instance;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存在竞态条件，线程A和线程B同时执行getInstance，同时判断instance为null,同时实例化对象，获得两个不同的对象。</p>
<p>（2）复合操作</p>
<p>避免竞态条件，必须在某个线程修改该变量式，通过某种方式防止其他线程使用这个变量，确保其他线程只能在修改操作完成前后进行读取和修改。</p>
<p>在java.util.concurrent.atomic包中包含了一些原子变量，用于实现在数值和对象引用上的原子状态转换。</p>
<p>例如，可以用AtomicLong来代替long类型的计数器，确保状态的访问操作都是原子的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">实际情况中，尽可能使用线程安全对象（AutomicLong）来管理类的状态。与非线程安全的对象相比，更易维护和验证线程安全性。</span><br></pre></td></tr></table></figure>

<h4 id="2-3-加锁机制"><a href="#2-3-加锁机制" class="headerlink" title="2.3 加锁机制"></a>2.3 加锁机制</h4><p>如果使用多个线程安全对象。当在不变性条件中涉及多个变量时，各个变量之间并不是彼此独立的，而是某个变量的值会对其他变量的值产生约束。因此当更新某一变量时，需要在同一个原子操作中对其他变量同时进行更新。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">要保持状态一致性，就需要在单个原子操作中更新所有相关的状态变量。</span><br></pre></td></tr></table></figure>

<p>（1）内置锁</p>
<p>同步代码块（Synchronized Block）</p>
<p>两部分：一个作为锁的对象引用，一个作为由这个锁保护的代码块。</p>
<p>（2）重入</p>
<p>如果某个线程试图获得一个已经由他自己持有的锁，那么这个请求就会成功。</p>
<p>实现方式，为每个锁关联一个获取计数值和一个所有者线程。计数为0，表示未被任何线程持有。当线程请求一个未被持有的锁时，JVM将记下锁的持有者，并且将计数值置为1.如果同一线程再次获取，计数值将递增，当线程退出代码块，计数值递减。计数值为0时，释放锁。</p>
<h4 id="2-4-用锁来保护状态"><a href="#2-4-用锁来保护状态" class="headerlink" title="2.4 用锁来保护状态"></a>2.4 用锁来保护状态</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">每个共享的和可变的变量都应该只由一个锁来保护，从而使维护人员知道是哪一个锁。</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">对于每个包含多个变量的不变性条件，其中涉及的所有变量需要由同一个锁来保护。</span><br></pre></td></tr></table></figure>

<h4 id="2-5-活跃性与性能"><a href="#2-5-活跃性与性能" class="headerlink" title="2.5 活跃性与性能"></a>2.5 活跃性与性能</h4><p>对于在单个变量上实现原子操作来说，原子变量（AtomicLong）是很有用的，但如果已经使用了同步代码块（synchronized）来构造原子操作，而使用两种不同的同步机制不仅会带来混乱，也不会在性能或安全上带来任何好处，这里不推荐使用原子变量。</p>
<p>简单性：对整个方法进行同步</p>
<p>并发性：对尽可能短的代码路径进行同步</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当执行时间较长的计算或者可能无法快速完成的操作时（例如，网络I/O或控制台I/O），一定不要有锁</span><br></pre></td></tr></table></figure>

<h3 id="第三章-对象的共享"><a href="#第三章-对象的共享" class="headerlink" title="第三章 对象的共享"></a>第三章 对象的共享</h3><h4 id="3-1可见性"><a href="#3-1可见性" class="headerlink" title="3.1可见性"></a>3.1可见性</h4><p>重排序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在没有同步的情况下，编译器、处理器以及运行时等都可能对操作的执行顺序进行一些意想不到的调整。</span><br></pre></td></tr></table></figure>

<p>只有数据在多个线程之间共享，就使用正确的同步。</p>
<p>（1）失效数据</p>
<p>一个线程可能获得某个变量的最新值，而获得另一个变量的失效值。</p>
<p>（2）非原子的64位操作</p>
<p>最低安全性：获得的失效值至少是由之前某个线程设置的值，而不是一个随机值。</p>
<p>非volatile类型的64位数值变量（double和long）</p>
<p>jvm允许将64位的读操作或写操作分解为两个32位的操作。当读取一个非volatile类型的long变量时，如果对该变量的读操作和写操作在不同的线程中执行，那么很可能会读取到某个值的高32位和另一个值的低32位。</p>
<p>（3）加锁与可见性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">加锁的含义不仅仅局限于互斥行为，还包括内存可见性。为了确保所有线程都能看到共享变量的最新值，所有执行读操作或者写操作的线程都必须在同一个锁上同步。</span><br></pre></td></tr></table></figure>

<p>（4）Volatile变量</p>
<p>Java语言提供了一种稍弱的同步机制，即volatile变量，用来确保更新操作通知到其他线程。</p>
<p>比sychronized关键字更轻量级的同步机制</p>
<p>volatile变量通常用作某个操作完成、发生中断或者状态的标志。volatile的语义不足以确保递增操作（count++）的原子性，除非你能确保只有一个线程对变量执行写操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">加锁机制既可以确保可见性又可以确保原子性，而volatile变量只能确保可见性。</span><br></pre></td></tr></table></figure>

<p>当且仅当满足一下所有条件时，才应该使用volatile变量：</p>
<ul>
<li>对变量的写入操作不依赖变量的当前值，或者你能确保只有单个线程更新变量的值</li>
<li>该变量不会与其他状态变量一起纳入不变性条件中</li>
<li>在访问变量时不需要加锁</li>
</ul>
<h4 id="3-2发布与逸出"><a href="#3-2发布与逸出" class="headerlink" title="3.2发布与逸出"></a>3.2发布与逸出</h4><p>发布Publish：使对象能够在当前作用域之外的代码中使用。</p>
<p>例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Secret&gt; knownSecrets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span>&#123;</span><br><span class="line">    knowSecrets = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Secret&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>逸出Escape：当某个不该发布的对象被发布时。</p>
<p>例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UnsafeStates</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String[] states = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">        <span class="string">&quot;AK&quot;</span>,<span class="string">&quot;AL&quot;</span> ...</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">public</span> String[] getStates()&#123;<span class="keyword">return</span> states;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>任何调用者都可以修改数组内容。</p>
<p>使用封装的主要原因：封装能够使得对程序的正确性进行分析变得可能，并使得无意中破坏涉及约束条件变得更难。</p>
<p>安全的对象构造过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SafeListener</span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> EventListener listener;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">SafeListener</span><span class="params">()</span>&#123;</span><br><span class="line">        listener = <span class="keyword">new</span> <span class="title class_">EventListener</span>()&#123;</span><br><span class="line">          <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(Event e)</span>&#123;</span><br><span class="line">              doSomething(e);</span><br><span class="line">          &#125;  </span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-3线程封闭"><a href="#3-3线程封闭" class="headerlink" title="3.3线程封闭"></a>3.3线程封闭</h4><p>避免同步，不共享数据，如果仅在单线程内访问数据，就不需要同步。</p>
<p>线程封闭技术常用场景：</p>
<ul>
<li>Swing的可视化组件和数据模型对象</li>
<li>JDBC的Connection对象</li>
</ul>
<p>（1）Ad-hoc线程封闭</p>
<p>​	维护线程封闭性的职责完全由程序实现来承担。</p>
<p>（2）栈封闭</p>
<p>​	只能通过局部变量访问对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">loadTheArk</span><span class="params">(Collection&lt;Animal&gt; candidates)</span>&#123;</span><br><span class="line">	SortedSet&lt;Animal&gt; animals;</span><br><span class="line">    <span class="type">int</span> <span class="variable">numPairs</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">Animal</span> <span class="variable">candidate</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//animals被封闭在方法中，不要使他们逸出！</span></span><br><span class="line">    animals = <span class="keyword">new</span> <span class="title class_">TreeSet</span>&lt;Animal&gt;(<span class="keyword">new</span> <span class="title class_">SpeciesGenderComparator</span>());</span><br><span class="line">    animals.addAll(candidates);</span><br><span class="line">    <span class="keyword">for</span>(Animal a : animals)&#123;</span><br><span class="line">        <span class="keyword">if</span>(candidate == <span class="literal">null</span> || !candidate.isPotentialMate(a))</span><br><span class="line">            candidate = a;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            ark.load(<span class="keyword">new</span> <span class="title class_">AnimalPair</span>(candidate,a));</span><br><span class="line">            ++numPairs;</span><br><span class="line">            candidate = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只有一个引用指向集合animals，这个引用被封闭在局部变量中，因此也被封闭在执行线程中。</p>
<p>（3）ThreadLocal类</p>
<p>更规范的方式</p>
<p>ThreadLocal能使线程中的某个值与保存值的对象关联起来。</p>
<p>提供了get与set方法，为每个使用该变量的线程都存有一份独立的副本，因此get总是返回由当前执行线程在调用set时设置的最新值。</p>
<p>线程与值绑定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;Connection&gt; connectionHolder</span><br><span class="line">    = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Connection&gt;()&#123;</span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">initialValue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DriverManager.getConnection(DB_URL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> connectionHolder.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当某个线程初次调用ThreadLocal.get方法时，就会调用initialValue来获取初始值。</p>
<p>ThreadLocal&lt;T&gt;视为包含了Map&lt;Thread,T&gt;对象，保存了特定于该线程的值，但ThreadLocal的实现并非如此。线程终止后，值会作为垃圾回收。</p>
<h4 id="3-4不变性"><a href="#3-4不变性" class="headerlink" title="3.4不变性"></a>3.4不变性</h4><p><strong>不可变对象</strong>：某个对象在被创建后其状态就不能被修改。</p>
<p>不可变对象一定是线程安全的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">当满足以下条件时，对象才是不可变的:</span><br><span class="line">- 对象创建以后其状态就不能修改</span><br><span class="line">- 对象的所有域都是final类型.</span><br><span class="line">- 对象是正确创建的（在对象的创建期间，this引用没有逸出）。</span><br></pre></td></tr></table></figure>

<p>例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Immutable</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ThreeStooges</span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; stooges = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThreeStooges</span><span class="params">()</span>&#123;</span><br><span class="line">        stooges.add(<span class="string">&quot;Moe&quot;</span>);</span><br><span class="line">        stooges.add(<span class="string">&quot;Larry&quot;</span>);</span><br><span class="line">        stooges.add(<span class="string">&quot;Curly&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isStooge</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stooges.contains(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@immutable不可变类</span><br><span class="line">状态不会改变，每次修改都是创建新的对象。</span><br></pre></td></tr></table></figure>

<p>（1）Final域</p>
<p>final类型的域是不能修改的（但如果final域所引用的对象是可变的，那么这些被引用的对象是可以修改的）</p>
<p>final域能确保初始化过程的安全性，从而可以不受限制的访问不可变对象，并在共享这些对象时无需同步。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">编程习惯</span><br><span class="line">除非需要更高的可见性，否则应将所有的域都声明为私有域。</span><br><span class="line">除非某个域是可变的，否则应将其声明为final域。</span><br></pre></td></tr></table></figure>

<p>（2）使用Volatile类型来发布不可变对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Immutable</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OneValueCache</span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> BigInteger lastNumber;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BigInteger[] lastFactors;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OneValueCache</span><span class="params">(BigInteger i,</span></span><br><span class="line"><span class="params">                        BigInteger[] factors)</span>&#123;</span><br><span class="line">        lastNumber = i;</span><br><span class="line">        lastFactors = Arrays.copyOf(factors,factors.length);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> BigInteger[] getFactors(BigInteger i)&#123;</span><br><span class="line">        <span class="keyword">if</span>(lastNumber == <span class="literal">null</span> || !lastNumber.equals(i))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> Arrays.copyOf(lastFactors,lastFactors.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用指向不可变容器对象的volatile类型引用以缓存最新的结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VolatileCachedFactorizer</span> <span class="keyword">implements</span> <span class="title class_">Servlet</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">OneValueCache</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OneValueCache</span>(<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest req,ServletResponse resp)</span>&#123;</span><br><span class="line">        <span class="type">BigInteger</span> <span class="variable">i</span> <span class="operator">=</span> extractFromRequest(req);</span><br><span class="line">        BigInteger[] factors = cache.getFactors(i);</span><br><span class="line">        <span class="keyword">if</span>(factors == <span class="literal">null</span>)&#123;</span><br><span class="line">            factors = factor(i);</span><br><span class="line">            cache = <span class="keyword">new</span> <span class="title class_">OneValueCache</span>(i,factors);</span><br><span class="line">        &#125;</span><br><span class="line">        encodIntoResponse(resp,factors);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-5安全发布"><a href="#3-5安全发布" class="headerlink" title="3.5安全发布"></a>3.5安全发布</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Holder holder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span>&#123;</span><br><span class="line">	holder = <span class="keyword">new</span> <span class="title class_">Holder</span>(<span class="number">42</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存在可见性问题，其他线程看到的Holder对象处于不一致的状态。</p>
<p>（1）不正确的发布：正确的对象被破坏</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Holder</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> n;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Holder</span><span class="params">(<span class="type">int</span> n)</span>&#123; <span class="built_in">this</span>.n = n;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">assertSanity</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(n!=n)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(<span class="string">&quot;This statement is false.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于没有使用同步来确保Holder对象对其他线程可见，因此将Holder称为“未被正确发布”。</p>
<p>两个问题：</p>
<p>1.除了发布对象的线程外，其他线程可以看到的Holder域是一个失效值，因此将看到一个空引用或之前的旧值。</p>
<p>2.线程看到Holder引用的值是最新的，但Holder状态的值是失效的。</p>
<p>某个线程可能第一次读取失效的值，再次读取获得更新至导致n！&#x3D;n。</p>
<p>（2）不可变对象与初始化安全性</p>
<p>Java内存模型为不可变对象的共享提供了一种特殊的初始化安全性保证。）</p>
<p>即使在发布不可变对象的引用时没有使用同步，也仍可以安全地访问该对象。为了维持这种初始化安全性保证，必须满足不可变性地所有需求：</p>
<p>状态不可修改，所有域都是final类型，以及正确地构造过程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">任何线程都可以在不需要额外同步的情况下安全地访问不可变对象，即使在发布这些对象时没有使用同步</span><br></pre></td></tr></table></figure>



<p>（3）安全发布的常用模式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">要安全地发布一个对象，对象地引用以及对象的状态必须同时对其他线程可见。一个正确构造的对象可以通过以下方式来安全地发布：</span><br><span class="line">- 在静态初始化函数中初始化一个对象引用。</span><br><span class="line">- 将对象的引用保存到volatile类型的域或者AtomicReferance对象中</span><br><span class="line">- 将对象的引用保存到某个正确构造对象的final类型域中</span><br><span class="line">- 将对象的引用保存到一个由锁保护的域中</span><br></pre></td></tr></table></figure>



<p>（4）事实不可变对象</p>
<p>发布后不会被修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在没有额外的同步的情况下，任何线程都可以安全地使用被安全发布的事实不可变对象</span><br></pre></td></tr></table></figure>

<p>例如</p>
<p>用户登录，将Date存入Map，之后不会改变，就是事实不可变对象</p>
<p>（5）可变对象</p>
<p>如果对象在构造后可以修改，那么安全发布只能确保”发布当时“状态可见性。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">对象的发布需求取决于它的可变性：</span><br><span class="line">- 不可变对象可以通过任意机制来发布</span><br><span class="line">- 事实不可变对象必须通过安全方式来发布</span><br><span class="line">- 可变对象必须通过安全方式来发布，并且必须是线程安全的或者由某个锁保护起来。</span><br></pre></td></tr></table></figure>



<p>（6）安全的共享对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">并发程序中使用和共享对象时，可以使用一些实用的策略，包括：</span><br><span class="line">	线程封闭。线程封闭的对象只能由一个线程拥有，对象被封闭在该线程中，并且只能由这个线程修改。</span><br><span class="line">	只读共享，没有额外同步的情况下，共享的只读对象可以由多个线程并发访问，但任何线程不能修改。共享的只读对象包括不可变对象和事实不可变对象。</span><br><span class="line">	线程安全共享。线程安全的对象在其内部实现同步，因此多个线程可以通过对象的公有接口来进行访问，不需要进一步的同步。</span><br><span class="line">	保护对象。被保护的对象只能通过持有特定的锁来访问。保护对象包括封装在其他线程安全对象中的对象，以及已发布的并且由某个特定锁保护的对象。</span><br></pre></td></tr></table></figure>

<h3 id="第四章-对象的组合"><a href="#第四章-对象的组合" class="headerlink" title="第四章 对象的组合"></a>第四章 对象的组合</h3><h4 id="4-1设计线程安全的类"><a href="#4-1设计线程安全的类" class="headerlink" title="4.1设计线程安全的类"></a>4.1设计线程安全的类</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在设计线程安全类的过程中，需要包含以下三个基本要素：</span><br><span class="line">- 找出构成对象状态的所有变量。</span><br><span class="line">- 找出约束状态变量的不变性条件。</span><br><span class="line">- 建立对象状态的并发访问管理策略。</span><br></pre></td></tr></table></figure>

<p>分析对象状态首先从对象的域开始。如果对象中所有的域都是基本类型的变量，那么这些域将构成对象的全部状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Counter</span>&#123;</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span> <span class="keyword">private</span> <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">getValue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">increment</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(value == Long.MAX_VALUE)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;counter overflow&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ++value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="（1）收集同步需求"><a href="#（1）收集同步需求" class="headerlink" title="（1）收集同步需求"></a>（1）收集同步需求</h5><p>对象与变量都有一个状态空间，即所有可能的取值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果不了解对象的不变性条件与后验条件，那么就不能确保线程安全性。要满足在状态变量的有效值或状态转换上的各种约束条件，就需要借助于原子性与封装性。</span><br></pre></td></tr></table></figure>



<h5 id="（2）依赖状态的操作"><a href="#（2）依赖状态的操作" class="headerlink" title="（2）依赖状态的操作"></a>（2）依赖状态的操作</h5><p>类的不变性条件与后验条件约束了在对象上有哪些状态和状态转换是有效。</p>
<p>如果在某个操作中包含有基于状态的先验条件，这个操作称为依赖状态的操作。</p>
<h5 id="（3）状态的所有权"><a href="#（3）状态的所有权" class="headerlink" title="（3）状态的所有权"></a>（3）状态的所有权</h5><p>容器类通常表现出一种“所有权分离”的形式，其中容器类拥有其自身的状态，而客户代码则拥有容器中各个对象的状态。</p>
<p>例如 Servlet框架中的ServletContext</p>
<p>容器中存储的对象，与所有共享对象一样，它们必须安全地被共享。为了防止多个线程在并发访问同一个对象时产生的相互干扰，这些对象要么是线程安全的对象，要么是事实不可变的对象，或者由锁来保护的对象。</p>
<h4 id="4-2-实例封闭"><a href="#4-2-实例封闭" class="headerlink" title="4.2 实例封闭"></a>4.2 实例封闭</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将数据封装在对象内部，可以将数据的访问限制在对象的方法上，从而更容易确保线程在访问数据时总能持有正确的锁。</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PersonSet</span>&#123;</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Person&gt; mySet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Person&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">addPerson</span><span class="params">(Person p)</span>&#123;</span><br><span class="line">        mySet.add(p);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">containsPerson</span><span class="params">(Person p)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mySet.contains(p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过封闭机制确保线程安全</p>
<ul>
<li>封闭机制更易于构造线程安全的类，因为当封闭类的状态时，在分析类的线程安全性时就无需检查整个程序。</li>
</ul>
<h5 id="（1）Java监视器模式"><a href="#（1）Java监视器模式" class="headerlink" title="（1）Java监视器模式"></a>（1）Java监视器模式</h5><p>遵循Java监视器模式的对象会把对象的所有可变状态都封装起来，并由对象自己的内置锁来保护。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivateLock</span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">myLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;myLock&quot;)</span> Widget widget;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">someMethod</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(myLock)&#123;</span><br><span class="line">            <span class="comment">//访问或修改Widget的状态</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用私有的锁对象</p>
<p>优点：私有的锁对象可以将锁封装起来，使客户代码无法得到锁。</p>
<p>（2）实例：车辆追踪</p>
<p>基于监视器模式的车辆追踪</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MonitorVehicleTracking</span> &#123;</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String,MutablePoint&gt; locations;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MonitorVehicleTracking</span><span class="params">(Map&lt;String, MutablePoint&gt; locations)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.locations = deepCopy(locations);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> MutablePoint <span class="title function_">getLocation</span><span class="params">(String id)</span>&#123;</span><br><span class="line">        <span class="type">MutablePoint</span> <span class="variable">loc</span> <span class="operator">=</span> locations.get(id);</span><br><span class="line">        <span class="type">return</span> <span class="variable">loc</span> <span class="operator">=</span>= <span class="literal">null</span> ? <span class="literal">null</span> : <span class="keyword">new</span> <span class="title class_">MutablePoint</span>(loc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setLocation</span><span class="params">(String id,<span class="type">int</span> x,<span class="type">int</span> y)</span>&#123;</span><br><span class="line">        <span class="type">MutablePoint</span> <span class="variable">loc</span> <span class="operator">=</span> locations.get(id);</span><br><span class="line">        <span class="keyword">if</span> (loc == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;NO SUCH ID: &quot;</span>+id);</span><br><span class="line">        loc.x = x;</span><br><span class="line">        loc.y = y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String,MutablePoint&gt; <span class="title function_">deepCopy</span><span class="params">(Map&lt;String,MutablePoint&gt; m)</span>&#123;</span><br><span class="line">        Map&lt;String,MutablePoint&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String id : m.keySet()) &#123;</span><br><span class="line">            result.put(id,<span class="keyword">new</span> <span class="title class_">MutablePoint</span>(m.get(id)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableMap(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MutablePoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> x,y;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MutablePoint</span><span class="params">()</span>&#123;x=<span class="number">0</span>;y=<span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MutablePoint</span><span class="params">(MutablePoint p)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.x = p.x;</span><br><span class="line">        <span class="built_in">this</span>.y = p.y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过在返回客户代码之前复制可变的数据来稳吃线程安全性。</p>
<p>缺点：车辆容器非常大的情况下将极大地降低性能。</p>
<h4 id="4-3线程安全性的委托"><a href="#4-3线程安全性的委托" class="headerlink" title="4.3线程安全性的委托"></a>4.3线程安全性的委托</h4><h5 id="（1）实例：基于委托的车辆追踪其"><a href="#（1）实例：基于委托的车辆追踪其" class="headerlink" title="（1）实例：基于委托的车辆追踪其"></a>（1）实例：基于委托的车辆追踪其</h5><h5 id="（2）独立的状态变量"><a href="#（2）独立的状态变量" class="headerlink" title="（2）独立的状态变量"></a>（2）独立的状态变量</h5><h5 id="（3）当委托失效时"><a href="#（3）当委托失效时" class="headerlink" title="（3）当委托失效时"></a>（3）当委托失效时</h5><h5 id="（4）发布底层的状态变量"><a href="#（4）发布底层的状态变量" class="headerlink" title="（4）发布底层的状态变量"></a>（4）发布底层的状态变量</h5><h5 id="（5）示例：发布状态的车辆追踪其"><a href="#（5）示例：发布状态的车辆追踪其" class="headerlink" title="（5）示例：发布状态的车辆追踪其"></a>（5）示例：发布状态的车辆追踪其</h5><h4 id="4-4-在现有的线程安全类中添加功能"><a href="#4-4-在现有的线程安全类中添加功能" class="headerlink" title="4.4 在现有的线程安全类中添加功能"></a>4.4 在现有的线程安全类中添加功能</h4><p>重用能降低开发工作量、开发风险（因为现有的类都已经通过测试）以及维护成本。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BetterVector</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">Vector</span>&lt;E&gt;&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">putIfAbsent</span><span class="params">(E x)</span>&#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">absent</span> <span class="operator">=</span> !cotains(x);</span><br><span class="line">        <span class="keyword">if</span>(absent)</span><br><span class="line">            add(x);</span><br><span class="line">        <span class="keyword">return</span> absent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="（1）客户端加锁机制"><a href="#（1）客户端加锁机制" class="headerlink" title="（1）客户端加锁机制"></a>（1）客户端加锁机制</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ListHelper</span>&lt;E&gt;&#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;E&gt; list = Collections.synchronizedList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;E&gt;());</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">putIfAbsent</span><span class="params">(E x)</span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(list)&#123;</span><br><span class="line">        	<span class="type">boolean</span> <span class="variable">absent</span> <span class="operator">=</span> !list.contains(x);</span><br><span class="line">        	<span class="keyword">if</span>(absent)</span><br><span class="line">            	list.add(x);</span><br><span class="line">        	<span class="keyword">return</span> absent;    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过添加一个原子操作来扩展类是脆弱的，因为它将类的加锁代码分布到多个类中。</p>
<p>客户端加锁会破坏同步策略的封装性。</p>
<h5 id="（2）组合"><a href="#（2）组合" class="headerlink" title="（2）组合"></a>（2）组合</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImprovedList</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">List</span>&lt;T&gt;&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;T&gt; list;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ImprovedList</span><span class="params">(List&lt;T&gt; list)</span>&#123;<span class="built_in">this</span>.list = list;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">putIfAbsent</span><span class="params">(T x)</span>&#123;</span><br><span class="line">        <span class="type">booelan</span> <span class="variable">contains</span> <span class="operator">=</span> list.contains(x);</span><br><span class="line">        <span class="keyword">if</span>(contains)</span><br><span class="line">            list.add(x);</span><br><span class="line">        <span class="keyword">return</span> !contains;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span>&#123;list.clear();&#125;</span><br><span class="line">    <span class="comment">//...按照类似的方式委托List其他方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并不关心底层的List是否是线程安全的，即使List不是线程安全的或者修改了它的加锁实现，ImprovedList也会提供一致的加锁机制来实现线程安全性。</p>
<h4 id="4-5-将同步策略文档化"><a href="#4-5-将同步策略文档化" class="headerlink" title="4.5 将同步策略文档化"></a>4.5 将同步策略文档化</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在文档中说明客户代码需要了解的线程安全性保证，以及代码维护人员需要了解的同步策略</span><br></pre></td></tr></table></figure>

<h3 id="第五章-基础构建模块"><a href="#第五章-基础构建模块" class="headerlink" title="第五章 基础构建模块"></a>第五章 基础构建模块</h3><h4 id="5-1-同步容器类"><a href="#5-1-同步容器类" class="headerlink" title="5.1 同步容器类"></a>5.1 同步容器类</h4><p>同步容器类包括Vector和Hashtable</p>
<p>Collections.synchronizedXxx等工厂方法创建同步的封装器类</p>
<p>这些类实现线程安全的方式是：将它们的状态封装起来，并对每个公有方法都进行同步，使得每次只有一个线程能访问容器的状态。</p>
<h5 id="（1）同步容器类的问题"><a href="#（1）同步容器类的问题" class="headerlink" title="（1）同步容器类的问题"></a>（1）同步容器类的问题</h5><p>同步线程类是线程安全的，但在某些情况下可能需要额外的客户端加锁来保护复合操作。</p>
<p>例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getLast</span><span class="params">(Vector list)</span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">lastIndex</span> <span class="operator">=</span> list.size() - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> list.get(lastIndex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deleteLast</span><span class="params">(Vector list)</span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">lastIndex</span> <span class="operator">=</span> list.size()-<span class="number">1</span>;</span><br><span class="line">    list.remove(lastIndex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>多线程中getLast可能会出现ArrayIndexOutOfBoundsException异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getLast</span><span class="params">(Vector list)</span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span>(list)&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">lastIndex</span> <span class="operator">=</span> list.size()-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> list.get(lastIndex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deleteLast</span><span class="params">(Vector list)</span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(list)&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">lastIndex</span> <span class="operator">=</span> list.size() -<span class="number">1</span>;</span><br><span class="line">        list.remove(lastIndex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端加锁解决不可靠迭代问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (vector)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i&lt;vector.size();i++)</span><br><span class="line">        doSomething(vector.get(i));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="（2）迭代器与ConcurrentModificationException"><a href="#（2）迭代器与ConcurrentModificationException" class="headerlink" title="（2）迭代器与ConcurrentModificationException"></a>（2）迭代器与ConcurrentModificationException</h5><p>在设计同步容器类的迭代器时并没有考虑到并发修改的问题，并且他们表现出的行为是“及时失败”（fail-fast）的。意味着，当他们发现容器在迭代过程中被修改时，会抛出一个ConcurrentModificationException异常。</p>
<p>如果不希望再迭代期对容器加锁，那么一种替代方法就是“克隆”容器，并在副本上进行迭代。（克隆过程中仍然需要对容器加锁）</p>
<h5 id="（3）隐藏迭代器"><a href="#（3）隐藏迭代器" class="headerlink" title="（3）隐藏迭代器"></a>（3）隐藏迭代器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HiddenIterator</span>&#123;</span><br><span class="line">	<span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Integer&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Integer&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(Integer i)</span>&#123;</span><br><span class="line">        set.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Integer i)</span>&#123;</span><br><span class="line">        set.remove(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTenThings</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)</span><br><span class="line">            add(r.nextInt());</span><br><span class="line">        System.out.println(<span class="string">&quot;DEBUG:added ten elements to &quot;</span>+set);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">&quot;DEBUG:added ten elements to &quot;</span>+set);</span><br></pre></td></tr></table></figure>

<p>这里将字符串的连接操作转换为调用StringBuilder.append(Object)，这个方法会调用容器的toString方法，<strong>标准容器的toString方法将迭代容器</strong>。</p>
<p>如果HiddenIterator用synchronizedSet来包装HashSet，并且对同步代码进行封装，那么就不会发生这种错误。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">正如封装对象的状态有助于维持不变性条件一样，封装对象的同步机制同样有助于确保实施同步策略。</span><br></pre></td></tr></table></figure>

<h4 id="5-2-并发容器"><a href="#5-2-并发容器" class="headerlink" title="5.2 并发容器"></a>5.2 并发容器</h4><p>Java5.0提供了多种并发容器类改进同步容器的性能。</p>
<p>同步容器将所有对容器状态的访问都串行化，代价是严重降低并发性，当多个线程竞争容器的锁时，吞吐量严重降低。</p>
<p>并发容器针对多个线程并发访问设计。</p>
<p>Java5.0增加了ConcurrentHashMap，用来代替同步且基于散列的Map，以及CopyOnWriteArrayList，用于在遍历操作为主要操作的情况下代替同步的List。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">通过并发容器来代替同步容器，可以极大地提高伸缩性并降低风险。</span><br></pre></td></tr></table></figure>

<p>Java5.0增加了两种新的容器类型：Queue和BlockingQueue</p>
<p>Queue用来临时保存一组等待处理的元素。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="tag">并发编程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag">读书笔记</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2022
        <i class="ri-heart-fill heart_icon"></i> liang sm
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="卡西莫多的小站"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/photos">照片</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>谢谢老板~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=28457938&auto=1&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    

  </div>
</body>

</html>