<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> 卡西莫多的小站</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      
<section class="cover">
    
      
      <a class="forkMe" href="https://github.com/Shen-Yu/hexo-theme-ayer"
        target="_blank"><img width="149" height="149" src="/images/forkme.png"
          class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover1.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">卡西莫多的小站</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.staticfile.org/typed.js/2.0.12/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['面朝大海，春暖花开', '愿你一生努力，一生被爱', '想要的都拥有，得不到的都释怀'],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  
  

<div class="notice" style="margin-top:50px">
    <i class="ri-heart-fill"></i>
    <div class="notice-content" id="broad"></div>
</div>
<script type="text/javascript">
    fetch('https://v1.hitokoto.cn')
        .then(response => response.json())
        .then(data => {
            document.getElementById("broad").innerHTML = data.hitokoto;
        })
        .catch(console.error)
</script>

<style>
    .notice {
        padding: 20px;
        border: 1px dashed #e6e6e6;
        color: #969696;
        position: relative;
        display: inline-block;
        width: 100%;
        background: #fbfbfb50;
        border-radius: 10px;
    }

    .notice i {
        float: left;
        color: #999;
        font-size: 16px;
        padding-right: 10px;
        vertical-align: middle;
        margin-top: -2px;
    }

    .notice-content {
        display: initial;
        vertical-align: middle;
    }
</style>
  
  <article class="articles">
    
    
    
    
    <article
  id="post-SpringBoot(私教)"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/07/18/SpringBoot(%E7%A7%81%E6%95%99)/"
    >SpringBoot</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/07/18/SpringBoot(%E7%A7%81%E6%95%99)/" class="article-date">
  <time datetime="2022-07-18T01:30:24.519Z" itemprop="datePublished">2022-07-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringBoot/">SpringBoot</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="一、基本介绍"><a href="#一、基本介绍" class="headerlink" title="一、基本介绍"></a>一、基本介绍</h1><h2 id="1、什么是SpringBoot"><a href="#1、什么是SpringBoot" class="headerlink" title="1、什么是SpringBoot"></a>1、什么是SpringBoot</h2><p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-boot">https://spring.io/projects/spring-boot</a></p>
<h2 id="2、核心思想-约定优于配置"><a href="#2、核心思想-约定优于配置" class="headerlink" title="2、核心思想-约定优于配置"></a>2、核心思想-约定优于配置</h2><p><strong>What</strong>:</p>
<p>​	约定优于配置，又称按约定编程。一种软件设计规范。</p>
<p>​	本质上对系统、类库或框架中一些东西假定一个大众化合理的默认值（缺省值）。</p>
<p>​	加入所期待的配置与约定配置一致，可以不做任何配置，约定不符合期待时才需要对约定进行替换配置。</p>
<p><strong>Why</strong>:</p>
<p>​	大大减少了配置项</p>
<p><strong>How</strong>:</p>
<ul>
<li><p>起步依赖</p>
<p>如果没有需要特定依赖版本，可以使用spring-boot管理好的依赖减少配置</p>
</li>
<li><p>自动配置</p>
<p>按照spring的约定，存在某些条件的情况下自动配置bean到容器内。比如RedisAutoConfiguration在容器中不存在RedisTemplate的时候注入该bean。</p>
</li>
</ul>
<h2 id="3、SpringBoot的优势"><a href="#3、SpringBoot的优势" class="headerlink" title="3、SpringBoot的优势"></a>3、SpringBoot的优势</h2><ul>
<li>一键启动，极大的降低了构架应用的门槛</li>
<li>直接内嵌tomcat，jetty，undertow，无需打成war包</li>
<li>提供了starter机制简化构建配置</li>
<li>提供了健康检查，监控等能力</li>
<li><strong>自动配置</strong> 自动配置满足条件的spring和第三方依赖，不在大量依赖xml配置</li>
<li><strong>起步依赖</strong> 将具备某种功能的坐标打包到一起，并提供一些默认的功能，避免各种依赖冲突问题</li>
</ul>
<h1 id="二、常用功能"><a href="#二、常用功能" class="headerlink" title="二、常用功能"></a>二、常用功能</h1><h2 id="1、配置文件"><a href="#1、配置文件" class="headerlink" title="1、配置文件"></a>1、配置文件</h2><ul>
<li><strong>加载路径优先级</strong></li>
</ul>
<p>全局配置文件能够对一些默认配置值进行修改及自定义配置</p>
<p>Spring Boot使用一个application.properties或者application.yaml的文件作为全局配置文件</p>
<p>查找配置文件的路径如下图</p>
<p><img src="/images/SpringBootS_1.jpg" alt="配置路径"></p>
<p>①先去项目根目录找config文件夹下找配置文件</p>
<p>②再去根目录下找配置文件</p>
<p>③去resources下找config文件夹下找配置文件</p>
<p>④去resources下找配置文件</p>
<p>⑤相同配置序号低的配置会覆盖低的，即读取第一个读到的</p>
<p>⑥不同配置取并集</p>
<p>⑦有profile优先profile</p>
<ul>
<li><strong>加载类型优先级</strong></li>
</ul>
<p>SpringBoot2.4改进了处理application.properties和application.yml配置文件的方式</p>
<p>2.4.0之前版本，优先级properties&gt;yaml</p>
<p>2.4.0，优先级yaml&gt;properties</p>
<p>如果想继续使用SpringBoot2.3配置逻辑，可以通过在application.properties或者application.yaml配置文件中添加</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.config.use-legacy-processing</span> = <span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>Tips:强烈不建议同时使用两种类型的配置，每次阅读配置需要辨别，容易产生Bug</p>
<ul>
<li><p>properties配置</p>
<p>java特有配置格式，可以理解为Map&lt;String,String&gt;的kv结构</p>
</li>
<li><p>yml配置（推荐使用）</p>
<p>YAML是Spring Boot支持的一种JSON超集文件格式，以数据为中心</p>
<p>比如properties、xml等更适合做配置文件</p>
<p>​	①yml和xml相比，少了一些结构化的代码，使数据更直接，一目了然，相比properties文件更简洁</p>
<p>​	②YAML文件的扩展名可以使用.yml或者.yaml</p>
<p>​	③application.yml文件使用”key:(空格) value“格式配置属性，使用缩进控制层级关系。</p>
<p>可以表示Map，List，String，对象等</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">	<span class="attr">id:</span> <span class="number">1</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">哈哈哈</span></span><br><span class="line">	<span class="attr">hobby:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">吃</span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">睡</span></span><br><span class="line">	<span class="attr">map:</span> &#123; <span class="attr">k1:</span> <span class="string">v1</span>,<span class="attr">k2:</span> <span class="string">v2</span>&#125;</span><br><span class="line">	<span class="attr">pet:</span></span><br><span class="line">		<span class="attr">name:</span> <span class="string">旺财</span></span><br><span class="line">		<span class="attr">type:</span> <span class="string">狗子</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>自定义配置属性提示</p>
<p>1.定义配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;person&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List hobby;</span><br><span class="line">    <span class="keyword">private</span> String[] family;</span><br><span class="line">    <span class="keyword">private</span> Map map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.引入configuration-processor依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3.重新编译代码</p>
<p>​	会生成一个json就可以使用ide的提示</p>
<p><img src="/images/SpringBootS_2.jpg" alt="配置路径"></p>
</li>
</ul>
<h2 id="2、属性注入"><a href="#2、属性注入" class="headerlink" title="2、属性注入"></a>2、属性注入</h2><blockquote>
<p><strong>属性注入解决了配置到类的映射问题</strong></p>
</blockquote>
<p>使用SpringBoot全局配置文件设置属性时：</p>
<p>如果配置属性是SpringBoot已有属性，例如服务器端口server.port，那么Spring Boot内部会自动扫描并读取这些配置文件中的属性值并覆盖默认属性。</p>
<p>如果配置的属性是用户自定义属性，必须在程序中注入这些配置属性方可生效。</p>
<h3 id="（1）使用方式"><a href="#（1）使用方式" class="headerlink" title="（1）使用方式"></a>（1）使用方式</h3><p>@Configuration:声明一个类作为配置类</p>
<p>@Bean:声明在方法上，将方法的返回值加入Bean容器</p>
<p>@Value:属性注入，属性上添加注解</p>
<p>@ConfigurationProperties(prefix &#x3D; “jdbc”)：批量属性注入</p>
<p>@PropertySource(“classpath:&#x2F;jdbc.properties”)指定外部属性文件。在类上添加</p>
<ul>
<li><p>@ConfigurationProperties批量注入</p>
<p>适用于相同业务的一组属性的批量注入场景</p>
<p>@EnableCOnfigurationProperties是SpringBoot提供的一个注解，使用该注解用于启用应用对另外一个注解@ConfigurationProperties的支持，用于设置一组使用了注解@ConfigurationProperties的类，用于作为bean定义注册到容器中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;jdbc&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDBCProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String driverClassName;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//一般放在SpringBootDemoApplication.class中</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(JDBCProperties.class)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


</li>
<li><p>自定义配置类</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;another&quot;)</span></span><br><span class="line">    <span class="meta">@Bean</span><span class="comment">//只构造一次</span></span><br><span class="line">    <span class="keyword">public</span> AnotherComponent <span class="title function_">anotherComponent</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AnotherComponent</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnotherComponent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> enabled;</span><br><span class="line">    <span class="keyword">private</span> InetAddress remoteAddress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">another:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">remoteAddress:</span> <span class="string">localhost</span></span><br></pre></td></tr></table></figure>

<h3 id="（2）松散绑定"><a href="#（2）松散绑定" class="headerlink" title="（2）松散绑定"></a>（2）松散绑定</h3><p>SpringBoot使用一些宽松的规则将环境属性绑定到@ConfigurationProperties bean，因此环境属性名和bean属性名不需要完全匹配。此特性可以减少写代码适配字段格式的问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(&quot;acme.my-person.person&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OwnerProperties</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String firstName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">acme:</span></span><br><span class="line">	<span class="attr">my-person:</span></span><br><span class="line">		<span class="attr">person:</span></span><br><span class="line">			<span class="attr">first-name:</span> <span class="string">泰森</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>属性文件中配置</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>acme.my-project.person.first-name</td>
<td>羊肉串模式case，推荐使用</td>
</tr>
<tr>
<td>acme.myProject.person.firstName</td>
<td>标准驼峰模式</td>
</tr>
<tr>
<td>acme.my_project.person.first_name</td>
<td>下划线模式</td>
</tr>
<tr>
<td>ACME_MYPROJECT_PERSON_FIRSTNAME</td>
<td>大写下划线，如果使用系统环境时候推荐使用</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>特征</th>
<th>@ConfiguartionProperties</th>
<th>@Value</th>
</tr>
</thead>
<tbody><tr>
<td>宽松的绑定</td>
<td>yes</td>
<td>Limited</td>
</tr>
<tr>
<td>元数据支持</td>
<td>yes</td>
<td>no</td>
</tr>
<tr>
<td>SpEL表达式</td>
<td>no</td>
<td>yes</td>
</tr>
<tr>
<td>应用场景</td>
<td>批量属性绑定</td>
<td>单个属性绑定</td>
</tr>
</tbody></table>
<p>如果您确实想使用@Value，我们建议您使用它们的规范形式来引用属性名(kebabcase只使用小写字母)。这将允许Spring Boot使用与松散绑定@ConfigurationProperties时相同的逻辑。(建议使用小写)</p>
<h1 id="三、源码剖析"><a href="#三、源码剖析" class="headerlink" title="三、源码剖析"></a>三、源码剖析</h1><blockquote>
<p>带注释的源码地址<a target="_blank" rel="noopener" href="https://github.com/hehan-wang/spring-boot-2.2.9.RELEASE.git">https://github.com/hehan-wang/spring-boot-2.2.9.RELEASE.git</a></p>
</blockquote>
<h2 id="1、起步依赖"><a href="#1、起步依赖" class="headerlink" title="1、起步依赖"></a>1、起步依赖</h2><ul>
<li>为什么spring-boot项目很多常用包不用指定版本？</li>
</ul>
<p>①首先spring-boot项目会设置spring-boot-starter-parent作为父依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>②然后父依赖中又有父依赖spring-boot-dependencies</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">&lt;!--设置java版本等属性--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource.delimiter</span>&gt;</span>@<span class="tag">&lt;/<span class="name">resource.delimiter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--设置资源过滤，保留spring需要的配置文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;basedir&#125;/src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/application*.yml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/application*.yaml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/application*.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;basedir&#125;/src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/application*.yml<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/application*.yaml<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>**/application*.properties<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--设置插件的版本管理--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jetbrains.kotlin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kotlin-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;kotlin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">jvmTarget</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">jvmTarget</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">javaParameters</span>&gt;</span>true<span class="tag">&lt;/<span class="name">javaParameters</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">id</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">phase</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">id</span>&gt;</span>test-compile<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">phase</span>&gt;</span>test-compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>test-compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">          ....</span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>③使用maven真正完成依赖管理在父依赖spring-boot-dependencies</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">&lt;!--spring定义好一些常用包的依赖版本--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activemq.version</span>&gt;</span>5.16.5<span class="tag">&lt;/<span class="name">activemq.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">antlr2.version</span>&gt;</span>2.7.7<span class="tag">&lt;/<span class="name">antlr2.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appengine-sdk.version</span>&gt;</span>1.9.97<span class="tag">&lt;/<span class="name">appengine-sdk.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artemis.version</span>&gt;</span>2.19.1<span class="tag">&lt;/<span class="name">artemis.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aspectj.version</span>&gt;</span>1.9.7<span class="tag">&lt;/<span class="name">aspectj.version</span>&gt;</span></span><br><span class="line">    。。。。。。</span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--spring-boot-dependencies的dependencyManagement节点在这里，dependencies定义了SpringBoot版本的依赖的组件以及相应版本--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- SPring Boot --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-test-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-actuator-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>parent只有版本管理，真正依赖何时导入？</li>
</ul>
<p><strong>spring-boot-starter-web</strong>引入了tomcat，spring-mvc等web需要的相关依赖。版本号由<strong>spring-boot-dependencies</strong>中统一管理。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2、启动类注解（前置知识）"><a href="#2、启动类注解（前置知识）" class="headerlink" title="2、启动类注解（前置知识）"></a>2、启动类注解（前置知识）</h2><blockquote>
<p>两步走</p>
<p>​	1.找入口</p>
<p>​	2.抓主线</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span><span class="comment">//标注在类上说明这个类是`SpringBoot`的主配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBootMytestApplication</span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(SpringBootMytestApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>导入流程</p>
<p><img src="/images/SpringBootS_3.jpg" alt="注解"></p>
<h3 id="SpringBootApplication"><a href="#SpringBootApplication" class="headerlink" title="@SpringBootApplication"></a>@SpringBootApplication</h3><p>注解引入了其他三个注解</p>
<p>@SpringBootConfiguration&#x2F;&#x2F;标明该类为配置类</p>
<p>@EnableAutoConfiguration&#x2F;&#x2F;启动自动配置功能</p>
<p>@ComponentScan</p>
<blockquote>
<p><strong>思考如何让注解上面的注解生效呢？</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(</span></span><br><span class="line"><span class="meta">    excludeFilters = &#123;@Filter(</span></span><br><span class="line"><span class="meta">    type = FilterType.CUSTOM,</span></span><br><span class="line"><span class="meta">    classes = &#123;TypeExcludeFilter.class&#125;</span></span><br><span class="line"><span class="meta">), @Filter(</span></span><br><span class="line"><span class="meta">    type = FilterType.CUSTOM,</span></span><br><span class="line"><span class="meta">    classes = &#123;AutoConfigurationExcludeFilter.class&#125;</span></span><br><span class="line"><span class="meta">)&#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SpringBootConfiguration"><a href="#SpringBootConfiguration" class="headerlink" title="@SpringBootConfiguration"></a><strong>@SpringBootConfiguration</strong></h3><p>引入了@Configuration，表示该类与@Configuration的作用相同，表示当前类为spring配置类，可以使用@bean标签</p>
<h3 id="EnableAutoConfiguration"><a href="#EnableAutoConfiguration" class="headerlink" title="@EnableAutoConfiguration"></a><strong>@EnableAutoConfiguration</strong></h3><ul>
<li><p>@AutoCOnfigurationPackage</p>
<p>@Import(AutoCOnfigurationPackages.Registrar.class)</p>
<p>AutoConfigUrationPackages.Registrar功能，注册org.springframework.boot.autoconfigure.AutoConfigurationPackages.BasePackages，他有一个参数，这个参数是使用了@AutoConfigurationPackage这个注解的类所在的包路径，保存自动配置类以供以后使用。</p>
</li>
<li><p>@Import(AutoConfigurationImportSelector.class)</p>
</li>
</ul>
<p><img src="/images/SpringBootS_4.jpg" alt="AutoConfigurationImportSelector继承关系"></p>
<p>入口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeferredImportSelector</span> <span class="keyword">extends</span> <span class="title class_">ImportSelector</span> &#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">default</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">DeferredImportSelector</span>.Group&gt; getImportGroup() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Group</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(AnnotationMetadata var1, DeferredImportSelector var2)</span>;</span><br><span class="line"></span><br><span class="line">        Iterable&lt;DeferredImportSelector.Group.Entry&gt; selectImports();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>org.springframework.boot.autoconfigure.AutoConfigurationImportSelector#getImportGroup实现了org.springframework.context.annotation.DeferredImportSelector#getImportGroup交给AutoConfigurationGroup的process方法处理</li>
<li>AutoConfigurationGroup实现了org.springframework.context.annotation.DeferredImportSelector.Group所以重点关注<strong>process方法</strong>，<strong>selectImports方法</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.annotation.ConfigurationClassParser.DeferredImportSalectorGrouping#getImports</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> Iterable&lt;Group.Entry&gt; getImports()&#123;</span><br><span class="line">	<span class="keyword">for</span>(DeferredImportSelectorHolder deferredImport : <span class="built_in">this</span>.deferredImports)&#123;</span><br><span class="line">        <span class="built_in">this</span>.group.process(deferredImport.getCOnfigurationClass().getMetadata(),deferredImport.getImportSelector());</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.group.selectImports();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自动装配可以配合条件注解，条件注解使用在特定实际加载bean</p>
<p>@Conditional是Spring4新提供的注解，它的作用是按照一定条件进行判断，满足条件给容器注册bean。</p>
<p>@ConditionalOnClass：某个class位于类路径上，才会实例化⼀个Bean。<br>@ConditionalOnExpression：当表达式为true的时候，才会实例化⼀个Bean。基于SpEL表达式的条件判<br>断。<br>@ConditionalOnMissingBean：仅仅在当前上下⽂中不存在某个对象时，才会实例化⼀个Bean。<br>@ConditionalOnMissingClass：某个class类路径上不存在的时候，才会实例化⼀个Bean。  </p>
<p>@ConditionalOnNotWebApplication：不是web应⽤，才会实例化⼀个Bean。<br>@ConditionalOnWebApplication：当项⽬是⼀个Web项⽬时进⾏实例化。<br>@ConditionalOnNotWebApplication：当项⽬不是⼀个Web项⽬时进⾏实例化。<br>@ConditionalOnProperty：当指定的属性有指定的值时进⾏实例化。<br>@ConditionalOnJava：当JVM版本为指定的版本范围时触发实例化。<br>@ConditionalOnResource：当类路径下有指定的资源时触发实例化。<br>@ConditionalOnJndi：在JNDI存在的条件下触发实例化。<br>@ConditionalOnSingleCandidate：当指定的Bean在容器中只有⼀个，或者有多个但是指定了⾸选的<br>Bean时触发实例化。  </p>
<h3 id="ComponentScan"><a href="#ComponentScan" class="headerlink" title="@ComponentScan"></a>@ComponentScan</h3><p>从定义的扫描路径中，找出标识了需要装配的类自动装配到spring的bean容器中。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>SpringBoot自动配置原理：</p>
<p>①从spring.factories配置文件中加载自动配置类</p>
<p>②加载的自动配置类中排除掉@EnableAutoCOnfiguration注解的exclude属性指定的自动配置类</p>
<p>③然后再用AutoConfigurationImportFilter接口去过滤自动配置类是否符合其标注注解（若有标注的话）@ConditionalOnClass，@ConditionalOnBean和@ConditionalOnWebApplication的条件，若都复合则返回匹配结果；</p>
<p>④然后触发AutoConfigurationImportEvent事件，告诉ConditionEvaluationReport条件评估报告器对象来分别记录复合条件和exclude的自动配置类。</p>
<p>⑤最后spring再将最后筛选后的自动配置类导入IOC容器中</p>
<p>主流程代码org.springframework.boot.autoconfigure.AutoConfigurationImportSelector#getAutoConfigurationEntry</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">protected</span> AutoConfigurationImportSelector.AutoConfigurationEntry <span class="title function_">getAutoConfigurationEntry</span><span class="params">(AnnotationMetadata annotationMetadata)</span> &#123;</span><br><span class="line">        <span class="comment">//【1】获取是否有配置spring.boot.enableautoconfiguration属性,默认返回true</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.isEnabled(annotationMetadata)) &#123;</span><br><span class="line">            <span class="keyword">return</span> EMPTY_ENTRY;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">AnnotationAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> <span class="built_in">this</span>.getAttributes(annotationMetadata);</span><br><span class="line">            List&lt;String&gt; configurations = <span class="built_in">this</span>.getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//利用LinkedHashSet逸出重复的配置类</span></span><br><span class="line">            configurations = <span class="built_in">this</span>.removeDuplicates(configurations);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//得到要排除的自动配置类，比如注解属性exclude的配置类</span></span><br><span class="line">            <span class="comment">//比如：@SpringBootApplication(exclude = FreeMarkerAutoConfiguration.class)</span></span><br><span class="line">            <span class="comment">//将会获取到exclude = FreeMarkerAutoConfiguration.class的注解数据</span></span><br><span class="line">            Set&lt;String&gt; exclusions = <span class="built_in">this</span>.getExclusions(annotationMetadata, attributes);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//检查要被排除的配置类，因为有些不是自动配置类，故要抛出异常</span></span><br><span class="line">            <span class="built_in">this</span>.checkExcludedClasses(configurations, exclusions);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2】将要排除的配置类移除</span></span><br><span class="line">            configurations.removeAll(exclusions);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3】过滤@ConditionOnxxx⽣效的配置 因为从spring.factories⽂件获取的⾃动配置类太多，如果有些不必要的⾃动配置类都加载进内存，会造成内存浪费，因此这⾥需要进⾏过滤</span></span><br><span class="line">            configurations = <span class="built_in">this</span>.getConfigurationClassFilter().filter(configurations);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 【4】获取了符合条件的⾃动配置类后，此时触发AutoConfigurationImportEvent事件，</span></span><br><span class="line"><span class="comment">// ⽬的是告诉ConditionEvaluationReport条件评估报告器对象来记录符合条件的⾃动配置类</span></span><br><span class="line">            <span class="built_in">this</span>.fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">            <span class="comment">// 【5】将符合条件和要排除的⾃动配置类封装进AutoConfigurationEntry对象，并返回</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AutoConfigurationImportSelector</span>.AutoConfigurationEntry(configurations, exclusions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3、自动装配案例"><a href="#3、自动装配案例" class="headerlink" title="3、自动装配案例"></a>3、自动装配案例</h2><blockquote>
<p>HttpEncodingAutoConfiguration</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="comment">// 启动指定类的ConfigurationProperties功能；将配置⽂件中对应的值和HttpEncodingProperties绑定起来；</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(HttpProperties.class)</span></span><br><span class="line"><span class="comment">// Spring底层@Conditional注解，根据不同的条件，如果满⾜指定的条件，整个配置类⾥⾯的配置就会⽣效。</span></span><br><span class="line"><span class="comment">// 判断当前应⽤是否是web应⽤，如果是，当前配置类⽣效</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type =ConditionalOnWebApplication.Type.SERVLET)</span></span><br><span class="line"><span class="comment">// 判断当前项⽬有没有这个CharacterEncodingFilter ： SpringMVC中进⾏乱码解决的过滤器</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(CharacterEncodingFilter.class)</span></span><br><span class="line"><span class="comment">// 判断配置⽂件中是否存在某个配置 spring.http.encoding.enabled 如果不存在，判断也是成⽴的</span></span><br><span class="line"><span class="comment">// matchIfMissing = true 表示即使我们配置⽂件中不配置spring.http.encoding.enabled=true，也是默认⽣效的</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;spring.http.encoding&quot;, value =&quot;enabled&quot;, matchIfMissing = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpEncodingAutoConfiguration</span> &#123;</span><br><span class="line">	<span class="comment">// 它已经和SpringBoot配置⽂件中的值进⾏映射了</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> HttpProperties.Encoding properties;</span><br><span class="line">	<span class="comment">// 只有⼀个有参构造器的情况下，参数的值就会从容器中拿</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">HttpEncodingAutoConfiguration</span><span class="params">(HttpProperties properties)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.properties = properties.getEncoding();</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@Bean</span> <span class="comment">//给容器中添加⼀个组件，这个组件中的某些值需要从properties中获取</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span> <span class="comment">//判断容器中没有这个组件</span></span><br><span class="line">	<span class="keyword">public</span> CharacterEncodingFilter <span class="title function_">characterEncodingFilter</span><span class="params">()</span> &#123;</span><br><span class="line">    	<span class="type">CharacterEncodingFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderedCharacterEncodingFilter</span>();</span><br><span class="line">		filter.setEncoding(<span class="built_in">this</span>.properties.getCharset().name());</span><br><span class="line">		filter.setForceRequestEncoding(<span class="built_in">this</span>.properties.shouldForce(Type.REQUEST));</span><br><span class="line">		filter.setForceResponseEncoding(<span class="built_in">this</span>.properties.shouldForce(Type.RESPONSE));</span><br><span class="line">		<span class="keyword">return</span> filter;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> LocaleCharsetMappingsCustomizer <span class="title function_">localeCharsetMappingsCustomizer</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LocaleCharsetMappingsCustomizer</span>(<span class="built_in">this</span>.properties);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LocaleCharsetMappingsCustomizer</span> <span class="keyword">implements</span> <span class="title class_">WebServerFactoryCustomizer</span>&lt;ConfigurableServletWebServerFactory&gt;,Ordered &#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> HttpProperties.Encoding properties;</span><br><span class="line">		LocaleCharsetMappingsCustomizer(HttpProperties.Encoding properties)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">this</span>.properties = properties;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">customize</span><span class="params">(ConfigurableServletWebServerFactory factory)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.properties.getMapping() != <span class="literal">null</span>) &#123;</span><br><span class="line">                factory.setLocaleCharsetMappings(<span class="built_in">this</span>.properties.getMapping());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4、启动过程"><a href="#4、启动过程" class="headerlink" title="4、启动过程"></a>4、启动过程</h2><p>SpringApplication.run(SpringBootMytestApplication.class,args)真正开始启动容器</p>
<p>进行分两步</p>
<p>①初始化new SpringApplication()</p>
<p>②启动run()</p>
<h3 id="new"><a href="#new" class="headerlink" title="new"></a>new</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sources = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>();</span><br><span class="line">        <span class="built_in">this</span>.bannerMode = Mode.CONSOLE;</span><br><span class="line">        <span class="built_in">this</span>.logStartupInfo = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">this</span>.addCommandLineProperties = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">this</span>.addConversionService = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">this</span>.headless = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">this</span>.registerShutdownHook = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">this</span>.additionalProfiles = Collections.emptySet();</span><br><span class="line">        <span class="built_in">this</span>.isCustomEnvironment = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">this</span>.lazyInitialization = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">this</span>.applicationContextFactory = ApplicationContextFactory.DEFAULT;</span><br><span class="line">        <span class="built_in">this</span>.applicationStartup = ApplicationStartup.DEFAULT;</span><br><span class="line">    	<span class="comment">//设置资源加载器为null</span></span><br><span class="line">        <span class="built_in">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">    	<span class="comment">//断言加载资源类不能为null</span></span><br><span class="line">        Assert.notNull(primarySources, <span class="string">&quot;PrimarySources must not be null&quot;</span>);</span><br><span class="line">    	<span class="comment">//将primarySources数组转换为List，最后放到LinkedHashSet集合中</span></span><br><span class="line">        <span class="built_in">this</span>.primarySources = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>(Arrays.asList(primarySources));</span><br><span class="line">    	<span class="comment">//【1.1 推断应用类型，后面会根据类型初始化对应的环境。常用的一般都是servlet环境】</span></span><br><span class="line">        <span class="built_in">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();</span><br><span class="line">        <span class="built_in">this</span>.bootstrapRegistryInitializers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(<span class="built_in">this</span>.getSpringFactoriesInstances(BootstrapRegistryInitializer.class));</span><br><span class="line">       </span><br><span class="line">   <span class="comment">//【1.2 初始化classpath下 META-INF/spring.factories中已配置的ApplicationContextInitializer】</span></span><br><span class="line">    		<span class="built_in">this</span>.setInitializers(<span class="built_in">this</span>.getSpringFactoriesInstances(ApplicationContextInitializer.class));</span><br><span class="line">    	<span class="comment">//【1.3 初始化classpath下所有已配置的ApplicationListener】</span></span><br><span class="line">        <span class="built_in">this</span>.setListeners(<span class="built_in">this</span>.getSpringFactoriesInstances(ApplicationListener.class));</span><br><span class="line">        <span class="comment">//【1.4 根据调用栈，推断出main方法的类名】</span></span><br><span class="line">    	<span class="built_in">this</span>.mainApplicationClass = <span class="built_in">this</span>.deduceMainApplicationClass();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>SpringApplication 类的实例化过程，推断应⽤类型是否为web环境，初始化spring.factories定义的⼀些<br>插件  </p>
<ul>
<li>ApplicationContextInitializer</li>
<li>ApplicationListener</li>
</ul>
<h3 id="run"><a href="#run" class="headerlink" title="run"></a>run</h3><h4 id="主流程"><a href="#主流程" class="headerlink" title="主流程"></a>主流程</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*	运行spring应用，并刷新一个新的 ApplicationContext(Spring的上下文)</span></span><br><span class="line"><span class="comment">*	ConfigurableApplicationContext 是ApplicationContext接口的子接口。</span></span><br><span class="line"><span class="comment">*	在APplicationContext</span></span><br><span class="line"><span class="comment">*	基础上增加了配置上下文的工具。	ConfigurableApplicationContext是容器的高级接口</span></span><br><span class="line"><span class="comment">*	重点关注</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(String... args)</span> &#123;</span><br><span class="line">    	<span class="comment">//记录程序运行时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="type">DefaultBootstrapContext</span> <span class="variable">bootstrapContext</span> <span class="operator">=</span> <span class="built_in">this</span>.createBootstrapContext();</span><br><span class="line">    	<span class="comment">//ConfigurableApplicationContext Spring 的上下文</span></span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.configureHeadlessProperty();</span><br><span class="line">    	<span class="comment">//【1、获取并启动监听器】</span></span><br><span class="line">        <span class="type">SpringApplicationRunListeners</span> <span class="variable">listeners</span> <span class="operator">=</span> <span class="built_in">this</span>.getRunListeners(args);</span><br><span class="line">        listeners.starting(bootstrapContext, <span class="built_in">this</span>.mainApplicationClass);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ApplicationArguments</span> <span class="variable">applicationArguments</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultApplicationArguments</span>(args);</span><br><span class="line">            <span class="comment">//【2、构造应用上下文环境】</span></span><br><span class="line">            <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> <span class="built_in">this</span>.prepareEnvironment(listeners, bootstrapContext, applicationArguments);</span><br><span class="line">            <span class="comment">//处理需要忽略的Bean</span></span><br><span class="line">            <span class="built_in">this</span>.configureIgnoreBeanInfo(environment);</span><br><span class="line">            <span class="comment">//打印banner</span></span><br><span class="line">            <span class="type">Banner</span> <span class="variable">printedBanner</span> <span class="operator">=</span> <span class="built_in">this</span>.printBanner(environment);</span><br><span class="line">            <span class="comment">///【3、初始化应用上下文】</span></span><br><span class="line">            context = <span class="built_in">this</span>.createApplicationContext();</span><br><span class="line">            <span class="comment">//实例化SpringBootExceptionReporter.class，用来支持报告关于启动的错误</span></span><br><span class="line">            context.setApplicationStartup(<span class="built_in">this</span>.applicationStartup);</span><br><span class="line">            <span class="built_in">this</span>.prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">            <span class="comment">//【5、刷新应用上下文】</span></span><br><span class="line">            <span class="built_in">this</span>.refreshContext(context);</span><br><span class="line">            <span class="comment">//【6、刷新应用上下文后的扩展接口】</span></span><br><span class="line">            <span class="built_in">this</span>.afterRefresh(context, applicationArguments);</span><br><span class="line">            <span class="comment">//时间记录停止</span></span><br><span class="line">            <span class="type">Duration</span> <span class="variable">timeTakenToStartup</span> <span class="operator">=</span> Duration.ofNanos(System.nanoTime() - startTime);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.logStartupInfo) &#123;</span><br><span class="line">                (<span class="keyword">new</span> <span class="title class_">StartupInfoLogger</span>(<span class="built_in">this</span>.mainApplicationClass)).logStarted(<span class="built_in">this</span>.getApplicationLog(), timeTakenToStartup);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//发布容器启动完成事件</span></span><br><span class="line">            listeners.started(context, timeTakenToStartup);</span><br><span class="line">            <span class="comment">//初始化完毕后，调用注册的runner中的run方法</span></span><br><span class="line">            <span class="built_in">this</span>.callRunners(context, applicationArguments);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var12) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleRunFailure(context, var12, listeners);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(var12);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Duration</span> <span class="variable">timeTakenToReady</span> <span class="operator">=</span> Duration.ofNanos(System.nanoTime() - startTime);</span><br><span class="line">            listeners.ready(context, timeTakenToReady);</span><br><span class="line">            <span class="keyword">return</span> context;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var11) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleRunFailure(context, var11, (SpringApplicationRunListeners)<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(var11);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="初始化bean工厂时机"><a href="#初始化bean工厂时机" class="headerlink" title="初始化bean工厂时机"></a>初始化bean工厂时机</h4><p>在GenericApplicationContext构造⽅法中 <strong>new DefaultListableBeanFactory</strong> ,以便后续<br><strong>context.getBeanFactory()</strong> 获取  </p>
<p><img src="/images/SpringBootS_5.jpg" alt="getBeanFactory"></p>
<h4 id="如何查找注解上的所有注解？"><a href="#如何查找注解上的所有注解？" class="headerlink" title="如何查找注解上的所有注解？"></a>如何查找注解上的所有注解？</h4><blockquote>
<p>⾃动配置不就是把@Configuration配置类中符合@Conditiononxxx条件的bean注⼊IOC容器么？  </p>
</blockquote>
<p>入口</p>
<p><img src="/images/SpringBootS_7.jpg" alt="AbstractApplicationCOntext.java"></p>
<h4 id="启动类-import时机"><a href="#启动类-import时机" class="headerlink" title="启动类@import时机"></a>启动类@import时机</h4><p>导⼊的类可以是 <strong>ImportSelector</strong> 也可以是普通java类。<br>启动类中的 @Import(AutoConfigurationImportSelector.class)最终会调⽤<br>AutoConfigurationImportSelector.class <strong>pocess() , selectImports()</strong> 与上⽂注解相衔接  </p>
<p><img src="/images/SpringBootS_6.jpg" alt="ConfigurationClassParser.java"></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6/" rel="tag">框架</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%A7%81%E6%95%99/" rel="tag">私教</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-SpringMVC(私)"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/07/16/SpringMVC(%E7%A7%81)/"
    >SpringMVC</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/07/16/SpringMVC(%E7%A7%81)/" class="article-date">
  <time datetime="2022-07-16T00:58:25.000Z" itemprop="datePublished">2022-07-16</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringMVC/">SpringMVC</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="一、SpringMVC介绍"><a href="#一、SpringMVC介绍" class="headerlink" title="一、SpringMVC介绍"></a>一、SpringMVC介绍</h1><h2 id="1、MVC模式"><a href="#1、MVC模式" class="headerlink" title="1、MVC模式"></a>1、MVC模式</h2><p>MVC全名是Model-View-Controller，模型-视图-控制器的缩写</p>
<p><img src="/images/SpringMVC_1.jpg" alt="MVC模式"></p>
<ul>
<li>Model（模型）：模型包含业务模型和数据模型，数据模型用于封装数据，业务模型用于处理业务。</li>
</ul>
<p><strong>模型就是当我们使用软件去解决真实世界中各种实际问题的时候，对那些我们关心的实际事物的抽象和简化</strong></p>
<p>贫血模型（Anemic Domain Model）</p>
<blockquote>
<p><strong>模型实体在设计和实现上，不包含或包含很少的逻辑</strong></p>
</blockquote>
<p>实体只有简单属性和getter&#x2F;setter方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Book</span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> onLoan;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="type">int</span> id)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isOnLoan</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.loan;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOnLoan</span><span class="params">(<span class="type">boolean</span> onLoan)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.onLoan = onLoan;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookService</span>&#123;</span><br><span class="line">    <span class="comment">//借出的方法 比如需要校验参数，可能需要查询数据库，可能需要将从数据源获得的原始数据装配到返回对象中，可能需要应用过滤条件，这里的内容，就是逻辑</span></span><br><span class="line">    <span class="keyword">public</span> Bool <span class="title function_">lendOut</span><span class="params">(<span class="type">int</span> bookId,Date date)</span>&#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">valid</span> <span class="operator">=</span> isValid(bookId);</span><br><span class="line">        <span class="keyword">if</span>(!valid) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> getById(bookId);</span><br><span class="line">        book.setOnLoan(<span class="literal">true</span>);<span class="comment">//借出</span></span><br><span class="line">        updateById(book);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>充血模型（Rich Domain Model）</strong></p>
<blockquote>
<p>充血模型的设计中，领域模型实体就是有血有肉的了，既包含数据，也包含逻辑，具备了高程度的完备性和自洽性。复核面向对象思想</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Book</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> onLoan;</span><br><span class="line">    <span class="comment">//在这种方式下，lendOut方法不需要传入bookId，</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lendOut</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.onLoan = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookService</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Bool <span class="title function_">lendOut</span><span class="params">(<span class="type">int</span> bookId,Date date)</span>&#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">valid</span> <span class="operator">=</span> isValid(bookId);</span><br><span class="line">        <span class="keyword">if</span>(!valid) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> getById(bookId);</span><br><span class="line">        book.lendOut();<span class="comment">//调用book的借出方法</span></span><br><span class="line">        <span class="comment">//book.setOnLoan(true);//借出</span></span><br><span class="line">        updateById(book);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果lendOut()逻辑非常复杂，优势就体现出来了</p>
<p><strong>思考</strong></p>
<p>1.如何选择？</p>
<p>业务逻辑比较简单，就没必要做充血建模，即便设计成充血模型，类也非常单薄，看起来也奇怪。</p>
<p>2.哪些逻辑放在Domain中哪些放到service中？</p>
<ul>
<li><p>​	<br>    - Service类负责与Repository交流。从数据库读取数据转化成domain需要在service完成，使domain跟数据库解耦。</p>
<ul>
<li>Service负责跨领域模型的业务聚合功能，如保存订单和保存支付记录。</li>
<li>Service类负责一些非功能性及与第三方系统交互的工作。比如幂等、事务、发邮件、发消息、记录日志、调用其他系统的RPC接口等，都可以放到Service类中。</li>
<li>相同领域的业功能放在一个Domain里。</li>
</ul>
</li>
<li><p>View（视图）：通常指jsp、html、json。作用展示数据。通常视图是依据模型数据创建的。</p>
</li>
<li><p>Controller（控制器）：处理用户交互部分。作用处理程序逻辑的。</p>
<p>MVC提倡：每一层只编写自己的东西，不编写任何其他的代码；分层是为了解耦，解耦是为了维护方便和分工协作。</p>
</li>
</ul>
<h2 id="2、什么是SpringMVC"><a href="#2、什么是SpringMVC" class="headerlink" title="2、什么是SpringMVC"></a>2、什么是SpringMVC</h2><blockquote>
<p>SpringMVC全名叫SpringWebMVC，是一种基于ServletAPI，基于Java实现MVC设计模型的请求驱动类型的轻量级Web框架。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html">https://docs.spring.io/spring-framework/docs/current/reference/html/web.html</a></p>
<h1 id="二、SpringMVC应用"><a href="#二、SpringMVC应用" class="headerlink" title="二、SpringMVC应用"></a>二、SpringMVC应用</h1><h2 id="1、开发流程"><a href="#1、开发流程" class="headerlink" title="1、开发流程"></a>1、开发流程</h2><ul>
<li>①配置DIspatcherServlet</li>
<li>②开发处理业务逻辑的Handler(@Controller,@RequestMapping)</li>
<li>③xml配置controller包扫描springmvc三大件<ul>
<li>DispatcherServlet前端控制器（老大）</li>
<li>ViewResolver视图解析器</li>
<li>HandlerMapping处理器映射器</li>
<li>HandlerAdapter处理器适配器</li>
</ul>
</li>
<li>④将springmvc.xml文件路径配置到web.xml中</li>
</ul>
<h2 id="2、参数绑定"><a href="#2、参数绑定" class="headerlink" title="2、参数绑定"></a>2、参数绑定</h2><p><img src="/images/SpringMVC_2.jpg" alt="参数绑定"></p>
<h2 id="3、拦截器"><a href="#3、拦截器" class="headerlink" title="3、拦截器"></a>3、拦截器</h2><p><img src="/images/SpringMVC_3.jpg" alt="参数绑定"></p>
<ul>
<li><p>三处的拦截点</p>
<ul>
<li>handler执行前（权限校验）</li>
<li>handler执行后 跳转页面之前</li>
<li>页面渲染后执行</li>
</ul>
</li>
<li><p>实现</p>
<ul>
<li>class MyIntereceptor implements HandlerInterceptor</li>
<li>springmvc.xml加入&lt;mvc:interceptors&gt;&lt;&#x2F;&gt;</li>
</ul>
</li>
<li><p>多个拦截器执行顺序</p>
<ul>
<li><p>PreHandle按照注册正序调用</p>
<p>PostHandle，afterCompletion倒叙调用</p>
</li>
<li><p><img src="/images/SpringMVC_4.jpg" alt="参数绑定"></p>
</li>
</ul>
</li>
</ul>
<h2 id="4、异常处理"><a href="#4、异常处理" class="headerlink" title="4、异常处理"></a>4、异常处理</h2><p>用处：全局异常处理</p>
<ul>
<li>@ControllerAdvice捕获全局Controller异常</li>
<li>方法加@ExceptionHandler之恶能捕获当前Controller异常</li>
<li>返回ModelAndView可以跳转页面</li>
</ul>
<h1 id="三、源码剖析"><a href="#三、源码剖析" class="headerlink" title="三、源码剖析"></a>三、源码剖析</h1><h2 id="1、九大组件"><a href="#1、九大组件" class="headerlink" title="1、九大组件"></a>1、九大组件</h2><h3 id="（1）HandlerMapping（处理器映射器）"><a href="#（1）HandlerMapping（处理器映射器）" class="headerlink" title="（1）HandlerMapping（处理器映射器）"></a><u>（1）HandlerMapping（处理器映射器）</u></h3><p>用来查找Handler（处理器），具体表现形式可以是类，也可以是方法。例如，标注了@RequestMapping的每个方法都可以看成一个Handler。</p>
<p>Handler负责具体实际的请求处理，请求到达后，HandlerMapping的作用是找到请求相应的处理器Handler和Interceptor。</p>
<h3 id="（2）HandlerAdapter（处理器适配器）"><a href="#（2）HandlerAdapter（处理器适配器）" class="headerlink" title="（2）HandlerAdapter（处理器适配器）"></a><u>（2）HandlerAdapter（处理器适配器）</u></h3><p>HandlerAdapter是一个适配器。因为SpringMVC中的Handler可以是任意形式的，只要能处理请求即可。但是把请求交给Servlet的时候，由于Servlet的方法结构都是doService(HttpServletRequest reqHttpServletResponse resp)形式的，要让固定的Servlet处理方法调用Handler来进行处理，便是HandlerAdapter的职责。</p>
<h3 id="（3）HandlerExceptionResolver"><a href="#（3）HandlerExceptionResolver" class="headerlink" title="（3）HandlerExceptionResolver"></a>（3）HandlerExceptionResolver</h3><p>用于处理Handler产生的异常情况。作用是根据异常设置ModelAndView，之后交给渲染方法进行渲染，渲染方法会将ModelAndView渲染成页面。</p>
<h3 id="（4）ViewResolver"><a href="#（4）ViewResolver" class="headerlink" title="（4）ViewResolver"></a><u>（4）ViewResolver</u></h3><p>视图解析器，用于将String类型的视图名和Locale解析为View类型的试图，只有一个resolveViewName()方法。</p>
<p>Controller层返回的String类型视图名viewName最终会在这里被解析成为View。View是用来渲染页面的，会将程序返回的参数和数据填入模板中，生成html文件。</p>
<p>ViewResolver主要完成两件事：找到渲染所用的模板和所用的技术（视图的类型，如JSP）并填入参数。</p>
<p>默认情况下，SpringMVC会自动为我们配置一个InternalResourceViewResolver，是针对JSP类型视图的。</p>
<h3 id="（5）RequestToViewNameTranslator"><a href="#（5）RequestToViewNameTranslator" class="headerlink" title="（5）RequestToViewNameTranslator"></a>（5）RequestToViewNameTranslator</h3><p>从请求中获取ViewName</p>
<p>因为ViewResolver根据ViewName查找View，但有的Handler处理完成之后，没有设置View，也没有设置ViewName，便要通过这个组件从请求中查找ViewName。</p>
<h3 id="（6）LocaleResolver"><a href="#（6）LocaleResolver" class="headerlink" title="（6）LocaleResolver"></a>（6）LocaleResolver</h3><p>ViewResolver组件的resolverViewName需要两个参数，一个是视图名，一个是Locale。</p>
<p>LocaleResolver用于从请求中解析出Locale，比如中国Locale是zh—CN，用来表示一个区域，这个也是i18n的基础</p>
<h3 id="（7）ThemeResolver"><a href="#（7）ThemeResolver" class="headerlink" title="（7）ThemeResolver"></a>（7）ThemeResolver</h3><p>用于解析主题。主题是样式、图片及它们所形成的显示效果的集合。</p>
<h3 id="（8）MultipartResolver"><a href="#（8）MultipartResolver" class="headerlink" title="（8）MultipartResolver"></a>（8）MultipartResolver</h3><p>用于上传请求，将普通请求包装成MultipartHttpServletRequest来实现。</p>
<h3 id="（9）FlashMapManager"><a href="#（9）FlashMapManager" class="headerlink" title="（9）FlashMapManager"></a>（9）FlashMapManager</h3><p>FlashMap用于重定向时的参数传递。</p>
<p>重定向之前将要传递的数据写入请求（可以通过ServletRequestAttributes.getRequest()方法获得）的属性OUTPUT_FLASH_MAP_ATTRIBUTE中，这样在重定向之后的Handler中Spring就会自动将其设置到Model中。</p>
<p>FlashMapManager就是用来管理FlashMap的。</p>
<h2 id="2、处理流程"><a href="#2、处理流程" class="headerlink" title="2、处理流程"></a>2、处理流程</h2><p><img src="/images/SpringMVC_5.jpg" alt="处理流程"></p>
<ul>
<li>第一步：用户发送请求至前端控制器DispatcherServlet</li>
<li>第二步：DispatcherServlet收到请求调用HandlerMapping处理器映射器</li>
<li>第三步：处理器映射器根据请求Url找到具体的Handler（后端控制器），生成处理器对象及处理器拦截器（如果 有则生成）一并返回DispatcherServlet</li>
<li>第四步：DispatcherServlet调用HandlerAdapter处理器适配器去调用Handler</li>
<li>第五步：处理器适配器执行Handler</li>
<li>第六步：Handler执行完成给处理器适配器返回ModelAndView</li>
<li>第七步：处理器适配器向前端控制器返回ModelAndView，ModelAndView是SpringMVC框架的一个底层对象，包括Model和View</li>
<li>第八步：前端控制器请求视图解析器去视图解析，根据逻辑视图名来解析真正的视图</li>
<li>第九步：视图解析器向前端控制器返回View</li>
<li>第十步：前端控制器进行视图渲染，就是将模型数据（在ModelAndView对象中）填充到request域</li>
<li>第十一步：前端控制器向用户响应结果</li>
</ul>
<h2 id="3、请求主流程源码"><a href="#3、请求主流程源码" class="headerlink" title="3、请求主流程源码"></a>3、请求主流程源码</h2><p><img src="/images/SpringMVC_6.jpg" alt="请求主流程"></p>
<p>SpringMVC的源码分两步。初始化，运行时。</p>
<blockquote>
<p>运行时入口：</p>
<p>Javax.servlet.http.HttpServlet#doPost</p>
<p>–&gt;org.springframework.web.servlet.DispatcherServlet#doDispatch</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="type">HttpServletRequest</span> <span class="variable">processedRequest</span> <span class="operator">=</span> request;</span><br><span class="line">		<span class="type">HandlerExecutionChain</span> <span class="variable">mappedHandler</span> <span class="operator">=</span> <span class="literal">null</span>;<span class="comment">//handlerMapping拿出来的handler+拦截器组成的链</span></span><br><span class="line">		<span class="type">boolean</span> <span class="variable">multipartRequestParsed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">WebAsyncManager</span> <span class="variable">asyncManager</span> <span class="operator">=</span> WebAsyncUtils.getAsyncManager(request);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">			<span class="type">Exception</span> <span class="variable">dispatchException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//1、检查文件是否有上传的请求</span></span><br><span class="line">				processedRequest = checkMultipart(request);</span><br><span class="line">				multipartRequestParsed = (processedRequest != request);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Determine handler for the current request.</span></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                2、去的处理当前请求的Controller，这里也成为Handler，即处理器</span></span><br><span class="line"><span class="comment">                这里并不是直接返回Controller，而是返回HandlerExecutionChain 请求处理链对象</span></span><br><span class="line"><span class="comment">                该对象封装了Handler和Inteceptor</span></span><br><span class="line"><span class="comment">                **/</span></span><br><span class="line">				mappedHandler = getHandler(processedRequest);</span><br><span class="line">				<span class="keyword">if</span> (mappedHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//如果handler为空，返回404</span></span><br><span class="line">					noHandlerFound(processedRequest, response);</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Determine handler adapter for the current request.</span></span><br><span class="line">                <span class="comment">//3、获取处理请求的处理器适配器 HandlerAdapter</span></span><br><span class="line">				<span class="type">HandlerAdapter</span> <span class="variable">ha</span> <span class="operator">=</span> getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Process last-modified header, if supported by the handler.</span></span><br><span class="line">                <span class="comment">//处理 last-modified 请求头</span></span><br><span class="line">				<span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> request.getMethod();</span><br><span class="line">				<span class="type">boolean</span> <span class="variable">isGet</span> <span class="operator">=</span> <span class="string">&quot;GET&quot;</span>.equals(method);</span><br><span class="line">				<span class="keyword">if</span> (isGet || <span class="string">&quot;HEAD&quot;</span>.equals(method)) &#123;</span><br><span class="line">					<span class="type">long</span> <span class="variable">lastModified</span> <span class="operator">=</span> ha.getLastModified(request, mappedHandler.getHandler());</span><br><span class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">						logger.debug(<span class="string">&quot;Last-Modified value for [&quot;</span> + getRequestUri(request) + <span class="string">&quot;] is: &quot;</span> + lastModified);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;</span><br><span class="line">						<span class="keyword">return</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Actually invoke the handler.</span></span><br><span class="line">                <span class="comment">//4、实际处理器处理请求，返回结果视图对象</span></span><br><span class="line">				mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">//结果视图对象的处理</span></span><br><span class="line">				applyDefaultViewName(processedRequest, mv);</span><br><span class="line">				mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">				dispatchException = ex;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line">				<span class="comment">// As of 4.3, we&#x27;re processing Errors thrown from handler methods as well,</span></span><br><span class="line">				<span class="comment">// making them available for @ExceptionHandler methods and other scenarios.</span></span><br><span class="line">				dispatchException = <span class="keyword">new</span> <span class="title class_">NestedServletException</span>(<span class="string">&quot;Handler dispatch failed&quot;</span>, err);</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">//5.处理视图</span></span><br><span class="line">			processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line">			triggerAfterCompletion(processedRequest, response, mappedHandler,</span><br><span class="line">					<span class="keyword">new</span> <span class="title class_">NestedServletException</span>(<span class="string">&quot;Handler processing failed&quot;</span>, err));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">				<span class="comment">// Instead of postHandle and afterCompletion</span></span><br><span class="line">				<span class="keyword">if</span> (mappedHandler != <span class="literal">null</span>) &#123;</span><br><span class="line">					mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// Clean up any resources used by a multipart request.</span></span><br><span class="line">				<span class="keyword">if</span> (multipartRequestParsed) &#123;</span><br><span class="line">					cleanupMultipart(processedRequest);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>上面5步在进入源码debug继续追踪</p>
<h2 id="4、初始化主流程源码"><a href="#4、初始化主流程源码" class="headerlink" title="4、初始化主流程源码"></a>4、初始化主流程源码</h2><blockquote>
<p>初始化找入口：</p>
<p>org.springframework.web.servlet.FrameworkServlet.ContextRefreshListener#onApplicationEvent接收事件</p>
<p>–&gt;org.springframework.web.servlet.DispatcherServlet#initStrategies</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	初始化组件</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initStrategies</span><span class="params">(ApplicationContext context)</span> &#123;</span><br><span class="line">    	<span class="comment">//多文件上传组件</span></span><br><span class="line">        <span class="built_in">this</span>.initMultipartResolver(context);</span><br><span class="line">    	<span class="comment">//初始化本地语言环境</span></span><br><span class="line">        <span class="built_in">this</span>.initLocaleResolver(context);</span><br><span class="line">    	<span class="comment">//初始化模板处理器</span></span><br><span class="line">        <span class="built_in">this</span>.initThemeResolver(context);</span><br><span class="line">    	<span class="comment">//初始化HandlerMapping</span></span><br><span class="line">        <span class="built_in">this</span>.initHandlerMappings(context);</span><br><span class="line">    	<span class="comment">//初始化参数适配器</span></span><br><span class="line">        <span class="built_in">this</span>.initHandlerAdapters(context);</span><br><span class="line">    	<span class="comment">//初始化异常拦截器</span></span><br><span class="line">        <span class="built_in">this</span>.initHandlerExceptionResolvers(context);</span><br><span class="line">    	<span class="comment">//初始化视图预处理器</span></span><br><span class="line">        <span class="built_in">this</span>.initRequestToViewNameTranslator(context);</span><br><span class="line">    	<span class="comment">//初始化视图转换器</span></span><br><span class="line">        <span class="built_in">this</span>.initViewResolvers(context);</span><br><span class="line">    	<span class="comment">//初始化FlashMap管理器</span></span><br><span class="line">        <span class="built_in">this</span>.initFlashMapManager(context);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>初始化HandlerMapping</p>
<p><strong>注册容器里所有handler到AbstractHandlerMethodMapping#mappingRegistry中</strong></p>
<p>org.springframework.web.servlet.handler.AbstractHandlerMethodMapping#initHandlerMethods</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initHandlerMethods</span><span class="params">()</span> &#123; <span class="comment">//初始化handler的映射关系</span></span><br><span class="line">    String[] var1 = <span class="built_in">this</span>.getCandidateBeanNames();</span><br><span class="line">    <span class="type">int</span> <span class="variable">var2</span> <span class="operator">=</span> var1.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var3</span> <span class="operator">=</span> <span class="number">0</span>; var3 &lt; var2; ++var3) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> var1[var3];</span><br><span class="line">        <span class="keyword">if</span> (!beanName.startsWith(<span class="string">&quot;scopedTarget.&quot;</span>)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.processCandidateBean(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.handlerMethodsInitialized(<span class="built_in">this</span>.getHandlerMethods());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>org.springframework.web.servlet.handler.AbstractHandlerMethodMapping.MappingRegistry#register</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(T mapping, Object handler, Method method)</span> &#123;<span class="comment">//核心注册方法</span></span><br><span class="line">            <span class="keyword">if</span> (KotlinDetector.isKotlinType(method.getDeclaringClass()) &amp;&amp; AbstractHandlerMethodMapping.KotlinDelegate.isSuspend(method)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unsupported suspending handler method detected: &quot;</span> + method);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.readWriteLock.writeLock().lock();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">HandlerMethod</span> <span class="variable">handlerMethod</span> <span class="operator">=</span> AbstractHandlerMethodMapping.<span class="built_in">this</span>.createHandlerMethod(handler, method);</span><br><span class="line">                    <span class="built_in">this</span>.validateMethodMapping(handlerMethod, mapping);</span><br><span class="line">                    <span class="built_in">this</span>.mappingLookup.put(mapping, handlerMethod);</span><br><span class="line">                    List&lt;String&gt; directUrls = <span class="built_in">this</span>.getDirectUrls(mapping);</span><br><span class="line">                    <span class="type">Iterator</span> <span class="variable">var6</span> <span class="operator">=</span> directUrls.iterator();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> (String)var6.next();</span><br><span class="line">                        <span class="built_in">this</span>.urlLookup.add(url, mapping);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (AbstractHandlerMethodMapping.<span class="built_in">this</span>.getNamingStrategy() != <span class="literal">null</span>) &#123;</span><br><span class="line">                        name = AbstractHandlerMethodMapping.<span class="built_in">this</span>.getNamingStrategy().getName(handlerMethod, mapping);</span><br><span class="line">                        <span class="built_in">this</span>.addMappingName(name, handlerMethod);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">CorsConfiguration</span> <span class="variable">corsConfig</span> <span class="operator">=</span> AbstractHandlerMethodMapping.<span class="built_in">this</span>.initCorsConfiguration(handler, method, mapping);</span><br><span class="line">                    <span class="keyword">if</span> (corsConfig != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.corsLookup.put(handlerMethod, corsConfig);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">this</span>.registry.put(mapping, <span class="keyword">new</span> <span class="title class_">AbstractHandlerMethodMapping</span>.MappingRegistration(mapping, handlerMethod, directUrls, name));</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="built_in">this</span>.readWriteLock.writeLock().unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<h1 id="四、SpringMVC中的设计模式"><a href="#四、SpringMVC中的设计模式" class="headerlink" title="四、SpringMVC中的设计模式"></a>四、SpringMVC中的设计模式</h1><h2 id="1、适配器模式"><a href="#1、适配器模式" class="headerlink" title="1、适配器模式"></a>1、适配器模式</h2><h3 id="（1）适配器模式介绍"><a href="#（1）适配器模式介绍" class="headerlink" title="（1）适配器模式介绍"></a>（1）适配器模式介绍</h3><ul>
<li><strong>what</strong></li>
</ul>
<p>将一个接口转化成需要的另一个接口 使不兼容的类可以在一起工作</p>
<ul>
<li><strong>when</strong></li>
</ul>
<p>①、封装有缺陷接口</p>
<p>假设我们依赖的外部系统在接口设计方面有缺陷（比如包含大量静态方法，参数列表过长方法，名称丑陋代码），引入后会影响我们自身代码的可测试性。为了隔离设计上的缺陷，我们希望对外部系统提供的接口进行二次封装，抽象出更好的接口设计，这个时候就可以使用适配器模式了。</p>
<p>②、统一多个类的接口设计</p>
<p>某个功能的实现依赖多个外部系统，他们的方法签名完全不一致。通过适配器，将接口适配为统一的接口定义，然后就可以使用多态的特性服用代码逻辑。</p>
<p>③、兼容老版本</p>
<p>在做版本升级时候，对于一些要废弃的接口，不直接将其删除，暂时保留，标注为deprecated，并将内部实现逻辑委托为新的接口实现。让项目有个过渡期，而不是强制进行代码修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Collections</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Enumeration <span class="title function_">emumeration</span><span class="params">(<span class="keyword">final</span> Collection c)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Enumeration</span>()&#123;</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">i</span> <span class="operator">=</span> c.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasMoreElements</span><span class="params">()</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> i.hasNext();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">nextElement</span><span class="params">()</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> i.next();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>④、替换依赖外部系统</p>
<p>当我们把项目中依赖的一个外部系统A替换为另一个外部系统B的时候，利用适配器模式，把B适配成A，可以减少对代码的改动。</p>
<p>⑤、适配不同数据格式</p>
<p>它还可以用在不同格式的数据之间的适配</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; stooges = Arrays.asList(<span class="string">&quot;A&quot;</span>,<span class="string">&quot;B&quot;</span>,<span class="string">&quot;C&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>how</strong></li>
</ul>
<p>①、基于继承</p>
<p>②、基于实现</p>
<p>③、基于传参数（spring中使用这种）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ITarget</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">f1</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">f2</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">fc</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Adaptee</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fa</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fb</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fc</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//基于继承</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Adaptor</span> <span class="keyword">extends</span> <span class="title class_">Adaptee</span> <span class="keyword">implements</span> <span class="title class_">ITarget</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">f1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.fa();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">f2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//重新实现f2()...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这里fc()不需要实现，直接继承自Adaptee，和对象适配器最大的不同点</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//基于组合</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Adaptor2</span> <span class="keyword">implements</span> <span class="title class_">ITarget</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Adaptee adaptee;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Adaptor2</span><span class="params">(Adaptee adaptee)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.adaptee = adaptee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">f1</span><span class="params">()</span> &#123;</span><br><span class="line">        adaptee.fa();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">f2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//重新实现</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fc</span><span class="params">()</span> &#123;</span><br><span class="line">        adaptee.fc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如何选择？</p>
<ul>
<li>被适配类 接口不多都可以</li>
<li>被适配类接口多，并且大部分方法签名相同，使用继承减少代码量</li>
<li>被适配类接口多，并且大部分代码不相同，使用组合结构更灵活</li>
</ul>
<p>类继承在语义上更侧重于相似型，因此越相似的类即方法的名称几乎是一样的情况下，我们更喜欢用类来适配。</p>
<p>组合在语义上更侧重整体与部分，或者说部分可以在整体内自由变化，而变化意味着不相似，或者说方法绝大部分不同，那么使用对象适配的方式更合适。</p>
<ul>
<li><strong>why</strong></li>
</ul>
<p>适配器模式可以看作一种“<strong>补偿模式</strong>”，用来补救设计上的缺陷。</p>
<p>应用这种模式算是“无奈之举”，如果在设计初期，我们就能协调规避接口不兼容问题，那么这种模式就没有应用的机会了。</p>
<h3 id="（2）SpringMVC中的适配器模式"><a href="#（2）SpringMVC中的适配器模式" class="headerlink" title="（2）SpringMVC中的适配器模式"></a>（2）SpringMVC中的适配器模式</h3><p>编写Controller的方式有以下三种，其获取path-&gt;handler的方式完全不一样。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//方法一：通过@Controller、@RequestMapping来定义</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoController</span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/employname&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">getEmployeeName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">model</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;Greeting&quot;</span>);</span><br><span class="line">        model.addObject(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;Dinesh&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> model;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//方法二：实现Controller接口+xml配置文件:配置DemoController与URL的对应关系</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoController</span> <span class="keyword">implements</span> <span class="title class_">Controller</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">handleRequest</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">model</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(<span class="string">&quot;Greeting&quot;</span>);</span><br><span class="line">        model.addObject(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;Dinesh Madhwal&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> model;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//方法三：实现Servlet接口 + xml配置文件：配置DemoController类与URL的对应关系</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="built_in">super</span>.doGet(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;Hello World.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Spring采用了适配器模式统一接口设计<strong>HandlerAdapter</strong>中使用了<strong>适配器模式+策略模式</strong>适配多种不同Controller的返回结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerAdapter</span>&#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Object var1)</span>;</span><br><span class="line">    </span><br><span class="line">    ModelAndView <span class="title function_">handle</span><span class="params">(HttpServletRequest var1,HttpServletResponse var2,Object var3)</span><span class="keyword">throws</span> Exception;</span><br><span class="line">    </span><br><span class="line">    <span class="type">long</span> <span class="title function_">getLastModeified</span><span class="params">(HttpServletRequest var1,Object var2)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对应实现Controller接口的Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleControllerHandlerAdapter</span> <span class="keyword">implements</span> <span class="title class_">HandlerAdapter</span>()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleControllerHandlerAdapter</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Object handler)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> handler <span class="keyword">instanceof</span> Controller;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">handle</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                  HttpServletResponse response,Object handler)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">return</span> ((Controller)handler).handleRequest(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getLastModified</span><span class="params">(HttpServletRequest request,Object handler)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> handler <span class="keyword">instanceof</span> LastModified ? ((LastModified)handler).getLastModified(request):-<span class="number">1L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对应实现Servlet接口的Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleServletHandlerAdapter</span> <span class="keyword">implements</span> <span class="title class_">HandlerAdapter</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleServletHandlerAdapter</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Object handler)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> handler <span class="keyword">instanceof</span> Servlet;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">handle</span><span class="params">(HttpServletRequest request,HttpServletResponse response,Object handler)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    ((Servlet)handler).service(request,response);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getLastModified</span><span class="params">(HttpServletRequest request,Object handler)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取适配器类</span></span><br><span class="line">   <span class="keyword">protected</span> HandlerAdapter <span class="title function_">getHandlerAdapter</span><span class="params">(Object handler)</span> <span class="keyword">throws</span> ServletException&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">this</span>.handlerAdapters!=<span class="literal">null</span>)&#123;</span><br><span class="line">           <span class="keyword">for</span> (HandlerAdapter handlerAdapter : <span class="built_in">this</span>.handlerAdapters) &#123;</span><br><span class="line">               <span class="keyword">if</span> (handlerAdapter.supports(handler))&#123;</span><br><span class="line">                   <span class="keyword">return</span> handlerAdapter;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;No adapter for handler [&quot;</span> + handler + <span class="string">&quot;]:The DispatcherServlet configuration needs&quot;</span>+</span><br><span class="line">               <span class="string">&quot; to include a HandlerAdapter that supports this handler&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">	<span class="comment">//统一调用simple方法</span></span><br><span class="line">       mv = ha.handle(processedRequest,response,mappedHandler.getHandler());</span><br></pre></td></tr></table></figure>



<h2 id="2、责任链模式"><a href="#2、责任链模式" class="headerlink" title="2、责任链模式"></a>2、责任链模式</h2><h3 id="（1）责任链模式介绍"><a href="#（1）责任链模式介绍" class="headerlink" title="（1）责任链模式介绍"></a>（1）责任链模式介绍</h3><ul>
<li><p>what</p>
<p>将请求的发送和接收解耦，让多个接收对象都有机会处理这个请求。将这些接收对象串成一条链，并沿着这条链传递这个请求，直到链上的某个接收对象能够处理它为止。</p>
</li>
<li><p>when</p>
<p>①Servlet Filter</p>
<p>②Spring Interceptor</p>
<p>③敏感词过滤</p>
<p>④多logger日志打印</p>
</li>
<li><p>how</p>
</li>
<li><p>why</p>
<p>符合开闭原则 复用性 扩展性。新增一个过滤器不用修改其他代码</p>
</li>
</ul>
<h3 id="（2）SpringMvc中的责任链"><a href="#（2）SpringMvc中的责任链" class="headerlink" title="（2）SpringMvc中的责任链"></a>（2）SpringMvc中的责任链</h3><p>SpringMVC中提供了拦截器的功能，用来做一些通用逻辑的处理。使用到了责任链模式注册多个拦截器形成链式调用。</p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a><strong>使用</strong></h4><p>1、自定义拦截器（可以是多个）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Interceptor1</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * handler方法逻辑执行之前进行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;preHandle.....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * handler方法逻辑执行之后，页面尚未跳转之前进行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;postHandle.....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    页面渲染完成后执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterCompletion.....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/**/&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.liang.interceptor.Interceptor1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h4><p>1、构建拦截器链</p>
<p>org.springframework.web.servlet.handler.AbstractHandlerMapping#getHandlerExecutionChain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandlerExecutionChain</span><span class="params">(Object handler, HttpServletRequest request)</span> &#123;</span><br><span class="line">     <span class="type">HandlerExecutionChain</span> <span class="variable">chain</span> <span class="operator">=</span> handler <span class="keyword">instanceof</span> HandlerExecutionChain ? (HandlerExecutionChain)handler : <span class="keyword">new</span> <span class="title class_">HandlerExecutionChain</span>(handler);</span><br><span class="line">     <span class="type">String</span> <span class="variable">lookupPath</span> <span class="operator">=</span> <span class="built_in">this</span>.urlPathHelper.getLookupPathForRequest(request);</span><br><span class="line">     <span class="type">Iterator</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="built_in">this</span>.adaptedInterceptors.iterator();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">while</span>(var5.hasNext()) &#123;</span><br><span class="line">         <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> (HandlerInterceptor)var5.next();</span><br><span class="line">         <span class="keyword">if</span> (interceptor <span class="keyword">instanceof</span> MappedInterceptor) &#123;</span><br><span class="line">             <span class="type">MappedInterceptor</span> <span class="variable">mappedInterceptor</span> <span class="operator">=</span> (MappedInterceptor)interceptor;</span><br><span class="line">             <span class="keyword">if</span> (mappedInterceptor.matches(lookupPath, <span class="built_in">this</span>.pathMatcher)) &#123;</span><br><span class="line">                 chain.addInterceptor(mappedInterceptor.getInterceptor());<span class="comment">//如果拦截器匹配到当前path 添加到拦截链</span></span><br><span class="line">             &#125;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             chain.addInterceptor(interceptor);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> chain;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>2、链式调用HandlerExecutionChain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">applyPreHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;<span class="comment">//前置处理</span></span><br><span class="line">        HandlerInterceptor[] interceptors = <span class="built_in">this</span>.getInterceptors();</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; interceptors.length; <span class="built_in">this</span>.interceptorIndex = i++) &#123;<span class="comment">//从前往后</span></span><br><span class="line">                <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> interceptors[i];</span><br><span class="line">                <span class="keyword">if</span> (!interceptor.preHandle(request, response, <span class="built_in">this</span>.handler)) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.triggerAfterCompletion(request, response, (Exception)<span class="literal">null</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">applyPostHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> ModelAndView mv)</span> <span class="comment">//后置处理</span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HandlerInterceptor[] interceptors = <span class="built_in">this</span>.getInterceptors();</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> interceptors.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;<span class="comment">//从后到前</span></span><br><span class="line">                <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> interceptors[i];</span><br><span class="line">                interceptor.postHandle(request, response, <span class="built_in">this</span>.handler, mv);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">triggerAfterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="meta">@Nullable</span> Exception ex)</span><span class="comment">//最终处理 ex正常返回为null，错误返回有值 </span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HandlerInterceptor[] interceptors = <span class="built_in">this</span>.getInterceptors();</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptorIndex; i &gt;= <span class="number">0</span>; --i) &#123;<span class="comment">//将注册的拦截器进行链式调度</span></span><br><span class="line">                <span class="type">HandlerInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> interceptors[i];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    interceptor.afterCompletion(request, response, <span class="built_in">this</span>.handler, ex);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var8) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;HandlerInterceptor.afterCompletion threw exception&quot;</span>, var8);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6/" rel="tag">框架</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%A7%81%E6%95%99/" rel="tag">私教</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-SpringFrameWork(私)"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/07/13/SpringFrameWork(%E7%A7%81)/"
    >SpringFrameWork</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/07/13/SpringFrameWork(%E7%A7%81)/" class="article-date">
  <time datetime="2022-07-13T14:38:25.000Z" itemprop="datePublished">2022-07-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringFrameWork/">SpringFrameWork</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="一、Spring概念"><a href="#一、Spring概念" class="headerlink" title="一、Spring概念"></a>一、Spring概念</h1><h2 id="1、什么是Spring"><a href="#1、什么是Spring" class="headerlink" title="1、什么是Spring"></a>1、什么是Spring</h2><p>分层的full-stack（全栈）轻量级开源框架</p>
<p>IoC和AOP为内核</p>
<h2 id="2、Why-Spring"><a href="#2、Why-Spring" class="headerlink" title="2、Why Spring"></a>2、Why Spring</h2><p><a target="_blank" rel="noopener" href="https://spring.io/why-spring">https://spring.io/why-spring</a></p>
<ul>
<li>方便解耦、简化开发（Ioc容器，依赖反转）</li>
<li>AOP编程支持</li>
<li>声明式事务的支持（@Transactional）</li>
<li>方便程序的测试</li>
<li>降低JavaEE API使用难度</li>
<li>源码时经典的Java学习规范</li>
</ul>
<h2 id="3、核心架构"><a href="#3、核心架构" class="headerlink" title="3、核心架构"></a>3、核心架构</h2><p><img src="/images/SpringFrameWork_1.jpg" alt="Spring架构"></p>
<ul>
<li><p>Spring核心容器（Core Container）</p>
<p>①核心部分，管理Sping应用中bean的创建、配置和管理。②该模块包括了Spring bean工厂，为Spring提供了DI功能。③所有Spring模块构建于核心容器之上。</p>
</li>
<li><p>面向切面编程（AOP）</p>
<p>Aspects Spring。AOP帮助应用对象解耦。</p>
</li>
<li><p>数据访问与集成（Data Access&#x2F;Integration）</p>
<p>①Spring的JDBC和DAO模块封装了大量样板代码。②Spring AOP为数据访问提供了事务管理服务③Spring还对ORM进行了集成，如Hibernate、MyBatis等。该模块由JDBC、Transactions、ORM、OXM和JMS等模块组成</p>
</li>
<li><p>Web</p>
</li>
<li><p>Test</p>
</li>
</ul>
<h1 id="二、核心思想"><a href="#二、核心思想" class="headerlink" title="二、核心思想"></a>二、核心思想</h1><h2 id="1、工厂模式（Factory）"><a href="#1、工厂模式（Factory）" class="headerlink" title="1、工厂模式（Factory）"></a>1、工厂模式（Factory）</h2><p>简单工厂（Simple Factory）、工厂方法（Factory Method）和抽象工厂（Abstract Factory）</p>
<hr>
<p>复杂度无法消除，只能被转移：</p>
<ul>
<li>不用工厂模式，if-else逻辑、创建逻辑和业务代码<strong>耦合</strong>在一起</li>
<li>简单工厂是将不同创建逻辑放到一个工厂中，对象创建逻辑在这个工厂类中</li>
<li>工厂方法是不同创建逻辑放到不同工厂类中，先用一个工厂类来得到某个工厂类，再用这个工厂类来创建，对象创建在工厂类的工厂中</li>
<li>抽象工厂是工厂的工厂，创建多个类型相关的对象（spring ioc容器和FactorBean的关系）</li>
</ul>
<p>原始代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(String ruleConfigFilePath)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ruleConfigFileExtension</span> <span class="operator">=</span> getFileExtension(ruleConfigFilePath);</span><br><span class="line">        <span class="type">IRuleConfigParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;json&quot;</span>.equalsIgnoreCase(ruleConfigFileExtension))&#123;</span><br><span class="line">            parser = <span class="keyword">new</span> <span class="title class_">JsonRuleConfigParser</span>();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;xml&quot;</span>.equalsIgnoreCase(ruleConfigFileExtension))&#123;</span><br><span class="line">            parser = <span class="keyword">new</span> <span class="title class_">XmlRuleConfigParser</span>();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;yaml&quot;</span>.equalsIgnoreCase(ruleConfigFileExtension))&#123;</span><br><span class="line">            parser=<span class="keyword">new</span> <span class="title class_">YamlRuleConfigParser</span>();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;properties&quot;</span>.equalsIgnoreCase(ruleConfigFileExtension))&#123;</span><br><span class="line">            parser = <span class="keyword">new</span> <span class="title class_">PropertiesRuleConfigParser</span>();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Rule config file format is not supported: &quot;</span>+ruleConfigFilePath);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">configText</span> <span class="operator">=</span> <span class="string">&quot;牛皮666&quot;</span>;</span><br><span class="line">        parser.parse(configText);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getFileExtension</span><span class="params">(String filePath)</span>&#123;</span><br><span class="line">        <span class="comment">//解析文件拓展名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">substring</span> <span class="operator">=</span> filePath.substring(filePath.lastIndexOf(<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> substring;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>简单工厂模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String,IRuleConfigParser&gt; map;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RuleConfigParserFactory</span><span class="params">()</span>&#123;</span><br><span class="line">        map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;json&quot;</span>,<span class="keyword">new</span> <span class="title class_">JsonRuleConfigParser</span>());</span><br><span class="line">        map.put(<span class="string">&quot;xml&quot;</span>,<span class="keyword">new</span> <span class="title class_">XmlRuleConfigParser</span>());</span><br><span class="line">        map.put(<span class="string">&quot;yaml&quot;</span>,<span class="keyword">new</span> <span class="title class_">YamlRuleConfigParser</span>());</span><br><span class="line">        map.put(<span class="string">&quot;properties&quot;</span>,<span class="keyword">new</span> <span class="title class_">PropertiesRuleConfigParser</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(String ruleConfigFilePath)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ruleConfigFileExtension</span> <span class="operator">=</span> getFileExtension(ruleConfigFilePath);</span><br><span class="line">        <span class="type">IRuleConfigParser</span> <span class="variable">parser</span> <span class="operator">=</span> map.get(ruleConfigFileExtension);</span><br><span class="line">        <span class="type">String</span> <span class="variable">configText</span> <span class="operator">=</span> <span class="string">&quot;牛皮666&quot;</span>;</span><br><span class="line">        parser.parse(configText);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getFileExtension</span><span class="params">(String filePath)</span>&#123;</span><br><span class="line">        <span class="comment">//解析文件拓展名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">substring</span> <span class="operator">=</span> filePath.substring(filePath.lastIndexOf(<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> substring;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/SpringFrameWork_2.jpg" alt="工厂模式"></p>
<h3 id="工厂模式使用场景"><a href="#工厂模式使用场景" class="headerlink" title="工厂模式使用场景"></a><strong>工厂模式使用场景</strong></h3><p>创建对象较复杂场景</p>
<p>（1）需要很多if else，动态根据类型创建对象场景。可将if else收敛到工厂类内(Map简化if else)，提供易用的API。</p>
<p>（2）对象创建复杂的场景，比如一个对象要注入其他对象的情况。(spring ioc)</p>
<p><strong>优势</strong></p>
<p>（1）封装变化：创建逻辑方便查看</p>
<p>（2）代码复用：创建代码抽离到独立的工厂类可以复用</p>
<p>（3）隔离复杂性：复杂的创建逻辑封装，调用者无需了解如何创建</p>
<p>（4）控制复杂度：创建代码抽离出来，代码更简洁</p>
<h2 id="2、代理模式（Proxy）"><a href="#2、代理模式（Proxy）" class="headerlink" title="2、代理模式（Proxy）"></a>2、代理模式（Proxy）</h2><p>不改变原始类，引入代理类附加功能</p>
<hr>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a><strong>使用场景</strong></h3><p>非功能性通用需求</p>
<p>操作日志，事务、监控、统计、鉴权、限流、幂等，异常处理，RPC客户端（Feign，Dubbo），缓存（@Cached），SpringAOP。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a><strong>实现</strong></h3><p>需要打印所有接口的请求耗时。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">	<span class="keyword">public</span> UserVo <span class="title function_">register</span><span class="params">(String telephone,String password)</span>&#123;</span><br><span class="line">		<span class="type">long</span> <span class="variable">startTimetamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// ...省略register逻辑...</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">endTimeStamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">responseTime</span> <span class="operator">=</span> endTimeStamp - startTimetamp;</span><br><span class="line">        <span class="comment">//返回UserVo数据</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果多个接口增加代码</p>
<p>①耦合：监控代码跟业务代码不应该放在一个类中，不符合单一职责原则。</p>
<p>②重复：工作量大。不符合DRY（dont repeat youself）原则</p>
<h3 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a><strong>静态代理</strong></h3><p>①实现被代理对象：要求被代理类和代理类同时实现相应的一套接口，通过代理类重写接口的方法，实际上调用的是原始对象的同样的方法。</p>
<p>②继承被代理对象：代理类继承原始类，然后扩展附加功能。</p>
<p>委托实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lsm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UserControllerProxy.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 委托实现(继承接口，通过构造传递被委托对象，对外使用委托对象调用方法)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2022年07月14日 14:17:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserControllerProxy</span> <span class="keyword">implements</span> <span class="title class_">IUserController</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserController userController;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserControllerProxy</span><span class="params">(UserController userController)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userController = userController;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserVo <span class="title function_">login</span><span class="params">(String telemphone, String password)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">UserVo</span> <span class="variable">login</span> <span class="operator">=</span> userController.login(telemphone, password);</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">responseTime</span> <span class="operator">=</span> endTime - startTime;</span><br><span class="line">        <span class="keyword">return</span> login;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserVo <span class="title function_">register</span><span class="params">(String telemphone, String password)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">UserVo</span> <span class="variable">register</span> <span class="operator">=</span> userController.register(telemphone, password);</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">responseTime</span> <span class="operator">=</span> endTime - startTime;</span><br><span class="line">        <span class="keyword">return</span> register;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">IUserController</span> <span class="variable">userController</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserControllerProxy</span>(<span class="keyword">new</span> <span class="title class_">UserController</span>());</span><br><span class="line">userController.login();</span><br></pre></td></tr></table></figure>

<p>继承实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lsm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UserControllerProxyExtend.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 继承实现(继承后，重写父类方法，编写代理代码，中间调用父类方法实现)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2022年07月14日 14:23:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserControllerProxyExtend</span> <span class="keyword">extends</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserVo <span class="title function_">login</span><span class="params">(String telemphone, String password)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">UserVo</span> <span class="variable">login</span> <span class="operator">=</span> <span class="built_in">super</span>.login(telemphone, password);</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">responseTime</span> <span class="operator">=</span> endTime - startTime;</span><br><span class="line">        <span class="keyword">return</span> login;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserVo <span class="title function_">register</span><span class="params">(String telemphone, String password)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">UserVo</span> <span class="variable">register</span> <span class="operator">=</span> <span class="built_in">super</span>.register(telemphone, password);</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">responseTime</span> <span class="operator">=</span> endTime - startTime;</span><br><span class="line">        <span class="keyword">return</span> register;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">IUserController</span> <span class="variable">userController</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserControllerProxy</span>();</span><br><span class="line">userController.login();</span><br></pre></td></tr></table></figure>

<p>新问题，当类或者方法增加时，维护代理类的数量也会线性增加。</p>
<p>所以，使用动态代理，主流方式。</p>
<h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a><strong>动态代理</strong></h3><p>运行时，动态创建原始类对应的代理类，然后在系统中用代理类替换掉原始类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lsm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> MetricDynamicProxy.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 生成代理类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2022年07月14日 14:37:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MetricDynamicProxy</span>&lt;T&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T t;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">createProxy</span><span class="params">(T t)</span> &#123;</span><br><span class="line">        Class&lt;?&gt;[] interfaces = t.getClass().getInterfaces();</span><br><span class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(getClass().getClassLoader(), interfaces, <span class="keyword">new</span> <span class="title class_">LogDynamicProxyHandler</span>&lt;&gt;(t));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LogDynamicProxyHandler</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> T t;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">LogDynamicProxyHandler</span><span class="params">(T t)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.t = t;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">startTimestamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(t, args);<span class="comment">//原始方法调用</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">endTimeStamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="type">long</span> <span class="variable">responseTime</span> <span class="operator">=</span> endTimeStamp - startTimestamp;</span><br><span class="line">            <span class="type">String</span> <span class="variable">apiName</span> <span class="operator">=</span> t.getClass().getName() + <span class="string">&quot;:&quot;</span> + method.getName();</span><br><span class="line">            System.out.println(apiName + <span class="string">&quot; cost:&quot;</span> + responseTime);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/images/SpringFrameWork_3.jpg" alt="动态代理"></p>
<p><strong>动态代理实现方案</strong></p>
<p><strong><u>Java的动态代理本质上是字节码生成技术，动态生成类加载到JVM</u></strong></p>
<p>①Jdk代理</p>
<p>使用反射包下的Proxy类实现</p>
<p>②cglib</p>
<p>利用ASM开源包，对被代理对象类的class文件加载进来，通过修改其字节码生成子类来处理。</p>
<p>③ASM</p>
<p>Java字节码操控框架。动态生成类或者增强既有类的功能。ASM可直接产生一个二进制class文件，也可在类被加载入Java虚拟机之前动态改变类行为。</p>
<p>④javassist</p>
<p>字节码操作框架。API比ASM高级，无需掌握繁琐的java字节码指令</p>
<p>⑤byte-buddy</p>
<p>Byte Buddy是一个代码生成和操作库，用于在Java应用程序运行时创建和修改Java类，无需编译器的帮助。</p>
<p>允许创建任意类，不限于实现用于创建运行时代理的接口。</p>
<p>提供了一种可以使用Java代理或在构建过程中手动更改类的api</p>
<ul>
<li>无需理解字节码指令，即可使用简单的API就能很容易操作字节码，控制类和方法</li>
<li>已支持Java11，库轻量，仅取决于Java字节代码解析器库ASM的访问者API，本身不需要任何其他依赖项</li>
<li>比起JDK动态代理、cglib、javassist、Byte Buddy在性能上具有一定优势</li>
</ul>
<h2 id="3、Spring-IOC"><a href="#3、Spring-IOC" class="headerlink" title="3、Spring IOC"></a>3、Spring IOC</h2><p>简介</p>
<ul>
<li>什么是IOC（Inverse Of Control）</li>
</ul>
<p>Spring IOC容器采用了上述工厂模式的思想，是整个Spring的基础</p>
<p>对象创建权交给容器管理</p>
<ul>
<li>解决了什么问题</li>
</ul>
<p>解耦：解决对象间耦合的问题：通过接口注入对象，可以方便切换实现。</p>
<p>原本service需要各自创建不同dao对象，现在可以直接使用容器建好的对象。</p>
<p><strong>IOC vs DI</strong></p>
<p>DI（Dependency Injection）依赖注入是IOC的一种实现方式。</p>
<p>也可通过“依赖查找”(Dependency Lookup)解决</p>
<p>IOC：对象角度，对象实例化及管理权交给（反转）容器</p>
<p>DI：容器角度，容器会把对象依赖的其他对象注入（送进去）（例如对象的属性是个对象）</p>
<p><strong>依赖注入 vs 依赖查找</strong></p>
<p>实现控制反转两种方式：依赖注入和依赖查找</p>
<p>区别：</p>
<ul>
<li>依赖注入，@Autowired，被动接收对象，通过类型或名称判断将不同对象注入到不同属性中</li>
<li>依赖查找，beanFactory.getBean()，主动索取相应类型的对象，获得依赖对象的时间也可以在代码中自由控制</li>
</ul>
<h2 id="4、Spring-AOP"><a href="#4、Spring-AOP" class="headerlink" title="4、Spring AOP"></a>4、Spring AOP</h2><ul>
<li>什么是AOP（what）</li>
</ul>
<p>Aspect oriented Programming 面向切面编程&#x2F;面向方面编程</p>
<p>把通用无关代码做成切片，按需插入业务代码中。代理模式</p>
<p><img src="/images/SpringFrameWork_4.jpg" alt="AOP思想"></p>
<ul>
<li>解决了什么问题（why）</li>
</ul>
<p>不改变原有业务逻辑情况下，增强横切逻辑代码，根本上解耦合，避免横切逻辑代码重复</p>
<ul>
<li>如何解决的</li>
</ul>
<p>Java动态代理</p>
<h1 id="三、手写IOC实现"><a href="#三、手写IOC实现" class="headerlink" title="三、手写IOC实现"></a>三、手写IOC实现</h1><p>实现一个简单的DI容器的核心三个功能：配置解析、对象创建和对象生命周期管理</p>
<p>直播7一小时38</p>
<p>配置解析:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lsm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> XmlBeanConfigParser.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2022年07月15日 10:33:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XmlBeanConfigParser</span> <span class="keyword">implements</span> <span class="title class_">BeanConfigParser</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;BeanDefinition&gt; <span class="title function_">parse</span><span class="params">(InputStream inputStream)</span> &#123;</span><br><span class="line">        <span class="type">List</span> <span class="variable">beanDefinitions</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">DocumentBuilderFactory</span> <span class="variable">documentBuilderFactory</span> <span class="operator">=</span> DocumentBuilderFactory.newInstance();</span><br><span class="line">            <span class="type">DocumentBuilder</span> <span class="variable">documentBuilder</span> <span class="operator">=</span> documentBuilderFactory.newDocumentBuilder();</span><br><span class="line">            <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> documentBuilder.parse(inputStream);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> read it later, 关于 xml 为什么需要 normalize 一下</span></span><br><span class="line">            <span class="comment">//optional, but recommended</span></span><br><span class="line">            <span class="comment">//read this - http://stackoverflow.com/questions/13786607/normalization-in-dom-parsing-with-java-how-does-it-work</span></span><br><span class="line">            doc.getDocumentElement().normalize();</span><br><span class="line"></span><br><span class="line">            <span class="type">NodeList</span> <span class="variable">beanList</span> <span class="operator">=</span> doc.getElementsByTagName(<span class="string">&quot;bean&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; beanList.getLength(); i++) &#123;</span><br><span class="line">                <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> beanList.item(i);</span><br><span class="line">                <span class="keyword">if</span> (node.getNodeType() != Node.ELEMENT_NODE) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                <span class="type">Element</span> <span class="variable">element</span> <span class="operator">=</span> (Element) node;</span><br><span class="line">                <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>(</span><br><span class="line">                        element.getAttribute(<span class="string">&quot;id&quot;</span>),</span><br><span class="line">                        element.getAttribute(<span class="string">&quot;class&quot;</span>)</span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">if</span> (element.getAttribute(<span class="string">&quot;scope&quot;</span>).equals(<span class="string">&quot;singleton&quot;</span>))&#123;</span><br><span class="line">                    beanDefinition.setScope(BeanDefinition.Scope.SINGLETON);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (element.getAttribute(<span class="string">&quot;lazy-init&quot;</span>).equals(<span class="string">&quot;true&quot;</span>))&#123;</span><br><span class="line">                    beanDefinition.setLazyInit(<span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                loadConstructorArgs(</span><br><span class="line">                        element.getElementsByTagName(<span class="string">&quot;constructor-arg&quot;</span>),</span><br><span class="line">                        beanDefinition</span><br><span class="line">                );</span><br><span class="line">                beanDefinitions.add(beanDefinition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanDefinitions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadConstructorArgs</span><span class="params">(NodeList nodes, BeanDefinition beanDefinition)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nodes.getLength(); i++) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">item</span> <span class="operator">=</span> nodes.item(i);</span><br><span class="line">            <span class="keyword">if</span> (item.getNodeType() != Node.ELEMENT_NODE) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="type">Element</span> <span class="variable">element</span> <span class="operator">=</span> (Element) item;</span><br><span class="line"></span><br><span class="line">            BeanDefinition.<span class="type">ConstructorArg</span> <span class="variable">constructorArg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (!element.getAttribute(<span class="string">&quot;type&quot;</span>).isEmpty())&#123;</span><br><span class="line">                constructorArg = <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>.ConstructorArg.Builder()</span><br><span class="line">                        .setArg(element.getAttribute(<span class="string">&quot;value&quot;</span>))</span><br><span class="line">                        .setType(String.class)</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!element.getAttribute(<span class="string">&quot;ref&quot;</span>).isEmpty())&#123;</span><br><span class="line">                constructorArg = <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>.ConstructorArg.Builder()</span><br><span class="line">                        .setArg(element.getAttribute(<span class="string">&quot;ref&quot;</span>))</span><br><span class="line">                        .setRef(<span class="literal">true</span>)</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line">            beanDefinition.addConstructorArg(constructorArg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对象创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">createBean</span><span class="params">(BeanDefinition beanDefinition)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (beanDefinition.isSingleton()&amp;&amp;singletonObjects.containsKey(beanDefinition.getId()))&#123;</span><br><span class="line">            <span class="keyword">return</span> singletonObjects.get(beanDefinition.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//Class路径如何计算</span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">beanClass</span> <span class="operator">=</span> Class.forName(beanDefinition.getClassName());</span><br><span class="line">            List&lt;BeanDefinition.ConstructorArg&gt; constructorArgs = beanDefinition.getConstructorArgs();</span><br><span class="line">            <span class="keyword">if</span> (constructorArgs.isEmpty())&#123;</span><br><span class="line">                bean = beanClass.newInstance();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                Class[] argClasses = <span class="keyword">new</span> <span class="title class_">Class</span>[constructorArgs.size()];</span><br><span class="line">                Object[] argObjects = <span class="keyword">new</span> <span class="title class_">Object</span>[constructorArgs.size()];</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; constructorArgs.size(); i++) &#123;</span><br><span class="line">                    BeanDefinition.<span class="type">ConstructorArg</span> <span class="variable">arg</span> <span class="operator">=</span> constructorArgs.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (!arg.isRef())&#123;<span class="comment">//非引用资源</span></span><br><span class="line">                        argClasses[i] = arg.getType();</span><br><span class="line">                        argObjects[i] = arg.getArg();</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="type">BeanDefinition</span> <span class="variable">refbeanDefinition</span> <span class="operator">=</span> beanDefinations.get(arg.getArg());</span><br><span class="line">                        <span class="keyword">if</span> (refbeanDefinition == <span class="literal">null</span>)&#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchBeanDefinitionException</span>(<span class="string">&quot;Bean is not defined: &quot;</span> + arg.getArg());</span><br><span class="line">                        &#125;</span><br><span class="line">                        argObjects[i] = createBean(refbeanDefinition);</span><br><span class="line">                        argClasses[i] = argObjects[i].getClass();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                bean = beanClass.getConstructor(argClasses).newInstance(argObjects);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (ClassNotFoundException | InstantiationException | IllegalAccessException | NoSuchMethodException | InvocationTargetException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bean!=<span class="literal">null</span> &amp;&amp; beanDefinition.isSingleton())&#123;</span><br><span class="line">            singletonObjects.putIfAbsent(beanDefinition.getId(),bean);</span><br><span class="line">            <span class="keyword">return</span> singletonObjects.get(beanDefinition.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>对象生命周期管理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBeanDefinitions</span><span class="params">(List&lt;BeanDefinition&gt; beanDefinitionList)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (BeanDefinition beanDefinition : beanDefinitionList) &#123;</span><br><span class="line">            <span class="built_in">this</span>.beanDefinations.putIfAbsent(beanDefinition.getId(),beanDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (BeanDefinition beanDefinition : beanDefinitionList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanDefinition.isLazyInit() == <span class="literal">false</span> &amp;&amp; beanDefinition.isSingleton())&#123;</span><br><span class="line">                createBean(beanDefinition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>理解：懒加载先不创建对象，使用时创建。创建同时进行初始化</p>
<p>spring生命周期：创建阶段–&gt;初始化阶段–&gt;销毁阶段</p>
<p><strong>创建阶段</strong>：</p>
<ul>
<li>当<code>scope=&quot;singleton&quot;</code>：表示只创建一个对象（单例），Spring 工厂（IoC 容器）创建的同时，创建对象。</li>
<li>当<code>scope=&quot;prototype&quot;</code>：Spring 工厂在获取对象 <code>ctx.getBean(&quot;xxx&quot;)</code> 的同时，创建对象。</li>
</ul>
<p><strong>初始化阶段</strong>：</p>
<ul>
<li>InitializingBean接口</li>
<li>配置init-method</li>
</ul>
<p><strong>销毁阶段</strong>：</p>
<ul>
<li><p>DisposableBean 接口</p>
<p>实现<code>DisposableBean</code>接口，重写<code>destroy()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Product</span> <span class="keyword">implements</span> <span class="title class_">DisposableBean</span> &#123;</span><br><span class="line">    <span class="comment">// 程序员根据自己的需求, 定义销毁方法, 完成销毁操作</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Product.destroy&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 destroy-method</p>
<p>对象中提供一个普通的销毁方法，配置文件种配置<code>destroy-method</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Product</span> &#123;</span><br><span class="line">	<span class="comment">// 程序员根据自己的需求, 定义销毁方法, 完成销毁操作</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myDestory</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Product.myDestory&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;product&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.zqc.Product&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;myDestory&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="四、IOC应用"><a href="#四、IOC应用" class="headerlink" title="四、IOC应用"></a>四、IOC应用</h1><h2 id="1、BeanFactory与ApplicationContext区别"><a href="#1、BeanFactory与ApplicationContext区别" class="headerlink" title="1、BeanFactory与ApplicationContext区别"></a>1、BeanFactory与ApplicationContext区别</h2><p><img src="/images/SpringFrameWork_5.jpg" alt="继承关系"></p>
<p>ApplicationContext是具备应用特性的BeanFactory超集</p>
<p>ApplicationContext除了IoC容器角色，还有提供：</p>
<p>面向切面（AOP），配置元信息（Configuartion Metadata），资源管理（Resources），事件（Events），国际化（i18n），注解（Annotations），Environment抽象（Environment Abstraction）</p>
<h2 id="2、启动IOC容器的方式"><a href="#2、启动IOC容器的方式" class="headerlink" title="2、启动IOC容器的方式"></a>2、启动IOC容器的方式</h2><p>Java环境下启动：</p>
<p>ClassPathXmlApplicationContex：从类的根路径下加载配置文件（推荐使用）<br>FileSystemXmlApplicationContext：从磁盘路径上加载配置文件<br>AnnotationConfigApplicationContext：纯注解模式下启动Spring容器 </p>
<p>Web环境下启动：</p>
<p>基于web.xml</p>
<ul>
<li><p>使用方式</p>
<p><img src="/images/SpringFrameWork_6.jpg" alt="使用方式"></p>
</li>
<li><p>懒加载</p>
<p><img src="/images/SpringFrameWork_7.jpg" alt="懒加载"></p>
</li>
<li><p>FactoryBean&#x2F;BeanFactory区别</p>
<p><img src="/images/SpringFrameWork_8.jpg" alt="区别"></p>
</li>
<li><p>后置处理器</p>
<p>BeanPostProcessor bean对象实例化后做一些事</p>
<p>BeanFactoryPostProcessor工厂实例化后做一些事情</p>
</li>
</ul>
<blockquote>
<p>SpringBean生命周期（重点）<strong>（断点实操）</strong></p>
</blockquote>
<p><img src="/images/SpringFrameWork_9.jpg" alt="生命周期"></p>
<p>（1）根据配置情况调用Bean构造方法实例化bean</p>
<p>（2）使用依赖注入完成属性注入</p>
<p>（3）调用BeanNameAware的setBeanName()方法</p>
<p>（4）调用BeanFactoryAware的setBeanFactory()方法</p>
<p>（5）调用ApplicationContextAware的setApplicationContext()方法</p>
<p>（6）调用BeanPostProcessor的预始化方法</p>
<p>（7）执行@PostConstruct方法</p>
<p>（8）调用InitializatingBean的afterPropertiesSet()方法</p>
<p>（9）调用自定义init-method</p>
<p>（10）调用BeanPostProcessor的后初始化方法</p>
<p>（11）如果是singleton bean交给spring缓冲池，prototype返回调用者</p>
<p>（12）调用DispoableBean的destory方法</p>
<p>（13）调用@PreDestory destory-method</p>
<h2 id="3、其他依赖注入框架"><a href="#3、其他依赖注入框架" class="headerlink" title="3、其他依赖注入框架"></a>3、其他依赖注入框架</h2><p>java SE</p>
<ul>
<li>java Beans</li>
<li>Java ServiceLoader SPI</li>
<li>JNDI（Java Naming and Directory Interface）</li>
</ul>
<p>Java EE</p>
<ul>
<li>EJB（Enterprise Java Beans）</li>
<li>Servlet</li>
</ul>
<h1 id="五、IOC源码分析"><a href="#五、IOC源码分析" class="headerlink" title="五、IOC源码分析"></a>五、IOC源码分析</h1><p>源码分析方式</p>
<p>原则上：</p>
<ul>
<li>定焦原则：抓主线</li>
<li>宏观原则：站在上帝视角，关注架构，淡化细节</li>
</ul>
<p>技巧上：</p>
<ul>
<li>断点（观察调用栈）</li>
<li>反调（find usages）</li>
<li>经验（Spring中doXX具体处理的地方）</li>
</ul>
<h2 id="1、主流程（断点实操）"><a href="#1、主流程（断点实操）" class="headerlink" title="1、主流程（断点实操）"></a>1、主流程<strong>（断点实操）</strong></h2><p>org.springframework.context.support.AbstractApplicationContext#refresh</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">    	<span class="comment">//对象加锁</span></span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">            <span class="type">StartupStep</span> <span class="variable">contextRefresh</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.refresh&quot;</span>);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">            刷新前预处理</span></span><br><span class="line"><span class="comment">            设置Spring容器启动时间，</span></span><br><span class="line"><span class="comment">            开启活跃状态，撤销关闭状态</span></span><br><span class="line"><span class="comment">            验证环境里一些必须存在的属性等</span></span><br><span class="line"><span class="comment">            **/</span></span><br><span class="line">            <span class="built_in">this</span>.prepareRefresh();</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            获取BeanFactory;默认实现是DefaultListableBeanFactory加载BeanDefition并注册到BeanDefitionRegistory</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> <span class="built_in">this</span>.obtainFreshBeanFactory();</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            BeanFactory预准备工作（BeanFactory进行一些设置，比如context的类加载器等）</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="built_in">this</span>.prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                	BeanFactory准备工作完成后进行的后置处理工作</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="built_in">this</span>.postProcessBeanFactory(beanFactory);</span><br><span class="line">                <span class="type">StartupStep</span> <span class="variable">beanPostProcess</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationStartup.start(<span class="string">&quot;spring.context.beans.post-process&quot;</span>);</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">               		实例化实现了BeanFactoryPostProcessor接口的Bean，并调用方法</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="built_in">this</span>.invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                	注册BeanPostProcessor（Bean的后置处理器），在创建bean的前后等执行</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="built_in">this</span>.registerBeanPostProcessors(beanFactory);</span><br><span class="line">                beanPostProcess.end();</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                	初始化MessageSource组件（做国际化功能；消息绑定，消息解析）</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="built_in">this</span>.initMessageSource();</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                	初始化事件派发器</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="built_in">this</span>.initApplicationEventMulticaster();</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                	子类重写这个方法，在容器刷新的时候可以自定义逻辑；如创建Tomcat，Jetty等WEB服务器</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="built_in">this</span>.onRefresh();</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">					注册应用的监听器。就是注册实现了ApplicationListener接口的监听器bean</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">                <span class="built_in">this</span>.registerListeners();</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">					初始化所有剩下的非懒加载的单例bean</span></span><br><span class="line"><span class="comment">					初始化创建非懒加载方式的单例Bean实例（未设置属性）</span></span><br><span class="line"><span class="comment">                    填充属性</span></span><br><span class="line"><span class="comment">                    初始化方法调用（比如调用afterPropertiesSet方法、init-method方法）</span></span><br><span class="line"><span class="comment">                    调用BeanPostProcessor（后置处理器）对实例bean进行后置处理</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">                <span class="built_in">this</span>.finishBeanFactoryInitialization(beanFactory);</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">					完成context的刷新。主要是调用LifecycleProcessor的onRefresh()方法，并且发布事件（ContextRefreshedEvent）</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">                <span class="built_in">this</span>.finishRefresh();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (BeansException var10) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.logger.isWarnEnabled()) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.logger.warn(<span class="string">&quot;Exception encountered during context initialization - cancelling refresh attempt: &quot;</span> + var10);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">this</span>.destroyBeans();</span><br><span class="line">                <span class="built_in">this</span>.cancelRefresh(var10);</span><br><span class="line">                <span class="keyword">throw</span> var10;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.resetCommonCaches();</span><br><span class="line">                contextRefresh.end();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="2、懒加载"><a href="#2、懒加载" class="headerlink" title="2、懒加载"></a>2、懒加载</h2><p>初始化bean时会判断lazy-init这个字段</p>
<p>getBean时才创建AbstractBeanFactory.doGetBean()</p>
<h2 id="3、Spring循环依赖解决"><a href="#3、Spring循环依赖解决" class="headerlink" title="3、Spring循环依赖解决"></a>3、Spring循环依赖解决</h2><h3 id="（1）产生的原因"><a href="#（1）产生的原因" class="headerlink" title="（1）产生的原因"></a>（1）产生的原因</h3><p>循环依赖就是2个或以上的bean，对象的属性相互依赖形成环，造成死循环，无法构建成功</p>
<p><img src="/images/SpringFrameWork_10.jpg" alt="循环依赖"></p>
<h3 id="（2）解决循环依赖"><a href="#（2）解决循环依赖" class="headerlink" title="（2）解决循环依赖"></a>（2）解决循环依赖</h3><p>无法解决</p>
<p>①单例bean构造器参数循环依赖（无法解决）</p>
<p>②prototype原型bean循环依赖（无法解决）</p>
<p>可以自动解决</p>
<p>①单例的bean set注入或者@Autowired</p>
<h3 id="（3）解决方案（画时序图、断点实操）"><a href="#（3）解决方案（画时序图、断点实操）" class="headerlink" title="（3）解决方案（画时序图、断点实操）"></a>（3）解决方案<strong>（画时序图、断点实操）</strong></h3><blockquote>
<p><strong>使用三级缓存</strong>，整体思路把创建一半的对象放入缓存中</p>
</blockquote>
<p>解决过程</p>
<p>BeanA&lt;–&gt;BeanB循环依赖</p>
<p>①实例化A把自己放入三级缓存，发现A依赖B，去创建B</p>
<p>②B的创建过程中发现依赖A，去三级缓存找A，放入二级缓存</p>
<p>③升级过程中可以自定义扩展</p>
<p>④B构建完整放入，一级缓存，完成创建</p>
<p>⑤A从一级缓存找B，完成创建</p>
<p><img src="/images/SpringFrameWork_11.jpg" alt="三级缓存"></p>
<p><img src="/images/SpringFrameWork_12.jpg" alt="时序图"></p>
<h1 id="六、AOP应用"><a href="#六、AOP应用" class="headerlink" title="六、AOP应用"></a>六、AOP应用</h1><p>术语</p>
<ul>
<li>JoinPoint连接点：每个方法的特殊时期都是连接点</li>
<li>PointCut切入点：真正感兴趣的方法</li>
<li>Advice增强：增强逻辑+访问信息</li>
<li>Target目标对象</li>
<li>Proxy代理对象</li>
<li>Weaving织入</li>
<li>Aspect切面：切面&#x3D;切入点+增强&#x3D;切入点+横切逻辑+方位信息</li>
</ul>
<p>使用方式</p>
<p>①xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">&quot;logAspect&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;beanId&quot;</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">aop:poingcut</span> <span class="attr">id</span>=<span class="string">&quot;pt1&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">methos</span>=<span class="string">&quot;before-method&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pt1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:before</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">aop:poingcut</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>②xml+注解</p>
<ul>
<li>@Aspect</li>
<li>@Pointcut</li>
<li>@Before</li>
<li>@After</li>
<li>@Around</li>
<li>@AfterThrowing</li>
<li>@AfterReturning</li>
<li>&lt;aop:aspectj-autoproxy proxy-target-class&#x3D;”true”&gt;为true使用cglib</li>
</ul>
<p>③注解</p>
<p>​	@EnableAspectJAutoProxy</p>
<h1 id="七、AOP源码分析"><a href="#七、AOP源码分析" class="headerlink" title="七、AOP源码分析"></a>七、AOP源码分析</h1><blockquote>
<p>AOP基于BeanPostProcessor+动态代理实现（cglib&#x2F;jdk）。生成代理类的实例注入到工厂中</p>
</blockquote>
<p>代理类创建流程</p>
<p>AOP创建Proxy对象的地方有两个：</p>
<ul>
<li>常规bean的就是在BeanFactory.initializeBean()方法里面调用初始化方法后，调用applyBeanPostProcessorsAfterInitialization() –&gt;AbstractAutoProxyCreator.wrapIfNecessary()生成proxy对象。</li>
<li>还有就是在存在循环依赖的时候，在doCreateBean()–&gt;addSingletonFactory(beanName,()–&gt;getEarlyBeanReference(beanName,mbd,bean));–&gt;然后再getSingleton()的时候从三级缓存中取对象的时候，会调用getEarlyBeanReference()–&gt;AbstractAutoProxyCreator.wrapIfNecessary()生成proxy对象</li>
</ul>
<p>常规流程：</p>
<h1 id="八、声明式事务"><a href="#八、声明式事务" class="headerlink" title="八、声明式事务"></a>八、声明式事务</h1><p><strong>使用方式</strong></p>
<p>可以使用xml,xml+注解，注解三种形式使用</p>
<ul>
<li>xml或者注解实现事务控制</li>
<li>PlatformTransactionManager事务处理接口</li>
<li>xml模式<ul>
<li>&lt;bean id&#x3D;”transactionManager” class&#x3D;”org.springframework.jdbc.DataSourceTransactionManager” &gt;</li>
<li>&lt;tx:advice&gt;</li>
</ul>
</li>
<li>xml+注解<ul>
<li>&lt;tx:annataion-driven transaction-manager&#x3D;”transactionManager”&gt;</li>
<li>@Transaction</li>
</ul>
</li>
<li>注解<ul>
<li>@EnableTransactionManagement</li>
</ul>
</li>
</ul>
<p><strong>源码分析</strong></p>
<p>下面以注解的形式分析源码</p>
<p>入口为@ENableTransactionManagement注解，@Transactional为使用测。</p>
<p><strong>声明式事务基于AOP实现</strong></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6/" rel="tag">框架</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%A7%81%E6%95%99/" rel="tag">私教</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-java并发编程实战笔记"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/07/06/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/"
    >java并发编程实战</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/07/06/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/" class="article-date">
  <time datetime="2022-07-06T02:29:00.000Z" itemprop="datePublished">2022-07-06</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="第一部分-基础知识"><a href="#第一部分-基础知识" class="headerlink" title="第一部分 基础知识"></a>第一部分 基础知识</h2><h3 id="第二章-线程安全性"><a href="#第二章-线程安全性" class="headerlink" title="第二章 线程安全性"></a>第二章 线程安全性</h3><h4 id="2-1-什么是线程安全性"><a href="#2-1-什么是线程安全性" class="headerlink" title="2.1 什么是线程安全性"></a>2.1 什么是线程安全性</h4><p>当多个线程访问某个类时，这个类始终都能表现出正确的行为，这个类就是线程安全的。</p>
<h4 id="2-2-原子性"><a href="#2-2-原子性" class="headerlink" title="2.2 原子性"></a>2.2 原子性</h4><p>（1）竞态条件</p>
<p>在并发编程中，由于不恰当的执行时序儿出现不正确的结果是一种非常重要的情况，他有一个正式的名字：竞态条件（RaceCondition）</p>
<p>延迟初始化</p>
<p>目的：将对象初始化操作推迟到实际被使用才进行（类似于懒汉式）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyInitRace</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ExpensiveObject</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ExpensiveObject <span class="title function_">getInstance</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="literal">null</span>)</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">ExpensiveObject</span></span><br><span class="line">        <span class="keyword">return</span> instance;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存在竞态条件，线程A和线程B同时执行getInstance，同时判断instance为null,同时实例化对象，获得两个不同的对象。</p>
<p>（2）复合操作</p>
<p>避免竞态条件，必须在某个线程修改该变量式，通过某种方式防止其他线程使用这个变量，确保其他线程只能在修改操作完成前后进行读取和修改。</p>
<p>在java.util.concurrent.atomic包中包含了一些原子变量，用于实现在数值和对象引用上的原子状态转换。</p>
<p>例如，可以用AtomicLong来代替long类型的计数器，确保状态的访问操作都是原子的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">实际情况中，尽可能使用线程安全对象（AutomicLong）来管理类的状态。与非线程安全的对象相比，更易维护和验证线程安全性。</span><br></pre></td></tr></table></figure>

<h4 id="2-3-加锁机制"><a href="#2-3-加锁机制" class="headerlink" title="2.3 加锁机制"></a>2.3 加锁机制</h4><p>如果使用多个线程安全对象。当在不变性条件中涉及多个变量时，各个变量之间并不是彼此独立的，而是某个变量的值会对其他变量的值产生约束。因此当更新某一变量时，需要在同一个原子操作中对其他变量同时进行更新。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">要保持状态一致性，就需要在单个原子操作中更新所有相关的状态变量。</span><br></pre></td></tr></table></figure>

<p>（1）内置锁</p>
<p>同步代码块（Synchronized Block）</p>
<p>两部分：一个作为锁的对象引用，一个作为由这个锁保护的代码块。</p>
<p>（2）重入</p>
<p>如果某个线程试图获得一个已经由他自己持有的锁，那么这个请求就会成功。</p>
<p>实现方式，为每个锁关联一个获取计数值和一个所有者线程。计数为0，表示未被任何线程持有。当线程请求一个未被持有的锁时，JVM将记下锁的持有者，并且将计数值置为1.如果同一线程再次获取，计数值将递增，当线程退出代码块，计数值递减。计数值为0时，释放锁。</p>
<h4 id="2-4-用锁来保护状态"><a href="#2-4-用锁来保护状态" class="headerlink" title="2.4 用锁来保护状态"></a>2.4 用锁来保护状态</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">每个共享的和可变的变量都应该只由一个锁来保护，从而使维护人员知道是哪一个锁。</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">对于每个包含多个变量的不变性条件，其中涉及的所有变量需要由同一个锁来保护。</span><br></pre></td></tr></table></figure>

<h4 id="2-5-活跃性与性能"><a href="#2-5-活跃性与性能" class="headerlink" title="2.5 活跃性与性能"></a>2.5 活跃性与性能</h4><p>对于在单个变量上实现原子操作来说，原子变量（AtomicLong）是很有用的，但如果已经使用了同步代码块（synchronized）来构造原子操作，而使用两种不同的同步机制不仅会带来混乱，也不会在性能或安全上带来任何好处，这里不推荐使用原子变量。</p>
<p>简单性：对整个方法进行同步</p>
<p>并发性：对尽可能短的代码路径进行同步</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当执行时间较长的计算或者可能无法快速完成的操作时（例如，网络I/O或控制台I/O），一定不要有锁</span><br></pre></td></tr></table></figure>

<h3 id="第三章-对象的共享"><a href="#第三章-对象的共享" class="headerlink" title="第三章 对象的共享"></a>第三章 对象的共享</h3><h4 id="3-1可见性"><a href="#3-1可见性" class="headerlink" title="3.1可见性"></a>3.1可见性</h4><p>重排序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在没有同步的情况下，编译器、处理器以及运行时等都可能对操作的执行顺序进行一些意想不到的调整。</span><br></pre></td></tr></table></figure>

<p>只有数据在多个线程之间共享，就使用正确的同步。</p>
<p>（1）失效数据</p>
<p>一个线程可能获得某个变量的最新值，而获得另一个变量的失效值。</p>
<p>（2）非原子的64位操作</p>
<p>最低安全性：获得的失效值至少是由之前某个线程设置的值，而不是一个随机值。</p>
<p>非volatile类型的64位数值变量（double和long）</p>
<p>jvm允许将64位的读操作或写操作分解为两个32位的操作。当读取一个非volatile类型的long变量时，如果对该变量的读操作和写操作在不同的线程中执行，那么很可能会读取到某个值的高32位和另一个值的低32位。</p>
<p>（3）加锁与可见性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">加锁的含义不仅仅局限于互斥行为，还包括内存可见性。为了确保所有线程都能看到共享变量的最新值，所有执行读操作或者写操作的线程都必须在同一个锁上同步。</span><br></pre></td></tr></table></figure>

<p>（4）Volatile变量</p>
<p>Java语言提供了一种稍弱的同步机制，即volatile变量，用来确保更新操作通知到其他线程。</p>
<p>比sychronized关键字更轻量级的同步机制</p>
<p>volatile变量通常用作某个操作完成、发生中断或者状态的标志。volatile的语义不足以确保递增操作（count++）的原子性，除非你能确保只有一个线程对变量执行写操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">加锁机制既可以确保可见性又可以确保原子性，而volatile变量只能确保可见性。</span><br></pre></td></tr></table></figure>

<p>当且仅当满足一下所有条件时，才应该使用volatile变量：</p>
<ul>
<li>对变量的写入操作不依赖变量的当前值，或者你能确保只有单个线程更新变量的值</li>
<li>该变量不会与其他状态变量一起纳入不变性条件中</li>
<li>在访问变量时不需要加锁</li>
</ul>
<h4 id="3-2发布与逸出"><a href="#3-2发布与逸出" class="headerlink" title="3.2发布与逸出"></a>3.2发布与逸出</h4><p>发布Publish：使对象能够在当前作用域之外的代码中使用。</p>
<p>例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Secret&gt; knownSecrets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span>&#123;</span><br><span class="line">    knowSecrets = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Secret&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>逸出Escape：当某个不该发布的对象被发布时。</p>
<p>例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UnsafeStates</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String[] states = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">        <span class="string">&quot;AK&quot;</span>,<span class="string">&quot;AL&quot;</span> ...</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">public</span> String[] getStates()&#123;<span class="keyword">return</span> states;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>任何调用者都可以修改数组内容。</p>
<p>使用封装的主要原因：封装能够使得对程序的正确性进行分析变得可能，并使得无意中破坏涉及约束条件变得更难。</p>
<p>安全的对象构造过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SafeListener</span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> EventListener listener;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">SafeListener</span><span class="params">()</span>&#123;</span><br><span class="line">        listener = <span class="keyword">new</span> <span class="title class_">EventListener</span>()&#123;</span><br><span class="line">          <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(Event e)</span>&#123;</span><br><span class="line">              doSomething(e);</span><br><span class="line">          &#125;  </span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-3线程封闭"><a href="#3-3线程封闭" class="headerlink" title="3.3线程封闭"></a>3.3线程封闭</h4><p>避免同步，不共享数据，如果仅在单线程内访问数据，就不需要同步。</p>
<p>线程封闭技术常用场景：</p>
<ul>
<li>Swing的可视化组件和数据模型对象</li>
<li>JDBC的Connection对象</li>
</ul>
<p>（1）Ad-hoc线程封闭</p>
<p>​	维护线程封闭性的职责完全由程序实现来承担。</p>
<p>（2）栈封闭</p>
<p>​	只能通过局部变量访问对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">loadTheArk</span><span class="params">(Collection&lt;Animal&gt; candidates)</span>&#123;</span><br><span class="line">	SortedSet&lt;Animal&gt; animals;</span><br><span class="line">    <span class="type">int</span> <span class="variable">numPairs</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">Animal</span> <span class="variable">candidate</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//animals被封闭在方法中，不要使他们逸出！</span></span><br><span class="line">    animals = <span class="keyword">new</span> <span class="title class_">TreeSet</span>&lt;Animal&gt;(<span class="keyword">new</span> <span class="title class_">SpeciesGenderComparator</span>());</span><br><span class="line">    animals.addAll(candidates);</span><br><span class="line">    <span class="keyword">for</span>(Animal a : animals)&#123;</span><br><span class="line">        <span class="keyword">if</span>(candidate == <span class="literal">null</span> || !candidate.isPotentialMate(a))</span><br><span class="line">            candidate = a;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            ark.load(<span class="keyword">new</span> <span class="title class_">AnimalPair</span>(candidate,a));</span><br><span class="line">            ++numPairs;</span><br><span class="line">            candidate = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只有一个引用指向集合animals，这个引用被封闭在局部变量中，因此也被封闭在执行线程中。</p>
<p>（3）ThreadLocal类</p>
<p>更规范的方式</p>
<p>ThreadLocal能使线程中的某个值与保存值的对象关联起来。</p>
<p>提供了get与set方法，为每个使用该变量的线程都存有一份独立的副本，因此get总是返回由当前执行线程在调用set时设置的最新值。</p>
<p>线程与值绑定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;Connection&gt; connectionHolder</span><br><span class="line">    = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Connection&gt;()&#123;</span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">initialValue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DriverManager.getConnection(DB_URL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> connectionHolder.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当某个线程初次调用ThreadLocal.get方法时，就会调用initialValue来获取初始值。</p>
<p>ThreadLocal&lt;T&gt;视为包含了Map&lt;Thread,T&gt;对象，保存了特定于该线程的值，但ThreadLocal的实现并非如此。线程终止后，值会作为垃圾回收。</p>
<h4 id="3-4不变性"><a href="#3-4不变性" class="headerlink" title="3.4不变性"></a>3.4不变性</h4><p><strong>不可变对象</strong>：某个对象在被创建后其状态就不能被修改。</p>
<p>不可变对象一定是线程安全的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">当满足以下条件时，对象才是不可变的:</span><br><span class="line">- 对象创建以后其状态就不能修改</span><br><span class="line">- 对象的所有域都是final类型.</span><br><span class="line">- 对象是正确创建的（在对象的创建期间，this引用没有逸出）。</span><br></pre></td></tr></table></figure>

<p>例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Immutable</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ThreeStooges</span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; stooges = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThreeStooges</span><span class="params">()</span>&#123;</span><br><span class="line">        stooges.add(<span class="string">&quot;Moe&quot;</span>);</span><br><span class="line">        stooges.add(<span class="string">&quot;Larry&quot;</span>);</span><br><span class="line">        stooges.add(<span class="string">&quot;Curly&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isStooge</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stooges.contains(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@immutable不可变类</span><br><span class="line">状态不会改变，每次修改都是创建新的对象。</span><br></pre></td></tr></table></figure>

<p>（1）Final域</p>
<p>final类型的域是不能修改的（但如果final域所引用的对象是可变的，那么这些被引用的对象是可以修改的）</p>
<p>final域能确保初始化过程的安全性，从而可以不受限制的访问不可变对象，并在共享这些对象时无需同步。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">编程习惯</span><br><span class="line">除非需要更高的可见性，否则应将所有的域都声明为私有域。</span><br><span class="line">除非某个域是可变的，否则应将其声明为final域。</span><br></pre></td></tr></table></figure>

<p>（2）使用Volatile类型来发布不可变对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Immutable</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OneValueCache</span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> BigInteger lastNumber;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BigInteger[] lastFactors;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OneValueCache</span><span class="params">(BigInteger i,</span></span><br><span class="line"><span class="params">                        BigInteger[] factors)</span>&#123;</span><br><span class="line">        lastNumber = i;</span><br><span class="line">        lastFactors = Arrays.copyOf(factors,factors.length);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> BigInteger[] getFactors(BigInteger i)&#123;</span><br><span class="line">        <span class="keyword">if</span>(lastNumber == <span class="literal">null</span> || !lastNumber.equals(i))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> Arrays.copyOf(lastFactors,lastFactors.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用指向不可变容器对象的volatile类型引用以缓存最新的结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VolatileCachedFactorizer</span> <span class="keyword">implements</span> <span class="title class_">Servlet</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">OneValueCache</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OneValueCache</span>(<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest req,ServletResponse resp)</span>&#123;</span><br><span class="line">        <span class="type">BigInteger</span> <span class="variable">i</span> <span class="operator">=</span> extractFromRequest(req);</span><br><span class="line">        BigInteger[] factors = cache.getFactors(i);</span><br><span class="line">        <span class="keyword">if</span>(factors == <span class="literal">null</span>)&#123;</span><br><span class="line">            factors = factor(i);</span><br><span class="line">            cache = <span class="keyword">new</span> <span class="title class_">OneValueCache</span>(i,factors);</span><br><span class="line">        &#125;</span><br><span class="line">        encodIntoResponse(resp,factors);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-5安全发布"><a href="#3-5安全发布" class="headerlink" title="3.5安全发布"></a>3.5安全发布</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Holder holder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span>&#123;</span><br><span class="line">	holder = <span class="keyword">new</span> <span class="title class_">Holder</span>(<span class="number">42</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存在可见性问题，其他线程看到的Holder对象处于不一致的状态。</p>
<p>（1）不正确的发布：正确的对象被破坏</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Holder</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> n;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Holder</span><span class="params">(<span class="type">int</span> n)</span>&#123; <span class="built_in">this</span>.n = n;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">assertSanity</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(n!=n)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(<span class="string">&quot;This statement is false.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于没有使用同步来确保Holder对象对其他线程可见，因此将Holder称为“未被正确发布”。</p>
<p>两个问题：</p>
<p>1.除了发布对象的线程外，其他线程可以看到的Holder域是一个失效值，因此将看到一个空引用或之前的旧值。</p>
<p>2.线程看到Holder引用的值是最新的，但Holder状态的值是失效的。</p>
<p>某个线程可能第一次读取失效的值，再次读取获得更新至导致n！&#x3D;n。</p>
<p>（2）不可变对象与初始化安全性</p>
<p>Java内存模型为不可变对象的共享提供了一种特殊的初始化安全性保证。）</p>
<p>即使在发布不可变对象的引用时没有使用同步，也仍可以安全地访问该对象。为了维持这种初始化安全性保证，必须满足不可变性地所有需求：</p>
<p>状态不可修改，所有域都是final类型，以及正确地构造过程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">任何线程都可以在不需要额外同步的情况下安全地访问不可变对象，即使在发布这些对象时没有使用同步</span><br></pre></td></tr></table></figure>



<p>（3）安全发布的常用模式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">要安全地发布一个对象，对象地引用以及对象的状态必须同时对其他线程可见。一个正确构造的对象可以通过以下方式来安全地发布：</span><br><span class="line">- 在静态初始化函数中初始化一个对象引用。</span><br><span class="line">- 将对象的引用保存到volatile类型的域或者AtomicReferance对象中</span><br><span class="line">- 将对象的引用保存到某个正确构造对象的final类型域中</span><br><span class="line">- 将对象的引用保存到一个由锁保护的域中</span><br></pre></td></tr></table></figure>



<p>（4）事实不可变对象</p>
<p>发布后不会被修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在没有额外的同步的情况下，任何线程都可以安全地使用被安全发布的事实不可变对象</span><br></pre></td></tr></table></figure>

<p>例如</p>
<p>用户登录，将Date存入Map，之后不会改变，就是事实不可变对象</p>
<p>（5）可变对象</p>
<p>如果对象在构造后可以修改，那么安全发布只能确保”发布当时“状态可见性。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">对象的发布需求取决于它的可变性：</span><br><span class="line">- 不可变对象可以通过任意机制来发布</span><br><span class="line">- 事实不可变对象必须通过安全方式来发布</span><br><span class="line">- 可变对象必须通过安全方式来发布，并且必须是线程安全的或者由某个锁保护起来。</span><br></pre></td></tr></table></figure>



<p>（6）安全的共享对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">并发程序中使用和共享对象时，可以使用一些实用的策略，包括：</span><br><span class="line">	线程封闭。线程封闭的对象只能由一个线程拥有，对象被封闭在该线程中，并且只能由这个线程修改。</span><br><span class="line">	只读共享，没有额外同步的情况下，共享的只读对象可以由多个线程并发访问，但任何线程不能修改。共享的只读对象包括不可变对象和事实不可变对象。</span><br><span class="line">	线程安全共享。线程安全的对象在其内部实现同步，因此多个线程可以通过对象的公有接口来进行访问，不需要进一步的同步。</span><br><span class="line">	保护对象。被保护的对象只能通过持有特定的锁来访问。保护对象包括封装在其他线程安全对象中的对象，以及已发布的并且由某个特定锁保护的对象。</span><br></pre></td></tr></table></figure>

<h3 id="第四章-对象的组合"><a href="#第四章-对象的组合" class="headerlink" title="第四章 对象的组合"></a>第四章 对象的组合</h3><h4 id="4-1设计线程安全的类"><a href="#4-1设计线程安全的类" class="headerlink" title="4.1设计线程安全的类"></a>4.1设计线程安全的类</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在设计线程安全类的过程中，需要包含以下三个基本要素：</span><br><span class="line">- 找出构成对象状态的所有变量。</span><br><span class="line">- 找出约束状态变量的不变性条件。</span><br><span class="line">- 建立对象状态的并发访问管理策略。</span><br></pre></td></tr></table></figure>

<p>分析对象状态首先从对象的域开始。如果对象中所有的域都是基本类型的变量，那么这些域将构成对象的全部状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Counter</span>&#123;</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span> <span class="keyword">private</span> <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">getValue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">increment</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(value == Long.MAX_VALUE)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;counter overflow&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ++value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="（1）收集同步需求"><a href="#（1）收集同步需求" class="headerlink" title="（1）收集同步需求"></a>（1）收集同步需求</h5><p>对象与变量都有一个状态空间，即所有可能的取值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果不了解对象的不变性条件与后验条件，那么就不能确保线程安全性。要满足在状态变量的有效值或状态转换上的各种约束条件，就需要借助于原子性与封装性。</span><br></pre></td></tr></table></figure>



<h5 id="（2）依赖状态的操作"><a href="#（2）依赖状态的操作" class="headerlink" title="（2）依赖状态的操作"></a>（2）依赖状态的操作</h5><p>类的不变性条件与后验条件约束了在对象上有哪些状态和状态转换是有效。</p>
<p>如果在某个操作中包含有基于状态的先验条件，这个操作称为依赖状态的操作。</p>
<h5 id="（3）状态的所有权"><a href="#（3）状态的所有权" class="headerlink" title="（3）状态的所有权"></a>（3）状态的所有权</h5><p>容器类通常表现出一种“所有权分离”的形式，其中容器类拥有其自身的状态，而客户代码则拥有容器中各个对象的状态。</p>
<p>例如 Servlet框架中的ServletContext</p>
<p>容器中存储的对象，与所有共享对象一样，它们必须安全地被共享。为了防止多个线程在并发访问同一个对象时产生的相互干扰，这些对象要么是线程安全的对象，要么是事实不可变的对象，或者由锁来保护的对象。</p>
<h4 id="4-2-实例封闭"><a href="#4-2-实例封闭" class="headerlink" title="4.2 实例封闭"></a>4.2 实例封闭</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将数据封装在对象内部，可以将数据的访问限制在对象的方法上，从而更容易确保线程在访问数据时总能持有正确的锁。</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PersonSet</span>&#123;</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Person&gt; mySet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Person&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">addPerson</span><span class="params">(Person p)</span>&#123;</span><br><span class="line">        mySet.add(p);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">containsPerson</span><span class="params">(Person p)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mySet.contains(p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过封闭机制确保线程安全</p>
<ul>
<li>封闭机制更易于构造线程安全的类，因为当封闭类的状态时，在分析类的线程安全性时就无需检查整个程序。</li>
</ul>
<h5 id="（1）Java监视器模式"><a href="#（1）Java监视器模式" class="headerlink" title="（1）Java监视器模式"></a>（1）Java监视器模式</h5><p>遵循Java监视器模式的对象会把对象的所有可变状态都封装起来，并由对象自己的内置锁来保护。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivateLock</span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">myLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;myLock&quot;)</span> Widget widget;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">someMethod</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(myLock)&#123;</span><br><span class="line">            <span class="comment">//访问或修改Widget的状态</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用私有的锁对象</p>
<p>优点：私有的锁对象可以将锁封装起来，使客户代码无法得到锁。</p>
<p>（2）实例：车辆追踪</p>
<p>基于监视器模式的车辆追踪</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MonitorVehicleTracking</span> &#123;</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String,MutablePoint&gt; locations;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MonitorVehicleTracking</span><span class="params">(Map&lt;String, MutablePoint&gt; locations)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.locations = deepCopy(locations);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> MutablePoint <span class="title function_">getLocation</span><span class="params">(String id)</span>&#123;</span><br><span class="line">        <span class="type">MutablePoint</span> <span class="variable">loc</span> <span class="operator">=</span> locations.get(id);</span><br><span class="line">        <span class="type">return</span> <span class="variable">loc</span> <span class="operator">=</span>= <span class="literal">null</span> ? <span class="literal">null</span> : <span class="keyword">new</span> <span class="title class_">MutablePoint</span>(loc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setLocation</span><span class="params">(String id,<span class="type">int</span> x,<span class="type">int</span> y)</span>&#123;</span><br><span class="line">        <span class="type">MutablePoint</span> <span class="variable">loc</span> <span class="operator">=</span> locations.get(id);</span><br><span class="line">        <span class="keyword">if</span> (loc == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;NO SUCH ID: &quot;</span>+id);</span><br><span class="line">        loc.x = x;</span><br><span class="line">        loc.y = y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String,MutablePoint&gt; <span class="title function_">deepCopy</span><span class="params">(Map&lt;String,MutablePoint&gt; m)</span>&#123;</span><br><span class="line">        Map&lt;String,MutablePoint&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String id : m.keySet()) &#123;</span><br><span class="line">            result.put(id,<span class="keyword">new</span> <span class="title class_">MutablePoint</span>(m.get(id)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableMap(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MutablePoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> x,y;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MutablePoint</span><span class="params">()</span>&#123;x=<span class="number">0</span>;y=<span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MutablePoint</span><span class="params">(MutablePoint p)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.x = p.x;</span><br><span class="line">        <span class="built_in">this</span>.y = p.y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过在返回客户代码之前复制可变的数据来稳吃线程安全性。</p>
<p>缺点：车辆容器非常大的情况下将极大地降低性能。</p>
<h4 id="4-3线程安全性的委托"><a href="#4-3线程安全性的委托" class="headerlink" title="4.3线程安全性的委托"></a>4.3线程安全性的委托</h4><h5 id="（1）实例：基于委托的车辆追踪其"><a href="#（1）实例：基于委托的车辆追踪其" class="headerlink" title="（1）实例：基于委托的车辆追踪其"></a>（1）实例：基于委托的车辆追踪其</h5><h5 id="（2）独立的状态变量"><a href="#（2）独立的状态变量" class="headerlink" title="（2）独立的状态变量"></a>（2）独立的状态变量</h5><h5 id="（3）当委托失效时"><a href="#（3）当委托失效时" class="headerlink" title="（3）当委托失效时"></a>（3）当委托失效时</h5><h5 id="（4）发布底层的状态变量"><a href="#（4）发布底层的状态变量" class="headerlink" title="（4）发布底层的状态变量"></a>（4）发布底层的状态变量</h5><h5 id="（5）示例：发布状态的车辆追踪其"><a href="#（5）示例：发布状态的车辆追踪其" class="headerlink" title="（5）示例：发布状态的车辆追踪其"></a>（5）示例：发布状态的车辆追踪其</h5><h4 id="4-4-在现有的线程安全类中添加功能"><a href="#4-4-在现有的线程安全类中添加功能" class="headerlink" title="4.4 在现有的线程安全类中添加功能"></a>4.4 在现有的线程安全类中添加功能</h4><p>重用能降低开发工作量、开发风险（因为现有的类都已经通过测试）以及维护成本。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BetterVector</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">Vector</span>&lt;E&gt;&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">putIfAbsent</span><span class="params">(E x)</span>&#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">absent</span> <span class="operator">=</span> !cotains(x);</span><br><span class="line">        <span class="keyword">if</span>(absent)</span><br><span class="line">            add(x);</span><br><span class="line">        <span class="keyword">return</span> absent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="（1）客户端加锁机制"><a href="#（1）客户端加锁机制" class="headerlink" title="（1）客户端加锁机制"></a>（1）客户端加锁机制</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ListHelper</span>&lt;E&gt;&#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;E&gt; list = Collections.synchronizedList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;E&gt;());</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">putIfAbsent</span><span class="params">(E x)</span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(list)&#123;</span><br><span class="line">        	<span class="type">boolean</span> <span class="variable">absent</span> <span class="operator">=</span> !list.contains(x);</span><br><span class="line">        	<span class="keyword">if</span>(absent)</span><br><span class="line">            	list.add(x);</span><br><span class="line">        	<span class="keyword">return</span> absent;    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过添加一个原子操作来扩展类是脆弱的，因为它将类的加锁代码分布到多个类中。</p>
<p>客户端加锁会破坏同步策略的封装性。</p>
<h5 id="（2）组合"><a href="#（2）组合" class="headerlink" title="（2）组合"></a>（2）组合</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImprovedList</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">List</span>&lt;T&gt;&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;T&gt; list;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ImprovedList</span><span class="params">(List&lt;T&gt; list)</span>&#123;<span class="built_in">this</span>.list = list;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">putIfAbsent</span><span class="params">(T x)</span>&#123;</span><br><span class="line">        <span class="type">booelan</span> <span class="variable">contains</span> <span class="operator">=</span> list.contains(x);</span><br><span class="line">        <span class="keyword">if</span>(contains)</span><br><span class="line">            list.add(x);</span><br><span class="line">        <span class="keyword">return</span> !contains;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span>&#123;list.clear();&#125;</span><br><span class="line">    <span class="comment">//...按照类似的方式委托List其他方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并不关心底层的List是否是线程安全的，即使List不是线程安全的或者修改了它的加锁实现，ImprovedList也会提供一致的加锁机制来实现线程安全性。</p>
<h4 id="4-5-将同步策略文档化"><a href="#4-5-将同步策略文档化" class="headerlink" title="4.5 将同步策略文档化"></a>4.5 将同步策略文档化</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在文档中说明客户代码需要了解的线程安全性保证，以及代码维护人员需要了解的同步策略</span><br></pre></td></tr></table></figure>

<h3 id="第五章-基础构建模块"><a href="#第五章-基础构建模块" class="headerlink" title="第五章 基础构建模块"></a>第五章 基础构建模块</h3><h4 id="5-1-同步容器类"><a href="#5-1-同步容器类" class="headerlink" title="5.1 同步容器类"></a>5.1 同步容器类</h4><p>同步容器类包括Vector和Hashtable</p>
<p>Collections.synchronizedXxx等工厂方法创建同步的封装器类</p>
<p>这些类实现线程安全的方式是：将它们的状态封装起来，并对每个公有方法都进行同步，使得每次只有一个线程能访问容器的状态。</p>
<h5 id="（1）同步容器类的问题"><a href="#（1）同步容器类的问题" class="headerlink" title="（1）同步容器类的问题"></a>（1）同步容器类的问题</h5><p>同步线程类是线程安全的，但在某些情况下可能需要额外的客户端加锁来保护复合操作。</p>
<p>例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getLast</span><span class="params">(Vector list)</span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">lastIndex</span> <span class="operator">=</span> list.size() - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> list.get(lastIndex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deleteLast</span><span class="params">(Vector list)</span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">lastIndex</span> <span class="operator">=</span> list.size()-<span class="number">1</span>;</span><br><span class="line">    list.remove(lastIndex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>多线程中getLast可能会出现ArrayIndexOutOfBoundsException异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getLast</span><span class="params">(Vector list)</span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span>(list)&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">lastIndex</span> <span class="operator">=</span> list.size()-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> list.get(lastIndex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deleteLast</span><span class="params">(Vector list)</span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(list)&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">lastIndex</span> <span class="operator">=</span> list.size() -<span class="number">1</span>;</span><br><span class="line">        list.remove(lastIndex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端加锁解决不可靠迭代问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (vector)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i&lt;vector.size();i++)</span><br><span class="line">        doSomething(vector.get(i));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="（2）迭代器与ConcurrentModificationException"><a href="#（2）迭代器与ConcurrentModificationException" class="headerlink" title="（2）迭代器与ConcurrentModificationException"></a>（2）迭代器与ConcurrentModificationException</h5><p>在设计同步容器类的迭代器时并没有考虑到并发修改的问题，并且他们表现出的行为是“及时失败”（fail-fast）的。意味着，当他们发现容器在迭代过程中被修改时，会抛出一个ConcurrentModificationException异常。</p>
<p>如果不希望再迭代期对容器加锁，那么一种替代方法就是“克隆”容器，并在副本上进行迭代。（克隆过程中仍然需要对容器加锁）</p>
<h5 id="（3）隐藏迭代器"><a href="#（3）隐藏迭代器" class="headerlink" title="（3）隐藏迭代器"></a>（3）隐藏迭代器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HiddenIterator</span>&#123;</span><br><span class="line">	<span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Integer&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Integer&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(Integer i)</span>&#123;</span><br><span class="line">        set.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(Integer i)</span>&#123;</span><br><span class="line">        set.remove(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTenThings</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)</span><br><span class="line">            add(r.nextInt());</span><br><span class="line">        System.out.println(<span class="string">&quot;DEBUG:added ten elements to &quot;</span>+set);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">&quot;DEBUG:added ten elements to &quot;</span>+set);</span><br></pre></td></tr></table></figure>

<p>这里将字符串的连接操作转换为调用StringBuilder.append(Object)，这个方法会调用容器的toString方法，<strong>标准容器的toString方法将迭代容器</strong>。</p>
<p>如果HiddenIterator用synchronizedSet来包装HashSet，并且对同步代码进行封装，那么就不会发生这种错误。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">正如封装对象的状态有助于维持不变性条件一样，封装对象的同步机制同样有助于确保实施同步策略。</span><br></pre></td></tr></table></figure>

<h4 id="5-2-并发容器"><a href="#5-2-并发容器" class="headerlink" title="5.2 并发容器"></a>5.2 并发容器</h4><p>Java5.0提供了多种并发容器类改进同步容器的性能。</p>
<p>同步容器将所有对容器状态的访问都串行化，代价是严重降低并发性，当多个线程竞争容器的锁时，吞吐量严重降低。</p>
<p>并发容器针对多个线程并发访问设计。</p>
<p>Java5.0增加了ConcurrentHashMap，用来代替同步且基于散列的Map，以及CopyOnWriteArrayList，用于在遍历操作为主要操作的情况下代替同步的List。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">通过并发容器来代替同步容器，可以极大地提高伸缩性并降低风险。</span><br></pre></td></tr></table></figure>

<p>Java5.0增加了两种新的容器类型：Queue和BlockingQueue</p>
<p>Queue用来临时保存一组等待处理的元素。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="tag">并发编程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag">读书笔记</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-hello-world"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/07/05/hello-world/"
    >Hello World</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/07/05/hello-world/" class="article-date">
  <time datetime="2022-07-05T07:59:50.719Z" itemprop="datePublished">2022-07-05</time>
</a>    
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-设计模式"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/03/18/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"
    >设计模式</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/03/18/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="article-date">
  <time datetime="2022-03-18T02:29:00.000Z" itemprop="datePublished">2022-03-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h1><h2 id="构建型设计模式"><a href="#构建型设计模式" class="headerlink" title="构建型设计模式"></a>构建型设计模式</h2><h3 id="1、工厂设计模式"><a href="#1、工厂设计模式" class="headerlink" title="1、工厂设计模式"></a>1、工厂设计模式</h3><p>简单工厂模式：一个工厂类负责new对象，需要构建直接调用方法</p>
<p>工厂方法模式：父类中只有一个抽象方法，子类重写该方法构造</p>
<p>抽象工厂模式：有一个总的抽象父类</p>
<h3 id="2、单例设计模式"><a href="#2、单例设计模式" class="headerlink" title="2、单例设计模式"></a>2、单例设计模式</h3><p>饿汉式</p>
<p>懒汉式：双检锁、静态内部类</p>
<h3 id="3、建造型模式"><a href="#3、建造型模式" class="headerlink" title="3、建造型模式"></a>3、建造型模式</h3><p>实体类内部构建一个builder实体，负责定义属性</p>
<h3 id="4、原型模式"><a href="#4、原型模式" class="headerlink" title="4、原型模式"></a>4、原型模式</h3><p>原型实例指定创建对象的种类，并且通过拷贝这些原型创建新的对象。</p>
<p>实现Cloneable，重写clone()方法，原本的clone()方法只有浅拷贝</p>
<h2 id="结构型模式"><a href="#结构型模式" class="headerlink" title="结构型模式"></a>结构型模式</h2><h3 id="1、适配器模式"><a href="#1、适配器模式" class="headerlink" title="1、适配器模式"></a>1、适配器模式</h3><ul>
<li>增加一个适配器，对数据进行转换，防止数据异常</li>
</ul>
<h3 id="2、桥接模式"><a href="#2、桥接模式" class="headerlink" title="2、桥接模式"></a>2、桥接模式</h3><ul>
<li>将抽象部分与实现部分分离。形状桥接颜色</li>
<li>合成 &#x2F; 聚合复用原则：优先使用合成 &#x2F; 聚合，而不是类继承。</li>
</ul>
<h3 id="3、组合模式"><a href="#3、组合模式" class="headerlink" title="3、组合模式"></a>3、组合模式</h3><p>管理员和员工</p>
<ul>
<li>整体与部分有相似的结构，在操作时可以被一致对待时，就可以使用组合模式。</li>
</ul>
<p>透明方式：在接口中声明所有管理子对象的方法，对于外界来说叶节点和枝节点是透明的，它们具备完全一致的接口。</p>
<p>安全方式：在接口中不声明某些子类特有的方法</p>
<h3 id="4、装饰模式"><a href="#4、装饰模式" class="headerlink" title="4、装饰模式"></a>4、装饰模式</h3><ul>
<li>增强原有功能	透明装饰模式</li>
<li>添加新功能      半透明装饰模式</li>
</ul>
<h3 id="5、外观模式"><a href="#5、外观模式" class="headerlink" title="5、外观模式"></a>5、外观模式</h3><p>将多个子系统封装起来，提供一个更简洁的接口供外部调用。</p>
<h3 id="6、享元模式"><a href="#6、享元模式" class="headerlink" title="6、享元模式"></a>6、享元模式</h3><p>共享对象</p>
<p>程序可复用的特点</p>
<h3 id="7、代理模式"><a href="#7、代理模式" class="headerlink" title="7、代理模式"></a>7、代理模式</h3><p>静态代理</p>
<p>动态代理</p>
<h2 id="行为型模式"><a href="#行为型模式" class="headerlink" title="行为型模式"></a>行为型模式</h2><h3 id="1、责任链设计模式"><a href="#1、责任链设计模式" class="headerlink" title="1、责任链设计模式"></a>1、责任链设计模式</h3><p>主要用于处理职责相同，程度不同的类</p>
<h3 id="2、命令模式"><a href="#2、命令模式" class="headerlink" title="2、命令模式"></a>2、命令模式</h3><p>定义命令接口，接口中有执行，和撤销操作（将命令看作一个对象）</p>
<p>通过Stack&lt;&gt;存取，撤销时，可以多次撤销</p>
<p>宏命令</p>
<p>宏命令就是<strong>将多个命令合并起来组成的命令</strong>。</p>
<h3 id="3、解释器模式"><a href="#3、解释器模式" class="headerlink" title="3、解释器模式"></a>3、解释器模式</h3><p>在解释器模式中，我们将不可拆分的最小单元称之为终结表达式，可以被拆分的表达式称之为非终结表达式。</p>
<h3 id="4、迭代器模式"><a href="#4、迭代器模式" class="headerlink" title="4、迭代器模式"></a>4、迭代器模式</h3><p>提供一种方法访问一个容器对象中各个元素，而又不需暴露该对象的内部细节。</p>
<h3 id="5、中介者模式"><a href="#5、中介者模式" class="headerlink" title="5、中介者模式"></a>5、中介者模式</h3><p>定义一个中介对象来封装一系列对象之间的交互，使原有对象之间的耦合松散，且可以独立地改变它们之间的交互。</p>
<h3 id="6、备忘录模式"><a href="#6、备忘录模式" class="headerlink" title="6、备忘录模式"></a>6、备忘录模式</h3><p>在不破坏封装的条件下，通过备忘录对象存储另外一个对象内部状态的快照，在将来合适的时候把这个对象还原到存储起来的状态</p>
<h3 id="7、观察者模式"><a href="#7、观察者模式" class="headerlink" title="7、观察者模式"></a>7、观察者模式</h3><p>定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都得到通知并被自动更新。</p>
<h3 id="8、状态模式"><a href="#8、状态模式" class="headerlink" title="8、状态模式"></a>8、状态模式</h3><p>每个状态类都实现了 IUser 接口，在接口方法中实现自己特定的行为。</p>
<h3 id="9、策略模式"><a href="#9、策略模式" class="headerlink" title="9、策略模式"></a>9、策略模式</h3><p>定义了一系列算法，并将每一个算法封装起来，而且使它们还可以相互替换。策略模式让算法独立于使用它的客户而独立变化</p>
<h3 id="10、模板方法模式"><a href="#10、模板方法模式" class="headerlink" title="10、模板方法模式"></a>10、模板方法模式</h3><p>定义一个操作中的算法的骨架，而将一些步骤延迟到子类中。模板方法使得子类可以不改变一个算法的结构即可重定义该算法的某些特定步骤。</p>
<h3 id="11、访问者模式"><a href="#11、访问者模式" class="headerlink" title="11、访问者模式"></a>11、访问者模式</h3><p>将<code>数据的结构</code>和<code>对数据的操作</code>分离。</p>
<p>表示一个作用于某对象结构中的各元素的操作。它使你可以在不改变各元素的类的前提下定义作用于这些元素的新操作。</p>
<p>单分派和双重分派的区别就是：程序在选择重载方法和重写方法时，如果两种情况都是动态分派的，则称之为双重分派；如果其中一种情况是动态分派，另一种是静态分派，则称之为单分派。</p>
<p><strong>用重写方法的动态分派特性将重载方法也模拟成动态分派</strong>。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag">读书笔记</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-redis详解"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/03/02/redis%E8%AF%A6%E8%A7%A3/"
    >redis详解</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/03/02/redis%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time datetime="2022-03-02T06:06:25.000Z" itemprop="datePublished">2022-03-02</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><h2 id="1、Redis入门介绍"><a href="#1、Redis入门介绍" class="headerlink" title="1、Redis入门介绍"></a>1、Redis入门介绍</h2><ul>
<li>Redis运行速度快，并发性能强，运行在内存上的NoSql（not only sql）数据库</li>
</ul>
<h2 id="2、分布式数据库CAP原理"><a href="#2、分布式数据库CAP原理" class="headerlink" title="2、分布式数据库CAP原理"></a>2、分布式数据库CAP原理</h2><ul>
<li>传统的关系型数据库事务<ul>
<li><strong>A（Atomicity）</strong>：原子性，事务操作要么都成功，要么都失败</li>
<li><strong>C（Consistency）</strong>：一致性，事务开始前后，数据库完整性没有被破坏。</li>
<li><strong>I（Isolation）</strong>：独立性，防止多个事务交叉执行导致数据不一致</li>
<li><strong>D（Durability</strong>）：持久性，数据处理后，数据修改是永久的</li>
</ul>
</li>
<li>分布式数据库CAP<ul>
<li><strong>C（Consistency）</strong>：强一致性，所有节点同一时间数据完全一致</li>
<li><strong>A（Availability）</strong>：高可用性，服务一直可用</li>
<li><strong>P（Partiton tolerance）</strong>：分区容错性，某分区或网络分区故障时，仍然能够对外提供一致性或可用性的服务。</li>
</ul>
</li>
</ul>
<h1 id="二、使用Redis"><a href="#二、使用Redis" class="headerlink" title="二、使用Redis"></a>二、使用Redis</h1><h2 id="1、五大数据类型"><a href="#1、五大数据类型" class="headerlink" title="1、五大数据类型"></a>1、五大数据类型</h2><h3 id="（1）字符串String"><a href="#（1）字符串String" class="headerlink" title="（1）字符串String"></a>（1）字符串String</h3><ul>
<li>set&#x2F;get&#x2F;del&#x2F;append&#x2F;strlen</li>
<li>incr&#x2F;decr&#x2F;incrby&#x2F;decrby加减</li>
<li>getrange&#x2F;setrange:类似between…and…<ul>
<li>range：范围</li>
</ul>
</li>
<li>setex&#x2F;setnx<ul>
<li>set with expir:添加数据的同时设置生命周期</li>
<li>set if not exist:：添加数据的时候判断是否已经存在，防止已存在的数据被覆盖掉</li>
</ul>
</li>
<li>mset&#x2F;mget&#x2F;msetnx</li>
<li>m:more更多</li>
<li>getset:先get后set</li>
</ul>
<h3 id="（2）列表List"><a href="#（2）列表List" class="headerlink" title="（2）列表List"></a>（2）列表List</h3><ul>
<li>lpush&#x2F;rpush&#x2F;lrange</li>
<li>lpop&#x2F;rpop：移除第一个元素（上左下右）</li>
<li>lindex：根据下标查询元素（从左向右，自上而下）</li>
<li>llen：返回集合长度</li>
<li>lrem：删除n个value</li>
<li>ltrim：截取指定范围的值，别的全扔掉<ul>
<li>ltrim key begindex endindex</li>
</ul>
</li>
<li>rpoplpush：从一个集合搞一个元素到另一个集合中（右出一个，左进一个）</li>
<li>lset：改变某个下标的某个值<ul>
<li>lset key index value</li>
</ul>
</li>
<li>lset：改变某个下标的某个值 lset key index value<ul>
<li>linsert key before&#x2F;after oldvalue newvalue</li>
</ul>
</li>
</ul>
<h3 id="（3）集合Set"><a href="#（3）集合Set" class="headerlink" title="（3）集合Set"></a>（3）集合Set</h3><h3 id="（4）哈希Hash"><a href="#（4）哈希Hash" class="headerlink" title="（4）哈希Hash"></a>（4）哈希Hash</h3><h3 id="（5）有序集合Zset"><a href="#（5）有序集合Zset" class="headerlink" title="（5）有序集合Zset"></a>（5）有序集合Zset</h3> 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nosql/" rel="tag">nosql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/" rel="tag">redis</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-1.java编程基础"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/03/01/1.java%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"
    >java编程基础</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/03/01/1.java%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/" class="article-date">
  <time datetime="2022-03-01T06:06:25.000Z" itemprop="datePublished">2022-03-01</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/java%E5%9F%BA%E7%A1%80/">java基础</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="初识计算机和java语言"><a href="#初识计算机和java语言" class="headerlink" title="初识计算机和java语言"></a>初识计算机和java语言</h1><h2 id="跨平台原理"><a href="#跨平台原理" class="headerlink" title="跨平台原理"></a>跨平台原理</h2><p>Sun 定义了JVM规范，不同的操作系统大多提供了JVM实现，才使得相同的字节码文件可以在不同的系统上运行。</p>
<h1 id="java语言的编程基础"><a href="#java语言的编程基础" class="headerlink" title="java语言的编程基础"></a>java语言的编程基础</h1><h2 id="一、变量（重点）"><a href="#一、变量（重点）" class="headerlink" title="一、变量（重点）"></a>一、变量（重点）</h2><p>变量的声明方式</p>
<ul>
<li>数据类型 变量名 &#x3D; 初始值;</li>
<li>其中&#x3D;初始值可以省略，但;不可以省略</li>
</ul>
<p>标识符的命名法则（笔试）</p>
<ul>
<li>由数字、字母、下划线以及$等组成，其中数字不能开头（后面讲到）。</li>
</ul>
<h2 id="二、数据类型"><a href="#二、数据类型" class="headerlink" title="二、数据类型"></a>二、数据类型</h2><p>1、分类</p>
<p>（1）基本数据类型</p>
<p>byte（1字节）、short（2字节）、int（4字节，默认）、long（8字节，l或L结尾）</p>
<p>float（4字节,f或F结尾）、double（8字节，默认）</p>
<p>char（2字节）</p>
<p>boolean （1字节）</p>
<p>2、单字节表示整数范围（重点）</p>
<ul>
<li>在计算机中单个字节表示八位二进制位，其中最高位(最左边)代表符号位， 使用0代表非负数，使用1代表负数，具体表示的整数范围如下：</li>
<li>非负数表示范围：0000 0000 ~ 0111 1111 &#x3D;&gt; 0 ~ 127 &#x3D;&gt; 0 ~ 2^7-1</li>
<li>负数表示范围：1000 0000 ~ 1111 1111 &#x3D;&gt; -128 ~ -1 &#x3D;&gt; -2^7 ~ -2^0</li>
<li>单个字节表示的整数范围是：-2^7 ~ 2^7-1，也就是-128 ~ 127.</li>
</ul>
<p>3、字符类型</p>
<p>ASCII有：’0’ - 48 ‘A’ - 65 ‘a’ - 97 空格 - 32 换行符 - 10</p>
<h1 id="数组的概念和应用"><a href="#数组的概念和应用" class="headerlink" title="数组的概念和应用"></a>数组的概念和应用</h1><h2 id="一、一维数组"><a href="#一、一维数组" class="headerlink" title="一、一维数组"></a>一、一维数组</h2><h3 id="1、内存结构"><a href="#1、内存结构" class="headerlink" title="1、内存结构"></a>1、内存结构</h3><ul>
<li>栈区：栈用于存放程序运行过程当中所有的局部变量。</li>
<li>堆区：这部分空间用于存储使用new关键字创建的数组和对象。</li>
</ul>
<h3 id="2、数组优缺点"><a href="#2、数组优缺点" class="headerlink" title="2、数组优缺点"></a>2、数组优缺点</h3><ul>
<li>速度快，可以直接通过下标访问指定位置的元素。</li>
<li>数组要求所有元素的类型相同。</li>
<li>数组要求内存空间连续，并且长度一旦确定就不能修改。</li>
<li>增加和删除元素时可能移动大量元素，效率低</li>
</ul>
<h3 id="3、数组工具类"><a href="#3、数组工具类" class="headerlink" title="3、数组工具类"></a>3、数组工具类</h3><p>• java.util.Arrays类可以实现对数组中元素的遍历、查找、排序等操作</p>
<h2 id="二、二维数组"><a href="#二、二维数组" class="headerlink" title="二、二维数组"></a>二、二维数组</h2><h3 id="1、二维数组的声明和初始化方式"><a href="#1、二维数组的声明和初始化方式" class="headerlink" title="1、二维数组的声明和初始化方式"></a>1、二维数组的声明和初始化方式</h3><ul>
<li>数据类型[][] 数组名称 &#x3D; new 数据类型[行数][列数]; </li>
<li>数据类型[][] 数组名称 &#x3D;</li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%98%E9%87%8F/" rel="tag">变量</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" rel="tag">数据类型</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-4.数据库"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/02/25/4.%E6%95%B0%E6%8D%AE%E5%BA%93/"
    >数据库</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/02/25/4.%E6%95%B0%E6%8D%AE%E5%BA%93/" class="article-date">
  <time datetime="2022-02-25T06:06:25.000Z" itemprop="datePublished">2022-02-25</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="SQL语句（重点）"><a href="#SQL语句（重点）" class="headerlink" title="SQL语句（重点）"></a>SQL语句（重点）</h1><h2 id="一、SQL通用语法"><a href="#一、SQL通用语法" class="headerlink" title="一、SQL通用语法"></a>一、SQL通用语法</h2><ul>
<li>MySql使用SQL不区分大小写，一般关键字大写，数据库名 表名列名 小写</li>
<li>– 单行注释</li>
<li>&#x2F;* *&#x2F; 多行注释</li>
<li># MySql特有的注释</li>
</ul>
<h2 id="二、DDL"><a href="#二、DDL" class="headerlink" title="二、DDL"></a>二、DDL</h2><p>数据定义语句，用来定义数据库对象：库、表、列</p>
<h3 id="1、创建数据库"><a href="#1、创建数据库" class="headerlink" title="1、创建数据库"></a>1、创建数据库</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>create database 数据库名；</td>
<td>创建数据库</td>
</tr>
<tr>
<td>create database 数据库名 character set 字符集；</td>
<td>指定字符集</td>
</tr>
</tbody></table>
<h3 id="2、查看选择数据库"><a href="#2、查看选择数据库" class="headerlink" title="2、查看选择数据库"></a>2、查看选择数据库</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>use 数据库</td>
<td>切换数据库</td>
</tr>
<tr>
<td>select database();</td>
<td>查看当前正在使用数据库</td>
</tr>
<tr>
<td>show databases;</td>
<td>查看Mysql中所有数据库</td>
</tr>
<tr>
<td>show create database 数据库名;</td>
<td>查看数据库定义信息</td>
</tr>
</tbody></table>
<h3 id="3、修改数据库"><a href="#3、修改数据库" class="headerlink" title="3、修改数据库"></a>3、修改数据库</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>alter database 数据库名 character set 字符集;</td>
<td>数据库字符集修改</td>
</tr>
</tbody></table>
<h3 id="4、删除数据库"><a href="#4、删除数据库" class="headerlink" title="4、删除数据库"></a>4、删除数据库</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>drop database 数据库名</td>
<td>永久删除数据库</td>
</tr>
</tbody></table>
<h3 id="5、查看表"><a href="#5、查看表" class="headerlink" title="5、查看表"></a>5、查看表</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>show tables;</td>
<td>查看所有表面</td>
</tr>
<tr>
<td>desc 表名;</td>
<td>查看数据表的结构</td>
</tr>
</tbody></table>
<h3 id="6、删除表"><a href="#6、删除表" class="headerlink" title="6、删除表"></a>6、删除表</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>drop table 表名;</td>
<td>删除表</td>
</tr>
<tr>
<td>drop table if exists 表名;</td>
<td>如果存在就删除</td>
</tr>
</tbody></table>
<h2 id="三、DML"><a href="#三、DML" class="headerlink" title="三、DML"></a>三、DML</h2><p>数据操作语句，对表中记录更新</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名 （字段名<span class="number">1</span>，字段名<span class="number">2.</span>..） <span class="keyword">values</span>(字段值<span class="number">1</span>，字段值<span class="number">2.</span>..);</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> 表名 <span class="keyword">set</span> 列名 <span class="operator">=</span> 值 [<span class="keyword">where</span> 条件表达式：字段名 <span class="operator">=</span> 值 ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> 表名 [<span class="keyword">where</span> 字段名 <span class="operator">=</span> 值]</span><br><span class="line"></span><br><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> 表名;</span><br></pre></td></tr></table></figure>

<h2 id="四、DQL"><a href="#四、DQL" class="headerlink" title="四、DQL"></a>四、DQL</h2><p>数据控制语句，查询表中记录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select 列名 from 表名</span><br></pre></td></tr></table></figure>

<p>比较运算符</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>&gt; &lt; &lt;&#x3D; &gt;&#x3D; &#x3D; &lt;&gt; !&#x3D;</td>
<td>大于、小于、小于（大于）等于、不等于</td>
</tr>
<tr>
<td>BETWEEN…AND…</td>
<td>显示某一区间</td>
</tr>
<tr>
<td>IN（集合）</td>
<td>in中的每个数据都会作为一次条件,只要满足条件就会显示</td>
</tr>
<tr>
<td>LIKE ‘%张%’</td>
<td>模糊查询</td>
</tr>
<tr>
<td>IS NULL</td>
<td>查询某一列为NULL的值</td>
</tr>
</tbody></table>
<p>逻辑运算符</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>And &amp;&amp;</td>
<td>多个条件同时成立</td>
</tr>
<tr>
<td>Or ||</td>
<td>多个条件任一成立</td>
</tr>
<tr>
<td>Not</td>
<td>不成立，取反</td>
</tr>
</tbody></table>
<p>通配符</p>
<table>
<thead>
<tr>
<th>通配符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>%</td>
<td>匹配多个字符串</td>
</tr>
<tr>
<td>-</td>
<td>匹配一个字符</td>
</tr>
</tbody></table>
<h1 id="MySql单表-amp-约束-amp-事务"><a href="#MySql单表-amp-约束-amp-事务" class="headerlink" title="MySql单表&amp;约束&amp;事务"></a>MySql单表&amp;约束&amp;事务</h1><h2 id="一、DQL操作单表"><a href="#一、DQL操作单表" class="headerlink" title="一、DQL操作单表"></a>一、DQL操作单表</h2><h3 id="1、排序"><a href="#1、排序" class="headerlink" title="1、排序"></a>1、排序</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 字段名 <span class="keyword">FROM</span> 表名 [<span class="keyword">WHERE</span> 字段 <span class="operator">=</span> 值] <span class="keyword">ORDER</span> <span class="keyword">BY</span> 字段名 [<span class="keyword">ASC</span> <span class="operator">/</span> <span class="keyword">DESC</span>]</span><br></pre></td></tr></table></figure>

<h3 id="2、聚合函数"><a href="#2、聚合函数" class="headerlink" title="2、聚合函数"></a>2、聚合函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 聚合函数(字段名) <span class="keyword">FROM</span> 表名;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>聚合函数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>count(字段)</td>
<td>统计指定列不为NULL的记录行数</td>
</tr>
<tr>
<td>sum(字段)</td>
<td>求和</td>
</tr>
<tr>
<td>max(字段)</td>
<td>最大值</td>
</tr>
<tr>
<td>min(字段)</td>
<td>最小值</td>
</tr>
<tr>
<td>avg(字段)</td>
<td>平均值</td>
</tr>
</tbody></table>
<h3 id="3、分组"><a href="#3、分组" class="headerlink" title="3、分组"></a>3、分组</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 分组字段<span class="operator">/</span>聚合函数 <span class="keyword">FROM</span> 表名 <span class="keyword">GROUP</span> <span class="keyword">BY</span> 分组字段 [<span class="keyword">HAVING</span> 条件];</span><br></pre></td></tr></table></figure>

<ul>
<li>where与having的区别</li>
</ul>
<table>
<thead>
<tr>
<th>过滤方式</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>where</td>
<td>分组前的过滤，后面不可写聚合函数</td>
</tr>
<tr>
<td>having</td>
<td>分组后的过滤，后面写聚合函数</td>
</tr>
</tbody></table>
<h3 id="4、limit关键字"><a href="#4、limit关键字" class="headerlink" title="4、limit关键字"></a>4、limit关键字</h3><p>offset 起始行数, 从0开始记数, 如果省略 则默认为 0.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT 字段1,字段2... FROM 表名 LIMIT offset , length;</span><br></pre></td></tr></table></figure>

<h2 id="二、约束"><a href="#二、约束" class="headerlink" title="二、约束"></a>二、约束</h2><table>
<thead>
<tr>
<th>约束名</th>
<th>关键字</th>
</tr>
</thead>
<tbody><tr>
<td>主键</td>
<td>primary kay</td>
</tr>
<tr>
<td>唯一</td>
<td>unique</td>
</tr>
<tr>
<td>非空</td>
<td>not null</td>
</tr>
<tr>
<td>外键</td>
<td>foreign key</td>
</tr>
</tbody></table>
<h3 id="1、主键约束"><a href="#1、主键约束" class="headerlink" title="1、主键约束"></a>1、主键约束</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">字段名 字段类型 <span class="keyword">primary</span> key</span><br></pre></td></tr></table></figure>

<p>DESC 查看表结构</p>
<ul>
<li>删除主键约束</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 <span class="keyword">DROP</span> <span class="keyword">PRIMARY</span> KEY;</span><br></pre></td></tr></table></figure>

<ul>
<li>主键的自增</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">关键字:</span><br><span class="line">AUTO_INCREMENT 表示自动增长(字段类型必须是整数类型)</span><br></pre></td></tr></table></figure>

<h3 id="2、非空约束"><a href="#2、非空约束" class="headerlink" title="2、非空约束"></a>2、非空约束</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">字段名 字段类型 <span class="keyword">not</span> <span class="keyword">null</span></span><br></pre></td></tr></table></figure>

<h3 id="3、唯一约束"><a href="#3、唯一约束" class="headerlink" title="3、唯一约束"></a>3、唯一约束</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">字段名 字段类型 <span class="keyword">unique</span></span><br></pre></td></tr></table></figure>

<h3 id="4、外键约束"><a href="#4、外键约束" class="headerlink" title="4、外键约束"></a>4、外键约束</h3><ul>
<li>FOREIGN KEY</li>
</ul>
<h3 id="5、默认值"><a href="#5、默认值" class="headerlink" title="5、默认值"></a>5、默认值</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">字段名 字段类型 <span class="keyword">DEFAULT</span> 默认值</span><br></pre></td></tr></table></figure>

<h2 id="三、数据库事务"><a href="#三、数据库事务" class="headerlink" title="三、数据库事务"></a>三、数据库事务</h2><h3 id="1、MySql事务操作"><a href="#1、MySql事务操作" class="headerlink" title="1、MySql事务操作"></a>1、MySql事务操作</h3><ul>
<li>手动提交事务</li>
<li>自动提交事务</li>
</ul>
<p>（1）手动提交事务</p>
<table>
<thead>
<tr>
<th>功能</th>
<th>语句</th>
</tr>
</thead>
<tbody><tr>
<td>开启事务</td>
<td>start transaction;或者BEGIN；</td>
</tr>
<tr>
<td>提交事务</td>
<td>commit；</td>
</tr>
<tr>
<td>回滚事务</td>
<td>rollback；</td>
</tr>
</tbody></table>
<p>（2）自动提交事务</p>
<ul>
<li>MySQL 默认每一条 DML(增删改)语句都是一个单独的事务，每条语句都会自动开启一个事务，语句执 行完毕 自动提交事务，MySQL 默认开始自动提交事务</li>
</ul>
<p>取消自动提交</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> @<span class="variable">@autocommit</span><span class="operator">=</span>off</span><br></pre></td></tr></table></figure>

<h3 id="2、事务的四大特性ACID"><a href="#2、事务的四大特性ACID" class="headerlink" title="2、事务的四大特性ACID"></a>2、事务的四大特性ACID</h3><table>
<thead>
<tr>
<th>特性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>原子性</td>
<td>事务是一个整体，要么都成功，要么都失败</td>
</tr>
<tr>
<td>一致性</td>
<td>执行前和执行后数据库状态一致</td>
</tr>
<tr>
<td>隔离性</td>
<td>事务与事务之间不该互相影响</td>
</tr>
<tr>
<td>持久性</td>
<td>一旦事务执行成功，对数据库的修改是持久的</td>
</tr>
</tbody></table>
<h3 id="3、Mysql事务隔离级别（了解）"><a href="#3、Mysql事务隔离级别（了解）" class="headerlink" title="3、Mysql事务隔离级别（了解）"></a>3、Mysql事务隔离级别（了解）</h3><p>（1）并发访问产生的问题</p>
<table>
<thead>
<tr>
<th>并发访问问题</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>脏读</td>
<td>一个事务读到另一个事务中未提交数据</td>
</tr>
<tr>
<td>不可重复读</td>
<td>一个事务中两次读取的数据内容不一致</td>
</tr>
<tr>
<td>幻读</td>
<td>第一次读取后，其他事务进行了insert或delete操作，第二次读取，数据不一致</td>
</tr>
</tbody></table>
<p>（2）四种隔离级别</p>
<table>
<thead>
<tr>
<th>级别</th>
<th>名字</th>
<th>隔离级别</th>
<th>数据库默认隔离级别</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>读未提交</td>
<td>read uncommitted</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>读已提交</td>
<td>read committed</td>
<td>Oracle和SQLServer</td>
</tr>
<tr>
<td>3</td>
<td>可重复读</td>
<td>repeatable read</td>
<td>MySql</td>
</tr>
<tr>
<td>4</td>
<td>串行化</td>
<td>serializable</td>
<td></td>
</tr>
</tbody></table>
<p>（3）详细</p>
<p><strong>读未提交</strong></p>
<p>一个事务1开启后，进行update操作，此时另一事务2也开启，进行了查询操作，查询到了事务1update操作后的数据，此时事务1未提交，之后事务1回滚，事务2再查询就不一致了，导致了脏读。</p>
<p><strong>读已提交</strong></p>
<p>事务1开启后，进行update操作，此时其他事务无法查询修改，只有等事务1提交后，才能查询修改。只要事务1提交，其他事务查询记录立即改变。</p>
<p>解决了脏读问题，但是如果update之前，事务2进行查询，update提交后，事务2又进行查询，一个事务中查询记录不一致，导致不可重复读。</p>
<p><strong>可重复读</strong></p>
<p>事务1开启后，第一次查询后，事务2进行修改操作，事务2提交后，事务1第二次查询还是之前的记录.</p>
<p>可能读到别的事务新增或删除的数据，导致幻读</p>
<p><strong>串行化</strong></p>
<p>Serializable最高的事务隔离级别，事务串行化顺序执行，避免脏读、不可重复读和幻读。</p>
<p>效率低下，耗数据库性能，一般不使用。</p>
<h1 id="MySQL多表-amp-外键-amp-数据库设计"><a href="#MySQL多表-amp-外键-amp-数据库设计" class="headerlink" title="MySQL多表&amp;外键&amp;数据库设计"></a>MySQL多表&amp;外键&amp;数据库设计</h1><h2 id="一、外键约束"><a href="#一、外键约束" class="headerlink" title="一、外键约束"></a>一、外键约束</h2><h3 id="1、创建外键约束"><a href="#1、创建外键约束" class="headerlink" title="1、创建外键约束"></a>1、创建外键约束</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">CONSTRAINT</span>] [外键约束名称] <span class="keyword">FOREIGN</span> KEY(外键字段名) <span class="keyword">REFERENCES</span> 主表名(主键字段名)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE 从表 ADD [CONSTRAINT] [外键约束名称] FOREIGN KEY (外键字段名) REFERENCES 主表(主 键字段名);</span><br></pre></td></tr></table></figure>

<h3 id="2、删除外键约束"><a href="#2、删除外键约束" class="headerlink" title="2、删除外键约束"></a>2、删除外键约束</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 从表 <span class="keyword">drop</span> <span class="keyword">foreign</span> key 外键约束名称</span><br></pre></td></tr></table></figure>

<h3 id="3、级联删除操作（了解）"><a href="#3、级联删除操作（了解）" class="headerlink" title="3、级联删除操作（了解）"></a>3、级联删除操作（了解）</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE</span><br></pre></td></tr></table></figure>

<h2 id="二、多表查询"><a href="#二、多表查询" class="headerlink" title="二、多表查询"></a>二、多表查询</h2><h3 id="1、笛卡尔积"><a href="#1、笛卡尔积" class="headerlink" title="1、笛卡尔积"></a>1、笛卡尔积</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 字段名 <span class="keyword">FROM</span> 表<span class="number">1</span>, 表<span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2、多表查询的分类"><a href="#2、多表查询的分类" class="headerlink" title="2、多表查询的分类"></a>2、多表查询的分类</h3><p>（1）内连接查询</p>
<ul>
<li><p>通过指定的条件去匹配两张表中的数据, 匹配上就显示,匹配不上就不显示</p>
</li>
<li><p>隐式内连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 字段名 <span class="keyword">FROM</span> 左表, 右表 <span class="keyword">WHERE</span> 连接条件;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显式内连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 字段名 <span class="keyword">FROM</span> 左表 [<span class="keyword">INNER</span>] <span class="keyword">JOIN</span> 右表 <span class="keyword">ON</span> 条件</span><br><span class="line"><span class="comment">-- inner 可以省略</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>（2）外连接查询</p>
<ul>
<li><p>左外连接</p>
<p>使用LEFT 【OUTER】 JOIN</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 字段名 <span class="keyword">FROM</span> 左表 <span class="keyword">LEFT</span> [<span class="keyword">OUTER</span>] <span class="keyword">JOIN</span> 右表 <span class="keyword">ON</span> 条件</span><br></pre></td></tr></table></figure>
</li>
<li><p>右外连接</p>
<p>使用RIGHT 【OUTER】 JOIN</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 字段名 <span class="keyword">FROM</span> 左表 <span class="keyword">RIGHT</span> [<span class="keyword">OUTER</span> ]<span class="keyword">JOIN</span> 右表 <span class="keyword">ON</span> 条件</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="三、子查询"><a href="#三、子查询" class="headerlink" title="三、子查询"></a>三、子查询</h2><h3 id="1、子查询概念"><a href="#1、子查询概念" class="headerlink" title="1、子查询概念"></a>1、子查询概念</h3><ul>
<li>where型 子查询：将子查询结果，作为父查询的比较条件</li>
<li>from型 子查询：将子查询的结果，作为一张表，提供给父层查询使用</li>
<li>exists型 子查询：子查询的结果式单列多行，父层查询用IN函数，包含子查询结果</li>
</ul>
<h3 id="2、总结"><a href="#2、总结" class="headerlink" title="2、总结"></a>2、总结</h3><ol>
<li>子查询如果查出的是一个字段(单列), 那就在where后面作为条件使用.</li>
<li>子查询如果查询出的是多个字段(多列), 就当做一张表使用(要起别名).</li>
</ol>
<h2 id="四、数据库设计"><a href="#四、数据库设计" class="headerlink" title="四、数据库设计"></a>四、数据库设计</h2><h3 id="1、第一范式-1NF"><a href="#1、第一范式-1NF" class="headerlink" title="1、第一范式 1NF"></a>1、第一范式 1NF</h3><ul>
<li>概念：<ul>
<li>原子性，列不可分</li>
</ul>
</li>
</ul>
<h3 id="2、第二范式2NF"><a href="#2、第二范式2NF" class="headerlink" title="2、第二范式2NF"></a>2、第二范式2NF</h3><ul>
<li>概念：<ul>
<li>每列都和主键相关，一张表只能描述一件事</li>
</ul>
</li>
</ul>
<h3 id="3、第三范式3NF"><a href="#3、第三范式3NF" class="headerlink" title="3、第三范式3NF"></a>3、第三范式3NF</h3><ul>
<li>概念：<ul>
<li>消除依赖传递</li>
<li>如果能被推到，就不应单独设计</li>
</ul>
</li>
</ul>
<h1 id="MySQL索引-amp-视图-amp-存储过程"><a href="#MySQL索引-amp-视图-amp-存储过程" class="headerlink" title="MySQL索引&amp;视图&amp;存储过程"></a>MySQL索引&amp;视图&amp;存储过程</h1><h2 id="一、MySQL索引"><a href="#一、MySQL索引" class="headerlink" title="一、MySQL索引"></a>一、MySQL索引</h2><h3 id="1、常见索引分类"><a href="#1、常见索引分类" class="headerlink" title="1、常见索引分类"></a>1、常见索引分类</h3><table>
<thead>
<tr>
<th>索引名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>主键索引（primary key）</td>
<td>一种唯一性索引,每个表只能有一个主键, 用于标识数据表中的每一 条记录</td>
</tr>
<tr>
<td>唯一索引（unique）</td>
<td>索引列的索引所有值只能出现一次，必须唯一</td>
</tr>
<tr>
<td>普通索引（index）</td>
<td>作用就是加快对数据的访问速度</td>
</tr>
</tbody></table>
<ul>
<li><p>主键索引</p>
<ul>
<li>&#96;&#96;&#96;sql<br>CREATE TABLE 表名(<br>– 添加主键 (主键是唯一性索引,不能为null,不能重复,)<br>字段名 类型 PRIMARY KEY,<br>);<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 唯一索引</span><br><span class="line"></span><br><span class="line">  - ```sql</span><br><span class="line">    CREATE TABLE 表名(</span><br><span class="line">    列名 类型(长度),</span><br><span class="line">    -- 添加唯一索引</span><br><span class="line">    UNIQUE [索引名称] (列名)</span><br><span class="line">    );</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>普通索引</p>
<ul>
<li>&#96;&#96;&#96;sql<br>create index 索引名 on 表名(列名[长度])<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 删除索引</span><br><span class="line"></span><br><span class="line">  - ```sql</span><br><span class="line">    ALTER TABLE table_name DROP INDEX index_name;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="2、优缺点"><a href="#2、优缺点" class="headerlink" title="2、优缺点"></a>2、优缺点</h3><ul>
<li>优点<ul>
<li>大大的提高查询速度 </li>
<li>可以显著的减少查询中分组和排序的时间。</li>
</ul>
</li>
<li>缺点<ul>
<li>创建索引和维护索引需要时间，而且数据量越大时间越长</li>
<li>当对表中的数据进行增加，修改，删除的时候，索引也要同时进行维护，降低了数据的维护速度</li>
</ul>
</li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-3.java新特性"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2022/02/23/3.java%E6%96%B0%E7%89%B9%E6%80%A7/"
    >java新特性</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/02/23/3.java%E6%96%B0%E7%89%B9%E6%80%A7/" class="article-date">
  <time datetime="2022-02-23T06:03:25.000Z" itemprop="datePublished">2022-02-23</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/java%E5%9F%BA%E7%A1%80/">java基础</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="常用设计原则和设计模式"><a href="#常用设计原则和设计模式" class="headerlink" title="常用设计原则和设计模式"></a>常用设计原则和设计模式</h1><h2 id="一、设计原则（记住）"><a href="#一、设计原则（记住）" class="headerlink" title="一、设计原则（记住）"></a>一、设计原则（记住）</h2><ul>
<li>开闭原则<ul>
<li>对扩展开放对修改关闭，易维护升级</li>
</ul>
</li>
<li>里氏代换原则<ul>
<li>任何基类可出现的地方，子类一定可出现，多使用多态</li>
</ul>
</li>
<li>依赖倒转原则<ul>
<li>多依赖于抽象和接口而不是具体实现，对子类具有强制性和规范性</li>
</ul>
</li>
<li>接口隔离原则<ul>
<li>多使用小接口，避免接口污染，降低耦合</li>
</ul>
</li>
<li>迪米特法则（最少知道原则）<ul>
<li>高内聚低耦合，实体尽量少相互作用</li>
</ul>
</li>
<li>合成复用原则<ul>
<li>多使用合成&#x2F;聚合方式</li>
</ul>
</li>
</ul>
<h2 id="二、设计模式"><a href="#二、设计模式" class="headerlink" title="二、设计模式"></a>二、设计模式</h2><h3 id="1、基本分类"><a href="#1、基本分类" class="headerlink" title="1、基本分类"></a>1、基本分类</h3><ul>
<li>创建型模式-单例设计模式、工厂方法模式、抽象工厂模式、…</li>
<li>结构型模式-装饰器模式、代理模式、…</li>
<li>行为型模式-模板设计模式、…</li>
</ul>
<h2 id="三、设计模式详解（重点）"><a href="#三、设计模式详解（重点）" class="headerlink" title="三、设计模式详解（重点）"></a>三、设计模式详解（重点）</h2><h3 id="1、单例设计模式"><a href="#1、单例设计模式" class="headerlink" title="1、单例设计模式"></a>1、单例设计模式</h3><ul>
<li>饿汉式</li>
<li>懒汉式，需要对多线程进行同步处理</li>
</ul>
<h3 id="2、普通工厂模式"><a href="#2、普通工厂模式" class="headerlink" title="2、普通工厂模式"></a>2、普通工厂模式</h3><p>建立一个工厂类，对实现了同一接口的不同实现类进行实例创建</p>
<p><img src="/images/3_1.jpg" alt="普通工厂模式"></p>
<h3 id="3、多个工厂方法模式"><a href="#3、多个工厂方法模式" class="headerlink" title="3、多个工厂方法模式"></a>3、多个工厂方法模式</h3><p><img src="/images/3_2.jpg" alt="多个工厂方法模式"></p>
<h3 id="4、静态工厂方法模式"><a href="#4、静态工厂方法模式" class="headerlink" title="4、静态工厂方法模式"></a>4、静态工厂方法模式</h3><p><img src="/images/3_3.jpg" alt="静态工厂方法模式"></p>
<h3 id="5、抽象工厂模式"><a href="#5、抽象工厂模式" class="headerlink" title="5、抽象工厂模式"></a>5、抽象工厂模式</h3><p><img src="/images/3_4.jpg" alt="抽象工厂模式"></p>
<h3 id="6、装饰器模式"><a href="#6、装饰器模式" class="headerlink" title="6、装饰器模式"></a>6、装饰器模式</h3><p>（1）基本概念</p>
<ul>
<li>装饰器模式给一个对象增加一些新功能，要求装饰对象和被装饰对象实现同一个接口，装饰对象持有被装饰对象的实例。</li>
</ul>
<p><img src="/images/3_5.jpg" alt="装饰器模式"></p>
<h3 id="7、代理模式"><a href="#7、代理模式" class="headerlink" title="7、代理模式"></a>7、代理模式</h3><h4 id="（1）基本类型"><a href="#（1）基本类型" class="headerlink" title="（1）基本类型"></a>（1）基本类型</h4><ul>
<li>找一个代理类替原对象进行一些操作</li>
</ul>
<p><img src="/images/3_6.jpg" alt="代理模式"></p>
<h4 id="2-比较"><a href="#2-比较" class="headerlink" title="(2)比较"></a>(2)比较</h4><ul>
<li>装饰器模式是接收对象为参数，代理模式是在代理类中创建对象</li>
<li>装饰器模式关注于在一个对象上动态添加方法，代理模式关注控制对对象访问</li>
</ul>
<h3 id="8、模板方法模式"><a href="#8、模板方法模式" class="headerlink" title="8、模板方法模式"></a>8、模板方法模式</h3><p><img src="/images/3_7.jpg" alt="代理模式"></p>
<h1 id="新特性"><a href="#新特性" class="headerlink" title="新特性"></a>新特性</h1><h2 id="一、Java8新特性"><a href="#一、Java8新特性" class="headerlink" title="一、Java8新特性"></a>一、Java8新特性</h2><p>2014年3月发布</p>
<h3 id="1、函数式接口"><a href="#1、函数式接口" class="headerlink" title="1、函数式接口"></a>1、函数式接口</h3><ul>
<li><p>指只包含一个抽象方法的接口，如：java.lang.Runnable、java.util.Comparator接口等</p>
</li>
<li><p>@FunctionalInterface注解定义函数接口，若接口不符合函数式规范便会报错</p>
</li>
<li><p>java.util.function包</p>
<table>
<thead>
<tr>
<th>接口</th>
<th>方法</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>Consumer</td>
<td>void accept(T t)</td>
<td>根据指定参数执行操作</td>
</tr>
<tr>
<td>Supplier</td>
<td>T get()</td>
<td>得到一个返回</td>
</tr>
<tr>
<td>Function&lt;T,R&gt;</td>
<td>R apply(T t)</td>
<td>根据指定参数执行操作并返回</td>
</tr>
<tr>
<td>Predicate</td>
<td>boolean test(T t)</td>
<td>判断指定参数是否满足条件</td>
</tr>
</tbody></table>
</li>
</ul>
<h3 id="2、Lambda表达式"><a href="#2、Lambda表达式" class="headerlink" title="2、Lambda表达式"></a>2、Lambda表达式</h3><ul>
<li>参数列表、箭头符号-&gt;和方法体组成，方法体中可以是表达式，也可以是语句块</li>
<li>语法格式：(参数列表)-&gt;{方法体;}   -其中()、参数类型、{}以及return关键字可以省略。</li>
</ul>
<h3 id="3、方法引用"><a href="#3、方法引用" class="headerlink" title="3、方法引用"></a>3、方法引用</h3><ul>
<li>方法引用使用一对冒号::将类或对象进行连接<ul>
<li>对象的非静态方法引用 ObjectName :: MethodName</li>
<li>类的静态方法引用 ClassName :: StaticMethodName</li>
<li>类的静态方法引用 ClassName :: MethodName</li>
<li>构造器的引用 ClassName :: new</li>
<li>数组的引用 TypeName[] :: new</li>
</ul>
</li>
</ul>
<h3 id="4、Stream接口（暂无）"><a href="#4、Stream接口（暂无）" class="headerlink" title="4、Stream接口（暂无）"></a>4、Stream接口（暂无）</h3><h3 id="5、Optional类"><a href="#5、Optional类" class="headerlink" title="5、Optional类"></a>5、Optional类</h3><h4 id="（1）基本概念"><a href="#（1）基本概念" class="headerlink" title="（1）基本概念"></a>（1）基本概念</h4><ul>
<li>java.util.Optional类可以理解为一个简单的容器，其值可能是null或不是null，代表一个值存在或不存在</li>
<li>不用显式进行空值检测</li>
</ul>
<h4 id="（2）方法"><a href="#（2）方法" class="headerlink" title="（2）方法"></a>（2）方法</h4><table>
<thead>
<tr>
<th>方法</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>static Optional ofNullable(T value)</td>
<td>根据参数指定数值的到Optional类型对象</td>
</tr>
<tr>
<td>Optional map(Function&lt;? super T,? extends U&gt; mapper)</td>
<td>根据参数指定规则的结果来得到Optional类型的对象</td>
</tr>
<tr>
<td>T orElse(T other)</td>
<td>若该值存在就返回，否则返回other的数值</td>
</tr>
</tbody></table>
<h2 id="二、Java9的新特性"><a href="#二、Java9的新特性" class="headerlink" title="二、Java9的新特性"></a>二、Java9的新特性</h2><p>2017年9月</p>
<h3 id="1、模块化的使用"><a href="#1、模块化的使用" class="headerlink" title="1、模块化的使用"></a>1、模块化的使用</h3><h4 id="（1）语法格式"><a href="#（1）语法格式" class="headerlink" title="（1）语法格式"></a>（1）语法格式</h4><p>module 模块名称 {</p>
<p>}</p>
<h4 id="（2）模块化优势"><a href="#（2）模块化优势" class="headerlink" title="（2）模块化优势"></a>（2）模块化优势</h4><ul>
<li>减少内存的开销</li>
<li>可简化各种类库和大型应用的开发和维护</li>
<li>安全性，可维护性，提高性能</li>
</ul>
<h3 id="2、钻石操作符"><a href="#2、钻石操作符" class="headerlink" title="2、钻石操作符"></a>2、钻石操作符</h3><ul>
<li>在Java9中允许在匿名内部类的使用中使用钻石操作符。</li>
</ul>
<h2 id="三、Java10新特性"><a href="#三、Java10新特性" class="headerlink" title="三、Java10新特性"></a>三、Java10新特性</h2><h3 id="1、Java10的概述"><a href="#1、Java10的概述" class="headerlink" title="1、Java10的概述"></a>1、Java10的概述</h3><ul>
<li>2018年3月发布，本地类型推断、一个垃圾回收的增强</li>
</ul>
<h3 id="2、局部类型推断"><a href="#2、局部类型推断" class="headerlink" title="2、局部类型推断"></a>2、局部类型推断</h3><h4 id="（1）基本概念-1"><a href="#（1）基本概念-1" class="headerlink" title="（1）基本概念"></a>（1）基本概念</h4><ul>
<li>Java10可使用var定义局部变量类型推断标识符，此符号仅适用于局部变量，</li>
<li>不能使用于方法形式参数，构造函数形式参数，方法返回类型，字段，catch形式参数或任何其他类型的变量声明。</li>
</ul>
<h4 id="（2）实际意义"><a href="#（2）实际意义" class="headerlink" title="（2）实际意义"></a>（2）实际意义</h4><ul>
<li>标识符var不是关键字，只是一个保留的类型名称。这意味着var用作变量，方法名或包名的代码不会受到影响，但var不能作为类或则接口的名字。</li>
<li>避免了信息冗余。</li>
<li>对齐了变量名。</li>
<li>更容易阅读。</li>
</ul>
<h2 id="四、Java11的新特性"><a href="#四、Java11的新特性" class="headerlink" title="四、Java11的新特性"></a>四、Java11的新特性</h2><p>2018年9月发布</p>
<p>在Java11中可以使用java命令一次性进行编译和运行操作。</p>
<p>String类新增方法</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>boolean isBlank()</td>
<td>判断字符串是否为空或只包含空白代码点</td>
</tr>
<tr>
<td>Optional map(Function mapper)</td>
<td>根据参数指定规则的结果来得到Optional类 型的对象</td>
</tr>
<tr>
<td>T orElse(T other)</td>
<td>若该值存在就返回，否则返回other的数 值。</td>
</tr>
</tbody></table>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/1-8%E6%96%B0%E7%89%B9%E6%80%A7/" rel="tag">1.8新特性</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/">上一页</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2022
        <i class="ri-heart-fill heart_icon"></i> liang sm
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="卡西莫多的小站"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/photos">照片</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>谢谢老板~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=28457938&auto=1&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    

  </div>
</body>

</html>